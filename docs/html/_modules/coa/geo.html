<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>coa.geo &mdash; Pycoa dev documentation</title>
      <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/graphviz.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/doctools.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../../index.html" class="icon icon-home"> Pycoa
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <!-- Local TOC -->
              <div class="local-toc"></div>
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Pycoa</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home"></a> &raquo;</li>
          <li><a href="../index.html">Module code</a> &raquo;</li>
      <li>coa.geo</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for coa.geo</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="sd">&quot;&quot;&quot; Project : PyCoA</span>
<span class="sd">Date :    april 2020 - march 2021</span>
<span class="sd">Authors : Olivier Dadoun, Julien Browaeys, Tristan Beau</span>
<span class="sd">Copyright Â©pycoa.fr</span>
<span class="sd">License: See joint LICENSE file</span>

<span class="sd">Module : coa.geo</span>

<span class="sd">About :</span>
<span class="sd">-------</span>

<span class="sd">Geo classes within the PyCoA framework.</span>

<span class="sd">GeoManager class provides translations between naming normalisations</span>
<span class="sd">of countries. It&#39;s based on the pycountry module.</span>

<span class="sd">GeoInfo class allow to add new fields to a pandas DataFrame about</span>
<span class="sd">statistical information for countries.</span>

<span class="sd">GeoRegion class helps returning list of countries in a specified region</span>

<span class="sd">GeoCountry manages information for a single country.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">inspect</span>  <span class="c1"># for debug purpose</span>

<span class="kn">import</span> <span class="nn">warnings</span>

<span class="kn">import</span> <span class="nn">pycountry</span> <span class="k">as</span> <span class="nn">pc</span>
<span class="kn">import</span> <span class="nn">pycountry_convert</span> <span class="k">as</span> <span class="nn">pcc</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">geopandas</span> <span class="k">as</span> <span class="nn">gpd</span>
<span class="kn">import</span> <span class="nn">shapely.geometry</span> <span class="k">as</span> <span class="nn">sg</span>
<span class="kn">import</span> <span class="nn">shapely.affinity</span> <span class="k">as</span> <span class="nn">sa</span>
<span class="kn">import</span> <span class="nn">shapely.ops</span> <span class="k">as</span> <span class="nn">so</span>
<span class="kn">import</span> <span class="nn">bs4</span>

<span class="kn">from</span> <span class="nn">coa.tools</span> <span class="kn">import</span> <span class="n">verb</span><span class="p">,</span><span class="n">kwargs_test</span><span class="p">,</span><span class="n">get_local_from_url</span><span class="p">,</span><span class="n">dotdict</span><span class="p">,</span><span class="n">tostdstring</span>
<span class="kn">from</span> <span class="nn">coa.error</span> <span class="kn">import</span> <span class="o">*</span>

<span class="c1"># ---------------------------------------------------------------------</span>
<span class="c1"># --- GeoManager class ------------------------------------------------</span>
<span class="c1"># ---------------------------------------------------------------------</span>

<div class="viewcode-block" id="GeoManager"><a class="viewcode-back" href="../../coa.geo.html#coa.geo.GeoManager">[docs]</a><span class="k">class</span> <span class="nc">GeoManager</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;GeoManager class definition. No inheritance from any other class.</span>

<span class="sd">    It should raise only CoaError and derived exceptions in case</span>
<span class="sd">    of errors (see pycoa.error)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">_list_standard</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;iso2&#39;</span><span class="p">,</span>   <span class="c1"># Iso2 standard, default</span>
            <span class="s1">&#39;iso3&#39;</span><span class="p">,</span>           <span class="c1"># Iso3 standard</span>
            <span class="s1">&#39;name&#39;</span><span class="p">,</span>           <span class="c1"># Standard name ( != Official, caution )</span>
            <span class="s1">&#39;num&#39;</span><span class="p">]</span>            <span class="c1"># Numeric standard</span>

    <span class="n">_list_db</span><span class="o">=</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span><span class="s1">&#39;jhu&#39;</span><span class="p">,</span><span class="s1">&#39;worldometers&#39;</span><span class="p">,</span><span class="s1">&#39;owid&#39;</span><span class="p">,</span><span class="s1">&#39;opencovid19national&#39;</span><span class="p">,</span><span class="s1">&#39;spfnational&#39;</span><span class="p">]</span> <span class="c1"># first is default</span>
    <span class="n">_list_output</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;list&#39;</span><span class="p">,</span><span class="s1">&#39;dict&#39;</span><span class="p">,</span><span class="s1">&#39;pandas&#39;</span><span class="p">]</span> <span class="c1"># first is default</span>

    <span class="n">_standard</span> <span class="o">=</span> <span class="kc">None</span> <span class="c1"># currently used normalisation standard</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">standard</span><span class="o">=</span><span class="n">_list_standard</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
        <span class="sd">&quot;&quot;&quot; __init__ member function, with default definition of</span>
<span class="sd">        the used standard. To get the current default standard,</span>
<span class="sd">        see get_list_standard()[0].</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">verb</span><span class="p">(</span><span class="s2">&quot;Init of GeoManager() from &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">inspect</span><span class="o">.</span><span class="n">stack</span><span class="p">()[</span><span class="mi">1</span><span class="p">]))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_standard</span><span class="p">(</span><span class="n">standard</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_gr</span><span class="o">=</span><span class="n">GeoRegion</span><span class="p">()</span>

<div class="viewcode-block" id="GeoManager.get_GeoRegion"><a class="viewcode-back" href="../../coa.geo.html#coa.geo.GeoManager.get_GeoRegion">[docs]</a>    <span class="k">def</span> <span class="nf">get_GeoRegion</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; return the GeoRegion local instance</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_gr</span></div>

<div class="viewcode-block" id="GeoManager.get_region_list"><a class="viewcode-back" href="../../coa.geo.html#coa.geo.GeoManager.get_region_list">[docs]</a>    <span class="k">def</span> <span class="nf">get_region_list</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; return the list of region via the GeoRegion instance</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_gr</span><span class="o">.</span><span class="n">get_region_list</span><span class="p">()</span></div>

<div class="viewcode-block" id="GeoManager.get_list_standard"><a class="viewcode-back" href="../../coa.geo.html#coa.geo.GeoManager.get_list_standard">[docs]</a>    <span class="k">def</span> <span class="nf">get_list_standard</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; return the list of supported standard name of countries.</span>
<span class="sd">        First one is default for the class</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_list_standard</span></div>

<div class="viewcode-block" id="GeoManager.get_list_output"><a class="viewcode-back" href="../../coa.geo.html#coa.geo.GeoManager.get_list_output">[docs]</a>    <span class="k">def</span> <span class="nf">get_list_output</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; return supported list of output type. First one is default</span>
<span class="sd">        for the class</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_list_output</span></div>

<div class="viewcode-block" id="GeoManager.get_list_db"><a class="viewcode-back" href="../../coa.geo.html#coa.geo.GeoManager.get_list_db">[docs]</a>    <span class="k">def</span> <span class="nf">get_list_db</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; return supported list of database name for translation of</span>
<span class="sd">        country names to standard.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_list_db</span></div>

<div class="viewcode-block" id="GeoManager.get_standard"><a class="viewcode-back" href="../../coa.geo.html#coa.geo.GeoManager.get_standard">[docs]</a>    <span class="k">def</span> <span class="nf">get_standard</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; return current standard use within the GeoManager class</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_standard</span></div>

<div class="viewcode-block" id="GeoManager.set_standard"><a class="viewcode-back" href="../../coa.geo.html#coa.geo.GeoManager.set_standard">[docs]</a>    <span class="k">def</span> <span class="nf">set_standard</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">standard</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        set the working standard type within the GeoManager class.</span>
<span class="sd">        The standard should meet the get_list_standard() requirement</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">standard</span><span class="p">,</span><span class="nb">str</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">CoaTypeError</span><span class="p">(</span><span class="s1">&#39;GeoManager error, the standard argument&#39;</span>
                <span class="s1">&#39; must be a string&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">standard</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_list_standard</span><span class="p">():</span>
            <span class="k">raise</span> <span class="n">CoaKeyError</span><span class="p">(</span><span class="s1">&#39;GeoManager.set_standard error, &quot;&#39;</span><span class="o">+</span>\
                                    <span class="n">standard</span><span class="o">+</span><span class="s1">&#39; not managed. Please see &#39;</span>\
                                    <span class="s1">&#39;get_list_standard() function&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_standard</span><span class="o">=</span><span class="n">standard</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_standard</span><span class="p">()</span></div>

<div class="viewcode-block" id="GeoManager.to_standard"><a class="viewcode-back" href="../../coa.geo.html#coa.geo.GeoManager.to_standard">[docs]</a>    <span class="k">def</span> <span class="nf">to_standard</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Given a list of string of locations (countries), returns a</span>
<span class="sd">        normalised list according to the used standard (defined</span>
<span class="sd">        via the setStandard() or __init__ function. Current default is iso2.</span>

<span class="sd">        Arguments</span>
<span class="sd">        -----------------</span>
<span class="sd">        first arg        --  w, list of string of locations (or single string)</span>
<span class="sd">                             to convert to standard one</span>

<span class="sd">        output           -- &#39;list&#39; (default), &#39;dict&#39; or &#39;pandas&#39;</span>
<span class="sd">        db               -- database name to help conversion.</span>
<span class="sd">                            Default : None, meaning best effort to convert.</span>
<span class="sd">                            Known database : jhu, wordometer...</span>
<span class="sd">                            See get_list_db() for full list of known db for</span>
<span class="sd">                            standardization</span>
<span class="sd">        interpret_region -- Boolean, default=False. If yes, the output should</span>
<span class="sd">                            be only &#39;list&#39;.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">kwargs_test</span><span class="p">(</span><span class="n">kwargs</span><span class="p">,[</span><span class="s1">&#39;output&#39;</span><span class="p">,</span><span class="s1">&#39;db&#39;</span><span class="p">,</span><span class="s1">&#39;interpret_region&#39;</span><span class="p">],</span><span class="s1">&#39;Bad args used in the to_standard() function.&#39;</span><span class="p">)</span>

        <span class="n">output</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;output&#39;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">get_list_output</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">output</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_list_output</span><span class="p">():</span>
            <span class="k">raise</span> <span class="n">CoaKeyError</span><span class="p">(</span><span class="s1">&#39;Incorrect output type. See get_list_output()&#39;</span>
                <span class="s1">&#39; or help.&#39;</span><span class="p">)</span>

        <span class="n">db</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;db&#39;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">get_list_db</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">db</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_list_db</span><span class="p">():</span>
            <span class="k">raise</span> <span class="n">CoaDbError</span><span class="p">(</span><span class="s1">&#39;Unknown database &quot;&#39;</span><span class="o">+</span><span class="n">db</span><span class="o">+</span><span class="s1">&#39;&quot; for translation to &#39;</span>
                <span class="s1">&#39;standardized location names. See get_list_db() or help.&#39;</span><span class="p">)</span>

        <span class="n">interpret_region</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;interpret_region&#39;</span><span class="p">,</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">interpret_region</span><span class="p">,</span><span class="nb">bool</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">CoaTypeError</span><span class="p">(</span><span class="s1">&#39;The interpret_region argument is a boolean, &#39;</span>
                <span class="s1">&#39;not a &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">interpret_region</span><span class="p">)))</span>

        <span class="k">if</span> <span class="n">interpret_region</span><span class="o">==</span><span class="kc">True</span> <span class="ow">and</span> <span class="n">output</span><span class="o">!=</span><span class="s1">&#39;list&#39;</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">CoaKeyError</span><span class="p">(</span><span class="s1">&#39;The interpret_region True argument is incompatible &#39;</span>
                <span class="s1">&#39;with non list output option.&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">w</span><span class="p">,</span><span class="nb">str</span><span class="p">):</span>
            <span class="n">w</span><span class="o">=</span><span class="p">[</span><span class="n">w</span><span class="p">]</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">w</span><span class="p">,</span><span class="nb">list</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">CoaTypeError</span><span class="p">(</span><span class="s1">&#39;Waiting for str, list of str or pandas&#39;</span>
                <span class="s1">&#39;as input of get_standard function member of GeoManager&#39;</span><span class="p">)</span>

        <span class="n">w</span><span class="o">=</span><span class="p">[</span><span class="n">v</span><span class="o">.</span><span class="n">title</span><span class="p">()</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">w</span><span class="p">]</span> <span class="c1"># capitalize first letter of each name</span>

        <span class="n">w0</span><span class="o">=</span><span class="n">w</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">db</span><span class="p">:</span>
            <span class="n">w</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">first_db_translation</span><span class="p">(</span><span class="n">w</span><span class="p">,</span><span class="n">db</span><span class="p">)</span>
        <span class="n">n</span><span class="o">=</span><span class="p">[]</span> <span class="c1"># will contain standardized name of countries (if possible)</span>

        <span class="c1">#for c in w:</span>
        <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">w</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
            <span class="n">c</span><span class="o">=</span><span class="n">w</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">c</span><span class="p">)</span><span class="o">==</span><span class="nb">int</span><span class="p">:</span>
                <span class="n">c</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="n">c</span><span class="p">)</span><span class="o">!=</span><span class="nb">str</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">CoaTypeError</span><span class="p">(</span><span class="s1">&#39;Locations should be given as &#39;</span>
                    <span class="s1">&#39;strings or integers only&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_gr</span><span class="o">.</span><span class="n">get_region_list</span><span class="p">())</span> <span class="ow">and</span> <span class="n">interpret_region</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">w</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_gr</span><span class="o">.</span><span class="n">get_countries_from_region</span><span class="p">(</span><span class="n">c</span><span class="p">)</span><span class="o">+</span><span class="n">w</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">c</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                    <span class="n">n1</span><span class="o">=</span><span class="s1">&#39;&#39;</span> <span class="c1">#None</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">n0</span><span class="o">=</span><span class="n">pc</span><span class="o">.</span><span class="n">countries</span><span class="o">.</span><span class="n">lookup</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">LookupError</span><span class="p">:</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;Owid_&#39;</span><span class="p">):</span>
                                <span class="n">nf</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;owid_*&#39;</span><span class="p">]</span>
                                <span class="n">n1</span><span class="o">=</span><span class="s1">&#39;OWID_*&#39;</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">nf</span><span class="o">=</span><span class="n">pc</span><span class="o">.</span><span class="n">countries</span><span class="o">.</span><span class="n">search_fuzzy</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
                            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">nf</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">:</span>
                                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;Caution. More than one country match the key &quot;&#39;</span><span class="o">+</span>\
                                <span class="n">c</span><span class="o">+</span><span class="s1">&#39;&quot; : &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">([</span> <span class="p">(</span><span class="n">k</span><span class="o">.</span><span class="n">name</span><span class="o">+</span><span class="s1">&#39;, &#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">nf</span><span class="p">])</span><span class="o">+</span>\
                                <span class="s1">&#39;, using first one.</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                            <span class="n">n0</span><span class="o">=</span><span class="n">nf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                        <span class="k">except</span> <span class="ne">LookupError</span><span class="p">:</span>
                            <span class="k">raise</span> <span class="n">CoaLookupError</span><span class="p">(</span><span class="s1">&#39;No country match the key &quot;&#39;</span><span class="o">+</span><span class="n">c</span><span class="o">+</span><span class="s1">&#39;&quot;. Error.&#39;</span><span class="p">)</span>
                        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e1</span><span class="p">:</span>
                            <span class="k">raise</span> <span class="n">CoaNotManagedError</span><span class="p">(</span><span class="s1">&#39;Not managed error &#39;</span><span class="o">+</span><span class="nb">type</span><span class="p">(</span><span class="n">e1</span><span class="p">))</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e2</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="n">CoaNotManagedError</span><span class="p">(</span><span class="s1">&#39;Not managed error&#39;</span><span class="o">+</span><span class="nb">type</span><span class="p">(</span><span class="n">e1</span><span class="p">))</span>

                    <span class="k">if</span> <span class="n">n0</span> <span class="o">!=</span> <span class="s1">&#39;owid_*&#39;</span><span class="p">:</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_standard</span><span class="o">==</span><span class="s1">&#39;iso2&#39;</span><span class="p">:</span>
                            <span class="n">n1</span><span class="o">=</span><span class="n">n0</span><span class="o">.</span><span class="n">alpha_2</span>
                        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_standard</span><span class="o">==</span><span class="s1">&#39;iso3&#39;</span><span class="p">:</span>
                            <span class="n">n1</span><span class="o">=</span><span class="n">n0</span><span class="o">.</span><span class="n">alpha_3</span>
                        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_standard</span><span class="o">==</span><span class="s1">&#39;name&#39;</span><span class="p">:</span>
                            <span class="n">n1</span><span class="o">=</span><span class="n">n0</span><span class="o">.</span><span class="n">name</span>
                        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_standard</span><span class="o">==</span><span class="s1">&#39;num&#39;</span><span class="p">:</span>
                            <span class="n">n1</span><span class="o">=</span><span class="n">n0</span><span class="o">.</span><span class="n">numeric</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="k">raise</span> <span class="n">CoaKeyError</span><span class="p">(</span><span class="s1">&#39;Current standard is &#39;</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">_standard</span><span class="o">+</span>\
                                <span class="s1">&#39; which is not managed. Error.&#39;</span><span class="p">)</span>

                <span class="n">n</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">n1</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">output</span><span class="o">==</span><span class="s1">&#39;list&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">n</span>
        <span class="k">elif</span> <span class="n">output</span><span class="o">==</span><span class="s1">&#39;dict&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">w0</span><span class="p">,</span> <span class="n">n</span><span class="p">))</span>
        <span class="k">elif</span> <span class="n">output</span><span class="o">==</span><span class="s1">&#39;pandas&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s1">&#39;inputname&#39;</span><span class="p">:</span><span class="n">w0</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">_standard</span><span class="p">:</span><span class="n">n</span><span class="p">})</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span> <span class="c1"># should not be here</span></div>

<div class="viewcode-block" id="GeoManager.first_db_translation"><a class="viewcode-back" href="../../coa.geo.html#coa.geo.GeoManager.first_db_translation">[docs]</a>    <span class="k">def</span> <span class="nf">first_db_translation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">w</span><span class="p">,</span><span class="n">db</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; This function helps to translate from country name to</span>
<span class="sd">        standard for specific databases. It&#39;s the first step</span>
<span class="sd">        before final translation.</span>

<span class="sd">        One can easily add some database support adding some new rules</span>
<span class="sd">        for specific databases</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">translation_dict</span><span class="o">=</span><span class="p">{}</span>
        <span class="c1"># Caution : keys need to be in title mode, i.e. first letter capitalized</span>
        <span class="k">if</span> <span class="n">db</span><span class="o">==</span><span class="s1">&#39;jhu&#39;</span><span class="p">:</span>
            <span class="n">translation_dict</span><span class="o">.</span><span class="n">update</span><span class="p">({</span>\
                <span class="s2">&quot;Congo (Brazzaville)&quot;</span><span class="p">:</span><span class="s2">&quot;Republic of the Congo&quot;</span><span class="p">,</span>\
                <span class="s2">&quot;Congo (Kinshasa)&quot;</span><span class="p">:</span><span class="s2">&quot;COD&quot;</span><span class="p">,</span>\
                <span class="s2">&quot;Korea, South&quot;</span><span class="p">:</span><span class="s2">&quot;KOR&quot;</span><span class="p">,</span>\
                <span class="s2">&quot;Taiwan*&quot;</span><span class="p">:</span><span class="s2">&quot;Taiwan&quot;</span><span class="p">,</span>\
                <span class="s2">&quot;Laos&quot;</span><span class="p">:</span><span class="s2">&quot;LAO&quot;</span><span class="p">,</span>\
                <span class="s2">&quot;West Bank And Gaza&quot;</span><span class="p">:</span><span class="s2">&quot;PSE&quot;</span><span class="p">,</span>\
                <span class="s2">&quot;Burma&quot;</span><span class="p">:</span><span class="s2">&quot;Myanmar&quot;</span><span class="p">,</span>\
                <span class="s2">&quot;Iran&quot;</span><span class="p">:</span><span class="s2">&quot;IRN&quot;</span><span class="p">,</span>\
                <span class="s2">&quot;Diamond Princess&quot;</span><span class="p">:</span><span class="s2">&quot;&quot;</span><span class="p">,</span>\
                <span class="s2">&quot;Ms Zaandam&quot;</span><span class="p">:</span><span class="s2">&quot;&quot;</span><span class="p">,</span>\
                <span class="s2">&quot;Summer Olympics 2020&quot;</span><span class="p">:</span><span class="s2">&quot;&quot;</span><span class="p">,</span>\
                <span class="s2">&quot;Micronesia&quot;</span><span class="p">:</span><span class="s2">&quot;FSM&quot;</span><span class="p">,</span>\
                    <span class="p">})</span>  <span class="c1"># last two are names of boats</span>
        <span class="k">elif</span> <span class="n">db</span><span class="o">==</span><span class="s1">&#39;worldometers&#39;</span><span class="p">:</span>
            <span class="n">translation_dict</span><span class="o">.</span><span class="n">update</span><span class="p">({</span>\
                <span class="s2">&quot;Dr Congo&quot;</span><span class="p">:</span><span class="s2">&quot;COD&quot;</span><span class="p">,</span>\
                <span class="s2">&quot;Congo&quot;</span><span class="p">:</span><span class="s2">&quot;COG&quot;</span><span class="p">,</span>\
                <span class="s2">&quot;Iran&quot;</span><span class="p">:</span><span class="s2">&quot;IRN&quot;</span><span class="p">,</span>\
                <span class="s2">&quot;South Korea&quot;</span><span class="p">:</span><span class="s2">&quot;KOR&quot;</span><span class="p">,</span>\
                <span class="s2">&quot;North Korea&quot;</span><span class="p">:</span><span class="s2">&quot;PRK&quot;</span><span class="p">,</span>\
                <span class="s2">&quot;Czech Republic (Czechia)&quot;</span><span class="p">:</span><span class="s2">&quot;CZE&quot;</span><span class="p">,</span>\
                <span class="s2">&quot;Laos&quot;</span><span class="p">:</span><span class="s2">&quot;LAO&quot;</span><span class="p">,</span>\
                <span class="s2">&quot;Sao Tome &amp; Principe&quot;</span><span class="p">:</span><span class="s2">&quot;STP&quot;</span><span class="p">,</span>\
                <span class="s2">&quot;Channel Islands&quot;</span><span class="p">:</span><span class="s2">&quot;JEY&quot;</span><span class="p">,</span>\
                <span class="s2">&quot;St. Vincent &amp; Grenadines&quot;</span><span class="p">:</span><span class="s2">&quot;VCT&quot;</span><span class="p">,</span>\
                <span class="s2">&quot;U.S. Virgin Islands&quot;</span><span class="p">:</span><span class="s2">&quot;VIR&quot;</span><span class="p">,</span>\
                <span class="s2">&quot;Saint Kitts &amp; Nevis&quot;</span><span class="p">:</span><span class="s2">&quot;KNA&quot;</span><span class="p">,</span>\
                <span class="s2">&quot;Faeroe Islands&quot;</span><span class="p">:</span><span class="s2">&quot;FRO&quot;</span><span class="p">,</span>\
                <span class="s2">&quot;Caribbean Netherlands&quot;</span><span class="p">:</span><span class="s2">&quot;BES&quot;</span><span class="p">,</span>\
                <span class="s2">&quot;Wallis &amp; Futuna&quot;</span><span class="p">:</span><span class="s2">&quot;WLF&quot;</span><span class="p">,</span>\
                <span class="s2">&quot;Saint Pierre &amp; Miquelon&quot;</span><span class="p">:</span><span class="s2">&quot;SPM&quot;</span><span class="p">,</span>\
                <span class="s2">&quot;Sint Maarten&quot;</span><span class="p">:</span><span class="s2">&quot;SXM&quot;</span><span class="p">,</span>\
                <span class="p">}</span> <span class="p">)</span>
        <span class="k">elif</span> <span class="n">db</span><span class="o">==</span><span class="s1">&#39;owid&#39;</span><span class="p">:</span>
            <span class="n">translation_dict</span><span class="o">.</span><span class="n">update</span><span class="p">({</span>\
                    <span class="s2">&quot;Bonaire Sint Eustatius And Saba&quot;</span><span class="p">:</span><span class="s2">&quot;BES&quot;</span><span class="p">,</span>\
                    <span class="s2">&quot;Cape Verde&quot;</span><span class="p">:</span><span class="s2">&quot;CPV&quot;</span><span class="p">,</span>\
                    <span class="s2">&quot;Democratic Republic Of Congo&quot;</span><span class="p">:</span><span class="s2">&quot;COD&quot;</span><span class="p">,</span>\
                    <span class="s2">&quot;Faeroe Islands&quot;</span><span class="p">:</span><span class="s2">&quot;FRO&quot;</span><span class="p">,</span>\
                    <span class="s2">&quot;Laos&quot;</span><span class="p">:</span><span class="s2">&quot;LAO&quot;</span><span class="p">,</span>\
                    <span class="s2">&quot;South Korea&quot;</span><span class="p">:</span><span class="s2">&quot;KOR&quot;</span><span class="p">,</span>\
                    <span class="s2">&quot;Swaziland&quot;</span><span class="p">:</span><span class="s2">&quot;SWZ&quot;</span><span class="p">,</span>\
                    <span class="s2">&quot;United States Virgin Islands&quot;</span><span class="p">:</span><span class="s2">&quot;VIR&quot;</span><span class="p">,</span>\
                    <span class="s2">&quot;Iran&quot;</span><span class="p">:</span><span class="s2">&quot;IRN&quot;</span><span class="p">,</span>\
                    <span class="s2">&quot;Micronesia (Country)&quot;</span><span class="p">:</span><span class="s2">&quot;FSM&quot;</span><span class="p">,</span>\
                    <span class="s2">&quot;Northern Cyprus&quot;</span><span class="p">:</span><span class="s2">&quot;CYP&quot;</span><span class="p">,</span>\
                    <span class="s2">&quot;Curacao&quot;</span><span class="p">:</span><span class="s2">&quot;CUW&quot;</span><span class="p">,</span>\
                    <span class="s2">&quot;Faeroe Islands&quot;</span><span class="p">:</span><span class="s2">&quot;FRO&quot;</span><span class="p">,</span>\
                    <span class="s2">&quot;Vatican&quot;</span><span class="p">:</span><span class="s2">&quot;VAT&quot;</span>
                <span class="p">})</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">translation_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">w</span><span class="p">]</span></div></div>

<span class="c1"># ---------------------------------------------------------------------</span>
<span class="c1"># --- GeoInfo class ---------------------------------------------------</span>
<span class="c1"># ---------------------------------------------------------------------</span>

<div class="viewcode-block" id="GeoInfo"><a class="viewcode-back" href="../../coa.geo.html#coa.geo.GeoInfo">[docs]</a><span class="k">class</span> <span class="nc">GeoInfo</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;GeoInfo class definition. No inheritance from any other class.</span>

<span class="sd">    It should raise only CoaError and derived exceptions in case</span>
<span class="sd">    of errors (see pycoa.error)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">_list_field</span><span class="o">=</span><span class="p">{</span>\
        <span class="s1">&#39;continent_code&#39;</span><span class="p">:</span><span class="s1">&#39;pycountry_convert (https://pypi.org/project/pycountry-convert/)&#39;</span><span class="p">,</span>\
        <span class="s1">&#39;continent_name&#39;</span><span class="p">:</span><span class="s1">&#39;pycountry_convert (https://pypi.org/project/pycountry-convert/)&#39;</span> <span class="p">,</span>\
        <span class="s1">&#39;country_name&#39;</span><span class="p">:</span><span class="s1">&#39;pycountry_convert (https://pypi.org/project/pycountry-convert/)&#39;</span> <span class="p">,</span>\
        <span class="s1">&#39;population&#39;</span><span class="p">:</span><span class="s1">&#39;https://www.worldometers.info/world-population/population-by-country/&#39;</span><span class="p">,</span>\
        <span class="s1">&#39;area&#39;</span><span class="p">:</span><span class="s1">&#39;https://www.worldometers.info/world-population/population-by-country/&#39;</span><span class="p">,</span>\
        <span class="s1">&#39;fertility&#39;</span><span class="p">:</span><span class="s1">&#39;https://www.worldometers.info/world-population/population-by-country/&#39;</span><span class="p">,</span>\
        <span class="s1">&#39;median_age&#39;</span><span class="p">:</span><span class="s1">&#39;https://www.worldometers.info/world-population/population-by-country/&#39;</span><span class="p">,</span>\
        <span class="s1">&#39;urban_rate&#39;</span><span class="p">:</span><span class="s1">&#39;https://www.worldometers.info/world-population/population-by-country/&#39;</span><span class="p">,</span>\
        <span class="c1">#&#39;geometry&#39;:&#39;https://github.com/johan/world.geo.json/&#39;,\</span>
        <span class="s1">&#39;geometry&#39;</span><span class="p">:</span><span class="s1">&#39;http://thematicmapping.org/downloads/world_borders.php and https://github.com/johan/world.geo.json/&#39;</span><span class="p">,</span>\
        <span class="s1">&#39;region_code_list&#39;</span><span class="p">:</span><span class="s1">&#39;https://en.wikipedia.org/w/index.php?title=List_of_countries_by_United_Nations_geoscheme&amp;oldid=1008989486&#39;</span><span class="p">,</span>\
        <span class="c1">#https://en.wikipedia.org/wiki/List_of_countries_by_United_Nations_geoscheme&#39;,\</span>
        <span class="s1">&#39;region_name_list&#39;</span><span class="p">:</span><span class="s1">&#39;https://en.wikipedia.org/w/index.php?title=List_of_countries_by_United_Nations_geoscheme&amp;oldid=1008989486&#39;</span><span class="p">,</span>\
        <span class="c1">#https://en.wikipedia.org/wiki/List_of_countries_by_United_Nations_geoscheme&#39;,\</span>
        <span class="s1">&#39;capital&#39;</span><span class="p">:</span><span class="s1">&#39;https://en.wikipedia.org/w/index.php?title=List_of_countries_by_United_Nations_geoscheme&amp;oldid=1008989486&#39;</span><span class="p">,</span>\
        <span class="c1">#https://en.wikipedia.org/wiki/List_of_countries_by_United_Nations_geoscheme&#39;,\</span>
        <span class="s1">&#39;flag&#39;</span><span class="p">:</span><span class="s1">&#39;https://github.com/linssen/country-flag-icons/blob/master/countries.json&#39;</span><span class="p">,</span>\
        <span class="p">}</span>

    <span class="n">_data_geometry</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
    <span class="n">_data_population</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
    <span class="n">_data_flag</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">gm</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; __init__ member function.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">verb</span><span class="p">(</span><span class="s2">&quot;Init of GeoInfo() from &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">inspect</span><span class="o">.</span><span class="n">stack</span><span class="p">()[</span><span class="mi">1</span><span class="p">]))</span>
        <span class="k">if</span> <span class="n">gm</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_gm</span><span class="o">=</span><span class="n">gm</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_gm</span><span class="o">=</span><span class="n">GeoManager</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_grp</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_gm</span><span class="o">.</span><span class="n">_gr</span><span class="o">.</span><span class="n">get_pandas</span><span class="p">()</span>

<div class="viewcode-block" id="GeoInfo.get_GeoManager"><a class="viewcode-back" href="../../coa.geo.html#coa.geo.GeoInfo.get_GeoManager">[docs]</a>    <span class="k">def</span> <span class="nf">get_GeoManager</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; return the local instance of used GeoManager()</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_gm</span></div>

<div class="viewcode-block" id="GeoInfo.get_list_field"><a class="viewcode-back" href="../../coa.geo.html#coa.geo.GeoInfo.get_list_field">[docs]</a>    <span class="k">def</span> <span class="nf">get_list_field</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; return the list of supported additionnal fields available</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_list_field</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span></div>

<div class="viewcode-block" id="GeoInfo.get_source"><a class="viewcode-back" href="../../coa.geo.html#coa.geo.GeoInfo.get_source">[docs]</a>    <span class="k">def</span> <span class="nf">get_source</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">field</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; return the source of the information provided for a given</span>
<span class="sd">        field.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">field</span><span class="o">==</span><span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_list_field</span>
        <span class="k">elif</span> <span class="n">field</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_list_field</span><span class="p">():</span>
            <span class="k">raise</span> <span class="n">CoaKeyError</span><span class="p">(</span><span class="s1">&#39;The field &quot;&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">field</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;&quot; is not &#39;</span>
                <span class="s1">&#39;a supported field of GeoInfo(). Please see help or &#39;</span>
                <span class="s1">&#39;the get_list_field() output.&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">field</span><span class="o">+</span><span class="s1">&#39; : &#39;</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">_list_field</span><span class="p">[</span><span class="n">field</span><span class="p">]</span></div>


<div class="viewcode-block" id="GeoInfo.add_field"><a class="viewcode-back" href="../../coa.geo.html#coa.geo.GeoInfo.add_field">[docs]</a>    <span class="k">def</span> <span class="nf">add_field</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; this is the main function of the GeoInfo class. It adds to</span>
<span class="sd">        the input pandas dataframe some fields according to</span>
<span class="sd">        the geofield field of input.</span>
<span class="sd">        The return value is the pandas dataframe.</span>

<span class="sd">        Arguments :</span>
<span class="sd">        field    -- should be given as a string of list of strings and</span>
<span class="sd">                    should be valid fields (see get_list_field() )</span>
<span class="sd">                    Mandatory.</span>
<span class="sd">        input    -- provide the input pandas dataframe. Mandatory.</span>
<span class="sd">        geofield -- provide the field name in the pandas where the</span>
<span class="sd">                    location is stored. Default : &#39;location&#39;</span>
<span class="sd">        overload -- Allow to overload a field. Boolean value.</span>
<span class="sd">                    Default : False</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># --- kwargs analysis ---</span>

        <span class="n">kwargs_test</span><span class="p">(</span><span class="n">kwargs</span><span class="p">,[</span><span class="s1">&#39;field&#39;</span><span class="p">,</span><span class="s1">&#39;input&#39;</span><span class="p">,</span><span class="s1">&#39;geofield&#39;</span><span class="p">,</span><span class="s1">&#39;overload&#39;</span><span class="p">],</span>
            <span class="s1">&#39;Bad args used in the add_field() function.&#39;</span><span class="p">)</span>

        <span class="n">p</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;input&#39;</span><span class="p">,</span><span class="kc">None</span><span class="p">)</span> <span class="c1"># the panda</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">CoaTypeError</span><span class="p">(</span><span class="s1">&#39;You should provide a valid input pandas&#39;</span>
                <span class="s1">&#39; DataFrame as input. See help.&#39;</span><span class="p">)</span>
        <span class="n">p</span><span class="o">=</span><span class="n">p</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="n">overload</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;overload&#39;</span><span class="p">,</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">overload</span><span class="p">,</span><span class="nb">bool</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">CoaTypeError</span><span class="p">(</span><span class="s1">&#39;The overload option should be a boolean.&#39;</span><span class="p">)</span>

        <span class="n">fl</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;field&#39;</span><span class="p">,</span><span class="kc">None</span><span class="p">)</span> <span class="c1"># field list</span>
        <span class="k">if</span> <span class="n">fl</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">CoaKeyError</span><span class="p">(</span><span class="s1">&#39;No field given. See help.&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">fl</span><span class="p">,</span><span class="nb">list</span><span class="p">):</span>
            <span class="n">fl</span><span class="o">=</span><span class="p">[</span><span class="n">fl</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="n">f</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_list_field</span><span class="p">()</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">fl</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">CoaKeyError</span><span class="p">(</span><span class="s1">&#39;All fields are not valid or supported &#39;</span>
                <span class="s1">&#39;ones. Please see help of get_list_field()&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">overload</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="n">f</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">p</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">fl</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">CoaKeyError</span><span class="p">(</span><span class="s1">&#39;Some fields already exist in you panda &#39;</span>
                <span class="s1">&#39;dataframe columns. You may set overload to True.&#39;</span><span class="p">)</span>

        <span class="n">geofield</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;geofield&#39;</span><span class="p">,</span><span class="s1">&#39;location&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">geofield</span><span class="p">,</span><span class="nb">str</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">CoaTypeError</span><span class="p">(</span><span class="s1">&#39;The geofield should be given as a &#39;</span>
                <span class="s1">&#39;string.&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">geofield</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">p</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">tolist</span><span class="p">():</span>
            <span class="k">raise</span> <span class="n">CoaKeyError</span><span class="p">(</span><span class="s1">&#39;The geofield &quot;&#39;</span><span class="o">+</span><span class="n">geofield</span><span class="o">+</span><span class="s1">&#39;&quot; given is &#39;</span>
                <span class="s1">&#39;not a valid column name of the input pandas dataframe.&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_gm</span><span class="o">.</span><span class="n">set_standard</span><span class="p">(</span><span class="s1">&#39;iso2&#39;</span><span class="p">)</span>
        <span class="n">countries_iso2</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_gm</span><span class="o">.</span><span class="n">to_standard</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="n">geofield</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_gm</span><span class="o">.</span><span class="n">set_standard</span><span class="p">(</span><span class="s1">&#39;iso3&#39;</span><span class="p">)</span>
        <span class="n">countries_iso3</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_gm</span><span class="o">.</span><span class="n">to_standard</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="n">geofield</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>

        <span class="n">p</span><span class="p">[</span><span class="s1">&#39;iso2_tmp&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">countries_iso2</span>
        <span class="n">p</span><span class="p">[</span><span class="s1">&#39;iso3_tmp&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">countries_iso3</span>

        <span class="c1"># --- loop over all needed fields ---</span>
        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">fl</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">p</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">tolist</span><span class="p">():</span>
                <span class="n">p</span><span class="o">=</span><span class="n">p</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">f</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="c1"># ----------------------------------------------------------</span>
            <span class="k">if</span> <span class="n">f</span> <span class="o">==</span> <span class="s1">&#39;continent_code&#39;</span><span class="p">:</span>
                <span class="n">p</span><span class="p">[</span><span class="n">f</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">pcc</span><span class="o">.</span><span class="n">country_alpha2_to_continent_code</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">countries_iso2</span><span class="p">]</span>
            <span class="c1"># ----------------------------------------------------------</span>
            <span class="k">elif</span> <span class="n">f</span> <span class="o">==</span> <span class="s1">&#39;continent_name&#39;</span><span class="p">:</span>
                <span class="n">p</span><span class="p">[</span><span class="n">f</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">pcc</span><span class="o">.</span><span class="n">convert_continent_code_to_continent_name</span><span class="p">(</span> \
                    <span class="n">pcc</span><span class="o">.</span><span class="n">country_alpha2_to_continent_code</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="p">)</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">countries_iso2</span> <span class="p">]</span>
            <span class="c1"># ----------------------------------------------------------</span>
            <span class="k">elif</span> <span class="n">f</span> <span class="o">==</span> <span class="s1">&#39;country_name&#39;</span><span class="p">:</span>
                <span class="n">p</span><span class="p">[</span><span class="n">f</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">pcc</span><span class="o">.</span><span class="n">country_alpha2_to_country_name</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">countries_iso2</span><span class="p">]</span>
            <span class="c1"># ----------------------------------------------------------</span>
            <span class="k">elif</span> <span class="n">f</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;population&#39;</span><span class="p">,</span><span class="s1">&#39;area&#39;</span><span class="p">,</span><span class="s1">&#39;fertility&#39;</span><span class="p">,</span><span class="s1">&#39;median_age&#39;</span><span class="p">,</span><span class="s1">&#39;urban_rate&#39;</span><span class="p">]:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data_population</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>

                    <span class="n">field_descr</span><span class="o">=</span><span class="p">(</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;idx&#39;</span><span class="p">),</span>
                        <span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="s1">&#39;Country&#39;</span><span class="p">,</span><span class="s1">&#39;country&#39;</span><span class="p">),</span>
                        <span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="s1">&#39;Population&#39;</span><span class="p">,</span><span class="s1">&#39;population&#39;</span><span class="p">),</span>
                        <span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="s1">&#39;Land Area&#39;</span><span class="p">,</span><span class="s1">&#39;area&#39;</span><span class="p">),</span>
                        <span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="s1">&#39;Fert&#39;</span><span class="p">,</span><span class="s1">&#39;fertility&#39;</span><span class="p">),</span>
                        <span class="p">(</span><span class="mi">9</span><span class="p">,</span><span class="s1">&#39;Med&#39;</span><span class="p">,</span><span class="s1">&#39;median_age&#39;</span><span class="p">),</span>
                        <span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="s1">&#39;Urban&#39;</span><span class="p">,</span><span class="s1">&#39;urban_rate&#39;</span><span class="p">),</span>
                        <span class="p">)</span> <span class="c1"># containts tuples with position in table, name of column, new name of field</span>

                    <span class="c1"># get data with cache ok for about 1 month</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_data_population</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_html</span><span class="p">(</span><span class="n">get_local_from_url</span><span class="p">(</span><span class="s1">&#39;https://www.worldometers.info/world-population/population-by-country/&#39;</span><span class="p">,</span><span class="mf">30e5</span><span class="p">)</span> <span class="p">)</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,[</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">field_descr</span><span class="p">]]</span>

                    <span class="c1"># test that field order hasn&#39;t changed in the db</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span> <span class="p">(</span><span class="n">col</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">field_descr</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">col</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_data_population</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span> <span class="p">):</span>
                        <span class="k">raise</span> <span class="n">CoaDbError</span><span class="p">(</span><span class="s1">&#39;The worldometers database changed its field names. &#39;</span>
                            <span class="s1">&#39;The GeoInfo should be updated. Please contact developers.&#39;</span><span class="p">)</span>

                    <span class="c1"># change field name</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_data_population</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">field_descr</span><span class="p">]</span>

                    <span class="c1"># standardization of country name</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_data_population</span><span class="p">[</span><span class="s1">&#39;iso3_tmp2&#39;</span><span class="p">]</span><span class="o">=</span>\
                        <span class="bp">self</span><span class="o">.</span><span class="n">_gm</span><span class="o">.</span><span class="n">to_standard</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_data_population</span><span class="p">[</span><span class="s1">&#39;country&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span>\
                        <span class="n">db</span><span class="o">=</span><span class="s1">&#39;worldometers&#39;</span><span class="p">)</span>

                <span class="n">p</span><span class="o">=</span><span class="n">p</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_data_population</span><span class="p">[[</span><span class="s2">&quot;iso3_tmp2&quot;</span><span class="p">,</span><span class="n">f</span><span class="p">]],</span><span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span>\
                        <span class="n">left_on</span><span class="o">=</span><span class="s1">&#39;iso3_tmp&#39;</span><span class="p">,</span><span class="n">right_on</span><span class="o">=</span><span class="s1">&#39;iso3_tmp2&#39;</span><span class="p">,</span>\
                        <span class="n">suffixes</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;_tmp&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="s1">&#39;iso3_tmp2&#39;</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

            <span class="c1"># ----------------------------------------------------------</span>
            <span class="k">elif</span> <span class="n">f</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;region_code_list&#39;</span><span class="p">,</span><span class="s1">&#39;region_name_list&#39;</span><span class="p">]:</span>

                <span class="k">if</span> <span class="n">f</span> <span class="o">==</span> <span class="s1">&#39;region_code_list&#39;</span><span class="p">:</span>
                    <span class="n">ff</span> <span class="o">=</span> <span class="s1">&#39;region&#39;</span>
                <span class="k">elif</span> <span class="n">f</span> <span class="o">==</span> <span class="s1">&#39;region_name_list&#39;</span><span class="p">:</span>
                    <span class="n">ff</span> <span class="o">=</span> <span class="s1">&#39;region_name&#39;</span>

                <span class="n">p</span><span class="p">[</span><span class="n">f</span><span class="p">]</span><span class="o">=</span><span class="n">p</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_grp</span><span class="p">[[</span><span class="s1">&#39;iso3&#39;</span><span class="p">,</span><span class="n">ff</span><span class="p">]],</span><span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span>\
                    <span class="n">left_on</span><span class="o">=</span><span class="s1">&#39;iso3_tmp&#39;</span><span class="p">,</span><span class="n">right_on</span><span class="o">=</span><span class="s1">&#39;iso3&#39;</span><span class="p">,</span>\
                    <span class="n">suffixes</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;_tmp&#39;</span><span class="p">))</span> \
                    <span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;iso3_tmp&#39;</span><span class="p">)[</span><span class="n">ff</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span><span class="o">.</span><span class="n">to_list</span><span class="p">()</span>
            <span class="c1"># ----------------------------------------------------------</span>
            <span class="k">elif</span> <span class="n">f</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;capital&#39;</span><span class="p">]:</span>
                <span class="n">p</span><span class="p">[</span><span class="n">f</span><span class="p">]</span><span class="o">=</span><span class="n">p</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_grp</span><span class="p">[[</span><span class="s1">&#39;iso3&#39;</span><span class="p">,</span><span class="n">f</span><span class="p">]]</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">(),</span> \
                    <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span><span class="n">left_on</span><span class="o">=</span><span class="s1">&#39;iso3_tmp&#39;</span><span class="p">,</span><span class="n">right_on</span><span class="o">=</span><span class="s1">&#39;iso3&#39;</span><span class="p">,</span>\
                    <span class="n">suffixes</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;_tmp&#39;</span><span class="p">))[</span><span class="n">f</span><span class="p">]</span>

            <span class="c1"># ----------------------------------------------------------</span>
            <span class="k">elif</span> <span class="n">f</span> <span class="o">==</span> <span class="s1">&#39;geometry&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data_geometry</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
                    <span class="c1">#geojsondatafile = &#39;https://raw.githubusercontent.com/johan/world.geo.json/master/countries.geo.json&#39;</span>
                    <span class="c1">#self._data_geometry = gpd.read_file(get_local_from_url(geojsondatafile,0,&#39;.json&#39;))[[&quot;id&quot;,&quot;geometry&quot;]]</span>
                    <span class="n">world_geometry_url_zipfile</span><span class="o">=</span><span class="s1">&#39;http://thematicmapping.org/downloads/TM_WORLD_BORDERS_SIMPL-0.3.zip&#39;</span> <span class="c1"># too much simplified version ?</span>
                    <span class="c1"># world_geometry_url_zipfile=&#39;http://thematicmapping.org/downloads/TM_WORLD_BORDERS-0.3.zip&#39; # too precize version ?</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_data_geometry</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">read_file</span><span class="p">(</span><span class="s1">&#39;zip://&#39;</span><span class="o">+</span><span class="n">get_local_from_url</span><span class="p">(</span><span class="n">world_geometry_url_zipfile</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="s1">&#39;.zip&#39;</span><span class="p">))[[</span><span class="s1">&#39;ISO3&#39;</span><span class="p">,</span><span class="s1">&#39;geometry&#39;</span><span class="p">]]</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_data_geometry</span><span class="o">.</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;id_tmp&quot;</span><span class="p">,</span><span class="s2">&quot;geometry&quot;</span><span class="p">]</span>

                    <span class="c1"># About some countries not properly managed by this database (south and north soudan)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_data_geometry</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_data_geometry</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s1">&#39;id_tmp&#39;</span><span class="p">:</span><span class="s1">&#39;SSD&#39;</span><span class="p">,</span><span class="s1">&#39;geometry&#39;</span><span class="p">:</span><span class="kc">None</span><span class="p">},</span><span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="c1"># adding the SSD row</span>
                    <span class="k">for</span> <span class="n">newc</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;SSD&#39;</span><span class="p">,</span><span class="s1">&#39;SDN&#39;</span><span class="p">]:</span>
                        <span class="n">newgeo</span><span class="o">=</span><span class="n">gpd</span><span class="o">.</span><span class="n">read_file</span><span class="p">(</span><span class="n">get_local_from_url</span><span class="p">(</span><span class="s1">&#39;https://github.com/johan/world.geo.json/raw/master/countries/&#39;</span><span class="o">+</span><span class="n">newc</span><span class="o">+</span><span class="s1">&#39;.geo.json&#39;</span><span class="p">))</span>
                        <span class="n">poly</span><span class="o">=</span><span class="n">newgeo</span><span class="p">[</span><span class="n">newgeo</span><span class="o">.</span><span class="n">id</span><span class="o">==</span><span class="n">newc</span><span class="p">]</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_data_geometry</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_data_geometry</span><span class="o">.</span><span class="n">id_tmp</span><span class="o">==</span><span class="n">newc</span><span class="p">,</span><span class="s1">&#39;geometry&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">gpd</span><span class="o">.</span><span class="n">GeoSeries</span><span class="p">(</span><span class="n">poly</span><span class="p">)</span><span class="o">.</span><span class="n">values</span>

                    <span class="c1"># About countries that we artificially put on the east of the map</span>
                    <span class="k">for</span> <span class="n">newc</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;RUS&#39;</span><span class="p">,</span><span class="s1">&#39;FJI&#39;</span><span class="p">,</span><span class="s1">&#39;NZL&#39;</span><span class="p">,</span><span class="s1">&#39;WSM&#39;</span><span class="p">]:</span>
                        <span class="n">poly</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_data_geometry</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_data_geometry</span><span class="o">.</span><span class="n">id_tmp</span><span class="o">==</span><span class="n">newc</span><span class="p">]</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                        <span class="n">poly</span><span class="o">=</span><span class="n">so</span><span class="o">.</span><span class="n">unary_union</span><span class="p">(</span><span class="n">sg</span><span class="o">.</span><span class="n">MultiPolygon</span><span class="p">([</span><span class="n">sg</span><span class="o">.</span><span class="n">Polygon</span><span class="p">([(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">)</span> <span class="k">if</span> <span class="n">x</span><span class="o">&gt;=</span><span class="mi">0</span> <span class="k">else</span> <span class="p">(</span><span class="n">x</span><span class="o">+</span><span class="mi">360</span><span class="p">,</span><span class="n">y</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span><span class="p">,</span><span class="n">y</span> <span class="ow">in</span> <span class="n">p</span><span class="o">.</span><span class="n">exterior</span><span class="o">.</span><span class="n">coords</span><span class="p">])</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">poly</span><span class="p">]))</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_data_geometry</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_data_geometry</span><span class="o">.</span><span class="n">id_tmp</span><span class="o">==</span><span class="n">newc</span><span class="p">,</span><span class="s1">&#39;geometry&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">gpd</span><span class="o">.</span><span class="n">GeoSeries</span><span class="p">(</span><span class="n">poly</span><span class="p">)</span><span class="o">.</span><span class="n">values</span>

                    <span class="c1"># About countries that we artificially put on the west of the map</span>
                    <span class="k">for</span> <span class="n">newc</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;USA&#39;</span><span class="p">]:</span>
                        <span class="n">poly</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_data_geometry</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_data_geometry</span><span class="o">.</span><span class="n">id_tmp</span><span class="o">==</span><span class="n">newc</span><span class="p">]</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                        <span class="n">poly</span><span class="o">=</span><span class="n">so</span><span class="o">.</span><span class="n">unary_union</span><span class="p">(</span><span class="n">sg</span><span class="o">.</span><span class="n">MultiPolygon</span><span class="p">([</span><span class="n">sg</span><span class="o">.</span><span class="n">Polygon</span><span class="p">([(</span><span class="n">x</span><span class="o">-</span><span class="mi">360</span><span class="p">,</span><span class="n">y</span><span class="p">)</span> <span class="k">if</span> <span class="n">x</span><span class="o">&gt;=</span><span class="mi">0</span> <span class="k">else</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span><span class="p">,</span><span class="n">y</span> <span class="ow">in</span> <span class="n">p</span><span class="o">.</span><span class="n">exterior</span><span class="o">.</span><span class="n">coords</span><span class="p">])</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">poly</span><span class="p">]))</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_data_geometry</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_data_geometry</span><span class="o">.</span><span class="n">id_tmp</span><span class="o">==</span><span class="n">newc</span><span class="p">,</span><span class="s1">&#39;geometry&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">gpd</span><span class="o">.</span><span class="n">GeoSeries</span><span class="p">(</span><span class="n">poly</span><span class="p">)</span><span class="o">.</span><span class="n">values</span>

                <span class="n">p</span><span class="o">=</span><span class="n">p</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_data_geometry</span><span class="p">,</span><span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span>\
                    <span class="n">left_on</span><span class="o">=</span><span class="s1">&#39;iso3_tmp&#39;</span><span class="p">,</span><span class="n">right_on</span><span class="o">=</span><span class="s1">&#39;id_tmp&#39;</span><span class="p">,</span>\
                    <span class="n">suffixes</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;_tmp&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="s1">&#39;id_tmp&#39;</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

            <span class="c1"># -----------------------------------------------------------</span>
            <span class="k">elif</span> <span class="n">f</span> <span class="o">==</span> <span class="s1">&#39;flag&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data_flag</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_data_flag</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_json</span><span class="p">(</span><span class="n">get_local_from_url</span><span class="p">(</span><span class="s1">&#39;https://github.com/linssen/country-flag-icons/raw/master/countries.json&#39;</span><span class="p">,</span><span class="mi">0</span><span class="p">))</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_data_flag</span><span class="p">[</span><span class="s1">&#39;flag_url&#39;</span><span class="p">]</span><span class="o">=</span><span class="s1">&#39;http:&#39;</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">_data_flag</span><span class="p">[</span><span class="s1">&#39;file_url&#39;</span><span class="p">]</span>

                <span class="n">p</span><span class="o">=</span><span class="n">p</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_data_flag</span><span class="p">[[</span><span class="s1">&#39;alpha3&#39;</span><span class="p">,</span><span class="s1">&#39;flag_url&#39;</span><span class="p">]],</span><span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span>\
                    <span class="n">left_on</span><span class="o">=</span><span class="s1">&#39;iso3_tmp&#39;</span><span class="p">,</span><span class="n">right_on</span><span class="o">=</span><span class="s1">&#39;alpha3&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="s1">&#39;alpha3&#39;</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">p</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="s1">&#39;iso2_tmp&#39;</span><span class="p">,</span><span class="s1">&#39;iso3_tmp&#39;</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">errors</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">)</span></div></div>

<span class="c1"># ---------------------------------------------------------------------</span>
<span class="c1"># --- GeoRegion class -------------------------------------------------</span>
<span class="c1"># ---------------------------------------------------------------------</span>

<div class="viewcode-block" id="GeoRegion"><a class="viewcode-back" href="../../coa.geo.html#coa.geo.GeoRegion">[docs]</a><span class="k">class</span> <span class="nc">GeoRegion</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;GeoRegion class definition. Does not inheritate from any other</span>
<span class="sd">    class.</span>

<span class="sd">    It should raise only CoaError and derived exceptions in case</span>
<span class="sd">    of errors (see pycoa.error)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">_source_dict</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;UN_M49&quot;</span><span class="p">:</span><span class="s2">&quot;https://en.wikipedia.org/w/index.php?title=UN_M49&amp;oldid=986603718&quot;</span><span class="p">,</span> <span class="c1"># pointing the previous correct ref . https://en.wikipedia.org/wiki/UN_M49&quot;,\</span>
        <span class="s2">&quot;GeoScheme&quot;</span><span class="p">:</span><span class="s2">&quot;https://en.wikipedia.org/w/index.php?title=List_of_countries_by_United_Nations_geoscheme&amp;oldid=1008989486&quot;</span><span class="p">,</span> <span class="c1">#pointing the previous correct ref. https://en.wikipedia.org/wiki/List_of_countries_by_United_Nations_geoscheme&quot;,</span>
        <span class="s2">&quot;European Union&quot;</span><span class="p">:</span><span class="s2">&quot;https://europa.eu/european-union/about-eu/countries/member-countries_en&quot;</span><span class="p">,</span>
        <span class="s2">&quot;G7&quot;</span><span class="p">:</span><span class="s2">&quot;https://en.wikipedia.org/wiki/Group_of_Seven&quot;</span><span class="p">,</span>
        <span class="s2">&quot;G8&quot;</span><span class="p">:</span><span class="s2">&quot;https://en.wikipedia.org/wiki/Group_of_Eight&quot;</span><span class="p">,</span>
        <span class="s2">&quot;G20&quot;</span><span class="p">:</span><span class="s2">&quot;https://en.wikipedia.org/wiki/G20&quot;</span><span class="p">,</span>
        <span class="s2">&quot;G77&quot;</span><span class="p">:</span><span class="s2">&quot;https://www.g77.org/doc/members.html&quot;</span><span class="p">,</span>
        <span class="s2">&quot;OECD&quot;</span><span class="p">:</span><span class="s2">&quot;https://en.wikipedia.org/wiki/OECD&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Commonwealth&quot;</span><span class="p">:</span><span class="s2">&quot;https://en.wikipedia.org/wiki/Member_states_of_the_Commonwealth_of_Nations&quot;</span><span class="p">,</span>
        <span class="p">}</span>

    <span class="n">_region_dict</span><span class="o">=</span><span class="p">{}</span>
    <span class="n">_p_gs</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,):</span>
        <span class="sd">&quot;&quot;&quot; __init__ member function.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1">#if &#39;XK&#39; in self._country_list:</span>
        <span class="c1">#    del self._country_list[&#39;XK&#39;] # creates bugs in pycountry and is currently a contested country as country</span>


        <span class="c1"># --- get the UN M49 information and organize the data in the _region_dict</span>

        <span class="n">verb</span><span class="p">(</span><span class="s2">&quot;Init of GeoRegion() from &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">inspect</span><span class="o">.</span><span class="n">stack</span><span class="p">()[</span><span class="mi">1</span><span class="p">]))</span>

        <span class="n">p_m49</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">read_html</span><span class="p">(</span><span class="n">get_local_from_url</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_source_dict</span><span class="p">[</span><span class="s2">&quot;UN_M49&quot;</span><span class="p">],</span><span class="mi">0</span><span class="p">))[</span><span class="mi">1</span><span class="p">]</span>

        <span class="n">p_m49</span><span class="o">.</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;code&#39;</span><span class="p">,</span><span class="s1">&#39;region_name&#39;</span><span class="p">]</span>
        <span class="n">p_m49</span><span class="p">[</span><span class="s1">&#39;region_name&#39;</span><span class="p">]</span><span class="o">=</span><span class="p">[</span><span class="n">r</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;(&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">rstrip</span><span class="p">()</span><span class="o">.</span><span class="n">title</span><span class="p">()</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">p_m49</span><span class="o">.</span><span class="n">region_name</span><span class="p">]</span>  <span class="c1"># suppress information in parenthesis in region name</span>
        <span class="n">p_m49</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;code&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_region_dict</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">p_m49</span><span class="o">.</span><span class="n">to_dict</span><span class="p">(</span><span class="s1">&#39;split&#39;</span><span class="p">)[</span><span class="s1">&#39;data&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_region_dict</span><span class="o">.</span><span class="n">update</span><span class="p">({</span>  <span class="s2">&quot;UE&quot;</span><span class="p">:</span><span class="s2">&quot;European Union&quot;</span><span class="p">,</span>
                                    <span class="s2">&quot;G7&quot;</span><span class="p">:</span><span class="s2">&quot;G7&quot;</span><span class="p">,</span>
                                    <span class="s2">&quot;G8&quot;</span><span class="p">:</span><span class="s2">&quot;G8&quot;</span><span class="p">,</span>
                                    <span class="s2">&quot;G20&quot;</span><span class="p">:</span><span class="s2">&quot;G20&quot;</span><span class="p">,</span>
                                    <span class="s2">&quot;OECD&quot;</span><span class="p">:</span><span class="s2">&quot;Oecd&quot;</span><span class="p">,</span>
                                    <span class="s2">&quot;G77&quot;</span><span class="p">:</span><span class="s2">&quot;G77&quot;</span><span class="p">,</span>
                                    <span class="s2">&quot;CW&quot;</span><span class="p">:</span><span class="s2">&quot;Commonwealth&quot;</span>
                                    <span class="p">})</span>  <span class="c1"># add UE for other analysis</span>

        <span class="c1"># --- filling cw information</span>
        <span class="n">p_cw</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">read_html</span><span class="p">(</span><span class="n">get_local_from_url</span><span class="p">(</span><span class="s1">&#39;https://en.wikipedia.org/wiki/Member_states_of_the_Commonwealth_of_Nations&#39;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cw</span><span class="o">=</span><span class="p">[</span><span class="n">w</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;[&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">w</span> <span class="ow">in</span> <span class="n">p_cw</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;Country&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to_list</span><span class="p">()]</span>   <span class="c1"># removing wikipedia notes</span>

        <span class="c1"># --- get the UnitedNation GeoScheme and organize the data</span>
        <span class="n">p_gs</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">read_html</span><span class="p">(</span><span class="n">get_local_from_url</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_source_dict</span><span class="p">[</span><span class="s2">&quot;GeoScheme&quot;</span><span class="p">],</span><span class="mi">0</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">p_gs</span><span class="o">.</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;country&#39;</span><span class="p">,</span><span class="s1">&#39;capital&#39;</span><span class="p">,</span><span class="s1">&#39;iso2&#39;</span><span class="p">,</span><span class="s1">&#39;iso3&#39;</span><span class="p">,</span><span class="s1">&#39;num&#39;</span><span class="p">,</span><span class="s1">&#39;m49&#39;</span><span class="p">]</span>

        <span class="n">idx</span><span class="o">=</span><span class="p">[]</span>
        <span class="n">reg</span><span class="o">=</span><span class="p">[]</span>
        <span class="n">cap</span><span class="o">=</span><span class="p">[]</span>

        <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">p_gs</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">row</span><span class="o">.</span><span class="n">iso3</span> <span class="o">!=</span> <span class="s1">&#39;â&#39;</span> <span class="p">:</span> <span class="c1"># meaning a non standard iso in wikipedia UN GeoScheme</span>
                <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">row</span><span class="o">.</span><span class="n">m49</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">,</span><span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;&lt;&#39;</span><span class="p">):</span>
                    <span class="n">idx</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">iso3</span><span class="p">)</span>
                    <span class="n">reg</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">r</span><span class="p">))</span>
                    <span class="n">cap</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">capital</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_p_gs</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s1">&#39;iso3&#39;</span><span class="p">:</span><span class="n">idx</span><span class="p">,</span><span class="s1">&#39;capital&#39;</span><span class="p">:</span><span class="n">cap</span><span class="p">,</span><span class="s1">&#39;region&#39;</span><span class="p">:</span><span class="n">reg</span><span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_p_gs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_p_gs</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">p_m49</span><span class="p">,</span><span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span><span class="n">left_on</span><span class="o">=</span><span class="s1">&#39;region&#39;</span><span class="p">,</span>\
                            <span class="n">right_on</span><span class="o">=</span><span class="s1">&#39;code&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="s2">&quot;code&quot;</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<div class="viewcode-block" id="GeoRegion.get_source"><a class="viewcode-back" href="../../coa.geo.html#coa.geo.GeoRegion.get_source">[docs]</a>    <span class="k">def</span> <span class="nf">get_source</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_source_dict</span></div>

<div class="viewcode-block" id="GeoRegion.get_region_list"><a class="viewcode-back" href="../../coa.geo.html#coa.geo.GeoRegion.get_region_list">[docs]</a>    <span class="k">def</span> <span class="nf">get_region_list</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_region_dict</span><span class="o">.</span><span class="n">values</span><span class="p">())</span></div>

<div class="viewcode-block" id="GeoRegion.is_region"><a class="viewcode-back" href="../../coa.geo.html#coa.geo.GeoRegion.is_region">[docs]</a>    <span class="k">def</span> <span class="nf">is_region</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">region</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; it returns either False or the correctly named region name</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">region</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">str</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">CoaKeyError</span><span class="p">(</span><span class="s2">&quot;The given region is not a str type.&quot;</span><span class="p">)</span>

        <span class="n">region</span><span class="o">=</span><span class="n">region</span><span class="o">.</span><span class="n">title</span><span class="p">()</span>  <span class="c1"># if not properly capitalized</span>

        <span class="k">if</span> <span class="n">region</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_region_list</span><span class="p">():</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">else</span> <span class="p">:</span>
            <span class="k">return</span> <span class="n">region</span></div>

<div class="viewcode-block" id="GeoRegion.get_countries_from_region"><a class="viewcode-back" href="../../coa.geo.html#coa.geo.GeoRegion.get_countries_from_region">[docs]</a>    <span class="k">def</span> <span class="nf">get_countries_from_region</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">region</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; it returns a list of countries for the given region name.</span>
<span class="sd">        The standard used is iso3. To convert to another standard,</span>
<span class="sd">        use the GeoManager class.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">r</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_region</span><span class="p">(</span><span class="n">region</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">r</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">CoaKeyError</span><span class="p">(</span><span class="s1">&#39;The given region &quot;&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">region</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;&quot; is unknown.&#39;</span><span class="p">)</span>
        <span class="n">region</span><span class="o">=</span><span class="n">r</span>

        <span class="n">clist</span><span class="o">=</span><span class="p">[]</span>

        <span class="k">if</span> <span class="n">region</span><span class="o">==</span><span class="s1">&#39;European Union&#39;</span><span class="p">:</span>
            <span class="n">clist</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;AUT&#39;</span><span class="p">,</span><span class="s1">&#39;BEL&#39;</span><span class="p">,</span><span class="s1">&#39;BGR&#39;</span><span class="p">,</span><span class="s1">&#39;CYP&#39;</span><span class="p">,</span><span class="s1">&#39;CZE&#39;</span><span class="p">,</span><span class="s1">&#39;DEU&#39;</span><span class="p">,</span><span class="s1">&#39;DNK&#39;</span><span class="p">,</span><span class="s1">&#39;EST&#39;</span><span class="p">,</span>\
                        <span class="s1">&#39;ESP&#39;</span><span class="p">,</span><span class="s1">&#39;FIN&#39;</span><span class="p">,</span><span class="s1">&#39;FRA&#39;</span><span class="p">,</span><span class="s1">&#39;GRC&#39;</span><span class="p">,</span><span class="s1">&#39;HRV&#39;</span><span class="p">,</span><span class="s1">&#39;HUN&#39;</span><span class="p">,</span><span class="s1">&#39;IRL&#39;</span><span class="p">,</span><span class="s1">&#39;ITA&#39;</span><span class="p">,</span>\
                        <span class="s1">&#39;LTU&#39;</span><span class="p">,</span><span class="s1">&#39;LUX&#39;</span><span class="p">,</span><span class="s1">&#39;LVA&#39;</span><span class="p">,</span><span class="s1">&#39;MLT&#39;</span><span class="p">,</span><span class="s1">&#39;NLD&#39;</span><span class="p">,</span><span class="s1">&#39;POL&#39;</span><span class="p">,</span><span class="s1">&#39;PRT&#39;</span><span class="p">,</span><span class="s1">&#39;ROU&#39;</span><span class="p">,</span>\
                        <span class="s1">&#39;SWE&#39;</span><span class="p">,</span><span class="s1">&#39;SVN&#39;</span><span class="p">,</span><span class="s1">&#39;SVK&#39;</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">region</span><span class="o">==</span><span class="s1">&#39;G7&#39;</span><span class="p">:</span>
            <span class="n">clist</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;DEU&#39;</span><span class="p">,</span><span class="s1">&#39;CAN&#39;</span><span class="p">,</span><span class="s1">&#39;USA&#39;</span><span class="p">,</span><span class="s1">&#39;FRA&#39;</span><span class="p">,</span><span class="s1">&#39;ITA&#39;</span><span class="p">,</span><span class="s1">&#39;JAP&#39;</span><span class="p">,</span><span class="s1">&#39;GBR&#39;</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">region</span><span class="o">==</span><span class="s1">&#39;G8&#39;</span><span class="p">:</span>
            <span class="n">clist</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;DEU&#39;</span><span class="p">,</span><span class="s1">&#39;CAN&#39;</span><span class="p">,</span><span class="s1">&#39;USA&#39;</span><span class="p">,</span><span class="s1">&#39;FRA&#39;</span><span class="p">,</span><span class="s1">&#39;ITA&#39;</span><span class="p">,</span><span class="s1">&#39;JAP&#39;</span><span class="p">,</span><span class="s1">&#39;GBR&#39;</span><span class="p">,</span><span class="s1">&#39;RUS&#39;</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">region</span><span class="o">==</span><span class="s1">&#39;G20&#39;</span><span class="p">:</span>
            <span class="n">clist</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;ZAF&#39;</span><span class="p">,</span><span class="s1">&#39;SAU&#39;</span><span class="p">,</span><span class="s1">&#39;ARG&#39;</span><span class="p">,</span><span class="s1">&#39;AUS&#39;</span><span class="p">,</span><span class="s1">&#39;BRA&#39;</span><span class="p">,</span><span class="s1">&#39;CAN&#39;</span><span class="p">,</span><span class="s1">&#39;CHN&#39;</span><span class="p">,</span><span class="s1">&#39;KOR&#39;</span><span class="p">,</span><span class="s1">&#39;USA&#39;</span><span class="p">,</span>\
                <span class="s1">&#39;IND&#39;</span><span class="p">,</span><span class="s1">&#39;IDN&#39;</span><span class="p">,</span><span class="s1">&#39;JAP&#39;</span><span class="p">,</span><span class="s1">&#39;MEX&#39;</span><span class="p">,</span><span class="s1">&#39;GBR&#39;</span><span class="p">,</span><span class="s1">&#39;RUS&#39;</span><span class="p">,</span><span class="s1">&#39;TUR&#39;</span><span class="p">,</span>\
                <span class="s1">&#39;AUT&#39;</span><span class="p">,</span><span class="s1">&#39;BEL&#39;</span><span class="p">,</span><span class="s1">&#39;BGR&#39;</span><span class="p">,</span><span class="s1">&#39;CYP&#39;</span><span class="p">,</span><span class="s1">&#39;CZE&#39;</span><span class="p">,</span><span class="s1">&#39;DEU&#39;</span><span class="p">,</span><span class="s1">&#39;DNK&#39;</span><span class="p">,</span><span class="s1">&#39;EST&#39;</span><span class="p">,</span>\
                <span class="s1">&#39;ESP&#39;</span><span class="p">,</span><span class="s1">&#39;FIN&#39;</span><span class="p">,</span><span class="s1">&#39;FRA&#39;</span><span class="p">,</span><span class="s1">&#39;GRC&#39;</span><span class="p">,</span><span class="s1">&#39;HRV&#39;</span><span class="p">,</span><span class="s1">&#39;HUN&#39;</span><span class="p">,</span><span class="s1">&#39;IRL&#39;</span><span class="p">,</span><span class="s1">&#39;ITA&#39;</span><span class="p">,</span>\
                <span class="s1">&#39;LTU&#39;</span><span class="p">,</span><span class="s1">&#39;LUX&#39;</span><span class="p">,</span><span class="s1">&#39;LVA&#39;</span><span class="p">,</span><span class="s1">&#39;MLT&#39;</span><span class="p">,</span><span class="s1">&#39;NLD&#39;</span><span class="p">,</span><span class="s1">&#39;POL&#39;</span><span class="p">,</span><span class="s1">&#39;PRT&#39;</span><span class="p">,</span><span class="s1">&#39;ROU&#39;</span><span class="p">,</span>\
                <span class="s1">&#39;SWE&#39;</span><span class="p">,</span><span class="s1">&#39;SVN&#39;</span><span class="p">,</span><span class="s1">&#39;SVK&#39;</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">region</span><span class="o">==</span><span class="s1">&#39;Oecd&#39;</span><span class="p">:</span> <span class="c1"># OCDE in french</span>
            <span class="n">clist</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;DEU&#39;</span><span class="p">,</span><span class="s1">&#39;AUS&#39;</span><span class="p">,</span><span class="s1">&#39;AUT&#39;</span><span class="p">,</span><span class="s1">&#39;BEL&#39;</span><span class="p">,</span><span class="s1">&#39;CAN&#39;</span><span class="p">,</span><span class="s1">&#39;CHL&#39;</span><span class="p">,</span><span class="s1">&#39;COL&#39;</span><span class="p">,</span><span class="s1">&#39;KOR&#39;</span><span class="p">,</span><span class="s1">&#39;DNK&#39;</span><span class="p">,</span>\
                <span class="s1">&#39;ESP&#39;</span><span class="p">,</span><span class="s1">&#39;EST&#39;</span><span class="p">,</span><span class="s1">&#39;USA&#39;</span><span class="p">,</span><span class="s1">&#39;FIN&#39;</span><span class="p">,</span><span class="s1">&#39;FRA&#39;</span><span class="p">,</span><span class="s1">&#39;GRC&#39;</span><span class="p">,</span><span class="s1">&#39;HUN&#39;</span><span class="p">,</span><span class="s1">&#39;IRL&#39;</span><span class="p">,</span><span class="s1">&#39;ISL&#39;</span><span class="p">,</span><span class="s1">&#39;ISR&#39;</span><span class="p">,</span>\
                <span class="s1">&#39;ITA&#39;</span><span class="p">,</span><span class="s1">&#39;JAP&#39;</span><span class="p">,</span><span class="s1">&#39;LVA&#39;</span><span class="p">,</span><span class="s1">&#39;LTU&#39;</span><span class="p">,</span><span class="s1">&#39;LUX&#39;</span><span class="p">,</span><span class="s1">&#39;MEX&#39;</span><span class="p">,</span><span class="s1">&#39;NOR&#39;</span><span class="p">,</span><span class="s1">&#39;NZL&#39;</span><span class="p">,</span><span class="s1">&#39;NLD&#39;</span><span class="p">,</span><span class="s1">&#39;POL&#39;</span><span class="p">,</span>\
                <span class="s1">&#39;PRT&#39;</span><span class="p">,</span><span class="s1">&#39;SVK&#39;</span><span class="p">,</span><span class="s1">&#39;SVN&#39;</span><span class="p">,</span><span class="s1">&#39;SWE&#39;</span><span class="p">,</span><span class="s1">&#39;CHE&#39;</span><span class="p">,</span><span class="s1">&#39;GBR&#39;</span><span class="p">,</span><span class="s1">&#39;CZE&#39;</span><span class="p">,</span><span class="s1">&#39;TUR&#39;</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">region</span><span class="o">==</span><span class="s1">&#39;G77&#39;</span><span class="p">:</span>
            <span class="n">clist</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;AFG&#39;</span><span class="p">,</span><span class="s1">&#39;DZA&#39;</span><span class="p">,</span><span class="s1">&#39;AGO&#39;</span><span class="p">,</span><span class="s1">&#39;ATG&#39;</span><span class="p">,</span><span class="s1">&#39;ARG&#39;</span><span class="p">,</span><span class="s1">&#39;AZE&#39;</span><span class="p">,</span><span class="s1">&#39;BHS&#39;</span><span class="p">,</span><span class="s1">&#39;BHR&#39;</span><span class="p">,</span><span class="s1">&#39;BGD&#39;</span><span class="p">,</span><span class="s1">&#39;BRB&#39;</span><span class="p">,</span><span class="s1">&#39;BLZ&#39;</span><span class="p">,</span>
                <span class="s1">&#39;BEN&#39;</span><span class="p">,</span><span class="s1">&#39;BTN&#39;</span><span class="p">,</span><span class="s1">&#39;BOL&#39;</span><span class="p">,</span><span class="s1">&#39;BWA&#39;</span><span class="p">,</span><span class="s1">&#39;BRA&#39;</span><span class="p">,</span><span class="s1">&#39;BRN&#39;</span><span class="p">,</span><span class="s1">&#39;BFA&#39;</span><span class="p">,</span><span class="s1">&#39;BDI&#39;</span><span class="p">,</span><span class="s1">&#39;CPV&#39;</span><span class="p">,</span><span class="s1">&#39;KHM&#39;</span><span class="p">,</span><span class="s1">&#39;CMR&#39;</span><span class="p">,</span>
                <span class="s1">&#39;CAF&#39;</span><span class="p">,</span><span class="s1">&#39;TCD&#39;</span><span class="p">,</span><span class="s1">&#39;CHL&#39;</span><span class="p">,</span><span class="s1">&#39;CHN&#39;</span><span class="p">,</span><span class="s1">&#39;COL&#39;</span><span class="p">,</span><span class="s1">&#39;COM&#39;</span><span class="p">,</span><span class="s1">&#39;COG&#39;</span><span class="p">,</span><span class="s1">&#39;CRI&#39;</span><span class="p">,</span><span class="s1">&#39;CIV&#39;</span><span class="p">,</span><span class="s1">&#39;CUB&#39;</span><span class="p">,</span><span class="s1">&#39;PRK&#39;</span><span class="p">,</span>
                <span class="s1">&#39;COD&#39;</span><span class="p">,</span><span class="s1">&#39;DJI&#39;</span><span class="p">,</span><span class="s1">&#39;DMA&#39;</span><span class="p">,</span><span class="s1">&#39;DOM&#39;</span><span class="p">,</span><span class="s1">&#39;ECU&#39;</span><span class="p">,</span><span class="s1">&#39;EGY&#39;</span><span class="p">,</span><span class="s1">&#39;SLV&#39;</span><span class="p">,</span><span class="s1">&#39;GNQ&#39;</span><span class="p">,</span><span class="s1">&#39;ERI&#39;</span><span class="p">,</span><span class="s1">&#39;SWZ&#39;</span><span class="p">,</span><span class="s1">&#39;ETH&#39;</span><span class="p">,</span>
                <span class="s1">&#39;FJI&#39;</span><span class="p">,</span><span class="s1">&#39;GAB&#39;</span><span class="p">,</span><span class="s1">&#39;GMB&#39;</span><span class="p">,</span><span class="s1">&#39;GHA&#39;</span><span class="p">,</span><span class="s1">&#39;GRD&#39;</span><span class="p">,</span><span class="s1">&#39;GTM&#39;</span><span class="p">,</span><span class="s1">&#39;GIN&#39;</span><span class="p">,</span><span class="s1">&#39;GNB&#39;</span><span class="p">,</span><span class="s1">&#39;GUY&#39;</span><span class="p">,</span><span class="s1">&#39;HTI&#39;</span><span class="p">,</span><span class="s1">&#39;HND&#39;</span><span class="p">,</span>
                <span class="s1">&#39;IND&#39;</span><span class="p">,</span><span class="s1">&#39;IDN&#39;</span><span class="p">,</span><span class="s1">&#39;IRN&#39;</span><span class="p">,</span><span class="s1">&#39;IRQ&#39;</span><span class="p">,</span><span class="s1">&#39;JAM&#39;</span><span class="p">,</span><span class="s1">&#39;JOR&#39;</span><span class="p">,</span><span class="s1">&#39;KEN&#39;</span><span class="p">,</span><span class="s1">&#39;KIR&#39;</span><span class="p">,</span><span class="s1">&#39;KWT&#39;</span><span class="p">,</span><span class="s1">&#39;LAO&#39;</span><span class="p">,</span><span class="s1">&#39;LBN&#39;</span><span class="p">,</span>
                <span class="s1">&#39;LSO&#39;</span><span class="p">,</span><span class="s1">&#39;LBR&#39;</span><span class="p">,</span><span class="s1">&#39;LBY&#39;</span><span class="p">,</span><span class="s1">&#39;MDG&#39;</span><span class="p">,</span><span class="s1">&#39;MWI&#39;</span><span class="p">,</span><span class="s1">&#39;MYS&#39;</span><span class="p">,</span><span class="s1">&#39;MDV&#39;</span><span class="p">,</span><span class="s1">&#39;MLI&#39;</span><span class="p">,</span><span class="s1">&#39;MHL&#39;</span><span class="p">,</span><span class="s1">&#39;MRT&#39;</span><span class="p">,</span><span class="s1">&#39;MUS&#39;</span><span class="p">,</span>
                <span class="s1">&#39;FSM&#39;</span><span class="p">,</span><span class="s1">&#39;MNG&#39;</span><span class="p">,</span><span class="s1">&#39;MAR&#39;</span><span class="p">,</span><span class="s1">&#39;MOZ&#39;</span><span class="p">,</span><span class="s1">&#39;MMR&#39;</span><span class="p">,</span><span class="s1">&#39;NAM&#39;</span><span class="p">,</span><span class="s1">&#39;NRU&#39;</span><span class="p">,</span><span class="s1">&#39;NPL&#39;</span><span class="p">,</span><span class="s1">&#39;NIC&#39;</span><span class="p">,</span><span class="s1">&#39;NER&#39;</span><span class="p">,</span><span class="s1">&#39;NGA&#39;</span><span class="p">,</span>
                <span class="s1">&#39;OMN&#39;</span><span class="p">,</span><span class="s1">&#39;PAK&#39;</span><span class="p">,</span><span class="s1">&#39;PAN&#39;</span><span class="p">,</span><span class="s1">&#39;PNG&#39;</span><span class="p">,</span><span class="s1">&#39;PRY&#39;</span><span class="p">,</span><span class="s1">&#39;PER&#39;</span><span class="p">,</span><span class="s1">&#39;PHL&#39;</span><span class="p">,</span><span class="s1">&#39;QAT&#39;</span><span class="p">,</span><span class="s1">&#39;RWA&#39;</span><span class="p">,</span><span class="s1">&#39;KNA&#39;</span><span class="p">,</span><span class="s1">&#39;LCA&#39;</span><span class="p">,</span>
                <span class="s1">&#39;VCT&#39;</span><span class="p">,</span><span class="s1">&#39;WSM&#39;</span><span class="p">,</span><span class="s1">&#39;STP&#39;</span><span class="p">,</span><span class="s1">&#39;SAU&#39;</span><span class="p">,</span><span class="s1">&#39;SEN&#39;</span><span class="p">,</span><span class="s1">&#39;SYC&#39;</span><span class="p">,</span><span class="s1">&#39;SLE&#39;</span><span class="p">,</span><span class="s1">&#39;SGP&#39;</span><span class="p">,</span><span class="s1">&#39;SLB&#39;</span><span class="p">,</span><span class="s1">&#39;SOM&#39;</span><span class="p">,</span><span class="s1">&#39;ZAF&#39;</span><span class="p">,</span>
                <span class="s1">&#39;SSD&#39;</span><span class="p">,</span><span class="s1">&#39;LKA&#39;</span><span class="p">,</span><span class="s1">&#39;PSE&#39;</span><span class="p">,</span><span class="s1">&#39;SDN&#39;</span><span class="p">,</span><span class="s1">&#39;SUR&#39;</span><span class="p">,</span><span class="s1">&#39;SYR&#39;</span><span class="p">,</span><span class="s1">&#39;TJK&#39;</span><span class="p">,</span><span class="s1">&#39;THA&#39;</span><span class="p">,</span><span class="s1">&#39;TLS&#39;</span><span class="p">,</span><span class="s1">&#39;TGO&#39;</span><span class="p">,</span><span class="s1">&#39;TON&#39;</span><span class="p">,</span>
                <span class="s1">&#39;TTO&#39;</span><span class="p">,</span><span class="s1">&#39;TUN&#39;</span><span class="p">,</span><span class="s1">&#39;TKM&#39;</span><span class="p">,</span><span class="s1">&#39;UGA&#39;</span><span class="p">,</span><span class="s1">&#39;ARE&#39;</span><span class="p">,</span><span class="s1">&#39;TZA&#39;</span><span class="p">,</span><span class="s1">&#39;URY&#39;</span><span class="p">,</span><span class="s1">&#39;VUT&#39;</span><span class="p">,</span><span class="s1">&#39;VEN&#39;</span><span class="p">,</span><span class="s1">&#39;VNM&#39;</span><span class="p">,</span><span class="s1">&#39;YEM&#39;</span><span class="p">,</span>
                <span class="s1">&#39;ZMB&#39;</span><span class="p">,</span><span class="s1">&#39;ZWE&#39;</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">region</span><span class="o">==</span><span class="s1">&#39;Commonwealth&#39;</span><span class="p">:</span>
            <span class="n">clist</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_cw</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">clist</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_p_gs</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_p_gs</span><span class="p">[</span><span class="s1">&#39;region_name&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">region</span><span class="p">][</span><span class="s1">&#39;iso3&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to_list</span><span class="p">()</span>

        <span class="k">return</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">clist</span><span class="p">)</span></div>

<div class="viewcode-block" id="GeoRegion.get_pandas"><a class="viewcode-back" href="../../coa.geo.html#coa.geo.GeoRegion.get_pandas">[docs]</a>    <span class="k">def</span> <span class="nf">get_pandas</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_p_gs</span></div></div>


<span class="c1"># ---------------------------------------------------------------------</span>
<span class="c1"># --- GeoCountryclass -------------------------------------------------</span>
<span class="c1"># ---------------------------------------------------------------------</span>

<div class="viewcode-block" id="GeoCountry"><a class="viewcode-back" href="../../coa.geo.html#coa.geo.GeoCountry">[docs]</a><span class="k">class</span> <span class="nc">GeoCountry</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;GeoCountry class definition.</span>
<span class="sd">    This class provides functions for specific countries and their states / departments / regions,</span>
<span class="sd">    and their geo properties (geometry, population if available, etc.)</span>

<span class="sd">    The list of supported countries is given by get_list_countries() function. &quot;&quot;&quot;</span>

    <span class="c1"># Assuming zip file here</span>
    <span class="n">_country_info_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;FRA&#39;</span><span class="p">:</span><span class="s1">&#39;https://data.opendatasoft.com/explore/dataset/georef-france-departement@public/download/?format=geojson&amp;timezone=Europe/Berlin&amp;lang=fr&#39;</span><span class="p">,</span>\
                    <span class="c1">#previously https://github.com/coa-project/coadata/raw/main/coastore/public.opendatasoft.com_912711563.zip&#39;,\</span>
                    <span class="s1">&#39;USA&#39;</span><span class="p">:</span><span class="s1">&#39;https://alicia.data.socrata.com/api/geospatial/jhnu-yfrj?method=export&amp;format=Original&#39;</span><span class="p">,</span>\
                    <span class="s1">&#39;ITA&#39;</span><span class="p">:</span><span class="s1">&#39;https://raw.githubusercontent.com/openpolis/geojson-italy/master/geojson/limits_IT_provinces.geojson&#39;</span><span class="p">,</span>\
                    <span class="s1">&#39;IND&#39;</span><span class="p">:</span><span class="s1">&#39;https://raw.githubusercontent.com/deldersveld/topojson/master/countries/india/india-states.json&#39;</span><span class="p">,</span>\
                    <span class="s1">&#39;DEU&#39;</span><span class="p">:</span><span class="s1">&#39;https://github.com/jgehrcke/covid-19-germany-gae/raw/master/geodata/DE-counties.geojson&#39;</span><span class="p">,</span>\
                    <span class="s1">&#39;ESP&#39;</span><span class="p">:</span><span class="s1">&#39;https://public.opendatasoft.com/explore/dataset/provincias-espanolas/download/?format=shp&amp;timezone=Europe/Berlin&amp;lang=en&#39;</span><span class="p">,</span>\
                    <span class="c1"># missing some counties &#39;GBR&#39;:&#39;https://opendata.arcgis.com/datasets/69dc11c7386943b4ad8893c45648b1e1_0.zip?geometry=%7B%22xmin%22%3A-44.36%2C%22ymin%22%3A51.099%2C%22xmax%22%3A39.487%2C%22ymax%22%3A59.78%2C%22type%22%3A%22extent%22%2C%22spatialReference%22%3A%7B%22wkid%22%3A4326%7D%7D&amp;outSR=%7B%22latestWkid%22%3A27700%2C%22wkid%22%3A27700%7D&#39;,\</span>
                    <span class="s1">&#39;GBR&#39;</span><span class="p">:</span><span class="s1">&#39;https://github.com/coa-project/coadata/raw/main/coastore/opendata.arcgis.com_3256063640&#39;</span><span class="p">,</span>\
                    <span class="c1"># previously (but broken) : https://opendata.arcgis.com/datasets/3a4fa2ce68f642e399b4de07643eeed3_0.geojson&#39;,\</span>
                    <span class="s1">&#39;BEL&#39;</span><span class="p">:</span><span class="s1">&#39;https://public.opendatasoft.com/explore/dataset/arrondissements-belges-2019/download/?format=shp&amp;timezone=Europe/Berlin&amp;lang=en&#39;</span><span class="p">,</span>\
                    <span class="s1">&#39;PRT&#39;</span><span class="p">:</span><span class="s1">&#39;https://github.com/coa-project/coadata/raw/main/coastore/concelhos.zip&#39;</span><span class="p">,</span>\
                    <span class="c1"># (simplification of &#39;https://github.com/coa-project/coadata/raw/main&#39;https://dados.gov.pt/en/datasets/r/59368d37-cbdb-426a-9472-5a04cf30fbe4&#39;,\</span>
                    <span class="s1">&#39;MYS&#39;</span><span class="p">:</span><span class="s1">&#39;https://stacks.stanford.edu/file/druid:zd362bc5680/data.zip&#39;</span><span class="p">,</span>\
                    <span class="s1">&#39;CHL&#39;</span><span class="p">:</span><span class="s1">&#39;http://geonode.meteochile.gob.cl/geoserver/wfs?format_options=charset%3AUTF-8&amp;typename=geonode%3Adivision_comunal_geo_ide_1&amp;outputFormat=SHAPE-ZIP&amp;version=1.0.0&amp;service=WFS&amp;request=GetFeature&#39;</span><span class="p">,</span>\
                    <span class="p">}</span>

    <span class="n">_source_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;FRA&#39;</span><span class="p">:{</span><span class="s1">&#39;Basics&#39;</span><span class="p">:</span><span class="n">_country_info_dict</span><span class="p">[</span><span class="s1">&#39;FRA&#39;</span><span class="p">],</span>\
                    <span class="s1">&#39;Subregion Flags&#39;</span><span class="p">:</span><span class="s1">&#39;http://sticker-departement.com/&#39;</span><span class="p">,</span>\
                    <span class="s1">&#39;Region Flags&#39;</span><span class="p">:</span><span class="s1">&#39;https://fr.wikipedia.org/w/index.php?title=R%C3%A9gion_fran%C3%A7aise&amp;oldid=177269957&#39;</span><span class="p">,</span>\
                    <span class="s1">&#39;Population&#39;</span><span class="p">:</span><span class="s1">&#39;https://www.insee.fr/fr/statistiques/4989753?sommaire=4989761&#39;</span><span class="p">},</span>\
                    <span class="s1">&#39;USA&#39;</span><span class="p">:{</span><span class="s1">&#39;Basics&#39;</span><span class="p">:</span><span class="n">_country_info_dict</span><span class="p">[</span><span class="s1">&#39;USA&#39;</span><span class="p">],</span>\
                    <span class="s1">&#39;Subregion informations&#39;</span><span class="p">:</span><span class="s1">&#39;https://en.wikipedia.org/wiki/List_of_states_and_territories_of_the_United_States&#39;</span><span class="p">},</span>\
                    <span class="s1">&#39;ITA&#39;</span><span class="p">:{</span><span class="s1">&#39;Basics&#39;</span><span class="p">:</span><span class="n">_country_info_dict</span><span class="p">[</span><span class="s1">&#39;ITA&#39;</span><span class="p">]},</span>\
                    <span class="s1">&#39;IND&#39;</span><span class="p">:{</span><span class="s1">&#39;Basics&#39;</span><span class="p">:</span><span class="n">_country_info_dict</span><span class="p">[</span><span class="s1">&#39;IND&#39;</span><span class="p">]},</span>\
                    <span class="s1">&#39;DEU&#39;</span><span class="p">:{</span><span class="s1">&#39;Basics&#39;</span><span class="p">:</span><span class="n">_country_info_dict</span><span class="p">[</span><span class="s1">&#39;DEU&#39;</span><span class="p">]},</span>\
                    <span class="s1">&#39;ESP&#39;</span><span class="p">:{</span><span class="s1">&#39;Basics&#39;</span><span class="p">:</span><span class="n">_country_info_dict</span><span class="p">[</span><span class="s1">&#39;ESP&#39;</span><span class="p">]},</span>\
                    <span class="s1">&#39;GBR&#39;</span><span class="p">:{</span><span class="s1">&#39;Basics&#39;</span><span class="p">:</span><span class="n">_country_info_dict</span><span class="p">[</span><span class="s1">&#39;GBR&#39;</span><span class="p">],</span><span class="s1">&#39;Regions&#39;</span><span class="p">:</span><span class="s1">&#39;http://geoportal1-ons.opendata.arcgis.com/datasets/0c3a9643cc7c4015bb80751aad1d2594_0.csv&#39;</span><span class="p">},</span>\
                    <span class="s1">&#39;BEL&#39;</span><span class="p">:{</span><span class="s1">&#39;Basics&#39;</span><span class="p">:</span><span class="n">_country_info_dict</span><span class="p">[</span><span class="s1">&#39;BEL&#39;</span><span class="p">]},</span>\
                    <span class="s1">&#39;PRT&#39;</span><span class="p">:{</span><span class="s1">&#39;Basics&#39;</span><span class="p">:</span><span class="n">_country_info_dict</span><span class="p">[</span><span class="s1">&#39;PRT&#39;</span><span class="p">]},</span>\
                    <span class="c1">#,&#39;District&#39;:&#39;https://raw.githubusercontent.com/JoaoFOliveira/portuguese-municipalities/master/municipalities.json&#39;},\</span>
                    <span class="s1">&#39;MYS&#39;</span><span class="p">:{</span><span class="s1">&#39;Basics&#39;</span><span class="p">:</span><span class="n">_country_info_dict</span><span class="p">[</span><span class="s1">&#39;MYS&#39;</span><span class="p">]},</span>\
                    <span class="s1">&#39;CHL&#39;</span><span class="p">:{</span><span class="s1">&#39;Basics&#39;</span><span class="p">:</span><span class="n">_country_info_dict</span><span class="p">[</span><span class="s1">&#39;CHL&#39;</span><span class="p">]},</span>\
                    <span class="p">}</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">country</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot; __init__ member function.</span>
<span class="sd">        Must give as arg the country to deal with, as a valid ISO3 string.</span>

<span class="sd">        Various args :</span>
<span class="sd">         - dense_geometry (boolean). If True , the geometry of subregions and</span>
<span class="sd">           region is changed in order to have dense overall geometry.</span>
<span class="sd">           Default False.</span>
<span class="sd">         - main_area (boolean). If True, only the geometry of the main area of</span>
<span class="sd">           the country is taken into account.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_country</span><span class="o">=</span><span class="n">country</span>
        <span class="k">if</span> <span class="n">country</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">country</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_list_countries</span><span class="p">():</span>
            <span class="k">raise</span> <span class="n">CoaKeyError</span><span class="p">(</span><span class="s2">&quot;Country &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">country</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot; not supported. Please see get_list_countries() and help. &quot;</span><span class="p">)</span>

        <span class="n">kwargs_test</span><span class="p">(</span><span class="n">kwargs</span><span class="p">,[</span><span class="s1">&#39;dense_geometry&#39;</span><span class="p">,</span><span class="s1">&#39;main_area&#39;</span><span class="p">],</span><span class="s1">&#39;Vad args used in this init of GeoCountry object. See help.&#39;</span><span class="p">)</span>

        <span class="n">dense_geometry</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;dense_geometry&quot;</span><span class="p">,</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">main_area</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;main_area&quot;</span><span class="p">,</span><span class="kc">False</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dense_geometry</span><span class="p">,</span><span class="nb">bool</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">main_area</span><span class="p">,</span><span class="nb">bool</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">CoaKeyError</span><span class="p">(</span><span class="s2">&quot;GeoCountry kwargs are boolean. See help.&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_country_data_region</span><span class="o">=</span><span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_country_data_subregion</span><span class="o">=</span><span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_municipality_region</span><span class="o">=</span><span class="kc">None</span>
        <span class="n">url</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_country_info_dict</span><span class="p">[</span><span class="n">country</span><span class="p">]</span>
        <span class="c1"># country by country, adapt the read file informations</span>

        <span class="c1"># --- &#39;FRA&#39; case ---------------------------------------------------------------------------------------</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_country</span><span class="o">==</span><span class="s1">&#39;FRA&#39;</span><span class="p">:</span>
            <span class="c1">#self._country_data = gpd.read_file(&#39;zip://&#39;+get_local_from_url(url,0,&#39;.zip&#39;))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_country_data</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">read_file</span><span class="p">(</span><span class="n">get_local_from_url</span><span class="p">(</span><span class="n">url</span><span class="p">,</span><span class="mi">0</span><span class="p">))</span>

            <span class="c1"># adding a flag for subregion (departements)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_country_data</span><span class="p">[</span><span class="s1">&#39;flag_subregion&#39;</span><span class="p">]</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_source_dict</span><span class="p">[</span><span class="s1">&#39;FRA&#39;</span><span class="p">][</span><span class="s1">&#39;Subregion Flags&#39;</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;img/dept/sticker_plaque_immat_&#39;</span><span class="o">+</span>\
                <span class="bp">self</span><span class="o">.</span><span class="n">_country_data</span><span class="p">[</span><span class="s1">&#39;dep_code&#39;</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span>\
                <span class="p">[</span><span class="n">n</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_country_data</span><span class="p">[</span><span class="s1">&#39;dep_name&#39;</span><span class="p">]]</span><span class="o">+</span><span class="s1">&#39;_moto.png&#39;</span> <span class="c1"># picture of a sticker for motobikes, not so bad...</span>

            <span class="c1"># Reading information to get region flags and correct names of regions</span>
            <span class="n">f_reg_flag</span><span class="o">=</span><span class="nb">open</span><span class="p">(</span><span class="n">get_local_from_url</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_source_dict</span><span class="p">[</span><span class="s1">&#39;FRA&#39;</span><span class="p">][</span><span class="s1">&#39;Region Flags&#39;</span><span class="p">],</span><span class="mi">0</span><span class="p">),</span> <span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf8&quot;</span><span class="p">)</span>

            <span class="n">content_reg_flag</span> <span class="o">=</span> <span class="n">f_reg_flag</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
            <span class="n">f_reg_flag</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="n">soup_reg_flag</span> <span class="o">=</span> <span class="n">bs4</span><span class="o">.</span><span class="n">BeautifulSoup</span><span class="p">(</span><span class="n">content_reg_flag</span><span class="p">,</span><span class="s1">&#39;lxml&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">img</span> <span class="ow">in</span> <span class="n">soup_reg_flag</span><span class="o">.</span><span class="n">find_all</span><span class="p">(</span><span class="s1">&#39;img&#39;</span><span class="p">):</span>  <span class="c1"># need to convert &lt;img tags to src content for pandas_read</span>
                <span class="n">src</span><span class="o">=</span><span class="n">img</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;src&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">src</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;/&#39;</span><span class="p">:</span>
                    <span class="n">src</span><span class="o">=</span><span class="s1">&#39;http:&#39;</span><span class="o">+</span><span class="n">src</span>
                <span class="n">img</span><span class="o">.</span><span class="n">replace_with</span><span class="p">(</span><span class="n">src</span><span class="p">)</span>

            <span class="n">tabs_reg_flag</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">read_html</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">soup_reg_flag</span><span class="p">))</span> <span class="c1"># pandas read the modified html</span>
            <span class="n">metropole</span><span class="o">=</span><span class="n">tabs_reg_flag</span><span class="p">[</span><span class="mi">5</span><span class="p">][[</span><span class="s2">&quot;Logo&quot;</span><span class="p">,</span><span class="s2">&quot;DÃ©nomination&quot;</span><span class="p">,</span><span class="s2">&quot;Code INSEE[5]&quot;</span><span class="p">]]</span>  <span class="c1"># getting 5th table, and only usefull columns</span>
            <span class="n">ultramarin</span><span class="o">=</span><span class="n">tabs_reg_flag</span><span class="p">[</span><span class="mi">6</span><span class="p">][[</span><span class="s2">&quot;Logo&quot;</span><span class="p">,</span><span class="s2">&quot;DÃ©nomination&quot;</span><span class="p">,</span><span class="s2">&quot;Code INSEE[5]&quot;</span><span class="p">]]</span> <span class="c1"># getting 6th table</span>
            <span class="n">p_reg_flag</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">metropole</span><span class="p">,</span><span class="n">ultramarin</span><span class="p">])</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;Code INSEE[5]&quot;</span><span class="p">:</span><span class="s2">&quot;code_region&quot;</span><span class="p">,</span>\
                                                                        <span class="s2">&quot;Logo&quot;</span><span class="p">:</span><span class="s2">&quot;flag_region&quot;</span><span class="p">,</span>\
                                                                        <span class="s2">&quot;DÃ©nomination&quot;</span><span class="p">:</span><span class="s2">&quot;name_region&quot;</span><span class="p">})</span>

            <span class="n">p_reg_flag</span><span class="o">=</span><span class="n">p_reg_flag</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">notnull</span><span class="p">(</span><span class="n">p_reg_flag</span><span class="p">[</span><span class="s2">&quot;code_region&quot;</span><span class="p">])]</span>  <span class="c1"># select only valid rows</span>
            <span class="n">p_reg_flag</span><span class="p">[</span><span class="s2">&quot;name_region&quot;</span><span class="p">]</span><span class="o">=</span><span class="p">[</span> <span class="n">n</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;[&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">p_reg_flag</span><span class="p">[</span><span class="s2">&quot;name_region&quot;</span><span class="p">]</span> <span class="p">]</span> <span class="c1"># remove footnote [k] index from wikipedia</span>
            <span class="n">p_reg_flag</span><span class="p">[</span><span class="s2">&quot;code_region&quot;</span><span class="p">]</span><span class="o">=</span><span class="p">[</span> <span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">c</span><span class="p">))</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">p_reg_flag</span><span class="p">[</span><span class="s2">&quot;code_region&quot;</span><span class="p">]</span> <span class="p">]</span> <span class="c1"># convert to str for merge the code, adding 1 leading 0 if needed</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_country_data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_country_data</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">p_reg_flag</span><span class="p">,</span><span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span>\
                    <span class="n">left_on</span><span class="o">=</span><span class="s1">&#39;reg_code&#39;</span><span class="p">,</span><span class="n">right_on</span><span class="o">=</span><span class="s1">&#39;code_region&#39;</span><span class="p">)</span> <span class="c1"># merging with flag and correct names</span>
            <span class="c1"># standardize name for region, subregion</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_country_data</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span>\
                <span class="s1">&#39;dep_code&#39;</span><span class="p">:</span><span class="s1">&#39;code_subregion&#39;</span><span class="p">,</span>\
                <span class="s1">&#39;dep_name&#39;</span><span class="p">:</span><span class="s1">&#39;name_subregion&#39;</span><span class="p">,</span>\
                <span class="c1">#&#39;nom_chf&#39;:&#39;town_subregion&#39;,\</span>
                <span class="p">},</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="c1"># adding population information (departements)</span>
            <span class="n">pop_fra</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_html</span><span class="p">(</span><span class="n">get_local_from_url</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_source_dict</span><span class="p">[</span><span class="s1">&#39;FRA&#39;</span><span class="p">][</span><span class="s1">&#39;Population&#39;</span><span class="p">]))[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">pop_fra</span><span class="p">[</span><span class="s1">&#39;population_subregion&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">pop_fra</span><span class="p">[</span><span class="s1">&#39;Population municipale&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;[ \xa0]&quot;</span><span class="p">,</span><span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
            <span class="c1"># En l&#39;absence de Mayotte dans ce document, car le recensement n&#39;a pas eu lieu en phase, ajout Ã  la main</span>
            <span class="c1"># En rÃ©fÃ©rence Ã  la page pour Mayotte : https://www.insee.fr/fr/statistiques/3291775?sommaire=2120838</span>
            <span class="n">mayotte_df</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">([{</span><span class="s1">&#39;Code dÃ©partement&#39;</span><span class="p">:</span><span class="s1">&#39;976&#39;</span><span class="p">,</span><span class="s1">&#39;population_subregion&#39;</span><span class="p">:</span><span class="mi">256518</span><span class="p">}])</span>
            <span class="n">pop_fra</span><span class="o">=</span><span class="n">pop_fra</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mayotte_df</span><span class="p">)</span>
            <span class="c1"># Pour les collectivitÃ©s d&#39;Outremer : https://www.insee.fr/fr/statistiques/4989739?sommaire=4989761</span>
            <span class="n">com_df</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">([{</span><span class="s1">&#39;Code dÃ©partement&#39;</span><span class="p">:</span><span class="s1">&#39;980&#39;</span><span class="p">,</span><span class="s1">&#39;population_subregion&#39;</span><span class="p">:(</span><span class="mi">5985</span><span class="o">+</span><span class="mi">10124</span><span class="o">+</span><span class="mi">34065</span><span class="o">+</span><span class="mi">281674</span><span class="o">+</span><span class="mi">12067</span><span class="p">)}])</span>
            <span class="n">pop_fra</span><span class="o">=</span><span class="n">pop_fra</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">com_df</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
            <span class="n">geo_com</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_country_data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_country_data</span><span class="o">.</span><span class="n">code_subregion</span><span class="o">.</span><span class="n">isin</span><span class="p">([</span><span class="s1">&#39;975&#39;</span><span class="p">,</span><span class="s1">&#39;977&#39;</span><span class="p">,</span><span class="s1">&#39;978&#39;</span><span class="p">,</span><span class="s1">&#39;986&#39;</span><span class="p">,</span><span class="s1">&#39;987&#39;</span><span class="p">])][[</span><span class="s1">&#39;geometry&#39;</span><span class="p">]]</span>
            <span class="n">geo_com</span><span class="p">[</span><span class="s1">&#39;smthing&#39;</span><span class="p">]</span><span class="o">=</span><span class="mi">0</span>
            <span class="n">geo_com</span><span class="o">=</span><span class="n">geo_com</span><span class="o">.</span><span class="n">dissolve</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="s1">&#39;smthing&#39;</span><span class="p">)[</span><span class="s1">&#39;geometry&#39;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_country_data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_country_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">([{</span><span class="s1">&#39;code_subregion&#39;</span><span class="p">:</span><span class="s1">&#39;980&#39;</span><span class="p">,</span><span class="s1">&#39;name_subregion&#39;</span><span class="p">:</span><span class="s1">&#39;CollectivitÃ©s d</span><span class="se">\&#39;</span><span class="s1">outre-mer&#39;</span><span class="p">,</span><span class="s1">&#39;code_region&#39;</span><span class="p">:</span><span class="s1">&#39;09&#39;</span><span class="p">,</span><span class="s1">&#39;name_region&#39;</span><span class="p">:</span><span class="s1">&#39;CollectivitÃ©s d</span><span class="se">\&#39;</span><span class="s1">outre-mer&#39;</span><span class="p">,</span><span class="s1">&#39;geometry&#39;</span><span class="p">:</span><span class="n">geo_com</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]}]))</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
            <span class="c1"># Merging</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_country_data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_country_data</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">pop_fra</span><span class="p">,</span><span class="n">left_on</span><span class="o">=</span><span class="s1">&#39;code_subregion&#39;</span><span class="p">,</span><span class="n">right_on</span><span class="o">=</span><span class="s1">&#39;Code dÃ©partement&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_country_data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_country_data</span><span class="p">[[</span><span class="s1">&#39;geometry&#39;</span><span class="p">,</span><span class="s1">&#39;code_subregion&#39;</span><span class="p">,</span><span class="s1">&#39;name_subregion&#39;</span><span class="p">,</span><span class="s1">&#39;flag_subregion&#39;</span><span class="p">,</span><span class="s1">&#39;code_region&#39;</span><span class="p">,</span><span class="s1">&#39;name_region&#39;</span><span class="p">,</span><span class="s1">&#39;population_subregion&#39;</span><span class="p">]]</span>
            <span class="c1">#.drop([&#39;id_geofla&#39;,&#39;code_reg&#39;,&#39;nom_reg&#39;,&#39;x_chf_lieu&#39;,&#39;y_chf_lieu&#39;,&#39;x_centroid&#39;,&#39;y_centroid&#39;,&#39;Code dÃ©partement&#39;,&#39;Nom du dÃ©partement&#39;,&#39;Population municipale&#39;],axis=1,inplace=True) # removing some column without interest</span>
            <span class="c1"># moving artificially (if needed) outre-mer area to be near to metropole for map representations</span>
            <span class="n">list_translation</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;Guadeloupe&quot;</span><span class="p">:(</span><span class="mi">63</span><span class="p">,</span><span class="mi">23</span><span class="p">),</span>
                                 <span class="s2">&quot;Martinique&quot;</span><span class="p">:(</span><span class="mi">63</span><span class="p">,</span><span class="mi">23</span><span class="p">),</span>
                                 <span class="s2">&quot;Guyane&quot;</span><span class="p">:(</span><span class="mi">50</span><span class="p">,</span><span class="mi">35</span><span class="p">),</span>
                                 <span class="s2">&quot;RÃ©union&quot;</span><span class="p">:(</span><span class="o">-</span><span class="mi">51</span><span class="p">,</span><span class="mi">60</span><span class="p">),</span>
                                 <span class="s2">&quot;Mayotte&quot;</span><span class="p">:(</span><span class="o">-</span><span class="mi">38</span><span class="p">,</span><span class="mf">51.5</span><span class="p">)}</span>

            <span class="k">if</span> <span class="n">dense_geometry</span> <span class="o">==</span> <span class="kc">True</span> <span class="p">:</span>
                <span class="c1"># Moving DROM-COM near hexagon</span>
                <span class="n">tmp</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">poi</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_country_data</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
                    <span class="n">x</span><span class="o">=</span><span class="mi">0</span>
                    <span class="n">y</span><span class="o">=</span><span class="mi">0</span>
                    <span class="n">w</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_country_data</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">index</span><span class="p">,</span><span class="s2">&quot;name_subregion&quot;</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">w</span> <span class="ow">in</span> <span class="n">list_translation</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                        <span class="n">x</span><span class="o">=</span><span class="n">list_translation</span><span class="p">[</span><span class="n">w</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                        <span class="n">y</span><span class="o">=</span><span class="n">list_translation</span><span class="p">[</span><span class="n">w</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
                    <span class="n">g</span> <span class="o">=</span> <span class="n">sa</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_country_data</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">index</span><span class="p">,</span> <span class="s1">&#39;geometry&#39;</span><span class="p">],</span> <span class="n">xoff</span><span class="o">=</span><span class="n">x</span><span class="p">,</span> <span class="n">yoff</span><span class="o">=</span><span class="n">y</span><span class="p">)</span>
                    <span class="n">tmp</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">g</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_country_data</span><span class="p">[</span><span class="s1">&#39;geometry&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">tmp</span>

                <span class="c1"># Add Ile de France zoom</span>
                <span class="n">idf_translation</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mf">6.5</span><span class="p">,</span><span class="o">-</span><span class="mi">5</span><span class="p">)</span>
                <span class="n">idf_scale</span><span class="o">=</span><span class="mi">5</span>
                <span class="n">idf_center</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mi">4</span><span class="p">,</span><span class="mi">44</span><span class="p">)</span>
                <span class="n">tmp</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">poi</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_country_data</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
                    <span class="n">g</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_country_data</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">index</span><span class="p">,</span> <span class="s1">&#39;geometry&#39;</span><span class="p">]</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_country_data</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">index</span><span class="p">,</span><span class="s1">&#39;code_subregion&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;75&#39;</span><span class="p">,</span><span class="s1">&#39;92&#39;</span><span class="p">,</span><span class="s1">&#39;93&#39;</span><span class="p">,</span><span class="s1">&#39;94&#39;</span><span class="p">]:</span>
                        <span class="n">g2</span><span class="o">=</span><span class="n">sa</span><span class="o">.</span><span class="n">scale</span><span class="p">(</span><span class="n">sa</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="n">g</span><span class="p">,</span><span class="n">xoff</span><span class="o">=</span><span class="n">idf_translation</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">yoff</span><span class="o">=</span><span class="n">idf_translation</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span>\
                                                <span class="n">xfact</span><span class="o">=</span><span class="n">idf_scale</span><span class="p">,</span><span class="n">yfact</span><span class="o">=</span><span class="n">idf_scale</span><span class="p">,</span><span class="n">origin</span><span class="o">=</span><span class="n">idf_center</span><span class="p">)</span>
                        <span class="n">g</span><span class="o">=</span><span class="n">so</span><span class="o">.</span><span class="n">unary_union</span><span class="p">([</span><span class="n">g</span><span class="p">,</span><span class="n">g2</span><span class="p">])</span>
                    <span class="n">tmp</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">g</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_country_data</span><span class="p">[</span><span class="s1">&#39;geometry&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">tmp</span>

            <span class="k">if</span> <span class="n">main_area</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_country_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_country_data</span><span class="p">[</span><span class="o">~</span><span class="bp">self</span><span class="o">.</span><span class="n">_country_data</span><span class="p">[</span><span class="s1">&#39;name_subregion&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">list_translation</span><span class="o">.</span><span class="n">keys</span><span class="p">())]</span>

        <span class="c1"># --- &#39;USA&#39; case ---------------------------------------------------------------------------------------</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_country</span> <span class="o">==</span> <span class="s1">&#39;USA&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_country_data</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">read_file</span><span class="p">(</span><span class="s1">&#39;zip://&#39;</span><span class="o">+</span><span class="n">get_local_from_url</span><span class="p">(</span><span class="n">url</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="s1">&#39;.zip&#39;</span><span class="p">))</span> <span class="c1"># under the hypothesis this is a zip file</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_country_data</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span>\
                <span class="s1">&#39;STATE_NAME&#39;</span><span class="p">:</span><span class="s1">&#39;name_subregion&#39;</span><span class="p">,</span>\
                <span class="s1">&#39;STATE_ABBR&#39;</span><span class="p">:</span><span class="s1">&#39;code_subregion&#39;</span><span class="p">,</span>\
                <span class="s1">&#39;SUB_REGION&#39;</span><span class="p">:</span><span class="s1">&#39;code_region&#39;</span><span class="p">},</span>\
                <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_country_data</span><span class="p">[</span><span class="s1">&#39;name_region&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_country_data</span><span class="p">[</span><span class="s1">&#39;code_region&#39;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_country_data</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="s1">&#39;DRAWSEQ&#39;</span><span class="p">,</span><span class="s1">&#39;STATE_FIPS&#39;</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="c1"># Adding informations from wikipedia</span>
            <span class="n">f_us</span><span class="o">=</span><span class="nb">open</span><span class="p">(</span><span class="n">get_local_from_url</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_source_dict</span><span class="p">[</span><span class="s1">&#39;USA&#39;</span><span class="p">][</span><span class="s1">&#39;Subregion informations&#39;</span><span class="p">],</span><span class="mi">0</span><span class="p">),</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span>
            <span class="n">content_us</span> <span class="o">=</span> <span class="n">f_us</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
            <span class="n">f_us</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="n">soup_us</span> <span class="o">=</span> <span class="n">bs4</span><span class="o">.</span><span class="n">BeautifulSoup</span><span class="p">(</span><span class="n">content_us</span><span class="p">,</span><span class="s1">&#39;lxml&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">img</span> <span class="ow">in</span> <span class="n">soup_us</span><span class="o">.</span><span class="n">find_all</span><span class="p">(</span><span class="s1">&#39;img&#39;</span><span class="p">):</span>  <span class="c1"># need to convert &lt;img tags to src content for pandas_read</span>
                <span class="n">src</span><span class="o">=</span><span class="n">img</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;src&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">src</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;/&#39;</span><span class="p">:</span>
                    <span class="n">src</span><span class="o">=</span><span class="s1">&#39;http:&#39;</span><span class="o">+</span><span class="n">src</span>
                <span class="n">img</span><span class="o">.</span><span class="n">replace_with</span><span class="p">(</span><span class="n">src</span><span class="p">)</span>

            <span class="n">h_us</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">read_html</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">soup_us</span><span class="p">))</span> <span class="c1"># pandas read the modified html</span>
            <span class="n">h_us</span><span class="o">=</span><span class="n">h_us</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">h_us</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">columns</span><span class="p">[[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">7</span><span class="p">]]]</span>
            <span class="n">h_us</span><span class="o">.</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;flag_subregion&#39;</span><span class="p">,</span><span class="s1">&#39;code_subregion&#39;</span><span class="p">,</span><span class="s1">&#39;town_subregion&#39;</span><span class="p">,</span><span class="s1">&#39;population_subregion&#39;</span><span class="p">,</span><span class="s1">&#39;area_subregion&#39;</span><span class="p">]</span>
            <span class="n">h_us</span><span class="p">[</span><span class="s1">&#39;flag_subregion&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span> <span class="n">h</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\xa0</span><span class="s1">&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="n">h_us</span><span class="p">[</span><span class="s1">&#39;flag_subregion&#39;</span><span class="p">]</span> <span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_country_data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_country_data</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">h_us</span><span class="p">,</span><span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span><span class="n">on</span><span class="o">=</span><span class="s1">&#39;code_subregion&#39;</span><span class="p">)</span>

            <span class="n">list_translation</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;AK&quot;</span><span class="p">:(</span><span class="mi">40</span><span class="p">,</span><span class="o">-</span><span class="mi">40</span><span class="p">),</span><span class="s2">&quot;HI&quot;</span><span class="p">:(</span><span class="mi">60</span><span class="p">,</span><span class="mi">0</span><span class="p">)}</span>
            <span class="n">list_scale</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;AK&quot;</span><span class="p">:</span><span class="mf">0.4</span><span class="p">,</span><span class="s2">&quot;HI&quot;</span><span class="p">:</span><span class="mi">1</span><span class="p">}</span>
            <span class="n">list_center</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;AK&quot;</span><span class="p">:(</span><span class="o">-</span><span class="mi">120</span><span class="p">,</span><span class="mi">25</span><span class="p">),</span><span class="s2">&quot;HI&quot;</span><span class="p">:(</span><span class="o">-</span><span class="mi">130</span><span class="p">,</span><span class="mi">25</span><span class="p">)}</span>

            <span class="k">if</span> <span class="n">dense_geometry</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">tmp</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">poi</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_country_data</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
                    <span class="n">x</span><span class="o">=</span><span class="mi">0</span>
                    <span class="n">y</span><span class="o">=</span><span class="mi">0</span>
                    <span class="n">w</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_country_data</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">index</span><span class="p">,</span><span class="s2">&quot;code_subregion&quot;</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">w</span> <span class="ow">in</span> <span class="n">list_translation</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                        <span class="n">x</span><span class="o">=</span><span class="n">list_translation</span><span class="p">[</span><span class="n">w</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                        <span class="n">y</span><span class="o">=</span><span class="n">list_translation</span><span class="p">[</span><span class="n">w</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
                        <span class="n">g</span><span class="o">=</span><span class="n">sa</span><span class="o">.</span><span class="n">scale</span><span class="p">(</span><span class="n">sa</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_country_data</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">index</span><span class="p">,</span> <span class="s1">&#39;geometry&#39;</span><span class="p">],</span><span class="n">xoff</span><span class="o">=</span><span class="n">x</span><span class="p">,</span><span class="n">yoff</span><span class="o">=</span><span class="n">y</span><span class="p">),</span>\
                                                <span class="n">xfact</span><span class="o">=</span><span class="n">list_scale</span><span class="p">[</span><span class="n">w</span><span class="p">],</span><span class="n">yfact</span><span class="o">=</span><span class="n">list_scale</span><span class="p">[</span><span class="n">w</span><span class="p">],</span><span class="n">origin</span><span class="o">=</span><span class="n">list_center</span><span class="p">[</span><span class="n">w</span><span class="p">])</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">g</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_country_data</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">index</span><span class="p">,</span> <span class="s1">&#39;geometry&#39;</span><span class="p">]</span>

                    <span class="n">tmp</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">g</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_country_data</span><span class="p">[</span><span class="s1">&#39;geometry&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">tmp</span>

            <span class="k">if</span> <span class="n">main_area</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_country_data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_country_data</span><span class="p">[</span><span class="o">~</span><span class="bp">self</span><span class="o">.</span><span class="n">_country_data</span><span class="p">[</span><span class="s1">&#39;code_subregion&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">list_translation</span><span class="o">.</span><span class="n">keys</span><span class="p">())]</span>

        <span class="c1"># --- &#39;ITA&#39; case ---------------------------------------------------------------------------------------</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_country</span> <span class="o">==</span> <span class="s1">&#39;ITA&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_country_data</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">read_file</span><span class="p">(</span><span class="n">get_local_from_url</span><span class="p">(</span><span class="n">url</span><span class="p">,</span><span class="mi">0</span><span class="p">))</span> <span class="c1"># this is a geojson file</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_country_data</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span>\
                <span class="s1">&#39;prov_name&#39;</span><span class="p">:</span><span class="s1">&#39;name_subregion&#39;</span><span class="p">,</span>\
                <span class="s1">&#39;prov_acr&#39;</span><span class="p">:</span><span class="s1">&#39;code_subregion&#39;</span><span class="p">,</span>\
                <span class="s1">&#39;reg_name&#39;</span><span class="p">:</span><span class="s1">&#39;name_region&#39;</span><span class="p">,</span>\
                <span class="s1">&#39;reg_istat_code&#39;</span><span class="p">:</span><span class="s1">&#39;code_region&#39;</span><span class="p">,</span>\
                <span class="p">},</span>
                <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_country_data</span><span class="p">[</span><span class="s1">&#39;name_region&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_country_data</span><span class="p">[</span><span class="s1">&#39;name_region&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">({</span>
            <span class="s1">&#39;Valle d</span><span class="se">\&#39;</span><span class="s1">Aosta/VallÃ©e d</span><span class="se">\&#39;</span><span class="s1">Aoste&#39;</span><span class="p">:</span><span class="s1">&#39;Valle d</span><span class="se">\&#39;</span><span class="s1">Aosta&#39;</span><span class="p">,</span>
            <span class="s1">&#39;Trentino-Alto Adige/SÃ¼dtirol&#39;</span><span class="p">:</span><span class="s1">&#39;Trentino-Alto Adige&#39;</span><span class="p">,</span> <span class="s1">&#39;Friuli-Venezia Giulia&#39;</span><span class="p">:</span><span class="s1">&#39;Friuli Venezia Giulia&#39;</span><span class="p">})</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_country_data</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="s1">&#39;prov_istat_code_num&#39;</span><span class="p">,</span><span class="s1">&#39;reg_istat_code_num&#39;</span><span class="p">,</span><span class="s1">&#39;prov_istat_code&#39;</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># --- &#39;IND&#39; case ---------------------------------------------------------------------------------------</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_country</span> <span class="o">==</span> <span class="s1">&#39;IND&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_country_data</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">read_file</span><span class="p">(</span><span class="n">get_local_from_url</span><span class="p">(</span><span class="n">url</span><span class="p">,</span><span class="mi">0</span><span class="p">))</span> <span class="c1"># this is a geojson file</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_country_data</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span>\
                <span class="s1">&#39;NAME_1&#39;</span><span class="p">:</span><span class="s1">&#39;name_subregion&#39;</span><span class="p">,</span>\
                <span class="s1">&#39;VARNAME_1&#39;</span><span class="p">:</span><span class="s1">&#39;variationname&#39;</span><span class="p">,</span>\
                <span class="s1">&#39;HASC_1&#39;</span><span class="p">:</span><span class="s1">&#39;code_subregion&#39;</span><span class="p">,</span>\
                <span class="p">},</span>
                <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_country_data</span><span class="p">[</span><span class="s1">&#39;name_subregion&#39;</span><span class="p">]</span><span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_country_data</span><span class="p">[</span><span class="s1">&#39;name_subregion&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;Orissa&#39;</span><span class="p">,</span><span class="s1">&#39;Odisha&#39;</span><span class="p">)</span>
            <span class="n">variationname</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_country_data</span><span class="p">[</span><span class="s1">&#39;variationname&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to_list</span><span class="p">()</span>
            <span class="n">name_subregion</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_country_data</span><span class="p">[</span><span class="s1">&#39;name_subregion&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to_list</span><span class="p">()</span>
            <span class="n">alllocationvariation</span><span class="o">=</span><span class="p">[</span> <span class="n">i</span><span class="o">+</span><span class="s1">&#39;|&#39;</span><span class="o">+</span><span class="n">j</span> <span class="k">if</span> <span class="n">j</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span> <span class="k">else</span> <span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">j</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">name_subregion</span><span class="p">,</span><span class="n">variationname</span><span class="p">)]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_country_data</span><span class="p">[</span><span class="s1">&#39;variation_name_subregion&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_country_data</span><span class="p">[</span><span class="s1">&#39;name_subregion&#39;</span><span class="p">]</span><span class="o">.</span>\
                    <span class="n">replace</span><span class="p">(</span><span class="n">name_subregion</span><span class="p">,</span><span class="n">alllocationvariation</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_country_data</span><span class="p">[</span><span class="s1">&#39;name_region&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_country_data</span><span class="p">[</span><span class="s1">&#39;name_subregion&#39;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_country_data</span><span class="p">[</span><span class="s1">&#39;code_region&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_country_data</span><span class="p">[</span><span class="s1">&#39;code_subregion&#39;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_country_data</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="s1">&#39;ISO&#39;</span><span class="p">,</span><span class="s1">&#39;NAME_0&#39;</span><span class="p">,</span><span class="s1">&#39;ID_1&#39;</span><span class="p">,</span><span class="s1">&#39;TYPE_1&#39;</span><span class="p">,</span><span class="s1">&#39;ENGTYPE_1&#39;</span><span class="p">,</span><span class="s1">&#39;id&#39;</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># --- &#39;DEU&#39; case ---------------------------------------------------------------------------------------</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_country</span> <span class="o">==</span> <span class="s1">&#39;DEU&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_country_data</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">read_file</span><span class="p">(</span><span class="n">get_local_from_url</span><span class="p">(</span><span class="n">url</span><span class="p">,</span><span class="mi">0</span><span class="p">))</span> <span class="c1"># this is a geojson file</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_country_data</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span>\
                <span class="s1">&#39;GEN&#39;</span><span class="p">:</span><span class="s1">&#39;name_subregion&#39;</span><span class="p">,</span>\
                <span class="s1">&#39;AGS&#39;</span><span class="p">:</span><span class="s1">&#39;code_subregion&#39;</span><span class="p">,</span>\
                <span class="p">},</span>
                <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="c1"># See https://www.ioer-monitor.de/en/methodology/glossary/o/official-municipality-key-ags/ for decoding information of region code</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_country_data</span><span class="p">[</span><span class="s1">&#39;code_region&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_country_data</span><span class="o">.</span><span class="n">code_subregion</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span><span class="o">//</span><span class="mi">1000</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
            <span class="n">h_deu</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">read_html</span><span class="p">(</span><span class="n">get_local_from_url</span><span class="p">(</span><span class="s1">&#39;https://de.zxc.wiki/wiki/Amtlicher_Gemeindeschl%C3%BCssel&#39;</span><span class="p">,</span><span class="mi">0</span><span class="p">))[</span><span class="mi">3</span><span class="p">]</span>
            <span class="n">h_deu</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">h_deu</span><span class="p">[</span><span class="s1">&#39;#&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">slice</span><span class="p">(</span><span class="n">stop</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
            <span class="n">h_deu</span><span class="p">[</span><span class="s1">&#39;name_region&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">h_deu</span><span class="p">[</span><span class="s1">&#39;country&#39;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_country_data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_country_data</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">h_deu</span><span class="p">,</span><span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span><span class="n">left_on</span><span class="o">=</span><span class="s1">&#39;code_region&#39;</span><span class="p">,</span><span class="n">right_on</span><span class="o">=</span><span class="s1">&#39;id&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_country_data</span><span class="p">[</span><span class="s1">&#39;code_subregion&#39;</span><span class="p">]</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_country_data</span><span class="o">.</span><span class="n">code_subregion</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_country_data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_country_data</span><span class="p">[[</span><span class="s1">&#39;name_subregion&#39;</span><span class="p">,</span><span class="s1">&#39;code_subregion&#39;</span><span class="p">,</span><span class="s1">&#39;name_region&#39;</span><span class="p">,</span><span class="s1">&#39;code_region&#39;</span><span class="p">,</span><span class="s1">&#39;geometry&#39;</span><span class="p">]]</span>
            <span class="n">disso</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_country_data</span><span class="p">[[</span><span class="s1">&#39;name_subregion&#39;</span><span class="p">,</span><span class="s1">&#39;geometry&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">dissolve</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="s1">&#39;name_subregion&#39;</span><span class="p">,</span> <span class="n">aggfunc</span><span class="o">=</span><span class="s1">&#39;sum&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
            <span class="c1"># aggregate geometry with the same subregion name # some code subregion is lost somehow</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_country_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_country_data</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">(</span><span class="n">subset</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;name_subregion&#39;</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_country_data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_country_data</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;geometry&#39;</span><span class="p">]),</span><span class="n">disso</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s1">&#39;name_subregion&#39;</span><span class="p">)</span>

        <span class="c1"># --- &#39;ESP&#39; case ---------------------------------------------------------------------------------------</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_country</span> <span class="o">==</span> <span class="s1">&#39;ESP&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_country_data</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">read_file</span><span class="p">(</span><span class="s1">&#39;zip://&#39;</span><span class="o">+</span><span class="n">get_local_from_url</span><span class="p">(</span><span class="n">url</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="s1">&#39;.zip&#39;</span><span class="p">),</span><span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span> <span class="c1"># this is shapefile file</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_country_data</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span>\
                <span class="s1">&#39;ccaa&#39;</span><span class="p">:</span><span class="s1">&#39;name_region&#39;</span><span class="p">,</span>\
                <span class="s1">&#39;cod_ccaa&#39;</span><span class="p">:</span><span class="s1">&#39;code_region&#39;</span><span class="p">,</span>\
                <span class="s1">&#39;provincia&#39;</span><span class="p">:</span><span class="s1">&#39;name_subregion&#39;</span><span class="p">,</span>\
                <span class="s1">&#39;codigo&#39;</span><span class="p">:</span><span class="s1">&#39;code_subregion&#39;</span><span class="p">},</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_country_data</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="s1">&#39;texto&#39;</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># --- &#39;GBR&#39; case ---------------------------------------------------------------------------------------</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_country</span> <span class="o">==</span> <span class="s1">&#39;GBR&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_country_data</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">read_file</span><span class="p">(</span><span class="n">get_local_from_url</span><span class="p">(</span><span class="n">url</span><span class="p">,</span><span class="mi">0</span><span class="p">))</span>
            <span class="n">reg_england</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">get_local_from_url</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_source_dict</span><span class="p">[</span><span class="s1">&#39;GBR&#39;</span><span class="p">][</span><span class="s1">&#39;Regions&#39;</span><span class="p">],</span><span class="mi">0</span><span class="p">))</span>
            <span class="n">reg_adding_dict</span><span class="o">=</span><span class="p">{</span>
                <span class="s1">&#39;E07000245&#39;</span><span class="p">:(</span><span class="s1">&#39;E12000006&#39;</span><span class="p">,</span><span class="s1">&#39;East of England&#39;</span><span class="p">),</span> <span class="c1"># West Suffolk in East of England</span>
                <span class="s1">&#39;E07000244&#39;</span><span class="p">:(</span><span class="s1">&#39;E12000006&#39;</span><span class="p">,</span><span class="s1">&#39;East of England&#39;</span><span class="p">),</span> <span class="c1"># East Suffolk in East of England</span>
                <span class="s1">&#39;E06000059&#39;</span><span class="p">:(</span><span class="s1">&#39;E12000009&#39;</span><span class="p">,</span><span class="s1">&#39;South West&#39;</span><span class="p">),</span> <span class="c1"># Dorset in South West</span>
                <span class="s1">&#39;E06000058&#39;</span><span class="p">:(</span><span class="s1">&#39;E12000009&#39;</span><span class="p">,</span><span class="s1">&#39;South West&#39;</span><span class="p">),</span> <span class="c1"># Bournemouth, Christchurch and Poole in South West</span>
                <span class="s1">&#39;E07000246&#39;</span><span class="p">:(</span><span class="s1">&#39;E12000009&#39;</span><span class="p">,</span><span class="s1">&#39;South West&#39;</span><span class="p">),</span> <span class="c1"># Somerset West and Taunton in South West</span>
            <span class="p">}</span>
            <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">reg_adding_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">reg_england</span><span class="o">=</span><span class="n">reg_england</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s1">&#39;LAD18CD&#39;</span><span class="p">:</span><span class="n">k</span><span class="p">,</span><span class="s1">&#39;RGN18CD&#39;</span><span class="p">:</span><span class="n">v</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="s1">&#39;RGN18NM&#39;</span><span class="p">:</span><span class="n">v</span><span class="p">[</span><span class="mi">1</span><span class="p">]},</span><span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_country_data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_country_data</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">reg_england</span><span class="p">,</span><span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span><span class="n">left_on</span><span class="o">=</span><span class="s1">&#39;lad19cd&#39;</span><span class="p">,</span><span class="n">right_on</span><span class="o">=</span><span class="s1">&#39;LAD18CD&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_country_data</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span>\
                <span class="s1">&#39;lad19nm&#39;</span><span class="p">:</span><span class="s1">&#39;name_subregion&#39;</span><span class="p">,</span>\
                <span class="s1">&#39;lad19cd&#39;</span><span class="p">:</span><span class="s1">&#39;code_subregion&#39;</span><span class="p">,</span>\
                <span class="s1">&#39;RGN18CD&#39;</span><span class="p">:</span><span class="s1">&#39;code_region&#39;</span><span class="p">,</span>\
                <span class="s1">&#39;RGN18NM&#39;</span><span class="p">:</span><span class="s1">&#39;name_region&#39;</span><span class="p">,</span>\
                <span class="p">},</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_country_data</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_country_data</span><span class="o">.</span><span class="n">code_region</span><span class="o">.</span><span class="n">isnull</span><span class="p">(),</span><span class="s1">&#39;code_region&#39;</span><span class="p">]</span> <span class="o">=</span> \
                <span class="bp">self</span><span class="o">.</span><span class="n">_country_data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_country_data</span><span class="o">.</span><span class="n">code_region</span><span class="o">.</span><span class="n">isnull</span><span class="p">()]</span><span class="o">.</span><span class="n">code_subregion</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">slice</span><span class="p">(</span><span class="n">stop</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">dict_region</span><span class="o">=</span><span class="p">{</span>\
                <span class="s1">&#39;E&#39;</span><span class="p">:</span><span class="s1">&#39;England&#39;</span><span class="p">,</span>\
                <span class="s1">&#39;W&#39;</span><span class="p">:</span><span class="s1">&#39;Wales&#39;</span><span class="p">,</span>\
                <span class="s1">&#39;S&#39;</span><span class="p">:</span><span class="s1">&#39;Scotland&#39;</span><span class="p">,</span>\
                <span class="s1">&#39;N&#39;</span><span class="p">:</span><span class="s1">&#39;Northern Ireland&#39;</span>\
                <span class="p">}</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_country_data</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_country_data</span><span class="o">.</span><span class="n">code_region</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">dict_region</span><span class="o">.</span><span class="n">keys</span><span class="p">())),</span><span class="s1">&#39;name_region&#39;</span><span class="p">]</span> <span class="o">=</span> \
                <span class="p">[</span><span class="n">dict_region</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_country_data</span><span class="o">.</span><span class="n">code_region</span> <span class="k">if</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">dict_region</span><span class="o">.</span><span class="n">keys</span><span class="p">())]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_country_data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_country_data</span><span class="p">[[</span><span class="s1">&#39;name_subregion&#39;</span><span class="p">,</span><span class="s1">&#39;code_subregion&#39;</span><span class="p">,</span><span class="s1">&#39;geometry&#39;</span><span class="p">,</span><span class="s1">&#39;code_region&#39;</span><span class="p">,</span><span class="s1">&#39;name_region&#39;</span><span class="p">]]</span>
            <span class="c1"># modifying projection</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_country_data</span><span class="p">[</span><span class="s1">&#39;geometry&#39;</span><span class="p">]</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_country_data</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">to_crs</span><span class="p">(</span><span class="s1">&#39;epsg:4326&#39;</span><span class="p">)</span>
        <span class="c1"># --- &#39;BEL&#39; case --------------------------------------------------------------------------------------------</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_country</span> <span class="o">==</span> <span class="s1">&#39;BEL&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_country_data</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">read_file</span><span class="p">(</span><span class="s1">&#39;zip://&#39;</span><span class="o">+</span><span class="n">get_local_from_url</span><span class="p">(</span><span class="n">url</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="s1">&#39;.zip&#39;</span><span class="p">),</span><span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span> <span class="c1"># this is shapefile file</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_country_data</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span>\
                <span class="s1">&#39;nom_arrondi&#39;</span><span class="p">:</span><span class="s1">&#39;name_subregion&#39;</span><span class="p">,</span>\
                <span class="s1">&#39;niscode&#39;</span><span class="p">:</span><span class="s1">&#39;code_subregion&#39;</span><span class="p">,</span>\
                <span class="s1">&#39;prov_code&#39;</span><span class="p">:</span><span class="s1">&#39;code_region&#39;</span><span class="p">},</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">p</span><span class="o">=</span><span class="p">[]</span>
            <span class="k">for</span> <span class="n">index</span><span class="p">,</span><span class="n">row</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_country_data</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">row</span><span class="o">.</span><span class="n">prov_name_f</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">p0</span><span class="o">=</span><span class="n">row</span><span class="o">.</span><span class="n">prov_name_f</span>
                <span class="k">elif</span> <span class="n">row</span><span class="o">.</span><span class="n">prov_name_n</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">p0</span><span class="o">=</span><span class="n">row</span><span class="o">.</span><span class="n">prov_name_n</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">p0</span><span class="o">=</span><span class="n">row</span><span class="o">.</span><span class="n">region</span>
                <span class="n">p</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p0</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_country_data</span><span class="p">[</span><span class="s1">&#39;name_region&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">p</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_country_data</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_country_data</span><span class="o">.</span><span class="n">code_region</span><span class="o">.</span><span class="n">isnull</span><span class="p">(),</span><span class="s1">&#39;code_region&#39;</span><span class="p">]</span><span class="o">=</span><span class="s1">&#39;00000&#39;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_country_data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_country_data</span><span class="p">[[</span><span class="s1">&#39;name_subregion&#39;</span><span class="p">,</span><span class="s1">&#39;code_subregion&#39;</span><span class="p">,</span><span class="s1">&#39;name_region&#39;</span><span class="p">,</span><span class="s1">&#39;code_region&#39;</span><span class="p">,</span><span class="s1">&#39;geometry&#39;</span><span class="p">]]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_country_data</span><span class="p">[</span><span class="s1">&#39;geometry&#39;</span><span class="p">]</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_country_data</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">to_crs</span><span class="p">(</span><span class="s1">&#39;epsg:4326&#39;</span><span class="p">)</span>
        <span class="c1"># --- &#39;PRT&#39; case --------------------------------------------------------------------------------------------</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_country</span> <span class="o">==</span> <span class="s1">&#39;PRT&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_country_data</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">read_file</span><span class="p">(</span><span class="s1">&#39;zip://&#39;</span><span class="o">+</span><span class="n">get_local_from_url</span><span class="p">(</span><span class="n">url</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="s1">&#39;.zip&#39;</span><span class="p">),</span><span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
            <span class="c1">#self._district=pd.read_json(self._source_dict[&#39;PRT&#39;][&#39;District&#39;])[[&#39;name&#39;,&#39;district&#39;]].dropna()</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_country_data</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span>\
                <span class="s1">&#39;NAME_2&#39;</span><span class="p">:</span><span class="s1">&#39;name_subregion&#39;</span><span class="p">,</span>\
                <span class="s1">&#39;NAME_1&#39;</span><span class="p">:</span><span class="s1">&#39;name_region&#39;</span><span class="p">,</span>\
                <span class="s1">&#39;HASC_2&#39;</span><span class="p">:</span><span class="s1">&#39;code_subregion&#39;</span><span class="p">},</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_country_data</span><span class="p">[</span><span class="s1">&#39;code_region&#39;</span><span class="p">]</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_country_data</span><span class="o">.</span><span class="n">code_subregion</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">slice</span><span class="p">(</span><span class="n">stop</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_country_data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_country_data</span><span class="p">[[</span><span class="s1">&#39;name_subregion&#39;</span><span class="p">,</span><span class="s1">&#39;code_subregion&#39;</span><span class="p">,</span><span class="s1">&#39;name_region&#39;</span><span class="p">,</span><span class="s1">&#39;code_region&#39;</span><span class="p">,</span><span class="s1">&#39;geometry&#39;</span><span class="p">]]</span>
        <span class="c1"># --- &#39;MYS&#39; case --------------------------------------------------------------------------------------------</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_country</span> <span class="o">==</span> <span class="s1">&#39;MYS&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_country_data</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">read_file</span><span class="p">(</span><span class="s1">&#39;zip://&#39;</span><span class="o">+</span><span class="n">get_local_from_url</span><span class="p">(</span><span class="n">url</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="s1">&#39;.zip&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">dissolve</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="s1">&#39;nam&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_country_data</span><span class="p">[</span><span class="s1">&#39;name_subregion&#39;</span><span class="p">]</span><span class="o">=</span><span class="p">[</span><span class="n">n</span><span class="o">.</span><span class="n">title</span><span class="p">()</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_country_data</span><span class="o">.</span><span class="n">nam</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_country_data</span><span class="p">[</span><span class="s1">&#39;code_subregion&#39;</span><span class="p">]</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_country_data</span><span class="o">.</span><span class="n">name_subregion</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_country_data</span><span class="p">[</span><span class="s1">&#39;code_region&#39;</span><span class="p">]</span><span class="o">=</span><span class="s1">&#39;MYS&#39;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_country_data</span><span class="p">[</span><span class="s1">&#39;name_region&#39;</span><span class="p">]</span><span class="o">=</span><span class="s1">&#39;Malaysia&#39;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_country_data</span><span class="p">[</span><span class="s1">&#39;code_subregion&#39;</span><span class="p">]</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_country_data</span><span class="o">.</span><span class="n">code_subregion</span>
            <span class="c1"># to help the join procedure with current covid data, some translation</span>
            <span class="n">dict_subregion</span><span class="o">=</span><span class="p">{</span>\
                <span class="s1">&#39;Wilayah Persekutuan Labuan&#39;</span><span class="p">:</span><span class="s1">&#39;W.P. Labuan&#39;</span><span class="p">,</span>\
                <span class="s1">&#39;Wilayah Persekutuan&#39;</span><span class="p">:</span><span class="s1">&#39;W.P. Kuala Lumpur&#39;</span><span class="p">,</span>\
                <span class="p">}</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_country_data</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_country_data</span><span class="o">.</span><span class="n">code_subregion</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">dict_subregion</span><span class="o">.</span><span class="n">keys</span><span class="p">())),</span><span class="s1">&#39;code_subregion&#39;</span><span class="p">]</span> <span class="o">=</span> \
                <span class="p">[</span><span class="n">dict_subregion</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_country_data</span><span class="o">.</span><span class="n">code_subregion</span> <span class="k">if</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">dict_subregion</span><span class="o">.</span><span class="n">keys</span><span class="p">())]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_country_data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_country_data</span><span class="p">[[</span><span class="s1">&#39;name_subregion&#39;</span><span class="p">,</span><span class="s1">&#39;code_subregion&#39;</span><span class="p">,</span><span class="s1">&#39;name_region&#39;</span><span class="p">,</span><span class="s1">&#39;code_region&#39;</span><span class="p">,</span><span class="s1">&#39;geometry&#39;</span><span class="p">]]</span>
        <span class="c1"># --- &#39;CHL&#39; case --------------------------------------------------------------------------------------------</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_country</span> <span class="o">==</span> <span class="s1">&#39;CHL&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_country_data</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">read_file</span><span class="p">(</span><span class="s1">&#39;zip://&#39;</span><span class="o">+</span><span class="n">get_local_from_url</span><span class="p">(</span><span class="n">url</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="s1">&#39;.zip&#39;</span><span class="p">),</span><span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_country_data</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span>\
                <span class="s1">&#39;NOM_REG&#39;</span><span class="p">:</span><span class="s1">&#39;name_region&#39;</span><span class="p">,</span>\
                <span class="s1">&#39;NOM_COM&#39;</span><span class="p">:</span><span class="s1">&#39;name_subregion&#39;</span><span class="p">},</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_country_data</span><span class="p">[</span><span class="s1">&#39;code_subregion&#39;</span><span class="p">]</span><span class="o">=</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">c</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_country_data</span><span class="o">.</span><span class="n">COD_COMUNA</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_country_data</span><span class="p">[</span><span class="s1">&#39;code_region&#39;</span><span class="p">]</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_country_data</span><span class="o">.</span><span class="n">code_subregion</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">slice</span><span class="p">(</span><span class="n">stop</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_country_data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_country_data</span><span class="p">[[</span><span class="s1">&#39;name_subregion&#39;</span><span class="p">,</span><span class="s1">&#39;code_subregion&#39;</span><span class="p">,</span><span class="s1">&#39;name_region&#39;</span><span class="p">,</span><span class="s1">&#39;code_region&#39;</span><span class="p">,</span><span class="s1">&#39;geometry&#39;</span><span class="p">]]</span>

    <span class="c1"># def get_region_from_municipality(self,lname):</span>
    <span class="c1">#     &quot;&quot;&quot;  Return region list from a municipality list</span>
    <span class="c1">#     &quot;&quot;&quot;</span>
    <span class="c1">#     if not isinstance(lname, list):</span>
    <span class="c1">#         lname=[lname]</span>
    <span class="c1">#     return self._municipality_region.loc[self._municipality_region.name.isin(lname)][&#39;district&#39;].to_list()</span>

<div class="viewcode-block" id="GeoCountry.get_source"><a class="viewcode-back" href="../../coa.geo.html#coa.geo.GeoCountry.get_source">[docs]</a>    <span class="k">def</span> <span class="nf">get_source</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Return informations about URL sources</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_country</span><span class="p">()</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_source_dict</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">get_country</span><span class="p">()]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_source_dict</span></div>

<div class="viewcode-block" id="GeoCountry.get_country"><a class="viewcode-back" href="../../coa.geo.html#coa.geo.GeoCountry.get_country">[docs]</a>    <span class="k">def</span> <span class="nf">get_country</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Return the current country used.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_country</span></div>

<div class="viewcode-block" id="GeoCountry.get_list_countries"><a class="viewcode-back" href="../../coa.geo.html#coa.geo.GeoCountry.get_list_countries">[docs]</a>    <span class="k">def</span> <span class="nf">get_list_countries</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; This function returns back the list of supported countries</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_country_info_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span></div>

<div class="viewcode-block" id="GeoCountry.is_init"><a class="viewcode-back" href="../../coa.geo.html#coa.geo.GeoCountry.is_init">[docs]</a>    <span class="k">def</span> <span class="nf">is_init</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Test if the country is initialized. Return True if it is. False if not.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_country</span><span class="p">()</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span></div>

<div class="viewcode-block" id="GeoCountry.test_is_init"><a class="viewcode-back" href="../../coa.geo.html#coa.geo.GeoCountry.test_is_init">[docs]</a>    <span class="k">def</span> <span class="nf">test_is_init</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Test if the country is initialized. If not, raise a CoaDbError.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_init</span><span class="p">():</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">CoaDbError</span><span class="p">(</span><span class="s2">&quot;The country is not set. Use a constructor with non empty country string.&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="GeoCountry.get_region_list"><a class="viewcode-back" href="../../coa.geo.html#coa.geo.GeoCountry.get_region_list">[docs]</a>    <span class="k">def</span> <span class="nf">get_region_list</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Return the list of available regions with code, name and geometry</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">cols</span><span class="o">=</span><span class="p">[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_list_properties</span><span class="p">()</span> <span class="k">if</span> <span class="s1">&#39;_region&#39;</span> <span class="ow">in</span> <span class="n">c</span><span class="p">]</span>
        <span class="n">cols</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;geometry&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_data</span><span class="p">(</span><span class="kc">True</span><span class="p">)[</span><span class="n">cols</span><span class="p">]</span></div>

<div class="viewcode-block" id="GeoCountry.is_region"><a class="viewcode-back" href="../../coa.geo.html#coa.geo.GeoCountry.is_region">[docs]</a>    <span class="k">def</span> <span class="nf">is_region</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">r</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Return False if r is a not a known region, return the correctly capitalized name if ok</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">r</span><span class="o">=</span><span class="n">tostdstring</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_region_list</span><span class="p">()</span><span class="o">.</span><span class="n">name_region</span><span class="o">.</span><span class="n">to_list</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">tostdstring</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">==</span> <span class="n">r</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">i</span>
        <span class="k">return</span> <span class="kc">False</span></div>

<div class="viewcode-block" id="GeoCountry.get_subregion_list"><a class="viewcode-back" href="../../coa.geo.html#coa.geo.GeoCountry.get_subregion_list">[docs]</a>    <span class="k">def</span> <span class="nf">get_subregion_list</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Return the list of available subregions with code, name and geometry</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">cols</span><span class="o">=</span><span class="p">[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_list_properties</span><span class="p">()</span> <span class="k">if</span> <span class="s1">&#39;_subregion&#39;</span> <span class="ow">in</span> <span class="n">c</span> <span class="p">]</span>
        <span class="n">cols</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;geometry&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_data</span><span class="p">()[</span><span class="n">cols</span><span class="p">]</span></div>

<div class="viewcode-block" id="GeoCountry.is_subregion"><a class="viewcode-back" href="../../coa.geo.html#coa.geo.GeoCountry.is_subregion">[docs]</a>    <span class="k">def</span> <span class="nf">is_subregion</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">r</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Return False if r is a not a known region, return the correctly capitalized name if ok</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">r2</span><span class="o">=</span><span class="n">tostdstring</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_subregion_list</span><span class="p">()</span><span class="o">.</span><span class="n">name_subregion</span><span class="o">.</span><span class="n">to_list</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">tostdstring</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">==</span> <span class="n">r2</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">i</span>
        <span class="n">a</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_subregion_list</span><span class="p">()[</span><span class="bp">self</span><span class="o">.</span><span class="n">get_subregion_list</span><span class="p">()</span><span class="o">.</span><span class="n">code_subregion</span><span class="o">==</span><span class="n">r</span><span class="p">]</span><span class="o">.</span><span class="n">name_subregion</span><span class="o">.</span><span class="n">values</span>
        <span class="k">if</span> <span class="n">a</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">return</span> <span class="kc">False</span></div>

<div class="viewcode-block" id="GeoCountry.get_subregions_from_region"><a class="viewcode-back" href="../../coa.geo.html#coa.geo.GeoCountry.get_subregions_from_region">[docs]</a>    <span class="k">def</span> <span class="nf">get_subregions_from_region</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Return the list of subregions within a specified region.</span>
<span class="sd">        Should give either the code or the name of the region as strings in kwarg : code=# or name=#</span>
<span class="sd">        Output default is &#39;code&#39; of subregions. Can be changer with output=&#39;name&#39;.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">kwargs_test</span><span class="p">(</span><span class="n">kwargs</span><span class="p">,[</span><span class="s1">&#39;name&#39;</span><span class="p">,</span><span class="s1">&#39;code&#39;</span><span class="p">,</span><span class="s1">&#39;output&#39;</span><span class="p">],</span><span class="s1">&#39;Should give either name or code of region. Output can be changed with the output option.&#39;</span><span class="p">)</span>
        <span class="n">code</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;code&quot;</span><span class="p">,</span><span class="kc">None</span><span class="p">)</span>
        <span class="n">name</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">,</span><span class="kc">None</span><span class="p">)</span>
        <span class="n">out</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;output&quot;</span><span class="p">,</span><span class="s1">&#39;code&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">code</span> <span class="o">==</span> <span class="kc">None</span><span class="p">)</span> <span class="o">^</span> <span class="p">(</span><span class="n">name</span> <span class="o">==</span> <span class="kc">None</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">CoaKeyError</span><span class="p">(</span><span class="s2">&quot;Should give either code or name of region, not both.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">out</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;code&#39;</span><span class="p">,</span><span class="s1">&#39;name&#39;</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="n">CoaKeyError</span><span class="p">(</span><span class="s2">&quot;Should set output either as &#39;code&#39; or &#39;name&#39; for subregions.&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">name</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">name</span><span class="p">,</span><span class="nb">str</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">CoaTypeError</span><span class="p">(</span><span class="s2">&quot;Name should be given as string.&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_region_list</span><span class="p">()[</span><span class="s1">&#39;name_region&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to_list</span><span class="p">():</span>
                <span class="k">raise</span> <span class="n">CoaWhereError</span> <span class="p">(</span><span class="s2">&quot;The region &quot;</span><span class="o">+</span><span class="n">name</span><span class="o">+</span><span class="s2">&quot; does not exist for country &quot;</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">get_country</span><span class="p">()</span><span class="o">+</span><span class="s2">&quot;. See get_region_list().&quot;</span><span class="p">)</span>
            <span class="n">cut</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_data</span><span class="p">(</span><span class="kc">True</span><span class="p">)[</span><span class="s1">&#39;name_region&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">name</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">code</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">code</span><span class="p">,</span><span class="nb">str</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">CoaTypeError</span><span class="p">(</span><span class="s2">&quot;Name should be given as string.&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">code</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_region_list</span><span class="p">()[</span><span class="s1">&#39;code_region&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to_list</span><span class="p">():</span>
                <span class="k">raise</span> <span class="n">CoaWhereError</span><span class="p">(</span><span class="s2">&quot;The region &quot;</span><span class="o">+</span><span class="n">code</span><span class="o">+</span><span class="s2">&quot; does not exist for country &quot;</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">get_country</span><span class="p">()</span><span class="o">+</span><span class="s2">&quot;. See get_region_list().&quot;</span><span class="p">)</span>
            <span class="n">cut</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_data</span><span class="p">(</span><span class="kc">True</span><span class="p">)[</span><span class="s1">&#39;code_region&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">code</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_data</span><span class="p">(</span><span class="kc">True</span><span class="p">)[</span><span class="n">cut</span><span class="p">][</span><span class="n">out</span><span class="o">+</span><span class="s1">&#39;_subregion&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="c1">#to_list()</span></div>

<div class="viewcode-block" id="GeoCountry.get_subregions_from_list_of_region_names"><a class="viewcode-back" href="../../coa.geo.html#coa.geo.GeoCountry.get_subregions_from_list_of_region_names">[docs]</a>    <span class="k">def</span> <span class="nf">get_subregions_from_list_of_region_names</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">l</span><span class="p">,</span><span class="n">output</span><span class="o">=</span><span class="s1">&#39;code&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Return the list of subregions according to list of region names given.</span>
<span class="sd">        The output argument (&#39;code&#39; as default) is given to the get_subregions_from_region function.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">l</span><span class="p">,</span><span class="nb">list</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">CoaTypeError</span><span class="p">(</span><span class="s2">&quot;Should provide list as argument&quot;</span><span class="p">)</span>
        <span class="n">s</span><span class="o">=</span><span class="p">[]</span>
        <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">l</span><span class="p">:</span>
            <span class="n">s</span><span class="o">=</span><span class="n">s</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">get_subregions_from_region</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">r</span><span class="p">,</span><span class="n">output</span><span class="o">=</span><span class="n">output</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">s</span></div>

<div class="viewcode-block" id="GeoCountry.get_list_properties"><a class="viewcode-back" href="../../coa.geo.html#coa.geo.GeoCountry.get_list_properties">[docs]</a>    <span class="k">def</span> <span class="nf">get_list_properties</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the list of available properties for the current country</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_is_init</span><span class="p">():</span>
            <span class="k">return</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_country_data</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">to_list</span><span class="p">())</span></div>

<div class="viewcode-block" id="GeoCountry.get_data"><a class="viewcode-back" href="../../coa.geo.html#coa.geo.GeoCountry.get_data">[docs]</a>    <span class="k">def</span> <span class="nf">get_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">region_version</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the whole geopandas data.</span>
<span class="sd">        If region_version = True (not default), the pandas output is region based focalized.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_is_init</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">region_version</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_country_data_region</span><span class="p">,</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span> <span class="c1"># i.e. is None</span>
                    <span class="n">col_reg</span><span class="o">=</span><span class="p">[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_country_data</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span> <span class="k">if</span> <span class="s1">&#39;_region&#39;</span> <span class="ow">in</span> <span class="n">c</span><span class="p">]</span>
                    <span class="n">col</span><span class="o">=</span><span class="n">col_reg</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                    <span class="n">col</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;geometry&#39;</span><span class="p">)</span> <span class="c1"># to merge the geometry of subregions</span>
                    <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_list_properties</span><span class="p">():</span>
                        <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;_subregion&#39;</span> <span class="ow">in</span> <span class="n">p</span><span class="p">)</span> <span class="ow">and</span> <span class="n">pd</span><span class="o">.</span><span class="n">api</span><span class="o">.</span><span class="n">types</span><span class="o">.</span><span class="n">is_numeric_dtype</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_country_data</span><span class="p">[</span><span class="n">p</span><span class="p">]):</span>
                            <span class="n">col</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="s1">&#39;code_subregion&#39;</span> <span class="ow">in</span> <span class="n">col</span><span class="p">:</span>
                        <span class="n">col</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;code_subregion&#39;</span><span class="p">)</span> <span class="c1"># to get the list of subregion in region</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="s1">&#39;name_subregion&#39;</span> <span class="ow">in</span> <span class="n">col</span><span class="p">:</span>
                        <span class="n">col</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;name_subregion&#39;</span><span class="p">)</span> <span class="c1"># to get the list of subregion name in region</span>

                    <span class="n">pr</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_country_data</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

                    <span class="c1"># Country specific management</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_country</span><span class="p">()</span><span class="o">==</span><span class="s1">&#39;FRA&#39;</span><span class="p">:</span> <span class="c1"># manage pseudo &#39;FRA&#39; regions &#39;MÃ©tropole&#39; and &#39;Outre-mer&#39;</span>
                        <span class="n">metropole_cut</span><span class="o">=</span><span class="n">pr</span><span class="o">.</span><span class="n">code_region</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span><span class="o">&gt;=</span><span class="mi">10</span>
                        <span class="n">pr_metropole</span><span class="o">=</span><span class="n">pr</span><span class="p">[</span><span class="n">metropole_cut</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                        <span class="n">pr_metropole</span><span class="p">[</span><span class="s1">&#39;code_region&#39;</span><span class="p">]</span><span class="o">=</span><span class="s1">&#39;999&#39;</span>
                        <span class="n">pr_metropole</span><span class="p">[</span><span class="s1">&#39;name_region&#39;</span><span class="p">]</span><span class="o">=</span><span class="s1">&#39;MÃ©tropole&#39;</span>
                        <span class="n">pr_metropole</span><span class="p">[</span><span class="s1">&#39;flag_region&#39;</span><span class="p">]</span><span class="o">=</span><span class="s1">&#39;&#39;</span>
                        <span class="n">pr_outremer</span><span class="o">=</span><span class="n">pr</span><span class="p">[</span><span class="o">~</span><span class="n">metropole_cut</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                        <span class="n">pr_outremer</span><span class="p">[</span><span class="s1">&#39;code_region&#39;</span><span class="p">]</span><span class="o">=</span><span class="s1">&#39;000&#39;</span>
                        <span class="n">pr_outremer</span><span class="p">[</span><span class="s1">&#39;name_region&#39;</span><span class="p">]</span><span class="o">=</span><span class="s1">&#39;Outre-mer&#39;</span>
                        <span class="n">pr_outremer</span><span class="p">[</span><span class="s1">&#39;flag_region&#39;</span><span class="p">]</span><span class="o">=</span><span class="s1">&#39;&#39;</span>

                        <span class="n">pr</span><span class="o">=</span><span class="n">pr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pr_metropole</span><span class="p">,</span><span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pr_outremer</span><span class="p">,</span><span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

                    <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_country</span><span class="p">()</span><span class="o">==</span><span class="s1">&#39;ESP&#39;</span> <span class="p">:</span> <span class="c1"># manage pseudo &#39;ESP&#39; regions within and outside continent</span>
                        <span class="n">islands_cut</span><span class="o">=</span><span class="n">pr</span><span class="o">.</span><span class="n">code_region</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span><span class="o">.</span><span class="n">isin</span><span class="p">([</span><span class="s1">&#39;05&#39;</span><span class="p">])</span>
                        <span class="n">pr_metropole</span><span class="o">=</span><span class="n">pr</span><span class="p">[</span><span class="o">~</span><span class="n">islands_cut</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                        <span class="n">pr_metropole</span><span class="p">[</span><span class="s1">&#39;code_region&#39;</span><span class="p">]</span><span class="o">=</span><span class="s1">&#39;99&#39;</span>
                        <span class="n">pr_metropole</span><span class="p">[</span><span class="s1">&#39;name_region&#39;</span><span class="p">]</span><span class="o">=</span><span class="s1">&#39;EspaÃ±a peninsular&#39;</span>
                        <span class="n">pr_metropole</span><span class="p">[</span><span class="s1">&#39;flag_region&#39;</span><span class="p">]</span><span class="o">=</span><span class="s1">&#39;&#39;</span>

                        <span class="n">pr_outremer</span><span class="o">=</span><span class="n">pr</span><span class="p">[</span><span class="n">islands_cut</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                        <span class="n">pr_outremer</span><span class="p">[</span><span class="s1">&#39;code_region&#39;</span><span class="p">]</span><span class="o">=</span><span class="s1">&#39;00&#39;</span>
                        <span class="n">pr_outremer</span><span class="p">[</span><span class="s1">&#39;name_region&#39;</span><span class="p">]</span><span class="o">=</span><span class="s1">&#39;Islas espaÃ±olas&#39;</span>
                        <span class="n">pr_outremer</span><span class="p">[</span><span class="s1">&#39;flag_region&#39;</span><span class="p">]</span><span class="o">=</span><span class="s1">&#39;&#39;</span>

                        <span class="n">pr</span><span class="o">=</span><span class="n">pr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pr_metropole</span><span class="p">,</span><span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pr_outremer</span><span class="p">,</span><span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

                    <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_country</span><span class="p">()</span><span class="o">==</span><span class="s1">&#39;PRT&#39;</span> <span class="p">:</span> <span class="c1"># manage pseudo &#39;PRT&#39; regions within and outside continent</span>
                        <span class="n">islands_cut</span><span class="o">=</span><span class="n">pr</span><span class="o">.</span><span class="n">code_region</span><span class="o">.</span><span class="n">isin</span><span class="p">([</span><span class="s1">&#39;PT.AC&#39;</span><span class="p">,</span><span class="s1">&#39;PT.MA&#39;</span><span class="p">])</span>
                        <span class="n">pr_metropole</span><span class="o">=</span><span class="n">pr</span><span class="p">[</span><span class="o">~</span><span class="n">islands_cut</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                        <span class="n">pr_metropole</span><span class="p">[</span><span class="s1">&#39;code_region&#39;</span><span class="p">]</span><span class="o">=</span><span class="s1">&#39;PT.99&#39;</span>
                        <span class="n">pr_metropole</span><span class="p">[</span><span class="s1">&#39;name_region&#39;</span><span class="p">]</span><span class="o">=</span><span class="s1">&#39;Portugal continental&#39;</span>
                        <span class="n">pr_metropole</span><span class="p">[</span><span class="s1">&#39;flag_region&#39;</span><span class="p">]</span><span class="o">=</span><span class="s1">&#39;&#39;</span>

                        <span class="n">pr_outremer</span><span class="o">=</span><span class="n">pr</span><span class="p">[</span><span class="n">islands_cut</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                        <span class="n">pr_outremer</span><span class="p">[</span><span class="s1">&#39;code_region&#39;</span><span class="p">]</span><span class="o">=</span><span class="s1">&#39;PT.00&#39;</span>
                        <span class="n">pr_outremer</span><span class="p">[</span><span class="s1">&#39;name_region&#39;</span><span class="p">]</span><span class="o">=</span><span class="s1">&#39;Ilhas portuguesas&#39;</span>
                        <span class="n">pr_outremer</span><span class="p">[</span><span class="s1">&#39;flag_region&#39;</span><span class="p">]</span><span class="o">=</span><span class="s1">&#39;&#39;</span>

                        <span class="n">pr</span><span class="o">=</span><span class="n">pr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pr_metropole</span><span class="p">,</span><span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pr_outremer</span><span class="p">,</span><span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

                    <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_country</span><span class="p">()</span><span class="o">==</span><span class="s1">&#39;USA&#39;</span><span class="p">:</span>
                        <span class="n">usa_col</span><span class="o">=</span><span class="n">pr</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
                        <span class="c1">#usa_col.remove(&#39;population_subregion&#39;) # Remove numeric column, if not, the dissolve does not work properly</span>
                        <span class="c1">#usa_col.remove(&#39;area_subregion&#39;) # idem</span>
                        <span class="n">pr</span><span class="o">=</span><span class="n">pr</span><span class="p">[</span><span class="n">usa_col</span><span class="p">]</span>

                    <span class="n">pr</span><span class="p">[</span><span class="s1">&#39;code_subregion&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">pr</span><span class="o">.</span><span class="n">code_subregion</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">])</span>
                    <span class="n">pr</span><span class="p">[</span><span class="s1">&#39;name_subregion&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">pr</span><span class="o">.</span><span class="n">name_subregion</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">])</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_country_data_region</span><span class="o">=</span><span class="n">pr</span><span class="o">.</span><span class="n">dissolve</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="n">col_reg</span><span class="p">,</span><span class="n">aggfunc</span><span class="o">=</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">sum</span><span class="p">()))</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="s1">&#39;code_region&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
                    <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;population&#39;</span><span class="p">,</span><span class="s1">&#39;area&#39;</span><span class="p">]:</span>
                        <span class="k">if</span> <span class="n">x</span><span class="o">+</span><span class="s1">&#39;_subregion&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_country_data_region</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">_country_data_region</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="n">x</span><span class="o">+</span><span class="s1">&#39;_subregion&#39;</span><span class="p">:</span><span class="n">x</span><span class="o">+</span><span class="s1">&#39;_region&#39;</span><span class="p">},</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_country_data_region</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_country_data_subregion</span><span class="p">,</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span> <span class="c1">#i.e. is None</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_country_data_subregion</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_country_data</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="s1">&#39;code_subregion&#39;</span><span class="p">)</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_country_data_subregion</span></div>

<div class="viewcode-block" id="GeoCountry.add_field"><a class="viewcode-back" href="../../coa.geo.html#coa.geo.GeoCountry.add_field">[docs]</a>    <span class="k">def</span> <span class="nf">add_field</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a the data pandas.Dataframe with an additionnal column with property prop.</span>

<span class="sd">        Arguments :</span>
<span class="sd">        input        : pandas.Dataframe object. Mandatory.</span>
<span class="sd">        field        : field of properties to add. Should be within the get_list_prop() list. Mandatory.</span>
<span class="sd">        input_key    : input geo key of the input pandas dataframe. Default  &#39;where&#39;</span>
<span class="sd">        geofield     : internal geo field to make the merge. Default &#39;code_subregion&#39;</span>
<span class="sd">        region_merging : Boolean value. Default False, except if the geofield contains &#39;_region&#39;.</span>
<span class="sd">                       If True, the merge between input dans GeoCountry data is done within the</span>
<span class="sd">                       region version of the data, not the subregion data which is the default</span>
<span class="sd">                       behavious.</span>
<span class="sd">        overload   : Allow to overload a field. Boolean value. Default : False</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Test of args</span>
        <span class="n">kwargs_test</span><span class="p">(</span><span class="n">kwargs</span><span class="p">,[</span><span class="s1">&#39;input&#39;</span><span class="p">,</span><span class="s1">&#39;field&#39;</span><span class="p">,</span><span class="s1">&#39;input_key&#39;</span><span class="p">,</span><span class="s1">&#39;geofield&#39;</span><span class="p">,</span><span class="s1">&#39;geotype&#39;</span><span class="p">,</span><span class="s1">&#39;overload&#39;</span><span class="p">],</span>
            <span class="s1">&#39;Bad args used in the add_field() function.&#39;</span><span class="p">)</span>

        <span class="c1"># Testing input</span>
        <span class="n">data</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;input&#39;</span><span class="p">,</span><span class="kc">None</span><span class="p">)</span> <span class="c1"># the panda</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">CoaTypeError</span><span class="p">(</span><span class="s1">&#39;You should provide a valid input pandas&#39;</span>
                <span class="s1">&#39; DataFrame as input. See help.&#39;</span><span class="p">)</span>
        <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="c1"># Testing input_key</span>
        <span class="n">input_key</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;input_key&#39;</span><span class="p">,</span><span class="s1">&#39;where&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">input_key</span><span class="p">,</span><span class="nb">str</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">CoaTypeError</span><span class="p">(</span><span class="s1">&#39;The input_key should be given as a string.&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">input_key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">tolist</span><span class="p">():</span>
            <span class="k">raise</span> <span class="n">CoaKeyError</span><span class="p">(</span><span class="s1">&#39;The input_key &quot;&#39;</span><span class="o">+</span><span class="n">input_key</span><span class="o">+</span><span class="s1">&#39;&quot; given is &#39;</span>
                <span class="s1">&#39;not a valid column name of the input pandas dataframe.&#39;</span><span class="p">)</span>

        <span class="c1"># Testing geofield</span>
        <span class="n">geofield</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;geofield&#39;</span><span class="p">,</span><span class="s1">&#39;code_subregion&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">geofield</span><span class="p">,</span><span class="nb">str</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">CoaTypeError</span><span class="p">(</span><span class="s1">&#39;The geofield should be given as a string.&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">geofield</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_country_data</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">tolist</span><span class="p">():</span>
            <span class="k">raise</span> <span class="n">CoaKeyError</span><span class="p">(</span><span class="s1">&#39;The geofield &quot;&#39;</span><span class="o">+</span><span class="n">geofield</span><span class="o">+</span><span class="s1">&#39;&quot; given is &#39;</span>
                <span class="s1">&#39;not a valid column name of the available data. &#39;</span>
                <span class="s1">&#39;See get_list_properties() for valid fields.&#39;</span><span class="p">)</span>

        <span class="n">region_merging</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;region_merging&#39;</span><span class="p">,</span><span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">region_merging</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="s1">&#39;_region&#39;</span> <span class="ow">in</span> <span class="n">geofield</span><span class="p">:</span>
                <span class="n">region_merging</span><span class="o">=</span><span class="kc">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">region_merging</span><span class="o">=</span><span class="kc">False</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">region_merging</span><span class="p">,</span><span class="nb">bool</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">CoaKeyError</span><span class="p">(</span><span class="s1">&#39;The region_mergin key should be boolean. See help.&#39;</span><span class="p">)</span>

        <span class="c1"># Testing fields</span>
        <span class="n">prop</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;field&#39;</span><span class="p">,</span><span class="kc">None</span><span class="p">)</span> <span class="c1"># field list</span>
        <span class="k">if</span> <span class="n">prop</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">CoaKeyError</span><span class="p">(</span><span class="s1">&#39;No field given. See help.&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">prop</span><span class="p">,</span><span class="nb">list</span><span class="p">):</span>
            <span class="n">prop</span><span class="o">=</span><span class="p">[</span><span class="n">prop</span><span class="p">]</span> <span class="c1"># make the prop input a list if needed</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">prop</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">CoaTypeError</span><span class="p">(</span><span class="s2">&quot;Each property should be a string whereas &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">prop</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot; is not a list of string.&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_list_properties</span><span class="p">()</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">prop</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">CoaKeyError</span><span class="p">(</span><span class="s2">&quot;The property &quot;</span><span class="o">+</span><span class="n">prop</span><span class="o">+</span><span class="s2">&quot; is not available for country &quot;</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">get_country</span><span class="p">()</span><span class="o">+</span><span class="s2">&quot;.&quot;</span><span class="p">)</span>

        <span class="c1"># Testing overload</span>
        <span class="n">overload</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;overload&#39;</span><span class="p">,</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">overload</span><span class="p">,</span><span class="nb">bool</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">CoaTypeError</span><span class="p">(</span><span class="s1">&#39;The overload option should be a boolean.&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">overload</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="n">p</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">prop</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">CoaKeyError</span><span class="p">(</span><span class="s1">&#39;Some fields already exist in you panda &#39;</span>
                <span class="s1">&#39;dataframe columns. You may set overload to True.&#39;</span><span class="p">)</span>

        <span class="c1"># Is the oject properly initialized ?</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test_is_init</span><span class="p">()</span>

        <span class="c1"># Now let&#39;s go for merging</span>
        <span class="n">prop</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;code_subregion&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">data</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_data</span><span class="p">(</span><span class="n">region_merging</span><span class="p">)[</span><span class="n">prop</span><span class="p">],</span><span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span><span class="n">left_on</span><span class="o">=</span><span class="n">input_key</span><span class="p">,</span>\
                            <span class="n">right_on</span><span class="o">=</span><span class="n">geofield</span><span class="p">)</span></div></div>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2021, Pycoa.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>