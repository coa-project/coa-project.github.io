<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>coa.covid19 &mdash; Pycoa dev documentation</title>
      <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/graphviz.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/doctools.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../../index.html" class="icon icon-home"> Pycoa
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <!-- Local TOC -->
              <div class="local-toc"></div>
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Pycoa</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home"></a> &raquo;</li>
          <li><a href="../index.html">Module code</a> &raquo;</li>
      <li>coa.covid19</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for coa.covid19</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Project : PyCoA</span>
<span class="sd">Date :    april 2020 - march 2021</span>
<span class="sd">Authors : Olivier Dadoun, Julien Browaeys, Tristan Beau</span>
<span class="sd">Copyright ©pycoa.fr</span>
<span class="sd">License: See joint LICENSE file</span>

<span class="sd">Module : coa.covid19</span>

<span class="sd">About :</span>
<span class="sd">-------</span>

<span class="sd">Main class definitions for covid19 dataset access. Currently, we are only using the JHU CSSE data.</span>
<span class="sd">The parser class gives a simplier access through an already filled dict of data</span>

<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">pandas</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">defaultdict</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">datetime</span> <span class="k">as</span> <span class="nn">dt</span>

<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">from</span> <span class="nn">coa.tools</span> <span class="kn">import</span> <span class="n">info</span><span class="p">,</span> <span class="n">verb</span><span class="p">,</span> <span class="n">kwargs_test</span><span class="p">,</span> <span class="n">get_local_from_url</span><span class="p">,</span> <span class="n">fill_missing_dates</span><span class="p">,</span> <span class="n">check_valid_date</span><span class="p">,</span> <span class="n">week_to_date</span><span class="p">,</span> <span class="n">get_db_list_dict</span>

<span class="kn">import</span> <span class="nn">coa.geo</span> <span class="k">as</span> <span class="nn">coge</span>
<span class="kn">import</span> <span class="nn">coa.dbinfo</span> <span class="k">as</span> <span class="nn">report</span>
<span class="kn">import</span> <span class="nn">coa.display</span> <span class="k">as</span> <span class="nn">codisplay</span>
<span class="kn">from</span> <span class="nn">coa.error</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">scipy</span> <span class="kn">import</span> <span class="n">stats</span> <span class="k">as</span> <span class="n">sps</span>
<span class="kn">import</span> <span class="nn">random</span>
<span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">reduce</span>
<span class="kn">import</span> <span class="nn">collections</span>

<div class="viewcode-block" id="DataBase"><a class="viewcode-back" href="../../coa.covid19.html#coa.covid19.DataBase">[docs]</a><span class="k">class</span> <span class="nc">DataBase</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
   <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">   DataBase class</span>
<span class="sd">   Parse a Covid-19 database and filled the pandas python objet : mainpandas</span>
<span class="sd">   It takes a string argument, which can be: &#39;jhu&#39;,&#39;spf&#39;, &#39;spfnational&#39;,&#39;owid&#39;, &#39;opencovid19&#39; and &#39;opencovid19national&#39;</span>
<span class="sd">   &quot;&quot;&quot;</span>
   <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">db_name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">         Fill the pandas_datase</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">verb</span><span class="p">(</span><span class="s2">&quot;Init of covid19.DataBase()&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">database_name</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">get_db_list_dict</span><span class="p">()</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">database_type</span> <span class="o">=</span> <span class="n">get_db_list_dict</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">available_options</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;nonneg&#39;</span><span class="p">,</span> <span class="s1">&#39;nofillnan&#39;</span><span class="p">,</span> <span class="s1">&#39;smooth7&#39;</span><span class="p">,</span> <span class="s1">&#39;sumall&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">available_keys_words</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dates</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">database_columns_not_computed</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">db</span> <span class="o">=</span> <span class="n">db_name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">geo_all</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">database_url</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">db_world</span><span class="o">=</span><span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">databaseinfo</span> <span class="o">=</span> <span class="n">report</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">database_name</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">CoaDbError</span><span class="p">(</span><span class="s1">&#39;Unknown &#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span> <span class="o">+</span> <span class="s1">&#39;. Available database so far in PyCoa are : &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">database_name</span><span class="p">),</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">get_db_list_dict</span><span class="p">()[</span><span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;nation&#39;</span><span class="p">:</span> <span class="c1"># world wide db</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">db_world</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">geo</span> <span class="o">=</span> <span class="n">coge</span><span class="o">.</span><span class="n">GeoManager</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">geo_all</span> <span class="o">=</span> <span class="s1">&#39;world&#39;</span>
                <span class="k">else</span><span class="p">:</span> <span class="c1"># local db</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">db_world</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">geo</span> <span class="o">=</span> <span class="n">coge</span><span class="o">.</span><span class="n">GeoCountry</span><span class="p">(</span><span class="n">get_db_list_dict</span><span class="p">()[</span><span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
                    <span class="k">if</span> <span class="n">get_db_list_dict</span><span class="p">()[</span><span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;region&#39;</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">geo_all</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">geo</span><span class="o">.</span><span class="n">get_region_list</span><span class="p">()</span>
                    <span class="k">elif</span> <span class="n">get_db_list_dict</span><span class="p">()[</span><span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;subregion&#39;</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">geo_all</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">geo</span><span class="o">.</span><span class="n">get_subregion_list</span><span class="p">()</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">CoaError</span><span class="p">(</span><span class="s1">&#39;Granularity problem, neither region or subregion&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">set_display</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">geo</span><span class="p">)</span>

                <span class="c1"># specific reading of data according to the db</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span> <span class="o">==</span> <span class="s1">&#39;jhu&#39;</span><span class="p">:</span>
                    <span class="n">info</span><span class="p">(</span><span class="s1">&#39;JHU aka Johns Hopkins database selected ...&#39;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">return_jhu_pandas</span><span class="p">()</span>
                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span> <span class="o">==</span> <span class="s1">&#39;jhu-usa&#39;</span><span class="p">:</span> <span class="c1">#USA</span>
                    <span class="n">info</span><span class="p">(</span><span class="s1">&#39;USA, JHU aka Johns Hopkins database selected ...&#39;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">return_jhu_pandas</span><span class="p">()</span>
                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span> <span class="o">==</span> <span class="s1">&#39;dpc&#39;</span><span class="p">:</span> <span class="c1">#ITA</span>
                    <span class="n">info</span><span class="p">(</span><span class="s1">&#39;ITA, Dipartimento della Protezione Civile database selected ...&#39;</span><span class="p">)</span>
                    <span class="n">rename_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;data&#39;</span><span class="p">:</span> <span class="s1">&#39;date&#39;</span><span class="p">,</span> <span class="s1">&#39;denominazione_regione&#39;</span><span class="p">:</span> <span class="s1">&#39;location&#39;</span><span class="p">,</span> <span class="s1">&#39;totale_casi&#39;</span><span class="p">:</span> <span class="s1">&#39;tot_cases&#39;</span><span class="p">,</span><span class="s1">&#39;deceduti&#39;</span><span class="p">:</span><span class="s1">&#39;tot_deaths&#39;</span><span class="p">}</span>
                    <span class="n">dpc1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">csv2pandas</span><span class="p">(</span><span class="s1">&#39;https://raw.githubusercontent.com/pcm-dpc/COVID-19/master/dati-regioni/dpc-covid19-ita-regioni.csv&#39;</span><span class="p">,</span>\
                    <span class="n">rename_columns</span> <span class="o">=</span> <span class="n">rename_dict</span><span class="p">,</span> <span class="n">separator</span><span class="o">=</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>
                    <span class="c1">#dpc1 = self.csv2pandas(&quot;https://github.com/pcm-dpc/COVID-19/raw/master/dati-province/dpc-covid19-ita-province.csv&quot;,\</span>
                    <span class="n">columns_keeped</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;tot_cases&#39;</span><span class="p">,</span><span class="s1">&#39;tot_deaths&#39;</span><span class="p">]</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">return_structured_pandas</span><span class="p">(</span><span class="n">dpc1</span><span class="p">,</span> <span class="n">columns_keeped</span><span class="o">=</span><span class="n">columns_keeped</span><span class="p">)</span>
                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span> <span class="o">==</span> <span class="s1">&#39;rki&#39;</span><span class="p">:</span> <span class="c1"># DEU</span>
                    <span class="n">info</span><span class="p">(</span><span class="s1">&#39;DEU, Robert Koch Institut data selected ...&#39;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">return_jhu_pandas</span><span class="p">()</span>
                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span> <span class="o">==</span> <span class="s1">&#39;dgs&#39;</span><span class="p">:</span> <span class="c1"># PRT</span>
                    <span class="n">info</span><span class="p">(</span><span class="s1">&#39;PRT, Direcção Geral de Saúde - Ministério da Saúde Português data selected ...&#39;</span><span class="p">)</span>
                    <span class="n">rename_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;data&#39;</span><span class="p">:</span> <span class="s1">&#39;date&#39;</span><span class="p">,</span><span class="s1">&#39;concelho&#39;</span><span class="p">:</span><span class="s1">&#39;location&#39;</span><span class="p">,</span><span class="s1">&#39;confirmados_1&#39;</span><span class="p">:</span><span class="s1">&#39;tot_cases&#39;</span><span class="p">}</span>
                    <span class="n">url</span><span class="o">=</span><span class="s1">&#39;https://raw.githubusercontent.com/dssg-pt/covid19pt-data/master/data_concelhos_new.csv&#39;</span>
                    <span class="n">prt_data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">csv2pandas</span><span class="p">(</span><span class="n">url</span><span class="p">,</span><span class="n">separator</span><span class="o">=</span><span class="s1">&#39;,&#39;</span><span class="p">,</span><span class="n">rename_columns</span> <span class="o">=</span> <span class="n">rename_dict</span><span class="p">)</span>
                    <span class="n">columns_keeped</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;tot_cases&#39;</span><span class="p">]</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">return_structured_pandas</span><span class="p">(</span><span class="n">prt_data</span><span class="p">,</span> <span class="n">columns_keeped</span><span class="o">=</span><span class="n">columns_keeped</span><span class="p">)</span>
                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span> <span class="o">==</span> <span class="s1">&#39;obepine&#39;</span> <span class="p">:</span> <span class="c1"># FRA</span>
                    <span class="n">info</span><span class="p">(</span><span class="s1">&#39;FRA, réseau Obepine, surveillance Sars-Cov-2 dans les eaux usées&#39;</span><span class="p">)</span>
                    <span class="n">url</span><span class="o">=</span><span class="s1">&#39;https://www.data.gouv.fr/fr/datasets/r/89196725-56cf-4a83-bab0-170ad1e8ef85&#39;</span>
                    <span class="n">rename_dict</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;Code_Region&#39;</span><span class="p">:</span><span class="s1">&#39;location&#39;</span><span class="p">,</span><span class="s1">&#39;Date&#39;</span><span class="p">:</span><span class="s1">&#39;date&#39;</span><span class="p">,</span><span class="s1">&#39;Indicateur&#39;</span><span class="p">:</span><span class="s1">&#39;idx_obepine&#39;</span><span class="p">}</span>
                    <span class="n">cast</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;Code_Region&#39;</span><span class="p">:</span> <span class="s1">&#39;string&#39;</span><span class="p">}</span>
                    <span class="n">obepine_data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">csv2pandas</span><span class="p">(</span><span class="n">url</span><span class="p">,</span><span class="n">cast</span><span class="o">=</span><span class="n">cast</span><span class="p">,</span><span class="n">separator</span><span class="o">=</span><span class="s1">&#39;;&#39;</span><span class="p">,</span><span class="n">rename_columns</span><span class="o">=</span><span class="n">rename_dict</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">return_structured_pandas</span><span class="p">(</span><span class="n">obepine_data</span><span class="p">,</span><span class="n">columns_keeped</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;idx_obepine&#39;</span><span class="p">])</span>
                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span> <span class="o">==</span> <span class="s1">&#39;escovid19data&#39;</span><span class="p">:</span> <span class="c1"># ESP</span>
                    <span class="n">info</span><span class="p">(</span><span class="s1">&#39;ESP, EsCovid19Data ...&#39;</span><span class="p">)</span>
                    <span class="n">rename_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;ine_code&#39;</span><span class="p">:</span> <span class="s1">&#39;location&#39;</span><span class="p">,</span>\
                        <span class="s1">&#39;deceased&#39;</span><span class="p">:</span><span class="s1">&#39;tot_deaths&#39;</span><span class="p">,</span>\
                        <span class="s1">&#39;cases_accumulated&#39;</span><span class="p">:</span><span class="s1">&#39;tot_cases&#39;</span><span class="p">,</span>\
                        <span class="s1">&#39;activos&#39;</span><span class="p">:</span><span class="s1">&#39;cur_cases&#39;</span><span class="p">,</span>\
                        <span class="s1">&#39;hospitalized&#39;</span><span class="p">:</span><span class="s1">&#39;cur_hosp&#39;</span><span class="p">,</span>\
                        <span class="s1">&#39;hospitalized_accumulated&#39;</span><span class="p">:</span><span class="s1">&#39;tot_hosp&#39;</span><span class="p">,</span>\
                        <span class="s1">&#39;intensive_care&#39;</span><span class="p">:</span><span class="s1">&#39;cur_icu&#39;</span><span class="p">,</span>\
                        <span class="s1">&#39;recovered&#39;</span><span class="p">:</span><span class="s1">&#39;tot_recovered&#39;</span><span class="p">,</span>\
                        <span class="s1">&#39;cases_per_cienmil&#39;</span><span class="p">:</span><span class="s1">&#39;cur_cases_per100k&#39;</span><span class="p">,</span>\
                        <span class="s1">&#39;intensive_care_per_1000000&#39;</span><span class="p">:</span><span class="s1">&#39;cur_icu_per1M&#39;</span><span class="p">,</span>\
                        <span class="s1">&#39;deceassed_per_100000&#39;</span><span class="p">:</span><span class="s1">&#39;tot_deaths_per100k&#39;</span><span class="p">,</span>\
                        <span class="s1">&#39;hospitalized_per_100000&#39;</span><span class="p">:</span><span class="s1">&#39;cur_hosp_per100k&#39;</span><span class="p">,</span>\
                    <span class="p">}</span>
                    <span class="c1">#url=&#39;https://github.com/montera34/escovid19data/raw/master/data/output/covid19-provincias-spain_consolidated.csv&#39;</span>
                    <span class="n">url</span><span class="o">=</span><span class="s1">&#39;https://raw.githubusercontent.com/montera34/escovid19data/master/data/output/covid19-provincias-spain_consolidated.csv&#39;</span>
                    <span class="n">col_names</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">get_local_from_url</span><span class="p">(</span><span class="n">url</span><span class="p">),</span> <span class="n">nrows</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">columns</span>
                    <span class="n">cast</span><span class="o">=</span><span class="p">{</span><span class="n">i</span><span class="p">:</span><span class="s1">&#39;string&#39;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">col_names</span><span class="p">[</span><span class="mi">17</span><span class="p">:]}</span>
                    <span class="n">esp_data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">csv2pandas</span><span class="p">(</span><span class="n">url</span><span class="p">,</span>\
                        <span class="n">separator</span><span class="o">=</span><span class="s1">&#39;,&#39;</span><span class="p">,</span><span class="n">rename_columns</span> <span class="o">=</span> <span class="n">rename_dict</span><span class="p">,</span><span class="n">cast</span> <span class="o">=</span> <span class="n">cast</span><span class="p">)</span>
                    <span class="c1">#print(&#39;Available columns : &#39;)</span>
                    <span class="c1">#display(esp_data.columns)</span>
                    <span class="n">esp_data</span><span class="p">[</span><span class="s1">&#39;location&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">esp_data</span><span class="o">.</span><span class="n">location</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
                    <span class="n">columns_keeped</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">rename_dict</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
                    <span class="n">columns_keeped</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s1">&#39;location&#39;</span><span class="p">)</span>

                    <span class="k">for</span> <span class="n">w</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">columns_keeped</span><span class="p">):</span>
                            <span class="n">esp_data</span><span class="p">[</span><span class="n">w</span><span class="p">]</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">to_numeric</span><span class="p">(</span><span class="n">esp_data</span><span class="p">[</span><span class="n">w</span><span class="p">],</span> <span class="n">errors</span> <span class="o">=</span> <span class="s1">&#39;coerce&#39;</span><span class="p">)</span>

                    <span class="bp">self</span><span class="o">.</span><span class="n">return_structured_pandas</span><span class="p">(</span><span class="n">esp_data</span><span class="p">,</span><span class="n">columns_keeped</span><span class="o">=</span><span class="n">columns_keeped</span><span class="p">)</span>

                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span> <span class="o">==</span> <span class="s1">&#39;sciensano&#39;</span><span class="p">:</span> <span class="c1">#Belgian institute for health,</span>
                    <span class="n">info</span><span class="p">(</span><span class="s1">&#39;BEL, Sciensano Belgian institute for health data  ...&#39;</span><span class="p">)</span>
                    <span class="n">rename_dict</span> <span class="o">=</span> <span class="p">{</span> <span class="s1">&#39;DATE&#39;</span> <span class="p">:</span> <span class="s1">&#39;date&#39;</span><span class="p">,</span>\
                    <span class="s1">&#39;PROVINCE&#39;</span><span class="p">:</span><span class="s1">&#39;location&#39;</span><span class="p">,</span>\
                    <span class="s1">&#39;TOTAL_IN&#39;</span><span class="p">:</span><span class="s1">&#39;cur_hosp&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;TOTAL_IN_ICU&#39;</span><span class="p">:</span><span class="s1">&#39;cur_icu&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;TOTAL_IN_RESP&#39;</span><span class="p">:</span><span class="s1">&#39;cur_resp&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;TOTAL_IN_ECMO&#39;</span><span class="p">:</span><span class="s1">&#39;cur_ecmo&#39;</span><span class="p">}</span>
                    <span class="n">url</span><span class="o">=</span><span class="s1">&#39;https://epistat.sciensano.be/Data/COVID19BE_HOSP.csv&#39;</span>
                    <span class="n">beldata</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">csv2pandas</span><span class="p">(</span><span class="n">url</span><span class="p">,</span><span class="n">separator</span><span class="o">=</span><span class="s1">&#39;,&#39;</span><span class="p">,</span><span class="n">rename_columns</span><span class="o">=</span><span class="n">rename_dict</span><span class="p">)</span>
                    <span class="p">[</span><span class="n">rename_dict</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;DATE&#39;</span><span class="p">,</span><span class="s1">&#39;PROVINCE&#39;</span><span class="p">]]</span>
                    <span class="n">columns_keeped</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">rename_dict</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
                    <span class="n">cvsloc2jsonloc</span><span class="o">=</span><span class="p">{</span>
                    <span class="s1">&#39;BrabantWallon&#39;</span><span class="p">:</span><span class="s1">&#39;Brabant wallon (le)&#39;</span><span class="p">,</span>\
                    <span class="s1">&#39;Brussels&#39;</span><span class="p">:</span><span class="s1">&#39;Région de Bruxelles-Capitale&#39;</span><span class="p">,</span>\
                    <span class="s1">&#39;Limburg&#39;</span><span class="p">:</span><span class="s1">&#39;Limbourg (le)&#39;</span><span class="p">,</span>\
                    <span class="s1">&#39;OostVlaanderen&#39;</span><span class="p">:</span><span class="s1">&#39;Flandre orientale (la)&#39;</span><span class="p">,</span>\
                    <span class="s1">&#39;Hainaut&#39;</span><span class="p">:</span><span class="s1">&#39;Hainaut (le)&#39;</span><span class="p">,</span>\
                    <span class="s1">&#39;VlaamsBrabant&#39;</span><span class="p">:</span><span class="s1">&#39;Brabant flamand (le)&#39;</span><span class="p">,</span>\
                    <span class="s1">&#39;WestVlaanderen&#39;</span><span class="p">:</span><span class="s1">&#39;Flandre occidentale (la)&#39;</span><span class="p">,</span>\
                    <span class="p">}</span>
                    <span class="n">beldata</span><span class="p">[</span><span class="s2">&quot;location&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">cvsloc2jsonloc</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                    <span class="n">beldata</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">beldata</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">],</span><span class="n">errors</span><span class="o">=</span><span class="s1">&#39;coerce&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">date</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">return_structured_pandas</span><span class="p">(</span><span class="n">beldata</span><span class="p">,</span><span class="n">columns_keeped</span><span class="o">=</span><span class="n">columns_keeped</span><span class="p">)</span>
                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span> <span class="o">==</span> <span class="s1">&#39;phe&#39;</span><span class="p">:</span> <span class="c1"># GBR from owid</span>
                    <span class="n">info</span><span class="p">(</span><span class="s1">&#39;GBR, Public Health England data ...&#39;</span><span class="p">)</span>
                    <span class="n">rename_dict</span> <span class="o">=</span> <span class="p">{</span> <span class="s1">&#39;areaCode&#39;</span><span class="p">:</span><span class="s1">&#39;location&#39;</span><span class="p">,</span>\
                        <span class="s1">&#39;cumDeaths28DaysByDeathDate&#39;</span><span class="p">:</span><span class="s1">&#39;tot_deaths&#39;</span><span class="p">,</span>\
                        <span class="s1">&#39;cumCasesBySpecimenDate&#39;</span><span class="p">:</span><span class="s1">&#39;tot_cases&#39;</span><span class="p">,</span>\
                        <span class="s1">&#39;cumLFDTestsBySpecimenDate&#39;</span><span class="p">:</span><span class="s1">&#39;tot_tests&#39;</span><span class="p">,</span>\
                        <span class="s1">&#39;cumPeopleVaccinatedFirstDoseByVaccinationDate&#39;</span><span class="p">:</span><span class="s1">&#39;tot_vacc1&#39;</span><span class="p">,</span>\
                        <span class="s1">&#39;cumPeopleVaccinatedSecondDoseByVaccinationDate&#39;</span><span class="p">:</span><span class="s1">&#39;tot_vacc2&#39;</span><span class="p">,</span>\
                        <span class="c1">#&#39;cumPeopleVaccinatedThirdInjectionByVaccinationDate&#39;:&#39;tot_vacc3&#39;,\</span>
                        <span class="c1">#&#39;covidOccupiedMVBeds&#39;:&#39;cur_icu&#39;,\</span>
                        <span class="c1">#&#39;cumPeopleVaccinatedFirstDoseByVaccinationDate&#39;:&#39;tot_dose1&#39;,\</span>
                        <span class="c1">#&#39;cumPeopleVaccinatedSecondDoseByVaccinationDate&#39;:&#39;tot_dose2&#39;,\</span>
                        <span class="c1">#&#39;hospitalCases&#39;:&#39;cur_hosp&#39;,\</span>
                        <span class="p">}</span>
                    <span class="n">url</span> <span class="o">=</span> <span class="s1">&#39;https://api.coronavirus.data.gov.uk/v2/data?areaType=ltla&#39;</span>
                    <span class="k">for</span> <span class="n">w</span> <span class="ow">in</span> <span class="n">rename_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                        <span class="k">if</span> <span class="n">w</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;areaCode&#39;</span><span class="p">]:</span>
                            <span class="n">url</span><span class="o">=</span><span class="n">url</span><span class="o">+</span><span class="s1">&#39;&amp;metric=&#39;</span><span class="o">+</span><span class="n">w</span>
                    <span class="n">url</span> <span class="o">=</span> <span class="n">url</span><span class="o">+</span><span class="s1">&#39;&amp;format=csv&#39;</span>
                    <span class="n">gbr_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">csv2pandas</span><span class="p">(</span><span class="n">url</span><span class="p">,</span><span class="n">separator</span><span class="o">=</span><span class="s1">&#39;,&#39;</span><span class="p">,</span><span class="n">rename_columns</span><span class="o">=</span><span class="n">rename_dict</span><span class="p">)</span>
                    <span class="n">constraints</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;Lineage&#39;</span><span class="p">:</span> <span class="s1">&#39;B.1.617.2&#39;</span><span class="p">}</span>
                    <span class="n">url</span> <span class="o">=</span> <span class="s1">&#39;https://covid-surveillance-data.cog.sanger.ac.uk/download/lineages_by_ltla_and_week.tsv&#39;</span>
                    <span class="n">gbrvar</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">csv2pandas</span><span class="p">(</span><span class="n">url</span><span class="p">,</span><span class="n">separator</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">,</span><span class="n">constraints</span><span class="o">=</span><span class="n">constraints</span><span class="p">,</span><span class="n">rename_columns</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;WeekEndDate&#39;</span><span class="p">:</span> <span class="s1">&#39;date&#39;</span><span class="p">,</span><span class="s1">&#39;LTLA&#39;</span><span class="p">:</span><span class="s1">&#39;location&#39;</span><span class="p">})</span>
                    <span class="n">varname</span> <span class="o">=</span>  <span class="s1">&#39;B.1.617.2&#39;</span>
                    <span class="n">gbr_data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">gbr_data</span><span class="p">,</span><span class="n">gbrvar</span><span class="p">,</span><span class="n">how</span><span class="o">=</span><span class="s2">&quot;outer&quot;</span><span class="p">,</span><span class="n">on</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;location&#39;</span><span class="p">,</span><span class="s1">&#39;date&#39;</span><span class="p">])</span>
                    <span class="n">gbr_data</span> <span class="o">=</span> <span class="n">gbr_data</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;Count&#39;</span><span class="p">:</span><span class="s1">&#39;cur_&#39;</span><span class="o">+</span><span class="n">varname</span><span class="p">})</span>
                    <span class="n">columns_keeped</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">rename_dict</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
                    <span class="n">columns_keeped</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;cur_&#39;</span><span class="o">+</span><span class="n">varname</span><span class="p">)</span>
                    <span class="n">columns_keeped</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s1">&#39;location&#39;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">return_structured_pandas</span><span class="p">(</span><span class="n">gbr_data</span><span class="p">,</span><span class="n">columns_keeped</span><span class="o">=</span><span class="n">columns_keeped</span><span class="p">)</span>
                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span> <span class="o">==</span> <span class="s1">&#39;moh&#39;</span><span class="p">:</span> <span class="c1"># MYS</span>
                    <span class="n">info</span><span class="p">(</span><span class="s1">&#39;Malaysia moh covid19-public database selected ...&#39;</span><span class="p">)</span>
                    <span class="n">rename_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;state&#39;</span><span class="p">:</span> <span class="s1">&#39;location&#39;</span><span class="p">}</span>
                    <span class="n">moh1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">csv2pandas</span><span class="p">(</span><span class="s2">&quot;https://raw.githubusercontent.com/MoH-Malaysia/covid19-public/main/epidemic/cases_state.csv&quot;</span><span class="p">,</span><span class="n">rename_columns</span><span class="o">=</span><span class="n">rename_dict</span><span class="p">,</span><span class="n">separator</span><span class="o">=</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>
                    <span class="n">moh1</span><span class="p">[</span><span class="s1">&#39;tot_cases&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">moh1</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;location&#39;</span><span class="p">])[</span><span class="s1">&#39;cases_new&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">cumsum</span><span class="p">()</span>

                    <span class="n">moh2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">csv2pandas</span><span class="p">(</span><span class="s2">&quot;https://raw.githubusercontent.com/MoH-Malaysia/covid19-public/main/epidemic/hospital.csv&quot;</span><span class="p">,</span><span class="n">rename_columns</span><span class="o">=</span><span class="n">rename_dict</span><span class="p">,</span><span class="n">separator</span><span class="o">=</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>
                    <span class="n">moh3</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">csv2pandas</span><span class="p">(</span><span class="s2">&quot;https://raw.githubusercontent.com/MoH-Malaysia/covid19-public/main/epidemic/icu.csv&quot;</span><span class="p">,</span><span class="n">rename_columns</span><span class="o">=</span><span class="n">rename_dict</span><span class="p">,</span><span class="n">separator</span><span class="o">=</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>
                    <span class="n">moh4</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">csv2pandas</span><span class="p">(</span><span class="s2">&quot;https://raw.githubusercontent.com/CITF-Malaysia/citf-public/main/vaccination/vax_state.csv&quot;</span><span class="p">,</span><span class="n">rename_columns</span><span class="o">=</span><span class="n">rename_dict</span><span class="p">,</span><span class="n">separator</span><span class="o">=</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>

                    <span class="n">list_moh</span> <span class="o">=</span> <span class="p">[</span><span class="n">moh1</span><span class="p">,</span><span class="n">moh2</span><span class="p">,</span><span class="n">moh3</span><span class="p">,</span><span class="n">moh4</span><span class="p">]</span>
                    <span class="n">result</span> <span class="o">=</span> <span class="n">reduce</span><span class="p">(</span><span class="k">lambda</span> <span class="n">left</span><span class="p">,</span> <span class="n">right</span><span class="p">:</span> <span class="n">left</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">right</span><span class="p">,</span> <span class="n">how</span> <span class="o">=</span> <span class="s1">&#39;outer&#39;</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;location&#39;</span><span class="p">,</span><span class="s1">&#39;date&#39;</span><span class="p">]),</span> <span class="n">list_moh</span><span class="p">)</span>
                    <span class="n">columns_keeped</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;tot_cases&#39;</span><span class="p">,</span><span class="s1">&#39;hosp_covid&#39;</span><span class="p">,</span><span class="s1">&#39;daily_partial&#39;</span><span class="p">,</span><span class="s1">&#39;daily_full&#39;</span><span class="p">,</span><span class="s1">&#39;icu_covid&#39;</span><span class="p">,</span><span class="s1">&#39;beds_icu_covid&#39;</span><span class="p">]</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">return_structured_pandas</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">columns_keeped</span> <span class="o">=</span> <span class="n">columns_keeped</span><span class="p">)</span>
                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span> <span class="o">==</span> <span class="s1">&#39;minciencia&#39;</span><span class="p">:</span> <span class="c1"># CHL</span>
                    <span class="n">info</span><span class="p">(</span><span class="s1">&#39;Chile Ministerio de Ciencia, Tecnología, Conocimiento, e Innovación database selected ...&#39;</span><span class="p">)</span>
                    <span class="n">cast</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;Codigo comuna&#39;</span><span class="p">:</span> <span class="s1">&#39;string&#39;</span><span class="p">}</span>
                    <span class="n">rename_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;Codigo comuna&#39;</span><span class="p">:</span><span class="s1">&#39;location&#39;</span><span class="p">,</span><span class="s1">&#39;Poblacion&#39;</span><span class="p">:</span><span class="s1">&#39;population&#39;</span><span class="p">,</span><span class="s1">&#39;Fecha&#39;</span><span class="p">:</span><span class="s1">&#39;date&#39;</span><span class="p">,</span><span class="s1">&#39;Casos confirmados&#39;</span><span class="p">:</span><span class="s1">&#39;cases&#39;</span><span class="p">}</span>
                    <span class="n">ciencia</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">csv2pandas</span><span class="p">(</span><span class="s2">&quot;https://raw.githubusercontent.com/MinCiencia/Datos-COVID19/master/output/producto1/Covid-19_std.csv&quot;</span><span class="p">,</span><span class="n">cast</span><span class="o">=</span><span class="n">cast</span><span class="p">,</span><span class="n">rename_columns</span><span class="o">=</span><span class="n">rename_dict</span><span class="p">,</span><span class="n">separator</span><span class="o">=</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>
                    <span class="n">columns_keeped</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;cases&#39;</span><span class="p">]</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">return_structured_pandas</span><span class="p">(</span><span class="n">ciencia</span><span class="p">,</span> <span class="n">columns_keeped</span> <span class="o">=</span> <span class="n">columns_keeped</span><span class="p">)</span>
                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span> <span class="o">==</span> <span class="s1">&#39;covid19india&#39;</span><span class="p">:</span> <span class="c1"># IND</span>
                    <span class="n">info</span><span class="p">(</span><span class="s1">&#39;COVID19India database selected ...&#39;</span><span class="p">)</span>
                    <span class="n">rename_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;Date&#39;</span><span class="p">:</span> <span class="s1">&#39;date&#39;</span><span class="p">,</span> <span class="s1">&#39;State&#39;</span><span class="p">:</span> <span class="s1">&#39;location&#39;</span><span class="p">}</span>
                    <span class="n">drop_field</span>  <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;State&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;India&#39;</span><span class="p">,</span> <span class="s1">&#39;State Unassigned&#39;</span><span class="p">]}</span>
                    <span class="n">indi</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">csv2pandas</span><span class="p">(</span><span class="s2">&quot;https://api.covid19india.org/csv/latest/states.csv&quot;</span><span class="p">,</span><span class="n">drop_field</span><span class="o">=</span><span class="n">drop_field</span><span class="p">,</span><span class="n">rename_columns</span><span class="o">=</span><span class="n">rename_dict</span><span class="p">,</span><span class="n">separator</span><span class="o">=</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>
                    <span class="n">columns_keeped</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Deceased&#39;</span><span class="p">,</span> <span class="s1">&#39;Confirmed&#39;</span><span class="p">,</span> <span class="s1">&#39;Recovered&#39;</span><span class="p">,</span> <span class="s1">&#39;Tested&#39;</span><span class="p">,]</span> <span class="c1"># Removing &#39;Other&#39; data, not identified</span>
                    <span class="n">indi</span><span class="p">[</span><span class="s1">&#39;location&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">indi</span><span class="p">[</span><span class="s1">&#39;location&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;Andaman and Nicobar Islands&#39;</span><span class="p">,</span><span class="s1">&#39;Andaman and Nicobar&#39;</span><span class="p">))</span>
                    <span class="n">locationvariant</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">geo</span><span class="o">.</span><span class="n">get_subregion_list</span><span class="p">()[</span><span class="s1">&#39;variation_name_subregion&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to_list</span><span class="p">()</span>
                    <span class="n">locationgeo</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">geo</span><span class="o">.</span><span class="n">get_subregion_list</span><span class="p">()[</span><span class="s1">&#39;name_subregion&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to_list</span><span class="p">()</span>
                    <span class="k">def</span> <span class="nf">fusion</span><span class="p">(</span><span class="n">pan</span><span class="p">,</span> <span class="n">new</span><span class="p">,</span> <span class="n">old</span><span class="p">):</span>
                        <span class="n">tmp</span> <span class="o">=</span> <span class="p">(</span><span class="n">pan</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">pan</span><span class="o">.</span><span class="n">location</span><span class="o">.</span><span class="n">isin</span><span class="p">([</span><span class="n">new</span><span class="p">,</span> <span class="n">old</span><span class="p">])]</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;date&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span>
                        <span class="n">tmp</span><span class="p">[</span><span class="s1">&#39;location&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">old</span>
                        <span class="n">tmp</span> <span class="o">=</span> <span class="n">tmp</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
                        <span class="n">cols</span> <span class="o">=</span> <span class="n">tmp</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
                        <span class="n">cols</span> <span class="o">=</span> <span class="n">cols</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">cols</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">:]</span> <span class="o">+</span> <span class="n">cols</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                        <span class="n">tmp</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">[</span><span class="n">cols</span><span class="p">]</span>
                        <span class="n">pan</span> <span class="o">=</span> <span class="n">pan</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="o">~</span><span class="n">pan</span><span class="o">.</span><span class="n">location</span><span class="o">.</span><span class="n">isin</span><span class="p">([</span><span class="n">new</span><span class="p">,</span> <span class="n">old</span><span class="p">])]</span>
                        <span class="n">pan</span> <span class="o">=</span> <span class="n">pan</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tmp</span><span class="p">)</span>
                        <span class="k">return</span> <span class="n">pan</span>

                    <span class="n">indi</span><span class="o">=</span><span class="n">fusion</span><span class="p">(</span><span class="n">indi</span><span class="p">,</span> <span class="s1">&#39;Telangana&#39;</span><span class="p">,</span> <span class="s1">&#39;Andhra Pradesh&#39;</span><span class="p">)</span>
                    <span class="n">indi</span><span class="o">=</span><span class="n">fusion</span><span class="p">(</span><span class="n">indi</span><span class="p">,</span><span class="s1">&#39;Ladakh&#39;</span><span class="p">,</span> <span class="s1">&#39;Jammu and Kashmir&#39;</span><span class="p">)</span>
                    <span class="c1"># change name according to json one</span>
                    <span class="n">oldnew</span> <span class="o">=</span> <span class="p">{}</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">indi</span><span class="o">.</span><span class="n">location</span><span class="o">.</span><span class="n">unique</span><span class="p">():</span>
                        <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">l</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">locationgeo</span><span class="p">,</span><span class="n">locationvariant</span><span class="p">):</span>
                            <span class="k">if</span> <span class="n">l</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                                <span class="n">oldnew</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">k</span>
                    <span class="n">indi</span><span class="p">[</span><span class="s1">&#39;location&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">indi</span><span class="p">[</span><span class="s1">&#39;location&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">oldnew</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">return_structured_pandas</span><span class="p">(</span><span class="n">indi</span><span class="p">,</span><span class="n">columns_keeped</span> <span class="o">=</span> <span class="n">columns_keeped</span><span class="p">)</span>
                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span> <span class="o">==</span> <span class="s1">&#39;covidtracking&#39;</span><span class="p">:</span>
                    <span class="n">info</span><span class="p">(</span><span class="s1">&#39;USA, CovidTracking.com database selected... ...&#39;</span><span class="p">)</span>
                    <span class="n">rename_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;state&#39;</span><span class="p">:</span> <span class="s1">&#39;location&#39;</span><span class="p">,</span>
                            <span class="s1">&#39;death&#39;</span><span class="p">:</span> <span class="s1">&#39;tot_death&#39;</span><span class="p">,</span>
                            <span class="s1">&#39;hospitalizedCumulative&#39;</span><span class="p">:</span> <span class="s1">&#39;tot_hosp&#39;</span><span class="p">,</span>
                            <span class="s1">&#39;hospitalizedCurrently&#39;</span><span class="p">:</span> <span class="s1">&#39;cur_hosp&#39;</span><span class="p">,</span>
                            <span class="s1">&#39;inIcuCumulative&#39;</span><span class="p">:</span> <span class="s1">&#39;tot_icu&#39;</span><span class="p">,</span>
                            <span class="s1">&#39;inIcuCurrently&#39;</span><span class="p">:</span> <span class="s1">&#39;cur_icu&#39;</span><span class="p">,</span>
                            <span class="s1">&#39;negative&#39;</span><span class="p">:</span> <span class="s1">&#39;tot_neg_test&#39;</span><span class="p">,</span>
                            <span class="s1">&#39;positive&#39;</span><span class="p">:</span> <span class="s1">&#39;tot_pos_test&#39;</span><span class="p">,</span>
                            <span class="s1">&#39;onVentilatorCumulative&#39;</span><span class="p">:</span> <span class="s1">&#39;tot_onVentilator&#39;</span><span class="p">,</span>
                            <span class="s1">&#39;onVentilatorCurrently&#39;</span><span class="p">:</span> <span class="s1">&#39;cur_onVentilator&#39;</span><span class="p">,</span>
                            <span class="s1">&#39;totalTestResults&#39;</span><span class="p">:</span><span class="s1">&#39;tot_test&#39;</span><span class="p">,</span>
                            <span class="p">}</span>
                    <span class="n">ctusa</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">csv2pandas</span><span class="p">(</span><span class="s2">&quot;https://covidtracking.com/data/download/all-states-history.csv&quot;</span><span class="p">,</span>
                        <span class="n">rename_columns</span> <span class="o">=</span> <span class="n">rename_dict</span><span class="p">,</span> <span class="n">separator</span> <span class="o">=</span> <span class="s1">&#39;,&#39;</span><span class="p">)</span>
                    <span class="n">columns_keeped</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">rename_dict</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
                    <span class="n">columns_keeped</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s1">&#39;location&#39;</span><span class="p">)</span> <span class="c1"># is already expected</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">return_structured_pandas</span><span class="p">(</span><span class="n">ctusa</span><span class="p">,</span> <span class="n">columns_keeped</span> <span class="o">=</span> <span class="n">columns_keeped</span><span class="p">)</span>
                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span> <span class="o">==</span> <span class="s1">&#39;spf&#39;</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span> <span class="o">==</span> <span class="s1">&#39;spfnational&#39;</span><span class="p">:</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span> <span class="o">==</span> <span class="s1">&#39;spfnational&#39;</span><span class="p">:</span>
                        <span class="n">rename_dict</span> <span class="o">=</span> <span class="p">{</span>
                        <span class="s1">&#39;patients_reanimation&#39;</span><span class="p">:</span><span class="s1">&#39;cur_reanimation&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;patients_hospitalises&#39;</span><span class="p">:</span><span class="s1">&#39;cur_hospitalises&#39;</span>
                        <span class="p">}</span>
                        <span class="n">columns_keeped</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;cur_reanimation&#39;</span><span class="p">,</span><span class="s1">&#39;cur_hospitalises&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;total_cas_confirmes&#39;</span><span class="p">,</span><span class="s1">&#39;total_deces_hopital&#39;</span><span class="p">,</span><span class="s1">&#39;total_patients_gueris&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;total_deces_ehpad&#39;</span><span class="p">,</span><span class="s1">&#39;total_cas_confirmes_ehpad&#39;</span><span class="p">,</span><span class="s1">&#39;total_cas_possibles_ehpad&#39;</span><span class="p">]</span>

                        <span class="n">spfnat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">csv2pandas</span><span class="p">(</span><span class="s2">&quot;https://www.data.gouv.fr/fr/datasets/r/d3a98a30-893f-47f7-96c5-2f4bcaaa0d71&quot;</span><span class="p">,</span>
                        <span class="n">rename_columns</span> <span class="o">=</span> <span class="n">rename_dict</span><span class="p">,</span> <span class="n">separator</span> <span class="o">=</span> <span class="s1">&#39;,&#39;</span><span class="p">)</span>
                        <span class="n">colcast</span><span class="o">=</span><span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">columns_keeped</span><span class="p">]</span>

                        <span class="n">spfnat</span><span class="p">[</span><span class="n">colcast</span><span class="p">]</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">to_numeric</span><span class="p">(</span><span class="n">spfnat</span><span class="p">[</span><span class="n">colcast</span><span class="p">]</span><span class="o">.</span><span class="n">stack</span><span class="p">(),</span><span class="n">errors</span> <span class="o">=</span> <span class="s1">&#39;coerce&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">unstack</span><span class="p">()</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">return_structured_pandas</span><span class="p">(</span><span class="n">spfnat</span><span class="p">,</span> <span class="n">columns_keeped</span><span class="o">=</span><span class="n">columns_keeped</span><span class="p">)</span> <span class="c1"># with &#39;tot_dc&#39; first</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">info</span><span class="p">(</span><span class="s1">&#39;SPF aka Sante Publique France database selected (France departement granularity) ...&#39;</span><span class="p">)</span>
                        <span class="n">info</span><span class="p">(</span><span class="s1">&#39;... Seven different databases from SPF will be parsed ...&#39;</span><span class="p">)</span>
                        <span class="c1"># https://www.data.gouv.fr/fr/datasets/donnees-hospitalieres-relatives-a-lepidemie-de-covid-19/</span>
                        <span class="c1"># Parse and convert spf data structure to JHU one for historical raison</span>
                        <span class="c1"># hosp Number of people currently hospitalized</span>
                        <span class="c1"># rea  Number of people currently in resuscitation or critical care</span>
                        <span class="c1"># rad      Total amount of patient that returned home</span>
                        <span class="c1"># dc       Total amout of deaths at the hospital</span>
                        <span class="c1"># &#39;sexe&#39; == 0 male + female</span>
                        <span class="n">cast</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;dep&#39;</span><span class="p">:</span> <span class="s1">&#39;string&#39;</span><span class="p">}</span>
                        <span class="n">rename</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;jour&#39;</span><span class="p">:</span> <span class="s1">&#39;date&#39;</span><span class="p">,</span> <span class="s1">&#39;dep&#39;</span><span class="p">:</span> <span class="s1">&#39;location&#39;</span><span class="p">}</span>
                        <span class="n">cast</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;HospConv&#39;</span><span class="p">:</span><span class="s1">&#39;string&#39;</span><span class="p">,</span><span class="s1">&#39;SSR_USLD&#39;</span><span class="p">:</span><span class="s1">&#39;string&#39;</span><span class="p">,</span><span class="s1">&#39;autres&#39;</span><span class="p">:</span><span class="s1">&#39;string&#39;</span><span class="p">})</span>
                        <span class="n">constraints</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;sexe&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">}</span>
                        <span class="n">spf1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">csv2pandas</span><span class="p">(</span><span class="s2">&quot;https://www.data.gouv.fr/fr/datasets/r/63352e38-d353-4b54-bfd1-f1b3ee1cabd7&quot;</span><span class="p">,</span>
                                      <span class="n">rename_columns</span> <span class="o">=</span> <span class="n">rename</span><span class="p">,</span> <span class="n">constraints</span> <span class="o">=</span> <span class="n">constraints</span><span class="p">,</span> <span class="n">cast</span> <span class="o">=</span> <span class="n">cast</span><span class="p">)</span>
                        <span class="c1"># https://www.data.gouv.fr/fr/datasets/donnees-hospitalieres-relatives-a-lepidemie-de-covid-19/</span>
                        <span class="c1"># All data are incidence. → integrated later in the code</span>
                        <span class="c1"># incid_hosp	string 	Nombre quotidien de personnes nouvellement hospitalisées</span>
                        <span class="c1"># incid_rea	integer	Nombre quotidien de nouvelles admissions en réanimation</span>
                        <span class="c1"># incid_dc	integer	Nombre quotidien de personnes nouvellement décédées</span>
                        <span class="c1"># incid_rad	integer	Nombre quotidien de nouveaux retours à domicile</span>
                        <span class="n">spf2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">csv2pandas</span><span class="p">(</span><span class="s2">&quot;https://www.data.gouv.fr/fr/datasets/r/6fadff46-9efd-4c53-942a-54aca783c30c&quot;</span><span class="p">,</span>
                                      <span class="n">rename_columns</span> <span class="o">=</span> <span class="n">rename</span><span class="p">,</span> <span class="n">cast</span> <span class="o">=</span> <span class="n">cast</span><span class="p">)</span>
                        <span class="c1"># https://www.data.gouv.fr/fr/datasets/donnees-relatives-aux-resultats-des-tests-virologiques-covid-19/</span>
                        <span class="c1"># T       Number of tests performed daily → integrated later</span>
                        <span class="c1"># P       Number of positive tests daily → integrated later</span>
                        <span class="n">constraints</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;cl_age90&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">}</span>
                        <span class="n">spf3</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">csv2pandas</span><span class="p">(</span><span class="s2">&quot;https://www.data.gouv.fr/fr/datasets/r/406c6a23-e283-4300-9484-54e78c8ae675&quot;</span><span class="p">,</span>
                                      <span class="n">rename_columns</span> <span class="o">=</span> <span class="n">rename</span><span class="p">,</span> <span class="n">constraints</span> <span class="o">=</span> <span class="n">constraints</span><span class="p">,</span> <span class="n">cast</span> <span class="o">=</span> <span class="n">cast</span><span class="p">)</span>
                        <span class="c1"># https://www.data.gouv.fr/fr/datasets/donnees-relatives-aux-personnes-vaccinees-contre-la-covid-19-1</span>
                        <span class="c1"># Les données issues du système d’information Vaccin Covid permettent de dénombrer en temps quasi réel</span>
                        <span class="c1"># (J-1), le nombre de personnes ayant reçu une injection de vaccin anti-covid en tenant compte du nombre</span>
                        <span class="c1"># de doses reçues, de l’âge, du sexe ainsi que du niveau géographique (national, régional et</span>
                        <span class="c1"># départemental).</span>
                        <span class="n">constraints</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;vaccin&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">}</span> <span class="c1"># 0 means all vaccines</span>
                        <span class="c1"># previously : https://www.data.gouv.fr/fr/datasets/r/4f39ec91-80d7-4602-befb-4b522804c0af</span>
                        <span class="n">spf5</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">csv2pandas</span><span class="p">(</span><span class="s2">&quot;https://www.data.gouv.fr/fr/datasets/r/535f8686-d75d-43d9-94b3-da8cdf850634&quot;</span><span class="p">,</span>
                            <span class="n">rename_columns</span> <span class="o">=</span> <span class="n">rename</span><span class="p">,</span> <span class="n">constraints</span> <span class="o">=</span> <span class="n">constraints</span><span class="p">,</span> <span class="n">separator</span> <span class="o">=</span> <span class="s1">&#39;;&#39;</span><span class="p">,</span> <span class="n">encoding</span> <span class="o">=</span> <span class="s2">&quot;ISO-8859-1&quot;</span><span class="p">,</span> <span class="n">cast</span> <span class="o">=</span> <span class="n">cast</span><span class="p">)</span>
                        <span class="c1">#print(spf5)</span>
                        <span class="c1"># https://www.data.gouv.fr/fr/datasets/indicateurs-de-suivi-de-lepidemie-de-covid-19/#_</span>
                        <span class="c1"># tension hospitaliere</span>
                        <span class="c1">#&#39;date&#39;, &#39;location&#39;, &#39;region&#39;, &#39;libelle_reg&#39;, &#39;libelle_dep&#39;, &#39;tx_incid&#39;,</span>
                        <span class="c1"># &#39;R&#39;, &#39;taux_occupation_sae&#39;, &#39;tx_pos&#39;, &#39;tx_incid_couleur&#39;, &#39;R_couleur&#39;,</span>
                        <span class="c1"># &#39;taux_occupation_sae_couleur&#39;, &#39;tx_pos_couleur&#39;, &#39;nb_orange&#39;,</span>
                        <span class="c1"># &#39;nb_rouge&#39;]</span>
                        <span class="c1"># Vert : taux d’occupation compris entre 0 et 40% ;</span>
                        <span class="c1"># Orange : taux d’occupation compris entre 40 et 60% ;</span>
                        <span class="c1"># Rouge : taux d&#39;occupation supérieur à 60%.</span>
                        <span class="c1"># R0</span>
                        <span class="c1"># vert : R0 entre 0 et 1 ;</span>
                        <span class="c1"># Orange : R0 entre 1 et 1,5 ;</span>
                        <span class="c1"># Rouge : R0 supérieur à 1,5.</span>
                        <span class="n">cast</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;departement&#39;</span><span class="p">:</span> <span class="s1">&#39;string&#39;</span><span class="p">}</span>
                        <span class="n">rename</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;extract_date&#39;</span><span class="p">:</span> <span class="s1">&#39;date&#39;</span><span class="p">,</span> <span class="s1">&#39;departement&#39;</span><span class="p">:</span> <span class="s1">&#39;location&#39;</span><span class="p">}</span>
                        <span class="c1">#columns_skipped=[&#39;region&#39;,&#39;libelle_reg&#39;,&#39;libelle_dep&#39;,&#39;tx_incid_couleur&#39;,&#39;R_couleur&#39;,\</span>
                        <span class="c1">#&#39;taux_occupation_sae_couleur&#39;,&#39;tx_pos_couleur&#39;,&#39;nb_orange&#39;,&#39;nb_rouge&#39;]</span>
                        <span class="n">spf4</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">csv2pandas</span><span class="p">(</span><span class="s2">&quot;https://www.data.gouv.fr/fr/datasets/r/4acad602-d8b1-4516-bc71-7d5574d5f33e&quot;</span><span class="p">,</span>
                                    <span class="n">rename_columns</span> <span class="o">=</span> <span class="n">rename</span><span class="p">,</span> <span class="n">separator</span><span class="o">=</span><span class="s1">&#39;,&#39;</span><span class="p">,</span> <span class="n">encoding</span> <span class="o">=</span> <span class="s2">&quot;ISO-8859-1&quot;</span><span class="p">,</span> <span class="n">cast</span><span class="o">=</span><span class="n">cast</span><span class="p">)</span>

                        <span class="c1">#https://www.data.gouv.fr/fr/datasets/donnees-de-laboratoires-pour-le-depistage-indicateurs-sur-les-variants/</span>
                        <span class="c1">#Prc_tests_PCR_TA_crible = % de tests PCR criblés parmi les PCR positives</span>
                        <span class="c1">#Prc_susp_501Y_V1 = % de tests avec suspicion de variant 20I/501Y.V1 (UK)</span>
                        <span class="c1">#Prc_susp_501Y_V2_3 = % de tests avec suspicion de variant 20H/501Y.V2 (ZA) ou 20J/501Y.V3 (BR)</span>
                        <span class="c1">#Prc_susp_IND = % de tests avec une détection de variant mais non identifiable</span>
                        <span class="c1">#Prc_susp_ABS = % de tests avec une absence de détection de variant</span>
                        <span class="c1">#Royaume-Uni (UK): code Nexstrain= 20I/501Y.V1</span>
                        <span class="c1">#Afrique du Sud (ZA) : code Nexstrain= 20H/501Y.V2</span>
                        <span class="c1">#Brésil (BR) : code Nexstrain= 20J/501Y.V3</span>

                        <span class="n">cast</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;dep&#39;</span><span class="p">:</span> <span class="s1">&#39;string&#39;</span><span class="p">}</span>
                        <span class="n">rename</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;dep&#39;</span><span class="p">:</span> <span class="s1">&#39;location&#39;</span><span class="p">}</span>
                        <span class="n">constraints</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;cl_age90&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">}</span>
                        <span class="n">spf6</span> <span class="o">=</span>  <span class="bp">self</span><span class="o">.</span><span class="n">csv2pandas</span><span class="p">(</span><span class="s2">&quot;https://www.data.gouv.fr/fr/datasets/r/16f4fd03-797f-4616-bca9-78ff212d06e8&quot;</span><span class="p">,</span>
                                     <span class="n">constraints</span> <span class="o">=</span> <span class="n">constraints</span><span class="p">,</span><span class="n">rename_columns</span> <span class="o">=</span> <span class="n">rename</span><span class="p">,</span> <span class="n">separator</span><span class="o">=</span><span class="s1">&#39;;&#39;</span><span class="p">,</span> <span class="n">cast</span><span class="o">=</span><span class="n">cast</span><span class="p">)</span>

                        <span class="n">constraints</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;age_18ans&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">}</span>
                        <span class="n">spf7</span> <span class="o">=</span>  <span class="bp">self</span><span class="o">.</span><span class="n">csv2pandas</span><span class="p">(</span><span class="s2">&quot;https://www.data.gouv.fr/fr/datasets/r/c0f59f00-3ab2-4f31-8a05-d317b43e9055&quot;</span><span class="p">,</span>
                                    <span class="n">constraints</span> <span class="o">=</span> <span class="n">constraints</span><span class="p">,</span> <span class="n">rename_columns</span> <span class="o">=</span> <span class="n">rename</span><span class="p">,</span> <span class="n">separator</span><span class="o">=</span><span class="s1">&#39;;&#39;</span><span class="p">,</span> <span class="n">cast</span><span class="o">=</span><span class="n">cast</span><span class="p">)</span>
                        <span class="c1">#Mutation d&#39;intérêt :</span>
                        <span class="c1">#A = E484K</span>
                        <span class="c1">#B = E484Q</span>
                        <span class="c1">#C = L452R</span>
                        <span class="n">spf8</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">csv2pandas</span><span class="p">(</span><span class="s2">&quot;https://www.data.gouv.fr/fr/datasets/r/4d3e5a8b-9649-4c41-86ec-5420eb6b530c&quot;</span><span class="p">,</span>
                        <span class="n">rename_columns</span> <span class="o">=</span> <span class="n">rename</span><span class="p">,</span> <span class="n">separator</span><span class="o">=</span><span class="s1">&#39;;&#39;</span><span class="p">,</span><span class="n">cast</span><span class="o">=</span><span class="n">cast</span><span class="p">)</span>
                        <span class="c1">#spf8keeped = list(spf8.columns)[2:]</span>
                        <span class="n">rename</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;date_de_passage&#39;</span><span class="p">:</span><span class="s1">&#39;date&#39;</span><span class="p">,</span><span class="s1">&#39;dep&#39;</span><span class="p">:</span><span class="s1">&#39;location&#39;</span><span class="p">}</span>
                        <span class="n">spf9</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">csv2pandas</span><span class="p">(</span><span class="s2">&quot;https://www.data.gouv.fr/en/datasets/r/eceb9fb4-3ebc-4da3-828d-f5939712600a&quot;</span><span class="p">,</span>
                        <span class="n">rename_columns</span> <span class="o">=</span> <span class="n">rename</span><span class="p">,</span> <span class="n">separator</span><span class="o">=</span><span class="s1">&#39;;&#39;</span><span class="p">,</span><span class="n">cast</span><span class="o">=</span><span class="n">cast</span><span class="p">)</span>

                        <span class="n">list_spf</span><span class="o">=</span><span class="p">[</span><span class="n">spf1</span><span class="p">,</span> <span class="n">spf2</span><span class="p">,</span> <span class="n">spf3</span><span class="p">,</span> <span class="n">spf4</span><span class="p">,</span> <span class="n">spf5</span><span class="p">,</span> <span class="n">spf6</span><span class="p">,</span> <span class="n">spf7</span><span class="p">,</span><span class="n">spf8</span><span class="p">,</span><span class="n">spf9</span><span class="p">]</span>

                        <span class="c1">#for i in list_spf:</span>
                        <span class="c1">#    i[&#39;date&#39;] = pd.to_datetime(i[&#39;date&#39;]).apply(lambda x: x if not pd.isnull(x) else &#39;&#39;)</span>
                        <span class="c1">#    print(i.loc[i.date==d1])</span>
                        <span class="c1">#dfs = [df.set_index([&#39;date&#39;, &#39;location&#39;]) for df in list_spf]</span>
                        <span class="n">result</span> <span class="o">=</span> <span class="n">reduce</span><span class="p">(</span><span class="k">lambda</span> <span class="n">left</span><span class="p">,</span> <span class="n">right</span><span class="p">:</span> <span class="n">left</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">right</span><span class="p">,</span> <span class="n">how</span> <span class="o">=</span> <span class="s1">&#39;outer&#39;</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;location&#39;</span><span class="p">,</span><span class="s1">&#39;date&#39;</span><span class="p">]),</span> <span class="n">list_spf</span><span class="p">)</span>
                        <span class="n">result</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="o">~</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;location&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">([</span><span class="s1">&#39;00&#39;</span><span class="p">])]</span>
                        <span class="n">result</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;location&#39;</span><span class="p">,</span><span class="s1">&#39;date&#39;</span><span class="p">])</span>
                        <span class="n">result</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;location&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">([</span><span class="s1">&#39;975&#39;</span><span class="p">,</span><span class="s1">&#39;977&#39;</span><span class="p">,</span><span class="s1">&#39;978&#39;</span><span class="p">,</span><span class="s1">&#39;986&#39;</span><span class="p">,</span><span class="s1">&#39;987&#39;</span><span class="p">]),</span><span class="s1">&#39;location&#39;</span><span class="p">]</span><span class="o">=</span><span class="s1">&#39;980&#39;</span>
                        <span class="k">for</span> <span class="n">w</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;incid_hosp&#39;</span><span class="p">,</span> <span class="s1">&#39;incid_rea&#39;</span><span class="p">,</span> <span class="s1">&#39;incid_rad&#39;</span><span class="p">,</span> <span class="s1">&#39;incid_dc&#39;</span><span class="p">,</span> <span class="s1">&#39;P&#39;</span><span class="p">,</span> <span class="s1">&#39;T&#39;</span><span class="p">,</span> <span class="s1">&#39;n_cum_dose1&#39;</span><span class="p">,</span> <span class="s1">&#39;n_cum_dose2&#39;</span><span class="p">,</span><span class="s1">&#39;n_cum_dose3&#39;</span><span class="p">,</span><span class="s1">&#39;n_cum_dose4&#39;</span><span class="p">,</span><span class="s1">&#39;n_cum_rappel&#39;</span><span class="p">]:</span>
                            <span class="n">result</span><span class="p">[</span><span class="n">w</span><span class="p">]</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">to_numeric</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="n">w</span><span class="p">],</span> <span class="n">errors</span> <span class="o">=</span> <span class="s1">&#39;coerce&#39;</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">w</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;incid_&#39;</span><span class="p">):</span>
                                <span class="n">ww</span> <span class="o">=</span> <span class="n">w</span><span class="p">[</span><span class="mi">6</span><span class="p">:]</span>
                                <span class="n">result</span><span class="p">[</span><span class="n">ww</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;location&#39;</span><span class="p">)[</span><span class="n">ww</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="n">method</span> <span class="o">=</span> <span class="s1">&#39;bfill&#39;</span><span class="p">)</span>
                                <span class="n">result</span><span class="p">[</span><span class="s1">&#39;incid_&#39;</span><span class="o">+</span><span class="n">ww</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;location&#39;</span><span class="p">)[</span><span class="s1">&#39;incid_&#39;</span><span class="o">+</span><span class="n">ww</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="n">method</span> <span class="o">=</span> <span class="s1">&#39;bfill&#39;</span><span class="p">)</span>
                                <span class="c1">#result[&#39;offset_&#39;+w] = result.loc[result.date==min_date][ww]-result.loc[result.date==min_date][&#39;incid_&#39;+ww]</span>
                                <span class="c1">#result[&#39;offset_&#39;+w] = result.groupby(&#39;location&#39;)[&#39;offset_&#39;+w].fillna(method=&#39;ffill&#39;)</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="k">pass</span>
                                <span class="c1">#result[&#39;offset_&#39;+w] = 0</span>
                            <span class="k">if</span> <span class="s1">&#39;n_cum&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">w</span><span class="p">:</span>
                                <span class="n">result</span><span class="p">[</span><span class="s1">&#39;tot_&#39;</span><span class="o">+</span><span class="n">w</span><span class="p">]</span><span class="o">=</span><span class="n">result</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;location&#39;</span><span class="p">])[</span><span class="n">w</span><span class="p">]</span><span class="o">.</span><span class="n">cumsum</span><span class="p">()</span><span class="c1">#+result[&#39;offset_&#39;+w]</span>

                        <span class="c1">#</span>
                        <span class="k">def</span> <span class="nf">dontneeeded</span><span class="p">():</span>
                            <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">result</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                                <span class="k">if</span> <span class="n">col</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;Prc&#39;</span><span class="p">):</span>
                                    <span class="n">result</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">/=</span> <span class="mf">100.</span>
                            <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">result</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                                <span class="k">if</span> <span class="n">col</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;ti&#39;</span><span class="p">):</span>
                                    <span class="n">result</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">/=</span> <span class="mf">7.</span> <span class="c1">#par</span>
                            <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">result</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                                <span class="k">if</span> <span class="n">col</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;tp&#39;</span><span class="p">):</span>
                                    <span class="n">result</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">/=</span> <span class="mf">7.</span> <span class="c1">#par</span>

                        <span class="n">rename_dict</span><span class="o">=</span><span class="p">{</span>
                            <span class="s1">&#39;dc&#39;</span><span class="p">:</span> <span class="s1">&#39;tot_dc&#39;</span><span class="p">,</span>
                            <span class="s1">&#39;hosp&#39;</span><span class="p">:</span> <span class="s1">&#39;cur_hosp&#39;</span><span class="p">,</span>
                            <span class="s1">&#39;rad&#39;</span><span class="p">:</span> <span class="s1">&#39;tot_rad&#39;</span><span class="p">,</span>
                            <span class="s1">&#39;rea&#39;</span><span class="p">:</span> <span class="s1">&#39;cur_rea&#39;</span><span class="p">,</span>
                            <span class="s1">&#39;n_cum_dose1&#39;</span><span class="p">:</span> <span class="s1">&#39;tot_vacc1&#39;</span><span class="p">,</span>
                            <span class="s1">&#39;n_cum_dose2&#39;</span><span class="p">:</span> <span class="s1">&#39;tot_vacc2&#39;</span><span class="p">,</span>
                            <span class="s1">&#39;n_cum_dose3&#39;</span><span class="p">:</span> <span class="s1">&#39;tot_vacc3&#39;</span><span class="p">,</span>
                            <span class="s1">&#39;n_cum_dose4&#39;</span><span class="p">:</span> <span class="s1">&#39;tot_vacc4&#39;</span><span class="p">,</span>
                            <span class="s1">&#39;n_cum_rappel&#39;</span><span class="p">:</span><span class="s1">&#39;tot_rappel_vacc&#39;</span><span class="p">,</span>
                            <span class="s1">&#39;tx_incid&#39;</span><span class="p">:</span> <span class="s1">&#39;cur_idx_tx_incid&#39;</span><span class="p">,</span>
                            <span class="s1">&#39;R&#39;</span><span class="p">:</span> <span class="s1">&#39;cur_idx_R&#39;</span><span class="p">,</span>
                            <span class="s1">&#39;taux_occupation_sae&#39;</span><span class="p">:</span> <span class="s1">&#39;cur_idx_taux_occupation_sae&#39;</span><span class="p">,</span>
                            <span class="s1">&#39;tx_pos&#39;</span><span class="p">:</span> <span class="s1">&#39;cur_taux_pos&#39;</span><span class="p">,</span>
                            <span class="s1">&#39;Prc_tests_PCR_TA_crible&#39;</span><span class="p">:</span><span class="s1">&#39;cur_idx_Prc_tests_PCR_TA_crible&#39;</span><span class="p">,</span>
                            <span class="s1">&#39;Prc_susp_501Y_V1&#39;</span><span class="p">:</span><span class="s1">&#39;cur_idx_Prc_susp_501Y_V1&#39;</span><span class="p">,</span>
                            <span class="s1">&#39;Prc_susp_501Y_V2_3&#39;</span><span class="p">:</span><span class="s1">&#39;cur_idx_Prc_susp_501Y_V2_3&#39;</span><span class="p">,</span>
                            <span class="s1">&#39;Prc_susp_IND&#39;</span><span class="p">:</span><span class="s1">&#39;cur_idx_Prc_susp_IND&#39;</span><span class="p">,</span>
                            <span class="s1">&#39;Prc_susp_ABS&#39;</span><span class="p">:</span><span class="s1">&#39;cur_idx_Prc_susp_ABS&#39;</span><span class="p">,</span>
                            <span class="s1">&#39;ti&#39;</span><span class="p">:</span><span class="s1">&#39;cur_idx_ti&#39;</span><span class="p">,</span>
                            <span class="s1">&#39;tp&#39;</span><span class="p">:</span><span class="s1">&#39;cur_idx_tp&#39;</span><span class="p">,</span>
                            <span class="s1">&#39;tx_crib&#39;</span> <span class="p">:</span> <span class="s1">&#39;cur_taux_crib&#39;</span><span class="p">,</span>
                            <span class="s1">&#39;tx_A1&#39;</span><span class="p">:</span><span class="s1">&#39;cur_idx_tx_A1&#39;</span><span class="p">,</span>
                            <span class="s1">&#39;tx_B1&#39;</span><span class="p">:</span><span class="s1">&#39;cur_idx_tx_B1&#39;</span><span class="p">,</span>
                            <span class="s1">&#39;tx_C1&#39;</span><span class="p">:</span><span class="s1">&#39;cur_idx_tx_C1&#39;</span><span class="p">,</span>
                            <span class="s1">&#39;nbre_pass_corona&#39;</span><span class="p">:</span><span class="s1">&#39;cur_nbre_pass_corona&#39;</span><span class="p">,</span>
                            <span class="p">}</span>
                        <span class="n">result</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">rename_dict</span><span class="p">)</span>
                        <span class="c1">#coltocast=list(rename_dict.values())[:5]</span>
                        <span class="c1">#result[coltocast] = result[coltocast].astype(&#39;Int64&#39;)</span>
                        <span class="n">spf8keeped</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;nb_A0&#39;</span><span class="p">,</span><span class="s1">&#39;nb_A1&#39;</span><span class="p">,</span> <span class="s1">&#39;nb_B0&#39;</span><span class="p">,</span> <span class="s1">&#39;nb_B1&#39;</span><span class="p">,</span> <span class="s1">&#39;nb_C0&#39;</span><span class="p">,</span> <span class="s1">&#39;nb_C1&#39;</span><span class="p">]</span>
                        <span class="n">columns_keeped</span>  <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">rename_dict</span><span class="o">.</span><span class="n">values</span><span class="p">())</span><span class="o">+</span><span class="p">[</span><span class="s1">&#39;tot_incid_hosp&#39;</span><span class="p">,</span> <span class="s1">&#39;tot_incid_rea&#39;</span><span class="p">,</span> <span class="s1">&#39;tot_incid_rad&#39;</span><span class="p">,</span> <span class="s1">&#39;tot_incid_dc&#39;</span><span class="p">,</span> <span class="s1">&#39;tot_P&#39;</span><span class="p">,</span> <span class="s1">&#39;tot_T&#39;</span><span class="p">]</span><span class="o">+</span><span class="n">spf8keeped</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">return_structured_pandas</span><span class="p">(</span><span class="n">result</span><span class="p">,</span><span class="n">columns_keeped</span><span class="o">=</span><span class="n">columns_keeped</span><span class="p">)</span> <span class="c1"># with &#39;tot_dc&#39; first</span>
                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span> <span class="o">==</span> <span class="s1">&#39;opencovid19&#39;</span> <span class="ow">or</span>  <span class="bp">self</span><span class="o">.</span><span class="n">db</span> <span class="o">==</span> <span class="s1">&#39;opencovid19national&#39;</span><span class="p">:</span>
                    <span class="n">rename</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;maille_code&#39;</span><span class="p">:</span><span class="s1">&#39;location&#39;</span><span class="p">}</span>
                    <span class="n">cast</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;source_url&#39;</span><span class="p">:</span><span class="nb">str</span><span class="p">,</span><span class="s1">&#39;source_archive&#39;</span><span class="p">:</span><span class="nb">str</span><span class="p">,</span><span class="s1">&#39;source_type&#39;</span><span class="p">:</span><span class="nb">str</span><span class="p">,</span><span class="s1">&#39;nouvelles_hospitalisations&#39;</span><span class="p">:</span><span class="nb">str</span><span class="p">,</span><span class="s1">&#39;nouvelles_reanimations&#39;</span><span class="p">:</span><span class="nb">str</span><span class="p">}</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span> <span class="o">==</span> <span class="s1">&#39;opencovid19&#39;</span><span class="p">:</span>
                        <span class="n">info</span><span class="p">(</span><span class="s1">&#39;OPENCOVID19 (country granularity) selected ...&#39;</span><span class="p">)</span>
                        <span class="n">drop_field</span>  <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;granularite&#39;</span><span class="p">:[</span><span class="s1">&#39;pays&#39;</span><span class="p">,</span><span class="s1">&#39;monde&#39;</span><span class="p">,</span><span class="s1">&#39;region&#39;</span><span class="p">]}</span>
                        <span class="n">dict_columns_keeped</span> <span class="o">=</span> <span class="p">{</span>
                            <span class="s1">&#39;deces&#39;</span><span class="p">:</span><span class="s1">&#39;tot_deces&#39;</span><span class="p">,</span>
                            <span class="s1">&#39;cas_confirmes&#39;</span><span class="p">:</span><span class="s1">&#39;tot_cas_confirmes&#39;</span><span class="p">,</span>
                            <span class="s1">&#39;reanimation&#39;</span><span class="p">:</span><span class="s1">&#39;cur_reanimation&#39;</span><span class="p">,</span>
                            <span class="s1">&#39;hospitalises&#39;</span><span class="p">:</span><span class="s1">&#39;cur_hospitalises&#39;</span><span class="p">,</span>
                            <span class="s1">&#39;gueris&#39;</span><span class="p">:</span><span class="s1">&#39;tot_gueris&#39;</span>
                            <span class="p">}</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">info</span><span class="p">(</span><span class="s1">&#39;OPENCOVID19 (national granularity) selected ...&#39;</span><span class="p">)</span>
                        <span class="n">drop_field</span>  <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;granularite&#39;</span><span class="p">:[</span><span class="s1">&#39;monde&#39;</span><span class="p">,</span><span class="s1">&#39;region&#39;</span><span class="p">,</span><span class="s1">&#39;departement&#39;</span><span class="p">]}</span>
                        <span class="n">dict_columns_keeped</span> <span class="o">=</span> <span class="p">{</span>
                        <span class="s1">&#39;deces&#39;</span><span class="p">:</span><span class="s1">&#39;tot_deces&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;cas_confirmes&#39;</span><span class="p">:</span><span class="s1">&#39;tot_cas_confirmes&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;cas_ehpad&#39;</span><span class="p">:</span><span class="s1">&#39;tot_cas_ehpad&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;cas_confirmes_ehpad&#39;</span><span class="p">:</span><span class="s1">&#39;tot_cas_confirmes_ehpad&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;cas_possibles_ehpad&#39;</span><span class="p">:</span><span class="s1">&#39;tot_cas_possibles_ehpad&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;deces_ehpad&#39;</span><span class="p">:</span><span class="s1">&#39;tot_deces_ehpad&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;reanimation&#39;</span><span class="p">:</span><span class="s1">&#39;cur_reanimation&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;hospitalises&#39;</span><span class="p">:</span><span class="s1">&#39;cur_hospitalises&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;gueris&#39;</span><span class="p">:</span><span class="s1">&#39;tot_gueris&#39;</span>
                        <span class="p">}</span>
                    <span class="n">opencovid19</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">csv2pandas</span><span class="p">(</span><span class="s1">&#39;https://raw.githubusercontent.com/opencovid19-fr/data/master/dist/chiffres-cles.csv&#39;</span><span class="p">,</span>
                                <span class="n">drop_field</span><span class="o">=</span><span class="n">drop_field</span><span class="p">,</span><span class="n">rename_columns</span><span class="o">=</span><span class="n">rename</span><span class="p">,</span><span class="n">separator</span><span class="o">=</span><span class="s1">&#39;,&#39;</span><span class="p">,</span><span class="n">cast</span><span class="o">=</span><span class="n">cast</span><span class="p">)</span>

                    <span class="n">opencovid19</span><span class="p">[</span><span class="s1">&#39;location&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">opencovid19</span><span class="p">[</span><span class="s1">&#39;location&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;COM-&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;DEP-&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;FRA&#39;</span><span class="p">,</span><span class="s1">&#39;France&#39;</span><span class="p">))</span>
                    <span class="c1"># integrating needed fields</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span> <span class="o">==</span> <span class="s1">&#39;opencovid19national&#39;</span><span class="p">:</span>
                        <span class="n">opencovid19</span> <span class="o">=</span> <span class="n">opencovid19</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="o">~</span><span class="n">opencovid19</span><span class="o">.</span><span class="n">granularite</span><span class="o">.</span><span class="n">isin</span><span class="p">([</span><span class="s1">&#39;collectivite-outremer&#39;</span><span class="p">])]</span>

                    <span class="n">column_to_integrate</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;nouvelles_hospitalisations&#39;</span><span class="p">,</span> <span class="s1">&#39;nouvelles_reanimations&#39;</span><span class="p">]</span>
                    <span class="n">opencovid19</span><span class="p">[</span><span class="n">column_to_integrate</span><span class="p">]</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">to_numeric</span><span class="p">(</span><span class="n">opencovid19</span><span class="p">[</span><span class="n">column_to_integrate</span><span class="p">]</span><span class="o">.</span><span class="n">stack</span><span class="p">(),</span><span class="n">errors</span> <span class="o">=</span> <span class="s1">&#39;coerce&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">unstack</span><span class="p">()</span>

                    <span class="k">for</span> <span class="n">w</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;nouvelles_hospitalisations&#39;</span><span class="p">,</span> <span class="s1">&#39;nouvelles_reanimations&#39;</span><span class="p">]:</span>
                        <span class="n">opencovid19</span><span class="p">[</span><span class="s1">&#39;tot_&#39;</span><span class="o">+</span><span class="n">w</span><span class="p">]</span><span class="o">=</span><span class="n">opencovid19</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;location&#39;</span><span class="p">])[</span><span class="n">w</span><span class="p">]</span><span class="o">.</span><span class="n">cumsum</span><span class="p">()</span>
                    <span class="c1">#columns_skipped = [&#39;granularite&#39;,&#39;maille_nom&#39;,&#39;source_nom&#39;,&#39;source_url&#39;,&#39;source_archive&#39;,&#39;source_type&#39;]</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">return_structured_pandas</span><span class="p">(</span><span class="n">opencovid19</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">dict_columns_keeped</span><span class="p">),</span><span class="n">columns_keeped</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">dict_columns_keeped</span><span class="o">.</span><span class="n">values</span><span class="p">())</span><span class="o">+</span><span class="p">[</span><span class="s1">&#39;tot_&#39;</span><span class="o">+</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">column_to_integrate</span><span class="p">])</span>
                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span> <span class="o">==</span> <span class="s1">&#39;owid&#39;</span><span class="p">:</span>
                    <span class="n">variant</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="n">info</span><span class="p">(</span><span class="s1">&#39;OWID aka </span><span class="se">\&quot;</span><span class="s1">Our World in Data</span><span class="se">\&quot;</span><span class="s1"> database selected ...&#39;</span><span class="p">)</span>
                    <span class="n">drop_field</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;location&#39;</span><span class="p">:[</span><span class="s1">&#39;International&#39;</span><span class="p">]}</span><span class="c1">#, &#39;World&#39;]}</span>
                    <span class="n">owid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">csv2pandas</span><span class="p">(</span><span class="s2">&quot;https://raw.githubusercontent.com/owid/covid-19-data/master/public/data/owid-covid-data.csv&quot;</span><span class="p">,</span>
                    <span class="n">separator</span><span class="o">=</span><span class="s1">&#39;,&#39;</span><span class="p">,</span><span class="n">drop_field</span><span class="o">=</span><span class="n">drop_field</span><span class="p">)</span>
                    <span class="c1"># renaming some columns</span>
                    <span class="n">col_to_rename1</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;reproduction_rate&#39;</span><span class="p">,</span><span class="s1">&#39;icu_patients&#39;</span><span class="p">,</span><span class="s1">&#39;hosp_patients&#39;</span><span class="p">,</span><span class="s1">&#39;positive_rate&#39;</span><span class="p">]</span>
                    <span class="n">renamed_cols1</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;cur_&#39;</span><span class="o">+</span><span class="n">c</span> <span class="k">if</span> <span class="n">c</span> <span class="o">!=</span> <span class="s1">&#39;positive_rate&#39;</span> <span class="k">else</span> <span class="s1">&#39;cur_idx_&#39;</span><span class="o">+</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">col_to_rename1</span><span class="p">]</span>
                    <span class="n">col_to_rename2</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;people_vaccinated&#39;</span><span class="p">,</span><span class="s1">&#39;people_fully_vaccinated&#39;</span><span class="p">,</span><span class="s1">&#39;people_fully_vaccinated_per_hundred&#39;</span><span class="p">,</span>\
                    <span class="s1">&#39;people_vaccinated_per_hundred&#39;</span><span class="p">,</span><span class="s1">&#39;population&#39;</span><span class="p">]</span>
                    <span class="n">renamed_cols2</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;total_&#39;</span><span class="o">+</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">col_to_rename2</span><span class="p">]</span>
                    <span class="n">col_to_rename</span> <span class="o">=</span> <span class="n">col_to_rename1</span><span class="o">+</span><span class="n">col_to_rename2</span>
                    <span class="n">renamed_cols</span> <span class="o">=</span> <span class="n">renamed_cols1</span> <span class="o">+</span><span class="n">renamed_cols2</span>
                    <span class="n">columns_keeped</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;iso_code&#39;</span><span class="p">,</span><span class="s1">&#39;total_deaths&#39;</span><span class="p">,</span><span class="s1">&#39;total_cases&#39;</span><span class="p">,</span><span class="s1">&#39;total_vaccinations&#39;</span><span class="p">]</span>
                    <span class="n">columns_keeped</span><span class="o">+=</span><span class="p">[</span><span class="s1">&#39;total_cases_per_million&#39;</span><span class="p">,</span><span class="s1">&#39;total_deaths_per_million&#39;</span><span class="p">,</span><span class="s1">&#39;total_vaccinations_per_hundred&#39;</span><span class="p">,</span><span class="s1">&#39;total_boosters&#39;</span><span class="p">,</span><span class="s1">&#39;total_tests&#39;</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">variant</span><span class="p">:</span>
                        <span class="n">constraints</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;variant&#39;</span><span class="p">:</span> <span class="s1">&#39;Omicron&#39;</span><span class="p">}</span>
                        <span class="c1">#cast={&#39;num_sequences&#39;:float,&#39;perc_sequences&#39;:float,&#39;num_sequences_total&#39;:float}</span>
                        <span class="n">owidvar</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">csv2pandas</span><span class="p">(</span><span class="s2">&quot;https://raw.githubusercontent.com/owid/covid-19-data/master/public/data/variants/covid-variants.csv&quot;</span><span class="p">,</span>
                        <span class="n">separator</span><span class="o">=</span><span class="s1">&#39;,&#39;</span><span class="p">,</span><span class="n">constraints</span><span class="o">=</span><span class="n">constraints</span><span class="p">)</span>
                        <span class="n">info</span><span class="p">(</span><span class="s1">&#39;... Omicron variant from other owid has been added ...&#39;</span><span class="p">)</span>
                        <span class="n">owid</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">owid</span><span class="p">,</span><span class="n">owidvar</span><span class="p">,</span><span class="n">on</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;location&#39;</span><span class="p">,</span><span class="s1">&#39;date&#39;</span><span class="p">])</span>
                        <span class="c1">#pandas_db = pandas_db.loc[(~pandas_db.iso_code.isnull())]</span>
                        <span class="n">columns_keeped</span> <span class="o">+=</span> <span class="p">[</span><span class="s1">&#39;num_sequences&#39;</span><span class="p">,</span><span class="s1">&#39;num_sequences_total&#39;</span><span class="p">,</span><span class="s1">&#39;perc_sequences&#39;</span><span class="p">]</span>
                    <span class="n">owid</span><span class="p">[</span><span class="s1">&#39;total_tests&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">owid</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;location&#39;</span><span class="p">])[</span><span class="s1">&#39;new_tests&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">cumsum</span><span class="p">()</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">return_structured_pandas</span><span class="p">(</span><span class="n">owid</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">col_to_rename</span><span class="p">,</span><span class="n">renamed_cols</span><span class="p">))),</span><span class="n">columns_keeped</span><span class="o">=</span><span class="n">columns_keeped</span><span class="o">+</span><span class="n">renamed_cols</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">CoaDbError</span><span class="p">(</span><span class="s2">&quot;An error occured while parsing data of &quot;</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">get_db</span><span class="p">()</span><span class="o">+</span><span class="s2">&quot;. This may be due to a data format modification. &quot;</span>
                    <span class="s2">&quot;You may contact support@pycoa.fr. Thanks.&quot;</span><span class="p">)</span>
            <span class="c1"># some info</span>
            <span class="n">info</span><span class="p">(</span><span class="s1">&#39;Few information concernant the selected database : &#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_db</span><span class="p">())</span>
            <span class="n">info</span><span class="p">(</span><span class="s1">&#39;Available key-words, which ∈&#39;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">get_available_keys_words</span><span class="p">())</span>
            <span class="n">info</span><span class="p">(</span><span class="s1">&#39;Example of location : &#39;</span><span class="p">,</span>  <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">random</span><span class="o">.</span><span class="n">choices</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_locations</span><span class="p">(),</span> <span class="n">k</span><span class="o">=</span><span class="mi">5</span><span class="p">)),</span> <span class="s1">&#39; ...&#39;</span><span class="p">)</span>
            <span class="n">info</span><span class="p">(</span><span class="s1">&#39;Last date data &#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_dates</span><span class="p">()</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>

<div class="viewcode-block" id="DataBase.factory"><a class="viewcode-back" href="../../coa.covid19.html#coa.covid19.DataBase.factory">[docs]</a>   <span class="nd">@staticmethod</span>
   <span class="k">def</span> <span class="nf">factory</span><span class="p">(</span><span class="n">db_name</span><span class="p">):</span>
       <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Return an instance to DataBase and to CocoDisplay methods</span>
<span class="sd">        This is recommended to avoid mismatch in labeled figures</span>
<span class="sd">       &#39;&#39;&#39;</span>
       <span class="n">datab</span> <span class="o">=</span> <span class="n">DataBase</span><span class="p">(</span><span class="n">db_name</span><span class="p">)</span>
       <span class="k">return</span>  <span class="n">datab</span><span class="p">,</span> <span class="n">datab</span><span class="o">.</span><span class="n">get_display</span><span class="p">()</span></div>

<div class="viewcode-block" id="DataBase.set_display"><a class="viewcode-back" href="../../coa.covid19.html#coa.covid19.DataBase.set_display">[docs]</a>   <span class="k">def</span> <span class="nf">set_display</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">db</span><span class="p">,</span><span class="n">geo</span><span class="p">):</span>
       <span class="sd">&#39;&#39;&#39; Set the CocoDisplay &#39;&#39;&#39;</span>
       <span class="bp">self</span><span class="o">.</span><span class="n">codisp</span> <span class="o">=</span> <span class="n">codisplay</span><span class="o">.</span><span class="n">CocoDisplay</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">geo</span><span class="p">)</span></div>

<div class="viewcode-block" id="DataBase.get_display"><a class="viewcode-back" href="../../coa.covid19.html#coa.covid19.DataBase.get_display">[docs]</a>   <span class="k">def</span> <span class="nf">get_display</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
       <span class="sd">&#39;&#39;&#39; Return the instance of CocoDisplay initialized by factory&#39;&#39;&#39;</span>
       <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">codisp</span></div>

<div class="viewcode-block" id="DataBase.get_db"><a class="viewcode-back" href="../../coa.covid19.html#coa.covid19.DataBase.get_db">[docs]</a>   <span class="k">def</span> <span class="nf">get_db</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Return the current covid19 database selected. See get_available_database() for full list</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span></div>

<div class="viewcode-block" id="DataBase.get_available_database"><a class="viewcode-back" href="../../coa.covid19.html#coa.covid19.DataBase.get_available_database">[docs]</a>   <span class="k">def</span> <span class="nf">get_available_database</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Return all the available Covid19 database</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">database_name</span></div>

<div class="viewcode-block" id="DataBase.get_available_options"><a class="viewcode-back" href="../../coa.covid19.html#coa.covid19.DataBase.get_available_options">[docs]</a>   <span class="k">def</span> <span class="nf">get_available_options</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Return available options for the get_stats method</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">o</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">available_options</span>
        <span class="k">return</span> <span class="n">o</span></div>

<div class="viewcode-block" id="DataBase.get_available_keys_words"><a class="viewcode-back" href="../../coa.covid19.html#coa.covid19.DataBase.get_available_keys_words">[docs]</a>   <span class="k">def</span> <span class="nf">get_available_keys_words</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Return all the available keyswords for the database selected</span>
<span class="sd">        Key-words are for:</span>
<span class="sd">        - jhu : [&#39;deaths&#39;,&#39;confirmed&#39;,&#39;recovered&#39;]</span>
<span class="sd">                            * the data are cumulative i.e for a date it represents the total cases</span>
<span class="sd">            For more information please have a look to https://github.com/CSSEGISandData/COVID-19/tree/master/csse_covid_19_data</span>
<span class="sd">        - &#39;owid&#39; : [&#39;total_deaths&#39;,&#39;total_cases&#39;,&#39;reproduction_rate&#39;,&#39;icu_patients&#39;,&#39;hosp_patients&#39;,&#39;total_tests&#39;,</span>
<span class="sd">                    &#39;positive_rate&#39;,&#39;total_vaccinations&#39;]</span>
<span class="sd">        For more information please have a look to https://github.com/owid/covid-19-data/tree/master/public/data/</span>
<span class="sd">        - &#39;spf&#39; : [&#39;hosp&#39;, &#39;rea&#39;, &#39;rad&#39;, &#39;dc&#39;, &#39;incid_hosp&#39;, &#39;incid_rea&#39;, &#39;incid_dc&#39;,</span>
<span class="sd">                    &#39;incid_rad&#39;, &#39;P&#39;, &#39;T&#39;, &#39;tx_incid&#39;, &#39;R&#39;, &#39;taux_occupation_sae&#39;, &#39;tx_pos&#39;]</span>
<span class="sd">            No translation have been done for french keywords data</span>
<span class="sd">        For more information please have a look to  https://www.data.gouv.fr/fr/organizations/sante-publique-france/</span>
<span class="sd">        - &#39;opencovid19&#39; :[&#39;cas_confirmes&#39;, &#39;deces&#39;,</span>
<span class="sd">        &#39;reanimation&#39;, &#39;hospitalises&#39;,&#39;nouvelles_hospitalisations&#39;, &#39;nouvelles_reanimations&#39;, &#39;gueris&#39;, &#39;depistes&#39;]</span>
<span class="sd">        - &#39;opencovid19national&#39; :[&#39;cas_confirmes&#39;, &#39;cas_ehpad&#39;, &#39;cas_confirmes_ehpad&#39;, &#39;cas_possibles_ehpad&#39;, &#39;deces&#39;, &#39;deces_ehpad&#39;,</span>
<span class="sd">        &#39;reanimation&#39;, &#39;hospitalises&#39;,&#39;nouvelles_hospitalisations&#39;, &#39;nouvelles_reanimations&#39;, &#39;gueris&#39;, &#39;depistes&#39;]</span>

<span class="sd">        No translation have been done for french keywords data</span>
<span class="sd">        For more information please have a look to https://github.com/opencovid19-fr</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">available_keys_words</span></div>

<div class="viewcode-block" id="DataBase.get_keyword_definition"><a class="viewcode-back" href="../../coa.covid19.html#coa.covid19.DataBase.get_keyword_definition">[docs]</a>   <span class="k">def</span> <span class="nf">get_keyword_definition</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">keys</span><span class="p">):</span>
       <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">            Return definition on the selected keword</span>
<span class="sd">       &#39;&#39;&#39;</span>
       <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">databaseinfo</span><span class="o">.</span><span class="n">generic_info</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_db</span><span class="p">(),</span><span class="n">keys</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
       <span class="k">return</span> <span class="n">value</span></div>

<div class="viewcode-block" id="DataBase.get_keyword_url"><a class="viewcode-back" href="../../coa.covid19.html#coa.covid19.DataBase.get_keyword_url">[docs]</a>   <span class="k">def</span> <span class="nf">get_keyword_url</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">keys</span><span class="p">):</span>
       <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Return url where the keyword have been parsed</span>
<span class="sd">       &#39;&#39;&#39;</span>
       <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">databaseinfo</span><span class="o">.</span><span class="n">generic_info</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_db</span><span class="p">(),</span><span class="n">keys</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
       <span class="n">master</span>  <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">databaseinfo</span><span class="o">.</span><span class="n">generic_info</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_db</span><span class="p">(),</span><span class="n">keys</span><span class="p">)[</span><span class="mi">2</span><span class="p">]</span>
       <span class="k">return</span> <span class="n">value</span><span class="p">,</span> <span class="n">master</span></div>


<div class="viewcode-block" id="DataBase.return_jhu_pandas"><a class="viewcode-back" href="../../coa.covid19.html#coa.covid19.DataBase.return_jhu_pandas">[docs]</a>   <span class="k">def</span> <span class="nf">return_jhu_pandas</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; For center for Systems Science and Engineering (CSSE) at Johns Hopkins University</span>
<span class="sd">            COVID-19 Data Repository by the see homepage: https://github.com/CSSEGISandData/COVID-19</span>
<span class="sd">            return a structure : pandas location - date - keywords</span>
<span class="sd">            for jhu location are countries (location uses geo standard)</span>
<span class="sd">            for jhu-usa location are Province_State (location uses geo standard)</span>
<span class="sd">            &#39;&#39;&#39;</span>
        <span class="n">base_url</span> <span class="o">=</span> <span class="s2">&quot;https://raw.githubusercontent.com/CSSEGISandData/COVID-19/master/&quot;</span><span class="o">+</span>\
                                <span class="s2">&quot;csse_covid_19_data/csse_covid_19_time_series/&quot;</span>
        <span class="n">base_name</span> <span class="o">=</span> <span class="s2">&quot;time_series_covid19_&quot;</span>
        <span class="c1"># previous are default for actual jhu db</span>

        <span class="n">pandas_jhu</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span> <span class="o">==</span> <span class="s1">&#39;jhu&#39;</span><span class="p">:</span> <span class="c1"># worldwide</span>
            <span class="n">extension</span> <span class="o">=</span>  <span class="s2">&quot;_global.csv&quot;</span>
            <span class="n">jhu_files_ext</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;deaths&#39;</span><span class="p">,</span> <span class="s1">&#39;confirmed&#39;</span><span class="p">,</span> <span class="s1">&#39;recovered&#39;</span><span class="p">]</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span> <span class="o">==</span> <span class="s1">&#39;jhu-usa&#39;</span><span class="p">:</span> <span class="c1"># &#39;USA&#39;</span>
            <span class="n">extension</span> <span class="o">=</span> <span class="s2">&quot;_US.csv&quot;</span>
            <span class="n">jhu_files_ext</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;deaths&#39;</span><span class="p">,</span><span class="s1">&#39;confirmed&#39;</span><span class="p">]</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span> <span class="o">==</span> <span class="s1">&#39;rki&#39;</span><span class="p">:</span> <span class="c1"># &#39;DEU&#39;</span>
            <span class="n">base_url</span> <span class="o">=</span> <span class="s1">&#39;https://github.com/jgehrcke/covid-19-germany-gae/raw/master/&#39;</span>
            <span class="n">jhu_files_ext</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;deaths&#39;</span><span class="p">,</span><span class="s1">&#39;cases&#39;</span><span class="p">]</span>
            <span class="n">extension</span> <span class="o">=</span> <span class="s1">&#39;-rki-by-ags.csv&#39;</span>
            <span class="n">base_name</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">CoaDbError</span><span class="p">(</span><span class="s1">&#39;Unknown JHU like db &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">available_keys_words</span> <span class="o">=</span> <span class="n">jhu_files_ext</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span> <span class="o">==</span> <span class="s1">&#39;rki&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">available_keys_words</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;tot_deaths&#39;</span><span class="p">,</span><span class="s1">&#39;tot_cases&#39;</span><span class="p">]</span>
        <span class="n">pandas_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">ext</span> <span class="ow">in</span> <span class="n">jhu_files_ext</span><span class="p">:</span>
            <span class="n">fileName</span> <span class="o">=</span> <span class="n">base_name</span> <span class="o">+</span> <span class="n">ext</span> <span class="o">+</span> <span class="n">extension</span>
            <span class="n">url</span> <span class="o">=</span> <span class="n">base_url</span> <span class="o">+</span> <span class="n">fileName</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">database_url</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
            <span class="n">pandas_jhu_db</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">get_local_from_url</span><span class="p">(</span><span class="n">url</span><span class="p">,</span><span class="mi">7200</span><span class="p">),</span> <span class="n">sep</span> <span class="o">=</span> <span class="s1">&#39;,&#39;</span><span class="p">)</span> <span class="c1"># cached for 2 hours</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span> <span class="o">==</span> <span class="s1">&#39;jhu&#39;</span><span class="p">:</span>
                <span class="n">pandas_jhu_db</span> <span class="o">=</span> <span class="n">pandas_jhu_db</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;Country/Region&#39;</span><span class="p">:</span><span class="s1">&#39;location&#39;</span><span class="p">})</span>
                <span class="n">pandas_jhu_db</span> <span class="o">=</span> <span class="n">pandas_jhu_db</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Province/State&#39;</span><span class="p">,</span><span class="s1">&#39;Lat&#39;</span><span class="p">,</span><span class="s1">&#39;Long&#39;</span><span class="p">])</span>
                <span class="n">pandas_jhu_db</span> <span class="o">=</span> <span class="n">pandas_jhu_db</span><span class="o">.</span><span class="n">melt</span><span class="p">(</span><span class="n">id_vars</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;location&quot;</span><span class="p">],</span><span class="n">var_name</span><span class="o">=</span><span class="s2">&quot;date&quot;</span><span class="p">,</span><span class="n">value_name</span><span class="o">=</span><span class="n">ext</span><span class="p">)</span>
                <span class="n">pandas_jhu_db</span> <span class="o">=</span> <span class="n">pandas_jhu_db</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="o">~</span><span class="n">pandas_jhu_db</span><span class="o">.</span><span class="n">location</span><span class="o">.</span><span class="n">isin</span><span class="p">([</span><span class="s1">&#39;Diamond Princess&#39;</span><span class="p">])]</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span> <span class="o">==</span> <span class="s1">&#39;jhu-usa&#39;</span><span class="p">:</span>
                <span class="n">pandas_jhu_db</span> <span class="o">=</span> <span class="n">pandas_jhu_db</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;Province_State&#39;</span><span class="p">:</span><span class="s1">&#39;location&#39;</span><span class="p">})</span>
                <span class="n">pandas_jhu_db</span> <span class="o">=</span> <span class="n">pandas_jhu_db</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;UID&#39;</span><span class="p">,</span><span class="s1">&#39;iso2&#39;</span><span class="p">,</span><span class="s1">&#39;iso3&#39;</span><span class="p">,</span><span class="s1">&#39;code3&#39;</span><span class="p">,</span><span class="s1">&#39;FIPS&#39;</span><span class="p">,</span>
                                    <span class="s1">&#39;Admin2&#39;</span><span class="p">,</span><span class="s1">&#39;Country_Region&#39;</span><span class="p">,</span><span class="s1">&#39;Lat&#39;</span><span class="p">,</span><span class="s1">&#39;Long_&#39;</span><span class="p">,</span><span class="s1">&#39;Combined_Key&#39;</span><span class="p">])</span>
                <span class="k">if</span> <span class="s1">&#39;Population&#39;</span> <span class="ow">in</span> <span class="n">pandas_jhu_db</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                    <span class="n">pandas_jhu_db</span> <span class="o">=</span> <span class="n">pandas_jhu_db</span><span class="o">.</span><span class="n">melt</span><span class="p">(</span><span class="n">id_vars</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;location&quot;</span><span class="p">,</span><span class="s1">&#39;Population&#39;</span><span class="p">],</span><span class="n">var_name</span><span class="o">=</span><span class="s2">&quot;date&quot;</span><span class="p">,</span><span class="n">value_name</span><span class="o">=</span><span class="n">ext</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">pandas_jhu_db</span> <span class="o">=</span> <span class="n">pandas_jhu_db</span><span class="o">.</span><span class="n">melt</span><span class="p">(</span><span class="n">id_vars</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;location&quot;</span><span class="p">],</span><span class="n">var_name</span><span class="o">=</span><span class="s2">&quot;date&quot;</span><span class="p">,</span><span class="n">value_name</span><span class="o">=</span><span class="n">ext</span><span class="p">)</span>
                <span class="n">removethose</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;American Samoa&#39;</span><span class="p">,</span><span class="s1">&#39;Diamond Princess&#39;</span><span class="p">,</span><span class="s1">&#39;Grand Princess&#39;</span><span class="p">,</span><span class="s1">&#39;Guam&#39;</span><span class="p">,</span>
                <span class="s1">&#39;Northern Mariana Islands&#39;</span><span class="p">,</span><span class="s1">&#39;Puerto Rico&#39;</span><span class="p">,</span><span class="s1">&#39;Virgin Islands&#39;</span><span class="p">]</span>
                <span class="n">pandas_jhu_db</span> <span class="o">=</span> <span class="n">pandas_jhu_db</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="o">~</span><span class="n">pandas_jhu_db</span><span class="o">.</span><span class="n">location</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">removethose</span><span class="p">)]</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span> <span class="o">==</span> <span class="s1">&#39;rki&#39;</span><span class="p">:</span>
                <span class="n">pandas_jhu_db</span> <span class="o">=</span> <span class="n">pandas_jhu_db</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;sum_&#39;</span><span class="o">+</span><span class="n">ext</span><span class="p">])</span>
                <span class="n">pandas_jhu_db</span> <span class="o">=</span> <span class="n">pandas_jhu_db</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;time_iso8601&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;index&#39;</span><span class="p">:</span><span class="s1">&#39;location&#39;</span><span class="p">})</span>
                <span class="n">pandas_jhu_db</span> <span class="o">=</span> <span class="n">pandas_jhu_db</span><span class="o">.</span><span class="n">melt</span><span class="p">(</span><span class="n">id_vars</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;location&quot;</span><span class="p">],</span><span class="n">var_name</span><span class="o">=</span><span class="s2">&quot;date&quot;</span><span class="p">,</span><span class="n">value_name</span><span class="o">=</span><span class="n">ext</span><span class="p">)</span>
                <span class="n">pandas_jhu_db</span><span class="p">[</span><span class="s1">&#39;location&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pandas_jhu_db</span><span class="o">.</span><span class="n">location</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
                <span class="n">pandas_jhu_db</span> <span class="o">=</span> <span class="n">pandas_jhu_db</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;deaths&#39;</span><span class="p">:</span><span class="s1">&#39;tot_deaths&#39;</span><span class="p">,</span><span class="s1">&#39;cases&#39;</span><span class="p">:</span><span class="s1">&#39;tot_cases&#39;</span><span class="p">})</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">CoaTypeError</span><span class="p">(</span><span class="s1">&#39;jhu nor jhu-usa database selected ... &#39;</span><span class="p">)</span>

            <span class="n">pandas_jhu_db</span><span class="o">=</span><span class="n">pandas_jhu_db</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;location&#39;</span><span class="p">,</span><span class="s1">&#39;date&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
            <span class="n">pandas_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pandas_jhu_db</span><span class="p">)</span>

        <span class="k">if</span> <span class="s1">&#39;jhu&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="p">:</span>
            <span class="n">pandas_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">pan</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="n">i</span><span class="p">:</span><span class="s1">&#39;tot_&#39;</span><span class="o">+</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">jhu_files_ext</span><span class="p">})</span> <span class="k">for</span> <span class="n">pan</span> <span class="ow">in</span> <span class="n">pandas_list</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">available_keys_words</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;tot_&#39;</span><span class="o">+</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">jhu_files_ext</span><span class="p">]</span>
        <span class="n">uniqloc</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">pandas_list</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;location&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span>
        <span class="n">oldloc</span> <span class="o">=</span> <span class="n">uniqloc</span>
        <span class="n">codedico</span><span class="o">=</span><span class="p">{}</span>
        <span class="n">toremove</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">newloc</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">location_is_code</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">db_world</span><span class="p">:</span>
            <span class="n">d_loc_s</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">OrderedDict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">uniqloc</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">geo</span><span class="o">.</span><span class="n">to_standard</span><span class="p">(</span><span class="n">uniqloc</span><span class="p">,</span><span class="n">output</span><span class="o">=</span><span class="s1">&#39;list&#39;</span><span class="p">,</span><span class="n">db</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_db</span><span class="p">(),</span><span class="n">interpret_region</span><span class="o">=</span><span class="kc">True</span><span class="p">)))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">slocation</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">d_loc_s</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
            <span class="n">g</span><span class="o">=</span><span class="n">coge</span><span class="o">.</span><span class="n">GeoManager</span><span class="p">(</span><span class="s1">&#39;iso3&#39;</span><span class="p">)</span>
            <span class="n">codename</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">OrderedDict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">slocation</span><span class="p">,</span><span class="n">g</span><span class="o">.</span><span class="n">to_standard</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">slocation</span><span class="p">,</span><span class="n">output</span><span class="o">=</span><span class="s1">&#39;list&#39;</span><span class="p">,</span><span class="n">db</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_db</span><span class="p">(),</span><span class="n">interpret_region</span><span class="o">=</span><span class="kc">True</span><span class="p">)))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">database_type</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;subregion&#39;</span><span class="p">:</span>
                <span class="n">pdcodename</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">geo</span><span class="o">.</span><span class="n">get_subregion_list</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">slocation</span> <span class="o">=</span> <span class="n">uniqloc</span>
                <span class="n">codename</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">OrderedDict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">slocation</span><span class="p">,</span><span class="nb">list</span><span class="p">(</span><span class="n">pdcodename</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">pdcodename</span><span class="o">.</span><span class="n">code_subregion</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">slocation</span><span class="p">)][</span><span class="s1">&#39;name_subregion&#39;</span><span class="p">])))</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span> <span class="o">==</span> <span class="s1">&#39;jhu-usa&#39;</span><span class="p">:</span>
                    <span class="n">d_loc_s</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">OrderedDict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">uniqloc</span><span class="p">,</span><span class="nb">list</span><span class="p">(</span><span class="n">pdcodename</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">pdcodename</span><span class="o">.</span><span class="n">name_subregion</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">uniqloc</span><span class="p">)][</span><span class="s1">&#39;code_subregion&#39;</span><span class="p">])))</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">slocation</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">d_loc_s</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
                    <span class="n">codename</span> <span class="o">=</span> <span class="n">d_loc_s</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span> <span class="o">==</span> <span class="s1">&#39;rki&#39;</span><span class="p">:</span>
                    <span class="n">d_loc_s</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">OrderedDict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">uniqloc</span><span class="p">,</span><span class="nb">list</span><span class="p">(</span><span class="n">pdcodename</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">pdcodename</span><span class="o">.</span><span class="n">code_subregion</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">uniqloc</span><span class="p">)][</span><span class="s1">&#39;name_subregion&#39;</span><span class="p">])))</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">slocation</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">d_loc_s</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
                    <span class="n">codename</span> <span class="o">=</span> <span class="n">d_loc_s</span>
                    <span class="n">location_is_code</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">def</span> <span class="nf">notuse</span><span class="p">():</span>
                        <span class="n">count_values</span><span class="o">=</span><span class="n">collections</span><span class="o">.</span><span class="n">Counter</span><span class="p">(</span><span class="n">d_loc_s</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
                        <span class="n">duplicates_location</span> <span class="o">=</span> <span class="nb">list</span><span class="p">({</span><span class="n">k</span><span class="p">:</span><span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">count_values</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">v</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">}</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
                        <span class="k">def</span> <span class="nf">findkeywithvalue</span><span class="p">(</span><span class="n">dico</span><span class="p">,</span><span class="n">what</span><span class="p">):</span>
                            <span class="n">a</span><span class="o">=</span><span class="p">[]</span>
                            <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">dico</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                                <span class="k">if</span> <span class="n">v</span> <span class="o">==</span> <span class="n">what</span><span class="p">:</span>
                                    <span class="n">a</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
                            <span class="k">return</span> <span class="n">a</span>
                        <span class="n">codedupli</span><span class="o">=</span><span class="p">{</span><span class="n">i</span><span class="p">:</span><span class="n">findkeywithvalue</span><span class="p">(</span><span class="n">d_loc_s</span><span class="p">,</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">duplicates_location</span><span class="p">}</span>

        <span class="n">result</span> <span class="o">=</span> <span class="n">reduce</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">on</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;location&#39;</span><span class="p">,</span><span class="s1">&#39;date&#39;</span><span class="p">]),</span> <span class="n">pandas_list</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">location_is_code</span><span class="p">:</span>
            <span class="n">result</span><span class="p">[</span><span class="s1">&#39;codelocation&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;location&#39;</span><span class="p">]</span>
            <span class="n">result</span><span class="p">[</span><span class="s1">&#39;location&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;location&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">codename</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span> <span class="o">==</span> <span class="s1">&#39;jhu&#39;</span><span class="p">:</span>
                <span class="n">result</span><span class="p">[</span><span class="s1">&#39;location&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;location&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">d_loc_s</span><span class="p">)</span>
            <span class="n">result</span><span class="p">[</span><span class="s1">&#39;codelocation&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;location&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">codename</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">result</span><span class="o">.</span><span class="n">location</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">slocation</span><span class="p">)]</span>

        <span class="n">tmp</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
        <span class="k">if</span> <span class="s1">&#39;Kosovo&#39;</span> <span class="ow">in</span> <span class="n">uniqloc</span><span class="p">:</span>
            <span class="c1">#Kosovo is Serbia ! with geo.to_standard</span>
            <span class="n">tmp</span><span class="o">=</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">result</span><span class="o">.</span><span class="n">location</span><span class="o">.</span><span class="n">isin</span><span class="p">([</span><span class="s1">&#39;Serbia&#39;</span><span class="p">])])</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;date&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
            <span class="n">tmp</span><span class="p">[</span><span class="s1">&#39;location&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Serbia&#39;</span>
            <span class="n">tmp</span><span class="p">[</span><span class="s1">&#39;codelocation&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;SRB&#39;</span>
            <span class="n">kw</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">available_keys_words</span><span class="p">]</span>
            <span class="n">colpos</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;location&#39;</span><span class="p">,</span> <span class="s1">&#39;date&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">kw</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;codelocation&#39;</span><span class="p">]</span>
            <span class="n">tmp</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">[</span><span class="n">colpos</span><span class="p">]</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="o">~</span><span class="n">result</span><span class="o">.</span><span class="n">location</span><span class="o">.</span><span class="n">isin</span><span class="p">([</span><span class="s1">&#39;Serbia&#39;</span><span class="p">])]</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tmp</span><span class="p">)</span>

        <span class="n">result</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">],</span><span class="n">errors</span><span class="o">=</span><span class="s1">&#39;coerce&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">date</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;location&#39;</span><span class="p">,</span><span class="s1">&#39;date&#39;</span><span class="p">])</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mainpandas</span> <span class="o">=</span> <span class="n">fill_missing_dates</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dates</span>  <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mainpandas</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">]</span></div>

<div class="viewcode-block" id="DataBase.csv2pandas"><a class="viewcode-back" href="../../coa.covid19.html#coa.covid19.DataBase.csv2pandas">[docs]</a>   <span class="k">def</span> <span class="nf">csv2pandas</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">url</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Parse and convert the database cvs file to a pandas structure</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">database_url</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
        <span class="n">kwargs_test</span><span class="p">(</span><span class="n">kwargs</span><span class="p">,[</span><span class="s1">&#39;cast&#39;</span><span class="p">,</span><span class="s1">&#39;separator&#39;</span><span class="p">,</span><span class="s1">&#39;encoding&#39;</span><span class="p">,</span><span class="s1">&#39;constraints&#39;</span><span class="p">,</span><span class="s1">&#39;rename_columns&#39;</span><span class="p">,</span><span class="s1">&#39;drop_field&#39;</span><span class="p">],</span>
            <span class="s1">&#39;Bad args used in the csv2pandas() function.&#39;</span><span class="p">)</span>

        <span class="n">cast</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;cast&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">dico_cast</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">cast</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span><span class="n">val</span> <span class="ow">in</span> <span class="n">cast</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">dico_cast</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>
        <span class="n">separator</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;separator&#39;</span><span class="p">,</span> <span class="s1">&#39;;&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">separator</span><span class="p">:</span>
            <span class="n">separator</span> <span class="o">=</span> <span class="n">separator</span>
        <span class="n">encoding</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;encoding&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">encoding</span><span class="p">:</span>
            <span class="n">encoding</span> <span class="o">=</span> <span class="n">encoding</span>
        <span class="n">pandas_db</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">get_local_from_url</span><span class="p">(</span><span class="n">url</span><span class="p">,</span><span class="mi">7200</span><span class="p">),</span><span class="n">sep</span><span class="o">=</span><span class="n">separator</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="n">dico_cast</span><span class="p">,</span> <span class="n">encoding</span> <span class="o">=</span> <span class="n">encoding</span><span class="p">,</span>
            <span class="n">keep_default_na</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">na_values</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="c1"># cached for 2 hours</span>

        <span class="c1">#pandas_db = pandas.read_csv(self.database_url,sep=separator,dtype=dico_cast, encoding = encoding )</span>
        <span class="n">constraints</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;constraints&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">rename_columns</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;rename_columns&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">drop_field</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;drop_field&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">constraints</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span><span class="n">val</span> <span class="ow">in</span> <span class="n">constraints</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">pandas_db</span> <span class="o">=</span> <span class="n">pandas_db</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">pandas_db</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">==</span> <span class="n">val</span><span class="p">]</span>
                <span class="n">pandas_db</span> <span class="o">=</span> <span class="n">pandas_db</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">key</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">drop_field</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span><span class="n">val</span> <span class="ow">in</span> <span class="n">drop_field</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">val</span><span class="p">:</span>
                    <span class="n">pandas_db</span> <span class="o">=</span>  <span class="n">pandas_db</span><span class="p">[</span><span class="n">pandas_db</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">!=</span> <span class="n">i</span> <span class="p">]</span>
        <span class="k">if</span> <span class="n">rename_columns</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span><span class="n">val</span> <span class="ow">in</span> <span class="n">rename_columns</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">pandas_db</span> <span class="o">=</span> <span class="n">pandas_db</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="n">key</span><span class="p">:</span><span class="n">val</span><span class="p">})</span>

        <span class="k">if</span> <span class="s1">&#39;semaine&#39;</span> <span class="ow">in</span>  <span class="n">pandas_db</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="n">pandas_db</span><span class="p">[</span><span class="s1">&#39;semaine&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span> <span class="n">week_to_date</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">pandas_db</span><span class="p">[</span><span class="s1">&#39;semaine&#39;</span><span class="p">]]</span>
            <span class="c1">#pandas_db = pandas_db.drop_duplicates(subset=[&#39;semaine&#39;])</span>
            <span class="n">pandas_db</span> <span class="o">=</span> <span class="n">pandas_db</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;semaine&#39;</span><span class="p">:</span><span class="s1">&#39;date&#39;</span><span class="p">})</span>

        <span class="n">pandas_db</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">pandas_db</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">],</span><span class="n">errors</span><span class="o">=</span><span class="s1">&#39;coerce&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">date</span>
        <span class="c1">#self.dates  = pandas_db[&#39;date&#39;]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span> <span class="o">==</span> <span class="s1">&#39;spfnational&#39;</span><span class="p">:</span>
            <span class="n">pandas_db</span><span class="p">[</span><span class="s1">&#39;location&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;France&#39;</span>
        <span class="n">pandas_db</span> <span class="o">=</span> <span class="n">pandas_db</span><span class="o">.</span><span class="n">sort_values</span><span class="p">([</span><span class="s1">&#39;location&#39;</span><span class="p">,</span><span class="s1">&#39;date&#39;</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">pandas_db</span></div>

<div class="viewcode-block" id="DataBase.return_structured_pandas"><a class="viewcode-back" href="../../coa.covid19.html#coa.covid19.DataBase.return_structured_pandas">[docs]</a>   <span class="k">def</span> <span class="nf">return_structured_pandas</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">mypandas</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Return the mainpandas core of the PyCoA structure</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">kwargs_test</span><span class="p">(</span><span class="n">kwargs</span><span class="p">,[</span><span class="s1">&#39;columns_skipped&#39;</span><span class="p">,</span><span class="s1">&#39;columns_keeped&#39;</span><span class="p">],</span>
            <span class="s1">&#39;Bad args used in the return_structured_pandas function.&#39;</span><span class="p">)</span>
        <span class="n">columns_skipped</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;columns_skipped&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">absolutlyneeded</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">,</span><span class="s1">&#39;location&#39;</span><span class="p">]</span>
        <span class="n">defaultkeept</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">mypandas</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">to_list</span><span class="p">())</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="n">absolutlyneeded</span><span class="p">))</span>
        <span class="n">columns_keeped</span>  <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;columns_keeped&#39;</span><span class="p">,</span> <span class="n">defaultkeept</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">columns_skipped</span><span class="p">:</span>
            <span class="n">columns_keeped</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">mypandas</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span> <span class="k">if</span> <span class="n">x</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">columns_skipped</span> <span class="o">+</span> <span class="n">absolutlyneeded</span><span class="p">]</span>
        <span class="n">mypandas</span> <span class="o">=</span> <span class="n">mypandas</span><span class="p">[</span><span class="n">absolutlyneeded</span> <span class="o">+</span> <span class="n">columns_keeped</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">available_keys_words</span> <span class="o">=</span> <span class="n">columns_keeped</span> <span class="c1">#+ absolutlyneeded</span>
        <span class="n">not_un_nation_dict</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;Kosovo&#39;</span><span class="p">:</span><span class="s1">&#39;Serbia&#39;</span><span class="p">,</span><span class="s1">&#39;Northern Cyprus&#39;</span><span class="p">:</span><span class="s1">&#39;Cyprus&#39;</span><span class="p">}</span>
        <span class="k">for</span> <span class="n">subpart_country</span><span class="p">,</span> <span class="n">main_country</span> <span class="ow">in</span> <span class="n">not_un_nation_dict</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="p">:</span>
            <span class="n">tmp</span><span class="o">=</span><span class="p">(</span><span class="n">mypandas</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">mypandas</span><span class="o">.</span><span class="n">location</span><span class="o">.</span><span class="n">isin</span><span class="p">([</span><span class="n">subpart_country</span><span class="p">,</span><span class="n">main_country</span><span class="p">])]</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;date&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span>
            <span class="n">tmp</span><span class="p">[</span><span class="s1">&#39;location&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">main_country</span>
            <span class="n">mypandas</span> <span class="o">=</span> <span class="n">mypandas</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="o">~</span><span class="n">mypandas</span><span class="o">.</span><span class="n">location</span><span class="o">.</span><span class="n">isin</span><span class="p">([</span><span class="n">subpart_country</span><span class="p">,</span><span class="n">main_country</span><span class="p">])]</span>
            <span class="n">tmp</span> <span class="o">=</span> <span class="n">tmp</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
            <span class="n">cols</span> <span class="o">=</span> <span class="n">tmp</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
            <span class="n">cols</span> <span class="o">=</span> <span class="n">cols</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">cols</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">:]</span> <span class="o">+</span> <span class="n">cols</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">tmp</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">[</span><span class="n">cols</span><span class="p">]</span>
            <span class="n">mypandas</span> <span class="o">=</span> <span class="n">mypandas</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tmp</span><span class="p">)</span>
        <span class="k">if</span> <span class="s1">&#39;iso_code&#39;</span> <span class="ow">in</span> <span class="n">mypandas</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="n">mypandas</span><span class="p">[</span><span class="s1">&#39;iso_code&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mypandas</span><span class="p">[</span><span class="s1">&#39;iso_code&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
            <span class="n">mypandasori</span><span class="o">=</span><span class="n">mypandas</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">strangeiso3tokick</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">mypandasori</span><span class="p">[</span><span class="s1">&#39;iso_code&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span> <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">==</span><span class="mi">3</span> <span class="p">]</span>
            <span class="n">mypandasori</span> <span class="o">=</span> <span class="n">mypandas</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="o">~</span><span class="n">mypandas</span><span class="o">.</span><span class="n">iso_code</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">strangeiso3tokick</span><span class="p">)]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">available_keys_words</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s1">&#39;iso_code&#39;</span><span class="p">)</span>
            <span class="n">mypandasori</span> <span class="o">=</span> <span class="n">mypandasori</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;location&#39;</span><span class="p">])</span>
            <span class="n">mypandasori</span> <span class="o">=</span> <span class="n">mypandasori</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;iso_code&#39;</span><span class="p">:</span><span class="s1">&#39;location&#39;</span><span class="p">})</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span> <span class="o">==</span> <span class="s1">&#39;owid&#39;</span><span class="p">:</span>
                <span class="n">onlyowid</span> <span class="o">=</span> <span class="n">mypandas</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">mypandas</span><span class="o">.</span><span class="n">iso_code</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">strangeiso3tokick</span><span class="p">)]</span>
                <span class="n">onlyowid</span> <span class="o">=</span> <span class="n">onlyowid</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="n">onlyowid</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="s1">&#39;location&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">onlyowid</span><span class="p">[</span><span class="s1">&#39;location&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span> <span class="p">:</span> <span class="s1">&#39;owid_&#39;</span><span class="o">+</span><span class="n">x</span><span class="p">)</span>
            <span class="n">mypandas</span> <span class="o">=</span> <span class="n">mypandasori</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span> <span class="o">==</span> <span class="s1">&#39;dpc&#39;</span><span class="p">:</span>
            <span class="n">gd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">geo</span><span class="o">.</span><span class="n">get_data</span><span class="p">()[[</span><span class="s1">&#39;code_region&#39;</span><span class="p">,</span><span class="s1">&#39;name_region&#39;</span><span class="p">]]</span>
            <span class="n">A</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;P.A. Bolzano&#39;</span><span class="p">,</span><span class="s1">&#39;P.A. Trento&#39;</span><span class="p">]</span>
            <span class="n">tmp</span><span class="o">=</span><span class="n">mypandas</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">mypandas</span><span class="o">.</span><span class="n">location</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">A</span><span class="p">)]</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;date&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
            <span class="n">tmp</span><span class="p">[</span><span class="s1">&#39;location&#39;</span><span class="p">]</span><span class="o">=</span><span class="s1">&#39;Trentino-Alto Adige&#39;</span>
            <span class="n">mypandas</span> <span class="o">=</span> <span class="n">mypandas</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="o">~</span><span class="n">mypandas</span><span class="o">.</span><span class="n">location</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">A</span><span class="p">)]</span>
            <span class="n">tmp</span> <span class="o">=</span> <span class="n">tmp</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
            <span class="n">mypandas</span> <span class="o">=</span> <span class="n">mypandas</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tmp</span><span class="p">)</span>
            <span class="n">uniqloc</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">mypandas</span><span class="p">[</span><span class="s1">&#39;location&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span>
            <span class="n">sub2reg</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">gd</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
            <span class="c1">#collections.OrderedDict(zip(uniqloc,list(gd.loc[gd.name_region.isin(uniqloc)][&#39;code_region&#39;])))</span>
            <span class="n">mypandas</span><span class="p">[</span><span class="s1">&#39;codelocation&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mypandas</span><span class="p">[</span><span class="s1">&#39;location&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">sub2reg</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span> <span class="o">==</span> <span class="s1">&#39;dgs&#39;</span><span class="p">:</span>
            <span class="n">gd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">geo</span><span class="o">.</span><span class="n">get_data</span><span class="p">()[[</span><span class="s1">&#39;name_region&#39;</span><span class="p">,</span><span class="s1">&#39;name_region&#39;</span><span class="p">]]</span>
            <span class="n">mypandas</span> <span class="o">=</span> <span class="n">mypandas</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">mypandas</span><span class="p">[</span><span class="s1">&#39;location&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mypandas</span><span class="p">[</span><span class="s1">&#39;location&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">title</span><span class="p">()</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;Do&#39;</span><span class="p">,</span> <span class="s1">&#39;do&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;Da&#39;</span><span class="p">,</span><span class="s1">&#39;da&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;De&#39;</span><span class="p">,</span><span class="s1">&#39;de&#39;</span><span class="p">))</span>
            <span class="n">uniqloc</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">mypandas</span><span class="p">[</span><span class="s1">&#39;location&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span>
            <span class="n">sub2reg</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">gd</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
            <span class="c1">#sub2reg = collections.OrderedDict(zip(uniqloc,list(gd.loc[gd.name_subregion.isin(uniqloc)][&#39;name_region&#39;])))</span>
            <span class="n">mypandas</span><span class="p">[</span><span class="s1">&#39;location&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mypandas</span><span class="p">[</span><span class="s1">&#39;location&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">sub2reg</span><span class="p">)</span>
            <span class="n">mypandas</span> <span class="o">=</span> <span class="n">mypandas</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="o">~</span><span class="n">mypandas</span><span class="o">.</span><span class="n">location</span><span class="o">.</span><span class="n">isnull</span><span class="p">()]</span>

         <span class="c1"># filling subregions.</span>
            <span class="n">gd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">geo</span><span class="o">.</span><span class="n">get_data</span><span class="p">()[[</span><span class="s1">&#39;code_region&#39;</span><span class="p">,</span><span class="s1">&#39;name_region&#39;</span><span class="p">]]</span>
            <span class="n">uniqloc</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">mypandas</span><span class="p">[</span><span class="s1">&#39;location&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span>
            <span class="n">name2code</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">OrderedDict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">uniqloc</span><span class="p">,</span><span class="nb">list</span><span class="p">(</span><span class="n">gd</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">gd</span><span class="o">.</span><span class="n">name_region</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">uniqloc</span><span class="p">)][</span><span class="s1">&#39;code_region&#39;</span><span class="p">])))</span>
            <span class="n">mypandas</span> <span class="o">=</span> <span class="n">mypandas</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="o">~</span><span class="n">mypandas</span><span class="o">.</span><span class="n">location</span><span class="o">.</span><span class="n">isnull</span><span class="p">()]</span>

        <span class="n">codename</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">location_is_code</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">uniqloc</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">mypandas</span><span class="p">[</span><span class="s1">&#39;location&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span> <span class="c1"># if possible location from csv are codelocation</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">db_world</span><span class="p">:</span>
            <span class="n">uniqloc</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">uniqloc</span> <span class="k">if</span> <span class="s1">&#39;OWID_&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">s</span><span class="p">]</span>
            <span class="n">codename</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">OrderedDict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">uniqloc</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">geo</span><span class="o">.</span><span class="n">to_standard</span><span class="p">(</span><span class="n">uniqloc</span><span class="p">,</span><span class="n">output</span><span class="o">=</span><span class="s1">&#39;list&#39;</span><span class="p">,</span><span class="n">db</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_db</span><span class="p">(),</span><span class="n">interpret_region</span><span class="o">=</span><span class="kc">True</span><span class="p">)))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">slocation</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">codename</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
            <span class="n">location_is_code</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">database_type</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;region&#39;</span> <span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span> <span class="o">==</span> <span class="s1">&#39;covid19india&#39;</span><span class="p">:</span>
                    <span class="n">mypandas</span> <span class="o">=</span> <span class="n">mypandas</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="o">~</span><span class="n">mypandas</span><span class="o">.</span><span class="n">location</span><span class="o">.</span><span class="n">isnull</span><span class="p">()]</span>
                    <span class="n">uniqloc</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">mypandas</span><span class="p">[</span><span class="s1">&#39;location&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span>
                <span class="n">temp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">geo</span><span class="o">.</span><span class="n">get_region_list</span><span class="p">()[[</span><span class="s1">&#39;name_region&#39;</span><span class="p">,</span><span class="s1">&#39;code_region&#39;</span><span class="p">]]</span>
                <span class="c1">#codename = collections.OrderedDict(zip(uniqloc,list(temp.loc[temp.name_region.isin(uniqloc)][&#39;code_region&#39;])))</span>
                <span class="n">codename</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">temp</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">slocation</span> <span class="o">=</span> <span class="n">uniqloc</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span> <span class="o">==</span> <span class="s1">&#39;obepine&#39;</span><span class="p">:</span>
                    <span class="n">codename</span> <span class="o">=</span> <span class="p">{</span><span class="n">v</span><span class="p">:</span><span class="n">k</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">codename</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
                    <span class="n">location_is_code</span> <span class="o">=</span> <span class="kc">True</span>

            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">database_type</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;subregion&#39;</span><span class="p">:</span>
                <span class="n">temp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">geo_all</span><span class="p">[[</span><span class="s1">&#39;code_subregion&#39;</span><span class="p">,</span><span class="s1">&#39;name_subregion&#39;</span><span class="p">]]</span>
                <span class="n">codename</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">temp</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">temp</span><span class="o">.</span><span class="n">code_subregion</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">uniqloc</span><span class="p">)]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;phe&#39;</span><span class="p">,</span><span class="s1">&#39;covidtracking&#39;</span><span class="p">,</span><span class="s1">&#39;spf&#39;</span><span class="p">,</span><span class="s1">&#39;escovid19data&#39;</span><span class="p">,</span><span class="s1">&#39;opencovid19&#39;</span><span class="p">,</span><span class="s1">&#39;minciencia&#39;</span><span class="p">,</span><span class="s1">&#39;moh&#39;</span><span class="p">]:</span>
                    <span class="c1">#codename={i:list(temp.loc[temp.code_subregion.isin([i])][&#39;name_subregion&#39;])[0] for i in uniqloc if not temp.loc[temp.code_subregion.isin([i])][&#39;name_subregion&#39;].empty }</span>
                    <span class="c1">#codename = collections.OrderedDict(zip(uniqloc,list(temp.loc[temp.code_subregion.isin(uniqloc)][&#39;name_subregion&#39;])))</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">slocation</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">codename</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
                    <span class="n">location_is_code</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1">#codename=dict(temp.loc[temp.code_subregion.isin(uniqloc)][[&#39;code_subregion&#39;,&#39;name_subregion&#39;]].values)</span>
                    <span class="c1">#codename={i:list(temp.loc[temp.code_subregion.isin([i])][&#39;code_subregion&#39;])[0] for i in uniqloc if not temp.loc[temp.code_subregion.isin([i])][&#39;code_subregion&#39;].empty }</span>
                    <span class="c1">#codename = collections.OrderedDict(zip(uniqloc,list(temp.loc[temp.name_subregion.isin(uniqloc)][&#39;code_subregion&#39;])))</span>
                    <span class="c1">#print(codename)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">slocation</span> <span class="o">=</span> <span class="n">uniqloc</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">CoaDbError</span><span class="p">(</span><span class="s1">&#39;Granularity problem , neither region nor sub_region ...&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span> <span class="o">==</span> <span class="s1">&#39;dgs&#39;</span><span class="p">:</span>
            <span class="n">mypandas</span> <span class="o">=</span> <span class="n">mypandas</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span> <span class="o">==</span> <span class="s1">&#39;spf&#39;</span><span class="p">:</span>
            <span class="n">mypandas</span> <span class="o">=</span> <span class="n">mypandas</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;location&#39;</span><span class="p">,</span> <span class="s1">&#39;date&#39;</span><span class="p">],</span> <span class="n">keep</span><span class="o">=</span><span class="s1">&#39;last&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span> <span class="o">!=</span> <span class="s1">&#39;spfnational&#39;</span><span class="p">:</span>
            <span class="n">mypandas</span> <span class="o">=</span> <span class="n">mypandas</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;location&#39;</span><span class="p">,</span><span class="s1">&#39;date&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">min_count</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span> <span class="c1"># summing in case of multiple dates (e.g. in opencovid19 data). But keep nan if any</span>
        <span class="n">mypandas</span> <span class="o">=</span> <span class="n">fill_missing_dates</span><span class="p">(</span><span class="n">mypandas</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">location_is_code</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span> <span class="o">!=</span> <span class="s1">&#39;dgs&#39;</span><span class="p">:</span>
                <span class="n">mypandas</span><span class="p">[</span><span class="s1">&#39;codelocation&#39;</span><span class="p">]</span> <span class="o">=</span>  <span class="n">mypandas</span><span class="p">[</span><span class="s1">&#39;location&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
            <span class="n">mypandas</span><span class="p">[</span><span class="s1">&#39;location&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mypandas</span><span class="p">[</span><span class="s1">&#39;location&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">codename</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span> <span class="o">==</span> <span class="s1">&#39;obepine&#39;</span><span class="p">:</span>
                <span class="n">mypandas</span> <span class="o">=</span> <span class="n">mypandas</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;location&#39;</span><span class="p">])</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">slocation</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">mypandas</span><span class="o">.</span><span class="n">codelocation</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span>
            <span class="n">mypandas</span> <span class="o">=</span> <span class="n">mypandas</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="o">~</span><span class="n">mypandas</span><span class="o">.</span><span class="n">location</span><span class="o">.</span><span class="n">isnull</span><span class="p">()]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">mypandas</span><span class="p">[</span><span class="s1">&#39;codelocation&#39;</span><span class="p">]</span> <span class="o">=</span>  <span class="n">mypandas</span><span class="p">[</span><span class="s1">&#39;location&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">codename</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span> <span class="o">==</span> <span class="s1">&#39;owid&#39;</span><span class="p">:</span>
            <span class="n">onlyowid</span><span class="p">[</span><span class="s1">&#39;codelocation&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">onlyowid</span><span class="p">[</span><span class="s1">&#39;location&#39;</span><span class="p">]</span>
            <span class="n">mypandas</span> <span class="o">=</span> <span class="n">mypandas</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">onlyowid</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mainpandas</span>  <span class="o">=</span> <span class="n">mypandas</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dates</span>  <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mainpandas</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">]</span></div>

<div class="viewcode-block" id="DataBase.get_mainpandas"><a class="viewcode-back" href="../../coa.covid19.html#coa.covid19.DataBase.get_mainpandas">[docs]</a>   <span class="k">def</span> <span class="nf">get_mainpandas</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
       <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">            * defaut :</span>
<span class="sd">                 - location = None</span>
<span class="sd">                 - date = None</span>
<span class="sd">                 - selected_col = None</span>
<span class="sd">                Return the csv file to the mainpandas structure</span>
<span class="sd">                index | location              | date      | keywords1       |  keywords2    | ...| keywordsn</span>
<span class="sd">                -----------------------------------------------------------------------------------------</span>
<span class="sd">                0     |        location1      |    1      |  l1-val1-1      |  l1-val2-1    | ...|  l1-valn-1</span>
<span class="sd">                1     |        location1      |    2      |  l1-val1-2      |  l1-val2-2    | ...|  l1-valn-2</span>
<span class="sd">                2     |        location1      |    3      |  l1-val1-3      |  l1-val2-3    | ...|  l1-valn-3</span>
<span class="sd">                                 ...</span>
<span class="sd">                p     |       locationp       |    1      |   lp-val1-1     |  lp-val2-1    | ...| lp-valn-1</span>
<span class="sd">                ...</span>
<span class="sd">            * location : list of location (None : all location)</span>
<span class="sd">            * date : latest date to retrieve (None : max date)</span>
<span class="sd">            * selected_col: column to keep according to get_available_keys_words (None : all get_available_keys_words)</span>
<span class="sd">                            N.B. location column is added</span>
<span class="sd">        &#39;&#39;&#39;</span>
       <span class="n">kwargs_test</span><span class="p">(</span><span class="n">kwargs</span><span class="p">,[</span><span class="s1">&#39;location&#39;</span><span class="p">,</span> <span class="s1">&#39;date&#39;</span><span class="p">,</span> <span class="s1">&#39;selected_col&#39;</span><span class="p">],</span>
                    <span class="s1">&#39;Bad args used in the get_stats() function.&#39;</span><span class="p">)</span>

       <span class="n">location</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;location&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
       <span class="n">selected_col</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;selected_col&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
       <span class="n">watch_date</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;date&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
       <span class="k">if</span> <span class="n">location</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">location</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                <span class="n">clist</span> <span class="o">=</span> <span class="p">([</span><span class="n">location</span><span class="p">])</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">clist</span> <span class="o">=</span> <span class="p">(</span><span class="n">location</span><span class="p">)</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">clist</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">CoaWhereError</span><span class="p">(</span><span class="s2">&quot;Location via the where keyword should be given as strings. &quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">db_world</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">geo</span><span class="o">.</span><span class="n">set_standard</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span> <span class="o">==</span> <span class="s1">&#39;owid&#39;</span><span class="p">:</span>
                    <span class="n">owid_name</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">clist</span> <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;owid_&#39;</span><span class="p">)]</span>
                    <span class="n">clist</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">clist</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">c</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;owid_&#39;</span><span class="p">)]</span>
                <span class="n">clist</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">geo</span><span class="o">.</span><span class="n">to_standard</span><span class="p">(</span><span class="n">clist</span><span class="p">,</span><span class="n">output</span><span class="o">=</span><span class="s1">&#39;list&#39;</span><span class="p">,</span> <span class="n">interpret_region</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">clist</span><span class="o">=</span><span class="n">clist</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">geo</span><span class="o">.</span><span class="n">get_subregions_from_list_of_region_names</span><span class="p">(</span><span class="n">clist</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">clist</span> <span class="o">==</span> <span class="p">[</span><span class="s1">&#39;FRA&#39;</span><span class="p">]</span> <span class="ow">or</span> <span class="n">clist</span> <span class="o">==</span> <span class="p">[</span><span class="s1">&#39;USA&#39;</span><span class="p">]</span> <span class="ow">or</span> <span class="n">clist</span> <span class="o">==</span> <span class="p">[</span><span class="s1">&#39;ITA&#39;</span><span class="p">]</span> <span class="p">:</span>
                    <span class="n">clist</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">geo_all</span><span class="p">[</span><span class="s1">&#39;code_subregion&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to_list</span><span class="p">()</span>
            <span class="n">clist</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">clist</span><span class="p">))</span> <span class="c1"># to suppress duplicate countries</span>
            <span class="n">diff_locations</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">clist</span><span class="p">)</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_locations</span><span class="p">()))</span>
            <span class="n">clist</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">clist</span> <span class="k">if</span> <span class="n">i</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">diff_locations</span><span class="p">]</span>
            <span class="n">filtered_pandas</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mainpandas</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">clist</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">owid_name</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">CoaWhereError</span><span class="p">(</span><span class="s1">&#39;Not a correct location found according to the where option given.&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span> <span class="o">==</span> <span class="s1">&#39;owid&#39;</span><span class="p">:</span>
                <span class="n">clist</span><span class="o">+=</span><span class="n">owid_name</span>
            <span class="n">filtered_pandas</span> <span class="o">=</span> <span class="n">filtered_pandas</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">filtered_pandas</span><span class="o">.</span><span class="n">location</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">clist</span><span class="p">)]</span>
            <span class="k">if</span> <span class="n">watch_date</span><span class="p">:</span>
                <span class="n">check_valid_date</span><span class="p">(</span><span class="n">watch_date</span><span class="p">)</span>
                <span class="n">mydate</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">watch_date</span><span class="p">)</span><span class="o">.</span><span class="n">date</span><span class="p">()</span>
            <span class="k">else</span> <span class="p">:</span>
                <span class="n">mydate</span> <span class="o">=</span> <span class="n">filtered_pandas</span><span class="o">.</span><span class="n">date</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
            <span class="n">filtered_pandas</span> <span class="o">=</span> <span class="n">filtered_pandas</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">filtered_pandas</span><span class="o">.</span><span class="n">date</span><span class="o">==</span><span class="n">mydate</span><span class="p">]</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">selected_col</span><span class="p">:</span>
                <span class="n">l</span> <span class="o">=</span> <span class="n">selected_col</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">l</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_available_keys_words</span><span class="p">())</span>
            <span class="n">l</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;location&#39;</span><span class="p">)</span>
            <span class="n">filtered_pandas</span> <span class="o">=</span> <span class="n">filtered_pandas</span><span class="p">[</span><span class="n">l</span><span class="p">]</span>
            <span class="k">return</span> <span class="n">filtered_pandas</span>
       <span class="bp">self</span><span class="o">.</span><span class="n">mainpandas</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mainpandas</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
       <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">mainpandas</span></div>

<div class="viewcode-block" id="DataBase.flat_list"><a class="viewcode-back" href="../../coa.covid19.html#coa.covid19.DataBase.flat_list">[docs]</a>   <span class="nd">@staticmethod</span>
   <span class="k">def</span> <span class="nf">flat_list</span><span class="p">(</span><span class="n">matrix</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Flatten list function used in covid19 methods&#39;&#39;&#39;</span>
        <span class="n">flatten_matrix</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">sublist</span> <span class="ow">in</span> <span class="n">matrix</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">sublist</span><span class="p">,</span><span class="nb">list</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">sublist</span><span class="p">:</span>
                    <span class="n">flatten_matrix</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">flatten_matrix</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sublist</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">flatten_matrix</span></div>

<div class="viewcode-block" id="DataBase.get_dates"><a class="viewcode-back" href="../../coa.covid19.html#coa.covid19.DataBase.get_dates">[docs]</a>   <span class="k">def</span> <span class="nf">get_dates</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Return all dates available in the current database as datetime format&#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">dates</span><span class="o">.</span><span class="n">values</span></div>

<div class="viewcode-block" id="DataBase.get_locations"><a class="viewcode-back" href="../../coa.covid19.html#coa.covid19.DataBase.get_locations">[docs]</a>   <span class="k">def</span> <span class="nf">get_locations</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Return available location countries / regions in the current database</span>
<span class="sd">            Using the geo method standardization</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">slocation</span></div>

<div class="viewcode-block" id="DataBase.return_nonan_dates_pandas"><a class="viewcode-back" href="../../coa.covid19.html#coa.covid19.DataBase.return_nonan_dates_pandas">[docs]</a>   <span class="k">def</span> <span class="nf">return_nonan_dates_pandas</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">field</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
         <span class="sd">&#39;&#39;&#39; Check if for last date all values are nan, if yes check previous date and loop until false&#39;&#39;&#39;</span>
         <span class="n">watchdate</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">date</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
         <span class="n">boolval</span> <span class="o">=</span> <span class="kc">True</span>
         <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span>
         <span class="k">while</span> <span class="p">(</span><span class="n">boolval</span><span class="p">):</span>
             <span class="n">boolval</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">date</span> <span class="o">==</span> <span class="p">(</span><span class="n">watchdate</span> <span class="o">-</span> <span class="n">dt</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="n">j</span><span class="p">))][</span><span class="n">field</span><span class="p">]</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span><span class="o">.</span><span class="n">empty</span>
             <span class="n">j</span> <span class="o">+=</span> <span class="mi">1</span>
         <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">date</span> <span class="o">&lt;=</span> <span class="n">watchdate</span> <span class="o">-</span> <span class="n">dt</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="n">j</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)]</span>
         <span class="n">boolval</span> <span class="o">=</span> <span class="kc">True</span>
         <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span>
         <span class="n">watchdate</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">date</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
         <span class="k">while</span> <span class="p">(</span><span class="n">boolval</span><span class="p">):</span>
             <span class="n">boolval</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">date</span> <span class="o">==</span> <span class="p">(</span><span class="n">watchdate</span> <span class="o">+</span> <span class="n">dt</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="n">j</span><span class="p">))][</span><span class="n">field</span><span class="p">]</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span><span class="o">.</span><span class="n">empty</span>
             <span class="n">j</span> <span class="o">+=</span> <span class="mi">1</span>
         <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">date</span> <span class="o">&gt;=</span> <span class="n">watchdate</span> <span class="o">-</span> <span class="n">dt</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="n">j</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)]</span>
         <span class="k">return</span> <span class="n">df</span></div>

<div class="viewcode-block" id="DataBase.get_stats"><a class="viewcode-back" href="../../coa.covid19.html#coa.covid19.DataBase.get_stats">[docs]</a>   <span class="k">def</span> <span class="nf">get_stats</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Return the pandas pandas_datase</span>
<span class="sd">         - index: only an incremental value</span>
<span class="sd">         - location: list of location used in the database selected (using geo standardization)</span>
<span class="sd">         - &#39;which&#39; :  return the keyword values selected from the avalailable keywords keepted seems</span>
<span class="sd">            self.get_available_keys_words()</span>

<span class="sd">         - &#39;option&#39; :default none</span>
<span class="sd">            * &#39;nonneg&#39; In some cases negatives values can appeared due to a database updated, nonneg option</span>
<span class="sd">                will smooth the curve during all the period considered</span>
<span class="sd">            * &#39;nofillnan&#39; if you do not want that NaN values are filled, which is the default behaviour</span>
<span class="sd">            * &#39;smooth7&#39; moving average, window of 7 days</span>
<span class="sd">            * &#39;sumall&#39; sum data over all locations</span>

<span class="sd">        keys are keyswords from the selected database</span>
<span class="sd">                location        | date      | keywords          |  daily            |  weekly</span>
<span class="sd">                -----------------------------------------------------------------------</span>
<span class="sd">                location1       |    1      |  val1-1           |  daily1-1          |  diff1-1</span>
<span class="sd">                location1       |    2      |  val1-2           |  daily1-2          |  diff1-2</span>
<span class="sd">                location1       |    3      |  val1-3           |  daily1-3          |  diff1-3</span>
<span class="sd">                    ...             ...                     ...</span>
<span class="sd">                location1       | last-date |  val1-lastdate    |  cumul1-lastdate   |   diff1-lastdate</span>
<span class="sd">                    ...</span>
<span class="sd">                location-i      |    1      |  vali-1           |  dailyi-1          |  diffi-1</span>
<span class="sd">                location-i      |    2      |  vali-1           |  daily1i-2         |  diffi-2</span>
<span class="sd">                location-i      |    3      |  vali-1           |  daily1i-3         |  diffi-3</span>
<span class="sd">                    ...</span>

<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">kwargs_test</span><span class="p">(</span><span class="n">kwargs</span><span class="p">,[</span><span class="s1">&#39;location&#39;</span><span class="p">,</span><span class="s1">&#39;which&#39;</span><span class="p">,</span><span class="s1">&#39;option&#39;</span><span class="p">],</span>
            <span class="s1">&#39;Bad args used in the get_stats() function.&#39;</span><span class="p">)</span>
        <span class="n">wallname</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="s1">&#39;location&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span> <span class="ow">or</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;location&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="o">.</span><span class="vm">__class__</span> <span class="ow">or</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;location&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">get_db_list_dict</span><span class="p">()[</span><span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;WW&#39;</span><span class="p">:</span>
                <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;location&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;world&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;location&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">slocation</span> <span class="c1">#self.geo_all[&#39;code_subregion&#39;].to_list()</span>
            <span class="n">wallname</span> <span class="o">=</span> <span class="n">get_db_list_dict</span><span class="p">()[</span><span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;location&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;location&#39;</span><span class="p">]</span>
        <span class="n">option</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;option&#39;</span><span class="p">,</span> <span class="s1">&#39;fillnan&#39;</span><span class="p">)</span>
        <span class="n">fillnan</span> <span class="o">=</span> <span class="kc">True</span> <span class="c1"># default</span>
        <span class="n">sumall</span> <span class="o">=</span> <span class="kc">False</span> <span class="c1"># default</span>
        <span class="n">sumallandsmooth7</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;which&#39;</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_available_keys_words</span><span class="p">()</span> <span class="p">:</span>
            <span class="k">raise</span> <span class="n">CoaKeyError</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;which&#39;</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39; is not a available for &#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span> <span class="o">+</span> <span class="s1">&#39; database name. &#39;</span>
            <span class="s1">&#39;See get_available_keys_words() for the full list.&#39;</span><span class="p">)</span>

        <span class="c1">#while for last date all values are nan previous date</span>
        <span class="n">mainpandas</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">return_nonan_dates_pandas</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_mainpandas</span><span class="p">(),</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;which&#39;</span><span class="p">])</span>
        <span class="n">devorigclist</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">origclistlist</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">origlistlistloc</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">option</span> <span class="ow">and</span> <span class="s1">&#39;sumall&#39;</span> <span class="ow">in</span> <span class="n">option</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;location&#39;</span><span class="p">],</span> <span class="nb">list</span><span class="p">):</span>
                <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;location&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[[</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;location&#39;</span><span class="p">]]]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;location&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="nb">list</span><span class="p">):</span>
                    <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;location&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;location&#39;</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;location&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;location&#39;</span><span class="p">]]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;location&#39;</span><span class="p">],</span> <span class="nb">list</span><span class="p">):</span>
            <span class="n">listloc</span> <span class="o">=</span> <span class="p">([</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;location&#39;</span><span class="p">]])</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">listloc</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">CoaWhereError</span><span class="p">(</span><span class="s2">&quot;Location via the where keyword should be given as strings. &quot;</span><span class="p">)</span>
            <span class="n">origclist</span> <span class="o">=</span> <span class="n">listloc</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">listloc</span> <span class="o">=</span> <span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;location&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">origclist</span> <span class="o">=</span> <span class="n">listloc</span>
            <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">listloc</span><span class="p">):</span>
                <span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">listloc</span><span class="p">):</span>
                    <span class="n">origlistlistloc</span> <span class="o">=</span> <span class="n">listloc</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">CoaWhereError</span><span class="p">(</span><span class="s2">&quot;In the case of sumall all locations must have the same types i.e</span><span class="se">\</span>
<span class="s2">                    list or string but both is not accepted, could be confusing&quot;</span><span class="p">)</span>

        <span class="n">owid_name</span><span class="o">=</span><span class="s1">&#39;&#39;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">db_world</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">geo</span><span class="o">.</span><span class="n">set_standard</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">origlistlistloc</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1">#fulllist = [ i if isinstance(i, list) else [i] for i in origclist ]</span>
                <span class="n">fulllist</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">deploy</span> <span class="ow">in</span> <span class="n">origlistlistloc</span><span class="p">:</span>
                    <span class="n">d</span><span class="o">=</span><span class="p">[]</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">deploy</span><span class="p">:</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">geo</span><span class="o">.</span><span class="n">get_GeoRegion</span><span class="p">()</span><span class="o">.</span><span class="n">is_region</span><span class="p">(</span><span class="n">i</span><span class="p">):</span>
                            <span class="n">d</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">geo</span><span class="o">.</span><span class="n">to_standard</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">output</span><span class="o">=</span><span class="s1">&#39;list&#39;</span><span class="p">,</span><span class="n">interpret_region</span><span class="o">=</span><span class="kc">True</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">d</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">geo</span><span class="o">.</span><span class="n">get_GeoRegion</span><span class="p">()</span><span class="o">.</span><span class="n">is_region</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
                    <span class="n">fulllist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
                <span class="n">dicooriglist</span> <span class="o">=</span> <span class="p">{</span> <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">i</span><span class="p">):</span><span class="bp">self</span><span class="o">.</span><span class="n">geo</span><span class="o">.</span><span class="n">to_standard</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">output</span><span class="o">=</span><span class="s1">&#39;list&#39;</span><span class="p">,</span><span class="n">interpret_region</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">fulllist</span><span class="p">}</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">owid_name</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">origclist</span> <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;owid_&#39;</span><span class="p">)]</span>
                <span class="n">clist</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">origclist</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">c</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;owid_&#39;</span><span class="p">)]</span>
                <span class="n">location_exploded</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">geo</span><span class="o">.</span><span class="n">to_standard</span><span class="p">(</span><span class="n">listloc</span><span class="p">,</span><span class="n">output</span><span class="o">=</span><span class="s1">&#39;list&#39;</span><span class="p">,</span><span class="n">interpret_region</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">owid_name</span><span class="p">)</span> <span class="o">!=</span><span class="mi">0</span> <span class="p">:</span>
                    <span class="n">location_exploded</span> <span class="o">+=</span> <span class="n">owid_name</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">def</span> <span class="nf">explosion</span><span class="p">(</span><span class="n">listloc</span><span class="p">,</span><span class="n">typeloc</span><span class="o">=</span><span class="s1">&#39;subregion&#39;</span><span class="p">):</span>
                <span class="n">exploded</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">a</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">geo</span><span class="o">.</span><span class="n">get_data</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">listloc</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">typeloc</span> <span class="o">==</span> <span class="s1">&#39;subregion&#39;</span><span class="p">:</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">geo</span><span class="o">.</span><span class="n">is_region</span><span class="p">(</span><span class="n">i</span><span class="p">):</span>
                            <span class="n">i</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">geo</span><span class="o">.</span><span class="n">is_region</span><span class="p">(</span><span class="n">i</span><span class="p">)]</span>
                            <span class="n">tmp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">geo</span><span class="o">.</span><span class="n">get_subregions_from_list_of_region_names</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">output</span><span class="o">=</span><span class="s1">&#39;name&#39;</span><span class="p">)</span>
                        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">geo</span><span class="o">.</span><span class="n">is_subregion</span><span class="p">(</span><span class="n">i</span><span class="p">):</span>
                           <span class="n">tmp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">geo</span><span class="o">.</span><span class="n">is_subregion</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="k">raise</span> <span class="n">CoaTypeError</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="s1">&#39;: not subregion nor region ... what is it ?&#39;</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="n">typeloc</span> <span class="o">==</span> <span class="s1">&#39;region&#39;</span><span class="p">:</span>
                        <span class="n">tmp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">geo</span><span class="o">.</span><span class="n">get_region_list</span><span class="p">()</span>
                        <span class="k">if</span> <span class="n">i</span><span class="o">.</span><span class="n">isdigit</span><span class="p">():</span>
                            <span class="n">tmp</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">tmp</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">tmp</span><span class="o">.</span><span class="n">code_region</span><span class="o">==</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;name_region&#39;</span><span class="p">])</span>
                        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">geo</span><span class="o">.</span><span class="n">is_region</span><span class="p">(</span><span class="n">i</span><span class="p">):</span>
                            <span class="n">tmp</span> <span class="o">=</span> <span class="n">i</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">geo</span><span class="o">.</span><span class="n">is_subregion</span><span class="p">(</span><span class="n">i</span><span class="p">):</span>
                                <span class="k">raise</span> <span class="n">CoaTypeError</span><span class="p">(</span><span class="n">i</span><span class="o">+</span> <span class="s1">&#39; is a subregion ... not compatible with a region DB granularity?&#39;</span><span class="p">)</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="k">raise</span> <span class="n">CoaTypeError</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="s1">&#39;: not subregion nor region ... what is it ?&#39;</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="n">CoaTypeError</span><span class="p">(</span><span class="s1">&#39;Not subregion nor region requested, don</span><span class="se">\&#39;</span><span class="s1">t know what to do ?&#39;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">exploded</span><span class="p">:</span>
                        <span class="n">exploded</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tmp</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">exploded</span><span class="o">=</span><span class="p">[</span><span class="n">tmp</span><span class="p">]</span>
                <span class="k">return</span> <span class="n">DataBase</span><span class="o">.</span><span class="n">flat_list</span><span class="p">(</span><span class="n">exploded</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">origlistlistloc</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">dicooriglist</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">i</span><span class="p">):</span><span class="n">explosion</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">database_type</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">origlistlistloc</span><span class="p">}</span>
                <span class="c1">#origlistlistloc = DataBase.flat_list(list(dicooriglist.values()))</span>
                <span class="c1">#location_exploded = origlistlistloc</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">listloc</span> <span class="o">=</span> <span class="n">explosion</span><span class="p">(</span><span class="n">listloc</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">database_type</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span>
                <span class="n">listloc</span> <span class="o">=</span> <span class="n">DataBase</span><span class="o">.</span><span class="n">flat_list</span><span class="p">(</span><span class="n">listloc</span><span class="p">)</span>
                <span class="n">location_exploded</span> <span class="o">=</span> <span class="n">listloc</span>

        <span class="k">def</span> <span class="nf">sticky</span><span class="p">(</span><span class="n">lname</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">lname</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
                <span class="n">tmp</span><span class="o">=</span><span class="s1">&#39;&#39;</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">lname</span><span class="p">:</span>
                    <span class="n">tmp</span> <span class="o">+=</span> <span class="n">i</span><span class="o">+</span><span class="s1">&#39;, &#39;</span>
                <span class="n">lname</span><span class="o">=</span><span class="n">tmp</span><span class="p">[:</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>
            <span class="k">return</span> <span class="p">[</span><span class="n">lname</span><span class="p">]</span>

        <span class="n">pdcluster</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
        <span class="n">j</span><span class="o">=</span><span class="mi">0</span>

        <span class="k">if</span> <span class="n">origlistlistloc</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">dicooriglist</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">tmp</span>  <span class="o">=</span> <span class="n">mainpandas</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">v</span><span class="p">):</span>
                    <span class="n">v</span><span class="o">=</span><span class="n">v</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">tmp</span> <span class="o">=</span> <span class="n">tmp</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">tmp</span><span class="o">.</span><span class="n">location</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">v</span><span class="p">)]</span>
                <span class="n">code</span> <span class="o">=</span> <span class="n">tmp</span><span class="o">.</span><span class="n">codelocation</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
                <span class="n">tmp</span><span class="p">[</span><span class="s1">&#39;clustername&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">tmp</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">pdcluster</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
                    <span class="n">pdcluster</span> <span class="o">=</span> <span class="n">tmp</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">pdcluster</span> <span class="o">=</span> <span class="n">pdcluster</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tmp</span><span class="p">)</span>
                <span class="n">j</span><span class="o">+=</span><span class="mi">1</span>
            <span class="n">pdfiltered</span> <span class="o">=</span> <span class="n">pdcluster</span><span class="p">[[</span><span class="s1">&#39;location&#39;</span><span class="p">,</span><span class="s1">&#39;date&#39;</span><span class="p">,</span><span class="s1">&#39;codelocation&#39;</span><span class="p">,</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;which&#39;</span><span class="p">],</span><span class="s1">&#39;clustername&#39;</span><span class="p">]]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">pdfiltered</span> <span class="o">=</span> <span class="n">mainpandas</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">mainpandas</span><span class="o">.</span><span class="n">location</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">location_exploded</span><span class="p">)]</span>
            <span class="n">pdfiltered</span> <span class="o">=</span> <span class="n">pdfiltered</span><span class="p">[[</span><span class="s1">&#39;location&#39;</span><span class="p">,</span><span class="s1">&#39;date&#39;</span><span class="p">,</span><span class="s1">&#39;codelocation&#39;</span><span class="p">,</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;which&#39;</span><span class="p">]]]</span>
            <span class="n">pdfiltered</span><span class="p">[</span><span class="s1">&#39;clustername&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pdfiltered</span><span class="p">[</span><span class="s1">&#39;location&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="c1"># deal with options now</span>
        <span class="c1">#if fillnan: # which is the default. Use nofillnan option instead.</span>
            <span class="c1"># fill with previous value</span>
        <span class="c1">#    pdfiltered = pdfiltered.copy()</span>
            <span class="c1">#if self.db_world:</span>
            <span class="c1">#pdfiltered[kwargs[&#39;which&#39;]] = pdfiltered.groupby([&#39;clustername&#39;])[kwargs[&#39;which&#39;]].fillna(method=&#39;bfill&#39;)</span>
        <span class="c1">#    pdfiltered.loc[:,kwargs[&#39;which&#39;]] = pdfiltered.groupby([&#39;clustername&#39;])[kwargs[&#39;which&#39;]].\</span>
        <span class="c1">#    apply(lambda x: x.bfill())</span>
            <span class="c1"># fill remaining nan with zeros</span>
            <span class="c1">#pdfiltered = pdfiltered.fillna(0)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">option</span><span class="p">,</span><span class="nb">list</span><span class="p">):</span>
            <span class="n">option</span><span class="o">=</span><span class="p">[</span><span class="n">option</span><span class="p">]</span>
        <span class="k">if</span> <span class="s1">&#39;fillnan&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">option</span> <span class="ow">and</span> <span class="s1">&#39;nofillnan&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">option</span><span class="p">:</span>
            <span class="n">option</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;fillnan&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="s1">&#39;nonneg&#39;</span> <span class="ow">in</span> <span class="n">option</span><span class="p">:</span>
            <span class="n">option</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s1">&#39;nonneg&#39;</span><span class="p">)</span>
            <span class="n">option</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;nonneg&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="s1">&#39;smooth7&#39;</span> <span class="ow">in</span>  <span class="n">option</span> <span class="ow">and</span> <span class="s1">&#39;sumall&#39;</span> <span class="ow">in</span>  <span class="n">option</span><span class="p">:</span>
            <span class="n">option</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s1">&#39;sumall&#39;</span><span class="p">)</span>
            <span class="n">option</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s1">&#39;smooth7&#39;</span><span class="p">)</span>
            <span class="n">option</span><span class="o">+=</span><span class="p">[</span><span class="s1">&#39;sumallandsmooth7&#39;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">option</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">o</span> <span class="o">==</span> <span class="s1">&#39;nonneg&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;which&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;cur_&#39;</span><span class="p">):</span>
                    <span class="k">raise</span> <span class="n">CoaKeyError</span><span class="p">(</span><span class="s1">&#39;The option nonneg cannot be used with instantaneous data, such as cur_ which variables.&#39;</span><span class="p">)</span>

                <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">location_exploded</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="nb">list</span><span class="p">):</span>
                    <span class="n">loopover</span> <span class="o">=</span> <span class="n">location_exploded</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">loopover</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">pdfiltered</span><span class="o">.</span><span class="n">location</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span>

                <span class="k">for</span> <span class="n">loca</span> <span class="ow">in</span> <span class="n">loopover</span><span class="p">:</span>
                    <span class="c1"># modify values in order that diff values is never negative</span>

                    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">location_exploded</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="nb">list</span><span class="p">):</span>
                        <span class="n">pdloc</span> <span class="o">=</span> <span class="n">pdfiltered</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span> <span class="n">pdfiltered</span><span class="o">.</span><span class="n">location</span> <span class="o">==</span> <span class="n">loca</span> <span class="p">][</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;which&#39;</span><span class="p">]]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">pdloc</span> <span class="o">=</span> <span class="n">pdfiltered</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span> <span class="n">pdfiltered</span><span class="o">.</span><span class="n">location</span> <span class="o">==</span> <span class="n">loca</span> <span class="p">][</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;which&#39;</span><span class="p">]]</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">y0</span><span class="o">=</span><span class="n">pdloc</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="c1"># integrated offset at t=0</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="n">y0</span><span class="o">=</span><span class="mi">0</span>
                    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">y0</span><span class="p">):</span>
                        <span class="n">y0</span><span class="o">=</span><span class="mi">0</span>
                    <span class="n">pa</span> <span class="o">=</span> <span class="n">pdloc</span><span class="o">.</span><span class="n">diff</span><span class="p">()</span>
                    <span class="n">yy</span> <span class="o">=</span> <span class="n">pa</span><span class="o">.</span><span class="n">values</span>
                    <span class="n">ind</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">pa</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
                    <span class="n">where_nan</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">yy</span><span class="p">)</span>
                    <span class="n">yy</span><span class="p">[</span><span class="n">where_nan</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.</span>
                    <span class="n">indices</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">yy</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="k">for</span> <span class="n">kk</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">yy</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]:</span>
                        <span class="n">k</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">kk</span><span class="p">)</span>
                        <span class="n">val_to_repart</span> <span class="o">=</span> <span class="o">-</span><span class="n">yy</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
                        <span class="k">if</span> <span class="n">k</span> <span class="o">&lt;</span> <span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">yy</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                            <span class="n">yy</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">yy</span><span class="p">[</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">yy</span><span class="p">[</span><span class="n">k</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span><span class="o">/</span><span class="mi">2</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">yy</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">yy</span><span class="p">[</span><span class="n">k</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                        <span class="n">val_to_repart</span> <span class="o">=</span> <span class="n">val_to_repart</span> <span class="o">+</span> <span class="n">yy</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
                        <span class="n">s</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nansum</span><span class="p">(</span><span class="n">yy</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">k</span><span class="p">])</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">([</span><span class="n">i</span> <span class="o">!=</span><span class="mi">0</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">yy</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">k</span><span class="p">]])</span> <span class="o">==</span> <span class="kc">True</span> <span class="ow">and</span> <span class="n">s</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="n">yy</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.</span>
                        <span class="k">elif</span> <span class="n">s</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="n">yy</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">yy</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">yy</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">k</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="nb">float</span><span class="p">(</span><span class="n">val_to_repart</span><span class="p">)</span><span class="o">/</span><span class="n">s</span><span class="p">)</span>
                    <span class="n">pdfilteredcopy</span><span class="o">=</span><span class="n">pdfiltered</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                    <span class="n">pdfilteredcopy</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">ind</span><span class="p">,</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;which&#39;</span><span class="p">]]</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">yy</span><span class="p">)</span><span class="o">+</span><span class="n">y0</span> <span class="c1"># do not forget the offset</span>
                    <span class="n">pdfiltered</span><span class="o">=</span><span class="n">pdfilteredcopy</span>
            <span class="k">elif</span> <span class="n">o</span> <span class="o">==</span> <span class="s1">&#39;nofillnan&#39;</span><span class="p">:</span>
                <span class="n">pdfiltered_nofillnan</span> <span class="o">=</span> <span class="n">pdfiltered</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">fillnan</span><span class="o">=</span><span class="kc">False</span>
            <span class="k">elif</span> <span class="n">o</span> <span class="o">==</span> <span class="s1">&#39;fillnan&#39;</span><span class="p">:</span>
                <span class="n">fillnan</span><span class="o">=</span><span class="kc">True</span>
                <span class="c1"># fill with previous value</span>
                <span class="n">pdfiltered</span> <span class="o">=</span> <span class="n">pdfiltered</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">pdfiltered_nofillnan</span> <span class="o">=</span> <span class="n">pdfiltered</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="n">pdfiltered</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;which&#39;</span><span class="p">]]</span> <span class="o">=</span>\
                <span class="n">pdfiltered</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;location&#39;</span><span class="p">,</span><span class="s1">&#39;clustername&#39;</span><span class="p">])[</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;which&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">bfill</span><span class="p">())</span>
                <span class="c1">#if kwargs[&#39;which&#39;].startswith(&#39;total_&#39;) or kwargs[&#39;which&#39;].startswith(&#39;tot_&#39;):</span>
                <span class="c1">#    pdfiltered.loc[:,kwargs[&#39;which&#39;]] = pdfiltered.groupby([&#39;clustername&#39;])[kwargs[&#39;which&#39;]].apply(lambda x: x.ffill())</span>
                <span class="k">if</span> <span class="n">pdfiltered</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">pdfiltered</span><span class="o">.</span><span class="n">date</span> <span class="o">==</span> <span class="n">pdfiltered</span><span class="o">.</span><span class="n">date</span><span class="o">.</span><span class="n">max</span><span class="p">()][</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;which&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">isnull</span><span class="p">()</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
                    <span class="nb">print</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;which&#39;</span><span class="p">],</span> <span class="s2">&quot;has been selected. Some missing data has been interpolated from previous data.&quot;</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;This warning appear right now due to some missing values at the latest date &quot;</span><span class="p">,</span> <span class="n">pdfiltered</span><span class="o">.</span><span class="n">date</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span><span class="s2">&quot;.&quot;</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Use the option=&#39;nofillnan&#39; if you want to only display the original data&quot;</span><span class="p">)</span>
                    <span class="n">pdfiltered</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;which&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">pdfiltered</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;clustername&#39;</span><span class="p">])[</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;which&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">ffill</span><span class="p">())</span>
                    <span class="n">pdfiltered</span> <span class="o">=</span> <span class="n">pdfiltered</span><span class="p">[</span><span class="n">pdfiltered</span><span class="p">[</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;which&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">notna</span><span class="p">()]</span>
            <span class="k">elif</span> <span class="n">o</span> <span class="o">==</span> <span class="s1">&#39;smooth7&#39;</span><span class="p">:</span>
                <span class="c1">#pdfiltered[kwargs[&#39;which&#39;]] = pdfiltered.groupby([&#39;clustername&#39;])[kwargs[&#39;which&#39;]].rolling(7,min_periods=7,center=True).mean().reset_index(level=0,drop=True)</span>
                <span class="c1">#pdfiltered[kwargs[&#39;which&#39;]] = pdfiltered.groupby([&#39;location&#39;])[kwargs[&#39;which&#39;]].rolling(7,min_periods=7,center=True).mean().reset_index(level=0,drop=True)</span>
                <span class="n">pdfiltered</span><span class="p">[</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;which&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">pdfiltered</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;location&#39;</span><span class="p">])[</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;which&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span><span class="n">min_periods</span><span class="o">=</span><span class="mi">7</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="c1">#pdfiltered[kwargs[&#39;which&#39;]] = pdfiltered[kwargs[&#39;which&#39;]].fillna(0) # causes bug with fillnan procedure below</span>
                <span class="c1">#pdfiltered = pdfiltered.groupby(&#39;location&#39;).apply(lambda x : x[3:-3]).reset_index(drop=True) # remove out of bound dates.</span>
                <span class="n">fillnan</span><span class="o">=</span><span class="kc">True</span>
                <span class="c1">#pdfiltered.loc[:,kwargs[&#39;which&#39;]] =\</span>
                <span class="c1">#pdfiltered.groupby([&#39;location&#39;,&#39;clustername&#39;])[kwargs[&#39;which&#39;]].apply(lambda x: x.bfill())</span>
            <span class="k">elif</span> <span class="n">o</span> <span class="o">==</span> <span class="s1">&#39;sumall&#39;</span><span class="p">:</span>
                <span class="n">sumall</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="c1">#if kwargs[&#39;which&#39;].startswith(&#39;cur_idx_Prc&#39;):</span>
                <span class="c1">#    print(&#39;Warning this data is from rolling value, ended date may be not correct ...&#39;)</span>
            <span class="k">elif</span> <span class="n">o</span> <span class="o">==</span> <span class="s1">&#39;sumallandsmooth7&#39;</span><span class="p">:</span>
                <span class="n">sumall</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">sumallandsmooth7</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">elif</span> <span class="n">o</span> <span class="o">!=</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">o</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span> <span class="ow">and</span> <span class="n">o</span> <span class="o">!=</span> <span class="s1">&#39;sumallandsmooth7&#39;</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">CoaKeyError</span><span class="p">(</span><span class="s1">&#39;The option &#39;</span><span class="o">+</span><span class="n">o</span><span class="o">+</span><span class="s1">&#39; is not recognized in get_stats. See get_available_options() for list.&#39;</span><span class="p">)</span>
        <span class="n">pdfiltered</span> <span class="o">=</span> <span class="n">pdfiltered</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># if sumall set, return only integrate val</span>
        <span class="n">tmppandas</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">sumall</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">origlistlistloc</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
               <span class="n">uniqcluster</span> <span class="o">=</span> <span class="n">pdfiltered</span><span class="o">.</span><span class="n">clustername</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
               <span class="k">if</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;which&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;cur_idx_&#39;</span><span class="p">):</span>
                   <span class="n">tmp</span> <span class="o">=</span> <span class="n">pdfiltered</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;clustername&#39;</span><span class="p">,</span><span class="s1">&#39;date&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
               <span class="k">else</span><span class="p">:</span>
                   <span class="n">tmp</span> <span class="o">=</span> <span class="n">pdfiltered</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;clustername&#39;</span><span class="p">,</span><span class="s1">&#39;date&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span><span class="c1">#.loc[pdfiltered.clustername.isin(uniqcluster)].\</span>

               <span class="c1">#dicocode = {i:list(pdfiltered.loc[pdfiltered.clustername.isin(i)][&#39;codelocation&#39;]) for i in uniqcluster}</span>
               <span class="n">codescluster</span> <span class="o">=</span> <span class="p">{</span><span class="n">i</span><span class="p">:</span><span class="nb">list</span><span class="p">(</span><span class="n">pdfiltered</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">pdfiltered</span><span class="o">.</span><span class="n">clustername</span><span class="o">==</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;codelocation&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">uniqcluster</span><span class="p">}</span>
               <span class="n">namescluster</span> <span class="o">=</span> <span class="p">{</span><span class="n">i</span><span class="p">:</span><span class="nb">list</span><span class="p">(</span><span class="n">pdfiltered</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">pdfiltered</span><span class="o">.</span><span class="n">clustername</span><span class="o">==</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;location&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">uniqcluster</span><span class="p">}</span>
               <span class="n">tmp</span><span class="p">[</span><span class="s1">&#39;codelocation&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">[</span><span class="s1">&#39;clustername&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">codescluster</span><span class="p">)</span>
               <span class="n">tmp</span><span class="p">[</span><span class="s1">&#39;location&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">[</span><span class="s1">&#39;clustername&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">namescluster</span><span class="p">)</span>

               <span class="c1">#if kwargs[&#39;which&#39;].startswith(&#39;cur_idx_&#39;):</span>
                    <span class="c1">#print(len(tmp.clustername[0].split(&#39;,&#39;)),tmp.clustername[0])</span>
                    <span class="c1">#tmp[kwargs[&#39;which&#39;]] = tmp.loc[tmp.clustername.isin(uniqcluster)].\</span>
                    <span class="c1">#apply(lambda x: x[kwargs[&#39;which&#39;]]/len(x.clustername[0].split(&#39;,&#39;)),axis=1)</span>
                <span class="c1">#    tmp[kwargs[&#39;which&#39;]]</span>
               <span class="n">pdfiltered</span> <span class="o">=</span> <span class="n">tmp</span>
               <span class="n">pdfiltered</span> <span class="o">=</span> <span class="n">pdfiltered</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">([</span><span class="s1">&#39;date&#39;</span><span class="p">,</span><span class="s1">&#39;clustername&#39;</span><span class="p">])</span>
               <span class="k">if</span> <span class="n">sumallandsmooth7</span><span class="p">:</span>
                   <span class="n">pdfiltered</span><span class="p">[</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;which&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">pdfiltered</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;clustername&#39;</span><span class="p">])[</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;which&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span><span class="n">min_periods</span><span class="o">=</span><span class="mi">7</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                   <span class="n">pdfiltered</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;which&#39;</span><span class="p">]]</span> <span class="o">=</span>\
                   <span class="n">pdfiltered</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;clustername&#39;</span><span class="p">])[</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;which&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">bfill</span><span class="p">())</span>
            <span class="c1"># computing daily, cumul and weekly</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;which&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;cur_idx_&#39;</span><span class="p">):</span>
                    <span class="n">tmp</span> <span class="o">=</span> <span class="n">pdfiltered</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;date&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">tmp</span> <span class="o">=</span> <span class="n">pdfiltered</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;date&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
                <span class="n">uniqloc</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">pdfiltered</span><span class="o">.</span><span class="n">location</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span>
                <span class="n">uniqcodeloc</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">pdfiltered</span><span class="o">.</span><span class="n">codelocation</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span>
                <span class="n">tmp</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="s1">&#39;location&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;dummy&#39;</span><span class="p">]</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">tmp</span><span class="p">)</span>
                <span class="n">tmp</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="s1">&#39;codelocation&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;dummy&#39;</span><span class="p">]</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">tmp</span><span class="p">)</span>
                <span class="n">tmp</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="s1">&#39;clustername&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;dummy&#39;</span><span class="p">]</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">tmp</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">tmp</span><span class="p">)):</span>
                    <span class="n">tmp</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="s1">&#39;location&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">uniqloc</span> <span class="c1">#sticky(uniqloc)</span>
                    <span class="n">tmp</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="s1">&#39;codelocation&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">uniqcodeloc</span> <span class="c1">#sticky(uniqcodeloc)</span>
                    <span class="n">tmp</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="s1">&#39;clustername&#39;</span><span class="p">]</span> <span class="o">=</span>  <span class="n">sticky</span><span class="p">(</span><span class="n">uniqloc</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">pdfiltered</span> <span class="o">=</span> <span class="n">tmp</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">db_world</span> <span class="p">:</span>
                <span class="n">pdfiltered</span><span class="p">[</span><span class="s1">&#39;clustername&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pdfiltered</span><span class="p">[</span><span class="s1">&#39;location&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">geo</span><span class="o">.</span><span class="n">to_standard</span><span class="p">(</span><span class="n">x</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">x</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;owid_&quot;</span><span class="p">)</span> <span class="k">else</span> <span class="n">x</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">pdfiltered</span><span class="p">[</span><span class="s1">&#39;clustername&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pdfiltered</span><span class="p">[</span><span class="s1">&#39;location&#39;</span><span class="p">]</span>

        <span class="n">pdfiltered</span><span class="p">[</span><span class="s1">&#39;daily&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pdfiltered</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;clustername&#39;</span><span class="p">)[</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;which&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">diff</span><span class="p">()</span>
        <span class="n">inx</span> <span class="o">=</span> <span class="n">pdfiltered</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;clustername&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">index</span>
        <span class="c1">#First value of diff is always NaN</span>
        <span class="n">pdfiltered</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">inx</span><span class="p">,</span> <span class="s1">&#39;daily&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pdfiltered</span><span class="p">[</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;which&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">inx</span><span class="p">]</span>
        <span class="k">if</span> <span class="s1">&#39;cur_&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;which&#39;</span><span class="p">]</span> <span class="ow">or</span> <span class="s1">&#39;total_&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;which&#39;</span><span class="p">]</span> <span class="ow">or</span> <span class="s1">&#39;tot_&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;which&#39;</span><span class="p">]:</span>
            <span class="n">pdfiltered</span><span class="p">[</span><span class="s1">&#39;cumul&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pdfiltered</span><span class="p">[</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;which&#39;</span><span class="p">]]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">pdfiltered</span><span class="p">[</span><span class="s1">&#39;cumul&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pdfiltered_nofillnan</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;clustername&#39;</span><span class="p">)[</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;which&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">cumsum</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">fillnan</span><span class="p">:</span>
                <span class="n">pdfiltered</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="s1">&#39;cumul&#39;</span><span class="p">]</span> <span class="o">=</span>\
                <span class="n">pdfiltered</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;location&#39;</span><span class="p">,</span><span class="s1">&#39;clustername&#39;</span><span class="p">])[</span><span class="s1">&#39;cumul&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">ffill</span><span class="p">())</span>
                <span class="n">pdfiltered</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="s1">&#39;daily&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pdfiltered</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;clustername&#39;</span><span class="p">)[</span><span class="s1">&#39;cumul&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">diff</span><span class="p">()</span>

        <span class="n">pdfiltered</span><span class="p">[</span><span class="s1">&#39;weekly&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pdfiltered</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;clustername&#39;</span><span class="p">)[</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;which&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span>
        <span class="n">inx7</span><span class="o">=</span><span class="n">pdfiltered</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;clustername&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span><span class="o">.</span><span class="n">index</span>
        <span class="n">pdfiltered</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">inx7</span><span class="p">,</span> <span class="s1">&#39;weekly&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pdfiltered</span><span class="p">[</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;which&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">inx7</span><span class="p">]</span>
        <span class="c1">#if fillnan:</span>
        <span class="c1">#    pdfiltered = pdfiltered.fillna(0) # for diff if needed</span>

        <span class="n">unifiedposition</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;location&#39;</span><span class="p">,</span> <span class="s1">&#39;date&#39;</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;which&#39;</span><span class="p">],</span> <span class="s1">&#39;daily&#39;</span><span class="p">,</span> <span class="s1">&#39;cumul&#39;</span><span class="p">,</span> <span class="s1">&#39;weekly&#39;</span><span class="p">,</span> <span class="s1">&#39;codelocation&#39;</span><span class="p">,</span><span class="s1">&#39;clustername&#39;</span><span class="p">]</span>
        <span class="n">pdfiltered</span> <span class="o">=</span> <span class="n">pdfiltered</span><span class="p">[</span><span class="n">unifiedposition</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">wallname</span> <span class="o">!=</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">sumall</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
               <span class="n">pdfiltered</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="s1">&#39;clustername&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">wallname</span>

        <span class="n">verb</span><span class="p">(</span><span class="s2">&quot;Here the information I</span><span class="se">\&#39;</span><span class="s2">ve got on &quot;</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;which&#39;</span><span class="p">],</span><span class="s2">&quot; : &quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_keyword_definition</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;which&#39;</span><span class="p">]))</span>
        <span class="k">return</span> <span class="n">pdfiltered</span></div>

<div class="viewcode-block" id="DataBase.merger"><a class="viewcode-back" href="../../coa.covid19.html#coa.covid19.DataBase.merger">[docs]</a>   <span class="k">def</span> <span class="nf">merger</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Merge two or more pycoa pandas from get_stats operation</span>
<span class="sd">        &#39;coapandas&#39;: list (min 2D) of pandas from stats</span>
<span class="sd">        &#39;whichcol&#39;: list variable associate to the coapandas list to be retrieve</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="n">coapandas</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;coapandas&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">whichcol</span> <span class="o">=</span>  <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;whichcol&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">coapandas</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">coapandas</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">coapandas</span><span class="p">)</span><span class="o">&lt;=</span><span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">CoaKeyError</span><span class="p">(</span><span class="s1">&#39;coapandas value must be at least a list of 2 elements ... &#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">whichcol</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">([</span> <span class="n">i</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">coapandas</span> <span class="p">])</span>
            <span class="n">whichcol</span> <span class="o">=</span> <span class="p">[</span> <span class="n">i</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">coapandas</span> <span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">whichcol</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">coapandas</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">CoaKeyError</span><span class="p">(</span><span class="s1">&#39;whichcol value must have same length as  coapandas i.e&#39;</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">coapandas</span><span class="p">)</span> <span class="o">+</span><span class="s1">&#39;... &#39;</span><span class="p">)</span>


        <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">([</span><span class="n">j</span> <span class="ow">in</span> <span class="n">i</span><span class="o">.</span><span class="n">columns</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">j</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">coapandas</span><span class="p">,</span><span class="n">whichcol</span><span class="p">)]):</span>
            <span class="k">raise</span> <span class="n">CoaKeyError</span><span class="p">(</span><span class="s1">&#39;Please check your coapandas and the associate whichcol &#39;</span><span class="p">)</span>

        <span class="n">base</span> <span class="o">=</span> <span class="n">coapandas</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">base</span> <span class="o">=</span> <span class="n">base</span><span class="p">[[</span><span class="s1">&#39;date&#39;</span><span class="p">,</span><span class="s1">&#39;clustername&#39;</span><span class="p">,</span><span class="n">whichcol</span><span class="p">[</span><span class="mi">0</span><span class="p">]]]</span>
        <span class="n">j</span><span class="o">=</span><span class="mi">1</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">coapandas</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
            <span class="n">p</span><span class="o">=</span><span class="n">p</span><span class="p">[[</span><span class="s1">&#39;date&#39;</span><span class="p">,</span><span class="s1">&#39;clustername&#39;</span><span class="p">,</span><span class="n">whichcol</span><span class="p">[</span><span class="n">j</span><span class="p">]]]</span>
            <span class="k">if</span> <span class="n">whichcol</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="ow">in</span> <span class="n">p</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                <span class="n">whichcol</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">+=</span> <span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">j</span><span class="p">)</span>
            <span class="n">p</span><span class="o">=</span><span class="n">p</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="n">whichcol</span><span class="p">[</span><span class="n">j</span><span class="p">]:</span><span class="n">whichcol</span><span class="p">[</span><span class="n">j</span><span class="p">]})</span>
            <span class="n">base</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">base</span><span class="p">,</span><span class="n">p</span><span class="p">,</span><span class="n">on</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">,</span><span class="s1">&#39;clustername&#39;</span><span class="p">])</span>
            <span class="n">j</span><span class="o">+=</span><span class="mi">1</span>
        <span class="k">if</span> <span class="s1">&#39;location&#39;</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">coapandas</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">columns</span><span class="p">):</span>
            <span class="n">base</span><span class="p">[[</span><span class="s1">&#39;where&#39;</span><span class="p">,</span><span class="s1">&#39;codelocation&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">coapandas</span><span class="p">[</span><span class="mi">0</span><span class="p">][[</span><span class="s1">&#39;location&#39;</span><span class="p">,</span><span class="s1">&#39;codelocation&#39;</span><span class="p">]]</span>  <span class="c1">#needed by display</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">base</span><span class="p">[[</span><span class="s1">&#39;where&#39;</span><span class="p">,</span><span class="s1">&#39;codelocation&#39;</span><span class="p">]]</span><span class="o">=</span> <span class="n">coapandas</span><span class="p">[</span><span class="mi">0</span><span class="p">][[</span><span class="s1">&#39;where&#39;</span><span class="p">,</span><span class="s1">&#39;codelocation&#39;</span><span class="p">]]</span>  <span class="c1">#needed by display</span>
        <span class="k">return</span> <span class="n">base</span></div>

<div class="viewcode-block" id="DataBase.saveoutput"><a class="viewcode-back" href="../../coa.covid19.html#coa.covid19.DataBase.saveoutput">[docs]</a>   <span class="k">def</span> <span class="nf">saveoutput</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
       <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">       saveoutput pycoas pandas as an  output file selected by output argument</span>
<span class="sd">       &#39;pandas&#39;: pycoa pandas</span>
<span class="sd">       &#39;saveformat&#39;: excel or csv (default excel)</span>
<span class="sd">       &#39;savename&#39;: pycoaout (default)</span>
<span class="sd">       &#39;&#39;&#39;</span>
       <span class="n">possibleformat</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;excel&#39;</span><span class="p">,</span><span class="s1">&#39;csv&#39;</span><span class="p">]</span>
       <span class="n">saveformat</span> <span class="o">=</span> <span class="s1">&#39;excel&#39;</span>
       <span class="n">savename</span> <span class="o">=</span> <span class="s1">&#39;pycoaout&#39;</span>
       <span class="n">pandyori</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
       <span class="k">if</span> <span class="s1">&#39;saveformat&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">saveformat</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;saveformat&#39;</span><span class="p">]</span>
       <span class="k">if</span> <span class="n">saveformat</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">possibleformat</span><span class="p">:</span>
           <span class="k">raise</span> <span class="n">CoaKeyError</span><span class="p">(</span><span class="s1">&#39;Output option &#39;</span><span class="o">+</span><span class="n">saveformat</span><span class="o">+</span><span class="s1">&#39; is not recognized.&#39;</span><span class="p">)</span>
       <span class="k">if</span> <span class="s1">&#39;savename&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span> <span class="ow">and</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;savename&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
          <span class="n">savename</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;savename&#39;</span><span class="p">]</span>

       <span class="k">if</span> <span class="ow">not</span> <span class="s1">&#39;pandas&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
          <span class="k">raise</span> <span class="n">CoaKeyError</span><span class="p">(</span><span class="s1">&#39;Absolute needed variable : the pandas desired &#39;</span><span class="p">)</span>
       <span class="k">else</span><span class="p">:</span>
          <span class="n">pandyori</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;pandas&#39;</span><span class="p">]</span>
       <span class="n">pandy</span> <span class="o">=</span> <span class="n">pandyori</span>
       <span class="n">pandy</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">pandy</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">])</span>
       <span class="n">pandy</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">pandy</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">))</span>
       <span class="k">if</span> <span class="n">saveformat</span> <span class="o">==</span> <span class="s1">&#39;excel&#39;</span><span class="p">:</span>
           <span class="n">pandy</span><span class="o">.</span><span class="n">to_excel</span><span class="p">(</span><span class="n">savename</span><span class="o">+</span><span class="s1">&#39;.xlsx&#39;</span><span class="p">,</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">na_rep</span><span class="o">=</span><span class="s1">&#39;NAN&#39;</span><span class="p">)</span>
       <span class="k">elif</span> <span class="n">saveformat</span> <span class="o">==</span> <span class="s1">&#39;csv&#39;</span><span class="p">:</span>
           <span class="n">pandy</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">savename</span><span class="o">+</span><span class="s1">&#39;.csv&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">float_format</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%.4f</span><span class="s1">&#39;</span><span class="p">,</span><span class="n">na_rep</span><span class="o">=</span><span class="s1">&#39;NAN&#39;</span><span class="p">)</span></div>

   <span class="c1">## https://www.kaggle.com/freealf/estimation-of-rt-from-cases</span>
<div class="viewcode-block" id="DataBase.smooth_cases"><a class="viewcode-back" href="../../coa.covid19.html#coa.covid19.DataBase.smooth_cases">[docs]</a>   <span class="k">def</span> <span class="nf">smooth_cases</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">cases</span><span class="p">):</span>
        <span class="n">new_cases</span> <span class="o">=</span> <span class="n">cases</span>

        <span class="n">smoothed</span> <span class="o">=</span> <span class="n">new_cases</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span>
            <span class="n">win_type</span><span class="o">=</span><span class="s1">&#39;gaussian&#39;</span><span class="p">,</span>
            <span class="n">min_periods</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
            <span class="n">center</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">std</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">round</span><span class="p">()</span>
            <span class="c1">#center=False).mean(std=2).round()</span>

        <span class="n">zeros</span> <span class="o">=</span> <span class="n">smoothed</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">smoothed</span><span class="o">.</span><span class="n">eq</span><span class="p">(</span><span class="mi">0</span><span class="p">)]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">zeros</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">idx_start</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">last_zero</span> <span class="o">=</span> <span class="n">zeros</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
            <span class="n">idx_start</span> <span class="o">=</span> <span class="n">smoothed</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">get_loc</span><span class="p">(</span><span class="n">last_zero</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="n">smoothed</span> <span class="o">=</span> <span class="n">smoothed</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">idx_start</span><span class="p">:]</span>
        <span class="n">original</span> <span class="o">=</span> <span class="n">new_cases</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">smoothed</span><span class="o">.</span><span class="n">index</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">smoothed</span></div>
<div class="viewcode-block" id="DataBase.get_posteriors"><a class="viewcode-back" href="../../coa.covid19.html#coa.covid19.DataBase.get_posteriors">[docs]</a>   <span class="k">def</span> <span class="nf">get_posteriors</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">sr</span><span class="p">,</span> <span class="n">window</span><span class="o">=</span><span class="mi">7</span><span class="p">,</span> <span class="n">min_periods</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="c1"># We create an array for every possible value of Rt</span>
        <span class="n">R_T_MAX</span> <span class="o">=</span> <span class="mi">12</span>
        <span class="n">r_t_range</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">R_T_MAX</span><span class="p">,</span> <span class="n">R_T_MAX</span><span class="o">*</span><span class="mi">100</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>

        <span class="c1"># Gamma is 1/serial interval</span>
        <span class="c1"># https://wwwnc.cdc.gov/eid/article/26/6/20-0357_article</span>
        <span class="n">GAMMA</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="mi">7</span>

        <span class="n">lam</span> <span class="o">=</span> <span class="n">sr</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">values</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">GAMMA</span> <span class="o">*</span> <span class="p">(</span><span class="n">r_t_range</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>

        <span class="c1"># Note: if you want to have a Uniform prior you can use the following line instead.</span>
        <span class="c1"># I chose the gamma distribution because of our prior knowledge of the likely value</span>
        <span class="c1"># of R_t.</span>

        <span class="c1"># prior0 = np.full(len(r_t_range), np.log(1/len(r_t_range)))</span>
        <span class="n">prior0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">sps</span><span class="o">.</span><span class="n">gamma</span><span class="p">(</span><span class="n">a</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span><span class="o">.</span><span class="n">pdf</span><span class="p">(</span><span class="n">r_t_range</span><span class="p">)</span> <span class="o">+</span> <span class="mf">1e-14</span><span class="p">)</span>

        <span class="n">likelihoods</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
            <span class="c1"># Short-hand way of concatenating the prior and likelihoods</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">c_</span><span class="p">[</span><span class="n">prior0</span><span class="p">,</span> <span class="n">sps</span><span class="o">.</span><span class="n">poisson</span><span class="o">.</span><span class="n">logpmf</span><span class="p">(</span><span class="n">sr</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">lam</span><span class="p">)],</span>
            <span class="n">index</span> <span class="o">=</span> <span class="n">r_t_range</span><span class="p">,</span>
            <span class="n">columns</span> <span class="o">=</span> <span class="n">sr</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>

        <span class="c1"># Perform a rolling sum of log likelihoods. This is the equivalent</span>
        <span class="c1"># of multiplying the original distributions. Exponentiate to move</span>
        <span class="c1"># out of log.</span>
        <span class="n">posteriors</span> <span class="o">=</span> <span class="n">likelihoods</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">window</span><span class="p">,</span>
                                     <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                                     <span class="n">min_periods</span><span class="o">=</span><span class="n">min_periods</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="n">posteriors</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">posteriors</span><span class="p">)</span>

        <span class="c1"># Normalize to 1.0</span>
        <span class="n">posteriors</span> <span class="o">=</span> <span class="n">posteriors</span><span class="o">.</span><span class="n">div</span><span class="p">(</span><span class="n">posteriors</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">posteriors</span></div></div>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2021, Pycoa.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>