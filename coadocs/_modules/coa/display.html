<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>coa.display &mdash; coa,  dev documentation</title>
      <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/graphviz.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/doctools.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../../index.html" class="icon icon-home"> coa, 
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../coa.html">coa package</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">coa, </a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home"></a> &raquo;</li>
          <li><a href="../index.html">Module code</a> &raquo;</li>
      <li>coa.display</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for coa.display</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Project : PyCoA</span>
<span class="sd">Date :    april 2020 - march 2021</span>
<span class="sd">Authors : Olivier Dadoun, Julien Browaeys, Tristan Beau</span>
<span class="sd">Copyright ©pycoa.fr</span>
<span class="sd">License: See joint LICENSE file</span>

<span class="sd">Module : coa.display</span>

<span class="sd">About :</span>
<span class="sd">-------</span>

<span class="sd">An interface module to easily plot pycoa data with bokeh</span>

<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">from</span> <span class="nn">coa.tools</span> <span class="kn">import</span> <span class="n">kwargs_test</span><span class="p">,</span> <span class="n">extract_dates</span><span class="p">,</span> <span class="n">verb</span><span class="p">,</span> <span class="n">get_db_list_dict</span>
<span class="kn">from</span> <span class="nn">coa.error</span> <span class="kn">import</span> <span class="o">*</span>

<span class="kn">import</span> <span class="nn">math</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">geopandas</span> <span class="k">as</span> <span class="nn">gpd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">defaultdict</span>
<span class="kn">import</span> <span class="nn">itertools</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">io</span>
<span class="kn">from</span> <span class="nn">io</span> <span class="kn">import</span> <span class="n">BytesIO</span>
<span class="kn">import</span> <span class="nn">base64</span>
<span class="kn">from</span> <span class="nn">IPython</span> <span class="kn">import</span> <span class="n">display</span>

<span class="kn">from</span> <span class="nn">bokeh.models</span> <span class="kn">import</span> <span class="n">ColumnDataSource</span><span class="p">,</span> <span class="n">TableColumn</span><span class="p">,</span> <span class="n">DataTable</span><span class="p">,</span> <span class="n">ColorBar</span><span class="p">,</span> \
    <span class="n">HoverTool</span><span class="p">,</span> <span class="n">CrosshairTool</span><span class="p">,</span> <span class="n">BasicTicker</span><span class="p">,</span> <span class="n">GeoJSONDataSource</span><span class="p">,</span> <span class="n">LinearColorMapper</span><span class="p">,</span> <span class="n">Label</span><span class="p">,</span> \
    <span class="n">PrintfTickFormatter</span><span class="p">,</span> <span class="n">BasicTickFormatter</span><span class="p">,</span> <span class="n">CustomJS</span><span class="p">,</span> <span class="n">CustomJSHover</span><span class="p">,</span> <span class="n">Select</span><span class="p">,</span> \
    <span class="n">Range1d</span><span class="p">,</span> <span class="n">DatetimeTickFormatter</span><span class="p">,</span> <span class="n">Legend</span><span class="p">,</span> <span class="n">LegendItem</span><span class="p">,</span> <span class="n">Text</span>
<span class="kn">from</span> <span class="nn">bokeh.models.widgets</span> <span class="kn">import</span> <span class="n">Tabs</span><span class="p">,</span> <span class="n">Panel</span>
<span class="kn">from</span> <span class="nn">bokeh.plotting</span> <span class="kn">import</span> <span class="n">figure</span>
<span class="kn">from</span> <span class="nn">bokeh.layouts</span> <span class="kn">import</span> <span class="n">row</span><span class="p">,</span> <span class="n">column</span><span class="p">,</span> <span class="n">gridplot</span>
<span class="kn">from</span> <span class="nn">bokeh.palettes</span> <span class="kn">import</span> <span class="n">Category10</span><span class="p">,</span> <span class="n">Category20</span><span class="p">,</span> <span class="n">Viridis256</span>
<span class="kn">from</span> <span class="nn">bokeh.models</span> <span class="kn">import</span> <span class="n">Title</span>

<span class="kn">from</span> <span class="nn">bokeh.io</span> <span class="kn">import</span> <span class="n">export_png</span>
<span class="kn">from</span> <span class="nn">bokeh</span> <span class="kn">import</span> <span class="n">events</span>
<span class="kn">from</span> <span class="nn">bokeh.models.widgets</span> <span class="kn">import</span> <span class="n">DateSlider</span>
<span class="kn">from</span> <span class="nn">bokeh.models</span> <span class="kn">import</span> <span class="n">LabelSet</span><span class="p">,</span> <span class="n">WMTSTileSource</span>
<span class="kn">from</span> <span class="nn">bokeh.transform</span> <span class="kn">import</span> <span class="n">transform</span><span class="p">,</span> <span class="n">cumsum</span>

<span class="kn">import</span> <span class="nn">shapely.geometry</span> <span class="k">as</span> <span class="nn">sg</span>

<span class="kn">import</span> <span class="nn">branca.colormap</span>
<span class="kn">from</span> <span class="nn">branca.colormap</span> <span class="kn">import</span> <span class="n">LinearColormap</span>
<span class="kn">from</span> <span class="nn">branca.element</span> <span class="kn">import</span> <span class="n">Element</span><span class="p">,</span> <span class="n">Figure</span>
<span class="kn">import</span> <span class="nn">folium</span>
<span class="kn">from</span> <span class="nn">PIL</span> <span class="kn">import</span> <span class="n">Image</span>
<span class="kn">import</span> <span class="nn">coa.geo</span> <span class="k">as</span> <span class="nn">coge</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">datetime</span> <span class="k">as</span> <span class="nn">dt</span>
<span class="kn">import</span> <span class="nn">bisect</span>
<span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">wraps</span>

<span class="n">width_height_default</span> <span class="o">=</span> <span class="p">[</span><span class="mi">500</span><span class="p">,</span> <span class="mi">380</span><span class="p">]</span>


<div class="viewcode-block" id="CocoDisplay"><a class="viewcode-back" href="../../coa.display.html#coa.display.CocoDisplay">[docs]</a><span class="k">class</span> <span class="nc">CocoDisplay</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">db</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">geo</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="n">verb</span><span class="p">(</span><span class="s2">&quot;Init of CocoDisplay() with db=&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">db</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">database_name</span> <span class="o">=</span> <span class="n">db</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dbld</span> <span class="o">=</span> <span class="n">get_db_list_dict</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lcolors</span> <span class="o">=</span> <span class="n">Category20</span><span class="p">[</span><span class="mi">20</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scolors</span> <span class="o">=</span> <span class="n">Category10</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ax_type</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;linear&#39;</span><span class="p">,</span> <span class="s1">&#39;log&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">geom</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">geopan</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">GeoDataFrame</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">location_geometry</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">boundary_metropole</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">options_stats</span>  <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;when&#39;</span><span class="p">,</span><span class="s1">&#39;input&#39;</span><span class="p">,</span><span class="s1">&#39;input_field&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">options_charts</span> <span class="o">=</span> <span class="p">[</span> <span class="s1">&#39;bins&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">options_front</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;where&#39;</span><span class="p">,</span><span class="s1">&#39;option&#39;</span><span class="p">,</span><span class="s1">&#39;which&#39;</span><span class="p">,</span><span class="s1">&#39;what&#39;</span><span class="p">,</span><span class="s1">&#39;visu&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">available_tiles</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;openstreet&#39;</span><span class="p">,</span><span class="s1">&#39;esri&#39;</span><span class="p">,</span><span class="s1">&#39;stamen&#39;</span><span class="p">,</span><span class="s1">&#39;positron&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">available_modes</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;mouse&#39;</span><span class="p">,</span><span class="s1">&#39;vline&#39;</span><span class="p">,</span><span class="s1">&#39;hline&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">available_textcopyrightposition</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;left&#39;</span><span class="p">,</span><span class="s1">&#39;right&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">uptitle</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">subtitle</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span><span class="p">,</span><span class="s1">&#39; &#39;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">dfigure_default</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;plot_height&#39;</span><span class="p">:</span><span class="n">width_height_default</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="p">,</span><span class="s1">&#39;plot_width&#39;</span><span class="p">:</span><span class="n">width_height_default</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="s1">&#39;title&#39;</span><span class="p">:</span><span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;textcopyrightposition&#39;</span><span class="p">:</span><span class="s1">&#39;left&#39;</span><span class="p">,</span><span class="s1">&#39;textcopyright&#39;</span><span class="p">:</span><span class="s1">&#39;default&#39;</span><span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dvisu_default</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;mode&#39;</span><span class="p">:</span><span class="s1">&#39;mouse&#39;</span><span class="p">,</span><span class="s1">&#39;tile&#39;</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">available_tiles</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="s1">&#39;orientation&#39;</span><span class="p">:</span><span class="s1">&#39;horizontal&#39;</span><span class="p">,</span><span class="s1">&#39;cursor_date&#39;</span><span class="p">:</span><span class="kc">None</span><span class="p">,</span><span class="s1">&#39;maplabel&#39;</span><span class="p">:</span><span class="kc">None</span><span class="p">,</span><span class="s1">&#39;guideline&#39;</span><span class="p">:</span><span class="kc">False</span><span class="p">}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">when_beg</span> <span class="o">=</span> <span class="n">dt</span><span class="o">.</span><span class="n">date</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">when_end</span> <span class="o">=</span> <span class="n">dt</span><span class="o">.</span><span class="n">date</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">alloptions</span> <span class="o">=</span>  <span class="bp">self</span><span class="o">.</span><span class="n">options_stats</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">options_charts</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">options_front</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dfigure_default</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dvisu_default</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbld</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">database_name</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;WW&#39;</span> <span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">geo</span><span class="o">=</span><span class="n">coge</span><span class="o">.</span><span class="n">GeoCountry</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dbld</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">database_name</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">country</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbld</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">database_name</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                <span class="c1">#self.boundary = geo[&#39;geometry&#39;].total_bounds</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbld</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">database_name</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;region&#39;</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">location_geometry</span> <span class="o">=</span> <span class="n">geo</span><span class="o">.</span><span class="n">get_region_list</span><span class="p">()[[</span><span class="s1">&#39;code_region&#39;</span><span class="p">,</span> <span class="s1">&#39;name_region&#39;</span><span class="p">,</span> <span class="s1">&#39;geometry&#39;</span><span class="p">]]</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">location_geometry</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">location_geometry</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;name_region&#39;</span><span class="p">:</span> <span class="s1">&#39;location&#39;</span><span class="p">})</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbld</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">database_name</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;PRT&#39;</span><span class="p">:</span>
                         <span class="n">tmp</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">location_geometry</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;name_region&#39;</span><span class="p">:</span> <span class="s1">&#39;location&#39;</span><span class="p">})</span>
                         <span class="n">tmp</span> <span class="o">=</span> <span class="n">tmp</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">tmp</span><span class="o">.</span><span class="n">code_region</span><span class="o">==</span><span class="s1">&#39;PT.99&#39;</span><span class="p">]</span>
                         <span class="bp">self</span><span class="o">.</span><span class="n">boundary_metropole</span> <span class="o">=</span><span class="n">tmp</span><span class="p">[</span><span class="s1">&#39;geometry&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">total_bounds</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbld</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">database_name</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;FRA&#39;</span><span class="p">:</span>
                         <span class="n">tmp</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">location_geometry</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;name_region&#39;</span><span class="p">:</span> <span class="s1">&#39;location&#39;</span><span class="p">})</span>
                         <span class="n">tmp</span> <span class="o">=</span> <span class="n">tmp</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">tmp</span><span class="o">.</span><span class="n">code_region</span><span class="o">==</span><span class="s1">&#39;999&#39;</span><span class="p">]</span>
                         <span class="bp">self</span><span class="o">.</span><span class="n">boundary_metropole</span> <span class="o">=</span><span class="n">tmp</span><span class="p">[</span><span class="s1">&#39;geometry&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">total_bounds</span>

                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbld</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">database_name</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;subregion&#39;</span><span class="p">:</span>
                    <span class="n">list_dep_metro</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">location_geometry</span> <span class="o">=</span> <span class="n">geo</span><span class="o">.</span><span class="n">get_subregion_list</span><span class="p">()[[</span><span class="s1">&#39;code_subregion&#39;</span><span class="p">,</span> <span class="s1">&#39;name_subregion&#39;</span><span class="p">,</span> <span class="s1">&#39;geometry&#39;</span><span class="p">]]</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">location_geometry</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">location_geometry</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;name_subregion&#39;</span><span class="p">:</span> <span class="s1">&#39;location&#39;</span><span class="p">})</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbld</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">database_name</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;FRA&#39;</span><span class="p">:</span>
                         <span class="n">list_dep_metro</span> <span class="o">=</span>  <span class="n">geo</span><span class="o">.</span><span class="n">get_subregions_from_region</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;Métropole&#39;</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbld</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">database_name</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;ESP&#39;</span><span class="p">:</span>
                         <span class="n">list_dep_metro</span> <span class="o">=</span>  <span class="n">geo</span><span class="o">.</span><span class="n">get_subregions_from_region</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;España peninsular&#39;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">list_dep_metro</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">boundary_metropole</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">location_geometry</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">location_geometry</span><span class="o">.</span><span class="n">code_subregion</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">list_dep_metro</span><span class="p">)][</span><span class="s1">&#39;geometry&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">total_bounds</span>

            <span class="k">else</span><span class="p">:</span>
                   <span class="bp">self</span><span class="o">.</span><span class="n">geo</span><span class="o">=</span><span class="n">coge</span><span class="o">.</span><span class="n">GeoManager</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">)</span>
                   <span class="n">geopan</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">GeoDataFrame</span><span class="p">()</span><span class="c1">#crs=&quot;EPSG:4326&quot;)</span>
                   <span class="n">info</span> <span class="o">=</span> <span class="n">coge</span><span class="o">.</span><span class="n">GeoInfo</span><span class="p">()</span>
                   <span class="n">allcountries</span> <span class="o">=</span> <span class="n">geo</span><span class="o">.</span><span class="n">get_GeoRegion</span><span class="p">()</span><span class="o">.</span><span class="n">get_countries_from_region</span><span class="p">(</span><span class="s1">&#39;world&#39;</span><span class="p">)</span>
                   <span class="n">geopan</span><span class="p">[</span><span class="s1">&#39;location&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">geo</span><span class="o">.</span><span class="n">to_standard</span><span class="p">(</span><span class="n">c</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">allcountries</span><span class="p">]</span>
                   <span class="n">geopan</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">add_field</span><span class="p">(</span><span class="n">field</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;geometry&#39;</span><span class="p">],</span><span class="nb">input</span><span class="o">=</span><span class="n">geopan</span> <span class="p">,</span><span class="n">geofield</span><span class="o">=</span><span class="s1">&#39;location&#39;</span><span class="p">)</span>
                   <span class="n">geopan</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">GeoDataFrame</span><span class="p">(</span><span class="n">geopan</span><span class="p">,</span> <span class="n">geometry</span><span class="o">=</span><span class="n">geopan</span><span class="o">.</span><span class="n">geometry</span><span class="p">,</span> <span class="n">crs</span><span class="o">=</span><span class="s2">&quot;EPSG:4326&quot;</span><span class="p">)</span>
                   <span class="n">geopan</span> <span class="o">=</span> <span class="n">geopan</span><span class="p">[</span><span class="n">geopan</span><span class="o">.</span><span class="n">location</span> <span class="o">!=</span> <span class="s1">&#39;Antarctica&#39;</span><span class="p">]</span>
                   <span class="n">geopan</span> <span class="o">=</span> <span class="n">geopan</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                   <span class="bp">self</span><span class="o">.</span><span class="n">location_geometry</span>  <span class="o">=</span> <span class="n">geopan</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">CoaTypeError</span><span class="p">(</span><span class="s1">&#39;What data base are you looking for ?&#39;</span><span class="p">)</span>

    <span class="sd">&#39;&#39;&#39; FIGURE COMMUN FOR ALL &#39;&#39;&#39;</span>
<div class="viewcode-block" id="CocoDisplay.standardfig"><a class="viewcode-back" href="../../coa.display.html#coa.display.CocoDisplay.standardfig">[docs]</a>    <span class="k">def</span> <span class="nf">standardfig</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">         Create a standard Bokeh figure, with pycoa.fr copyright, used in all the bokeh charts</span>
<span class="sd">         &quot;&quot;&quot;</span>
        <span class="n">plot_width</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;plot_width&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dfigure_default</span><span class="p">[</span><span class="s1">&#39;plot_width&#39;</span><span class="p">])</span>
        <span class="n">plot_height</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;plot_height&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dfigure_default</span><span class="p">[</span><span class="s1">&#39;plot_height&#39;</span><span class="p">])</span>
        <span class="n">textcopyright</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;textcopyright&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dfigure_default</span><span class="p">[</span><span class="s1">&#39;textcopyright&#39;</span><span class="p">])</span>
        <span class="n">textcopyrightposition</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;textcopyrightposition&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dfigure_default</span><span class="p">[</span><span class="s1">&#39;textcopyrightposition&#39;</span><span class="p">])</span>

        <span class="k">if</span> <span class="n">textcopyrightposition</span> <span class="o">==</span> <span class="s1">&#39;right&#39;</span><span class="p">:</span>
            <span class="n">xpos</span> <span class="o">=</span> <span class="mf">0.65</span>
        <span class="k">elif</span> <span class="n">textcopyrightposition</span> <span class="o">==</span> <span class="s1">&#39;left&#39;</span><span class="p">:</span>
            <span class="n">xpos</span> <span class="o">=</span> <span class="mf">0.08</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">CoaKeyError</span><span class="p">(</span><span class="s1">&#39;textcopyrightposition: must be right or left&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">textcopyright</span>  <span class="o">==</span> <span class="s1">&#39;default&#39;</span><span class="p">:</span>
                <span class="n">textcopyright</span> <span class="o">=</span> <span class="s1">&#39;©pycoa.fr (data from: </span><span class="si">{}</span><span class="s1">)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">database_name</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
                <span class="n">textcopyright</span> <span class="o">=</span> <span class="s1">&#39;©pycoa.fr &#39;</span> <span class="o">+</span> <span class="n">textcopyright</span>

        <span class="n">citation</span> <span class="o">=</span> <span class="n">Label</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">xpos</span> <span class="o">*</span> <span class="n">plot_width</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">textcopyright</span><span class="p">),</span> <span class="n">y</span><span class="o">=</span><span class="mf">0.01</span> <span class="o">*</span> <span class="n">plot_height</span><span class="p">,</span>
                                          <span class="n">x_units</span><span class="o">=</span><span class="s1">&#39;screen&#39;</span><span class="p">,</span> <span class="n">y_units</span><span class="o">=</span><span class="s1">&#39;screen&#39;</span><span class="p">,</span>
                                          <span class="n">text_font_size</span><span class="o">=</span><span class="s1">&#39;1.5vh&#39;</span><span class="p">,</span> <span class="n">background_fill_color</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">,</span> <span class="n">background_fill_alpha</span><span class="o">=</span><span class="mf">.75</span><span class="p">,</span>
                                          <span class="n">text</span><span class="o">=</span><span class="n">textcopyright</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dvisu_default</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>  <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">options_front</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">options_charts</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;textcopyright&#39;</span><span class="p">,</span> <span class="s1">&#39;textcopyrightposition&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">options_stats</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;date_slider&#39;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="n">figure</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">,</span> <span class="n">tools</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;save&#39;</span><span class="p">,</span> <span class="s1">&#39;box_zoom,reset&#39;</span><span class="p">],</span> <span class="n">toolbar_location</span><span class="o">=</span><span class="s2">&quot;right&quot;</span><span class="p">)</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">add_layout</span><span class="p">(</span><span class="n">citation</span><span class="p">)</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">add_layout</span><span class="p">(</span><span class="n">Title</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">uptitle</span><span class="p">,</span> <span class="n">text_font_size</span><span class="o">=</span><span class="s2">&quot;10pt&quot;</span><span class="p">),</span> <span class="s1">&#39;above&#39;</span><span class="p">)</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">add_layout</span><span class="p">(</span><span class="n">Title</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">subtitle</span><span class="p">,</span> <span class="n">text_font_size</span><span class="o">=</span><span class="s2">&quot;8pt&quot;</span><span class="p">,</span> <span class="n">text_font_style</span><span class="o">=</span><span class="s2">&quot;italic&quot;</span><span class="p">),</span> <span class="s1">&#39;below&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">fig</span></div>
    <span class="sd">&#39;&#39;&#39; WRAPPER COMMUN FOR ALL&#39;&#39;&#39;</span>
<div class="viewcode-block" id="CocoDisplay.decowrapper"><a class="viewcode-back" href="../../coa.display.html#coa.display.CocoDisplay.decowrapper">[docs]</a>    <span class="k">def</span> <span class="nf">decowrapper</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">            Main decorator it mainly deals with arg testings</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="nd">@wraps</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
        <span class="k">def</span> <span class="nf">wrapper</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">input</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">input_field</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Parse a standard input, return :</span>
<span class="sd">                - pandas: with location keyword (eventually force a column named &#39;where&#39; to &#39;location&#39;)</span>
<span class="sd">                - kwargs:</span>
<span class="sd">                    * keys = [plot_width, plot_width, title, when, title_temporal,bins, what, which]</span>
<span class="sd">            Note that method used only the needed variables, some of them are useless</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="nb">input</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">CoaTypeError</span><span class="p">(</span><span class="nb">input</span> <span class="o">+</span> <span class="s1">&#39;Must be a pandas, with pycoa structure !&#39;</span><span class="p">)</span>

            <span class="n">kwargs_test</span><span class="p">(</span><span class="n">kwargs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">alloptions</span><span class="p">,</span> <span class="s1">&#39;Bad args used in the display function.&#39;</span><span class="p">)</span>

            <span class="n">when</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;when&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="n">what</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;what&#39;</span><span class="p">,</span> <span class="s1">&#39;cumul&#39;</span><span class="p">)</span>  <span class="c1"># cumul is the default</span>
            <span class="n">which</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;which&#39;</span><span class="p">,</span> <span class="nb">input</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">input_field</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">input_field</span> <span class="o">=</span> <span class="n">what</span>
            <span class="n">option</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;option&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="n">bins</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;bins&#39;</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
            <span class="n">title</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;title&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="c1">#textcopyright = kwargs.get(&#39;textcopyright&#39;, &#39;default&#39;)</span>
            <span class="c1">#textcopyrightposition = kwargs.get(&#39;textcopyrightposition&#39;, &#39;left&#39;)</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;plot_width&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;plot_width&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dfigure_default</span><span class="p">[</span><span class="s1">&#39;plot_width&#39;</span><span class="p">])</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;plot_height&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;plot_height&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dfigure_default</span><span class="p">[</span><span class="s1">&#39;plot_height&#39;</span><span class="p">])</span>

            <span class="k">if</span> <span class="s1">&#39;where&#39;</span> <span class="ow">in</span> <span class="nb">input</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                <span class="nb">input</span> <span class="o">=</span> <span class="nb">input</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;where&#39;</span><span class="p">:</span> <span class="s1">&#39;location&#39;</span><span class="p">})</span>

            <span class="n">wallname</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbld</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">database_name</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span>
            <span class="k">if</span> <span class="s1">&#39;codelocation&#39;</span> <span class="ow">and</span> <span class="s1">&#39;clustername&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">input</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                <span class="nb">input</span><span class="p">[</span><span class="s1">&#39;codelocation&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;dummy&#39;</span>
                <span class="nb">input</span><span class="p">[</span><span class="s1">&#39;clustername&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;dummy&#39;</span>
                <span class="nb">input</span><span class="p">[</span><span class="s1">&#39;rolloverdisplay&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;dummy&#39;</span>
                <span class="nb">input</span><span class="p">[</span><span class="s1">&#39;permanentdisplay&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;dummy&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbld</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">database_name</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;WW&#39;</span> <span class="p">:</span>
                    <span class="nb">input</span><span class="p">[</span><span class="s1">&#39;codelocation&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">input</span><span class="p">[</span><span class="s1">&#39;codelocation&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;[&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;]&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">&lt;</span> <span class="mi">10</span> <span class="k">else</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;...&#39;</span><span class="o">+</span><span class="n">x</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="p">)</span>
                    <span class="nb">input</span><span class="p">[</span><span class="s1">&#39;permanentdisplay&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">input</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">clustername</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">geo</span><span class="o">.</span><span class="n">get_GeoRegion</span><span class="p">()</span><span class="o">.</span><span class="n">is_region</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">clustername</span><span class="p">)</span> <span class="k">else</span> <span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">codelocation</span><span class="p">),</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbld</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">database_name</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;subregion&#39;</span> <span class="p">:</span>
                        <span class="nb">input</span> <span class="o">=</span> <span class="nb">input</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="nb">input</span><span class="p">[</span><span class="s1">&#39;codelocation&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span><span class="nb">list</span><span class="p">):</span>
                            <span class="nb">input</span><span class="p">[</span><span class="s1">&#39;codelocation&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">input</span><span class="p">[</span><span class="s1">&#39;codelocation&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;&#39;&quot;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>\
                                                         <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">&lt;</span><span class="mi">5</span> <span class="k">else</span> <span class="s1">&#39;[&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;&#39;&quot;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;,...,&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;&#39;&quot;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;]&#39;</span><span class="p">)</span>

                        <span class="n">trad</span><span class="o">=</span><span class="p">{}</span>
                        <span class="n">cluster</span> <span class="o">=</span> <span class="nb">input</span><span class="o">.</span><span class="n">clustername</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
                        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="nb">input</span><span class="o">.</span><span class="n">location</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="nb">list</span><span class="p">):</span>
                           <span class="n">cluster</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">cluster</span><span class="p">]</span>
                        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">cluster</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbld</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">database_name</span><span class="p">][</span><span class="mi">2</span><span class="p">]:</span>
                                <span class="nb">input</span><span class="p">[</span><span class="s1">&#39;permanentdisplay&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">dbld</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">database_name</span><span class="p">][</span><span class="mi">2</span><span class="p">]]</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="nb">input</span><span class="p">)</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">geo</span><span class="o">.</span><span class="n">is_region</span><span class="p">(</span><span class="n">i</span><span class="p">):</span>
                                    <span class="n">trad</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">geo</span><span class="o">.</span><span class="n">is_region</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">geo</span><span class="o">.</span><span class="n">is_subregion</span><span class="p">(</span><span class="n">i</span><span class="p">):</span>
                                    <span class="n">trad</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">geo</span><span class="o">.</span><span class="n">is_subregion</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="c1">#input.loc[input.clustername==i][&#39;codelocation&#39;].iloc[0]</span>
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="n">trad</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span>
                                <span class="n">trad</span><span class="o">=</span><span class="p">{</span><span class="n">k</span><span class="p">:(</span><span class="n">v</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;...&#39;</span><span class="o">+</span><span class="n">v</span><span class="p">[</span><span class="o">-</span><span class="mi">3</span><span class="p">:]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">v</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">8</span> <span class="k">else</span> <span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">trad</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
                                <span class="k">if</span> <span class="s1">&#39;,&#39;</span> <span class="ow">in</span> <span class="nb">input</span><span class="o">.</span><span class="n">codelocation</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                                    <span class="nb">input</span><span class="p">[</span><span class="s1">&#39;permanentdisplay&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">input</span><span class="o">.</span><span class="n">clustername</span>
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="nb">input</span><span class="p">[</span><span class="s1">&#39;permanentdisplay&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">input</span><span class="o">.</span><span class="n">codelocation</span><span class="c1">#input.clustername.map(trad)</span>
                    <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbld</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">database_name</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;region&#39;</span> <span class="p">:</span>
                        <span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbld</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">database_name</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">input</span><span class="o">.</span><span class="n">clustername</span><span class="o">.</span><span class="n">unique</span><span class="p">()):</span>
                            <span class="nb">input</span><span class="p">[</span><span class="s1">&#39;permanentdisplay&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">dbld</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">database_name</span><span class="p">][</span><span class="mi">2</span><span class="p">]]</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="nb">input</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="nb">input</span><span class="p">[</span><span class="s1">&#39;permanentdisplay&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">input</span><span class="o">.</span><span class="n">codelocation</span>
                <span class="nb">input</span><span class="p">[</span><span class="s1">&#39;rolloverdisplay&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">input</span><span class="p">[</span><span class="s1">&#39;location&#39;</span><span class="p">]</span>

            <span class="n">uniqloc</span> <span class="o">=</span> <span class="nb">input</span><span class="o">.</span><span class="n">clustername</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">uniqloc</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">:</span>
                <span class="n">colors</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scolors</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">colors</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lcolors</span>
            <span class="n">colors</span> <span class="o">=</span> <span class="n">itertools</span><span class="o">.</span><span class="n">cycle</span><span class="p">(</span><span class="n">colors</span><span class="p">)</span>
            <span class="n">dico_colors</span> <span class="o">=</span> <span class="p">{</span><span class="n">i</span><span class="p">:</span> <span class="nb">next</span><span class="p">(</span><span class="n">colors</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">uniqloc</span><span class="p">}</span>

            <span class="nb">input</span> <span class="o">=</span> <span class="nb">input</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="nb">input</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="s1">&#39;colors&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">input</span><span class="p">[</span><span class="s1">&#39;clustername&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">dico_colors</span><span class="p">)</span><span class="c1">#(pd.merge(input, country_col, on=&#39;location&#39;))</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">input_field</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                  <span class="n">input_field</span> <span class="o">=</span> <span class="p">[</span><span class="n">input_field</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                  <span class="n">input_field</span> <span class="o">=</span> <span class="n">input_field</span>

            <span class="n">when_beg</span> <span class="o">=</span> <span class="nb">input</span><span class="p">[[</span><span class="n">input_field</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="s1">&#39;date&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">date</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
            <span class="n">when_end</span> <span class="o">=</span> <span class="nb">input</span><span class="p">[[</span><span class="n">input_field</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="s1">&#39;date&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">date</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>

            <span class="k">if</span> <span class="n">when</span><span class="p">:</span>
                <span class="n">when_beg</span><span class="p">,</span> <span class="n">when_end</span> <span class="o">=</span> <span class="n">extract_dates</span><span class="p">(</span><span class="n">when</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">when_end</span> <span class="o">&gt;</span> <span class="nb">input</span><span class="p">[[</span><span class="n">input_field</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="s1">&#39;date&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">date</span><span class="o">.</span><span class="n">max</span><span class="p">():</span>
                    <span class="n">when_end</span> <span class="o">=</span> <span class="nb">input</span><span class="p">[[</span><span class="n">input_field</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="s1">&#39;date&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">date</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>

                <span class="k">if</span> <span class="n">when_beg</span> <span class="o">==</span> <span class="n">dt</span><span class="o">.</span><span class="n">date</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span>
                    <span class="n">when_beg</span> <span class="o">=</span> <span class="nb">input</span><span class="p">[[</span><span class="n">input_field</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="s1">&#39;date&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">date</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>

                <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">when_beg</span><span class="p">,</span> <span class="n">dt</span><span class="o">.</span><span class="n">date</span><span class="p">):</span>
                    <span class="k">raise</span> <span class="n">CoaNoData</span><span class="p">(</span><span class="s2">&quot;With your current cuts, there are no data to plot.&quot;</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">when_end</span> <span class="o">&lt;=</span> <span class="n">when_beg</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Requested date below available one, take&#39;</span><span class="p">,</span> <span class="n">when_beg</span><span class="p">)</span>
                    <span class="n">when_end</span> <span class="o">=</span> <span class="n">when_beg</span>
                <span class="k">if</span> <span class="n">when_beg</span> <span class="o">&gt;</span> <span class="nb">input</span><span class="p">[[</span><span class="n">input_field</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="s1">&#39;date&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">date</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="ow">or</span> <span class="n">when_end</span> <span class="o">&gt;</span> <span class="nb">input</span><span class="p">[[</span><span class="n">input_field</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="s1">&#39;date&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">date</span><span class="o">.</span><span class="n">max</span><span class="p">():</span>
                    <span class="k">raise</span> <span class="n">CoaNoData</span><span class="p">(</span><span class="s2">&quot;No available data after &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="nb">input</span><span class="p">[[</span><span class="n">input_field</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="s1">&#39;date&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">date</span><span class="o">.</span><span class="n">max</span><span class="p">()))</span>
            <span class="n">when_end_change</span> <span class="o">=</span> <span class="n">when_end</span>

            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">input_field</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">input</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">isnull</span><span class="p">()</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
                    <span class="k">raise</span> <span class="n">CoaTypeError</span><span class="p">(</span><span class="s2">&quot;Sorry all data are NaN for &quot;</span> <span class="o">+</span> <span class="n">i</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">when_end_change</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">when_end_change</span><span class="p">,</span><span class="n">CocoDisplay</span><span class="o">.</span><span class="n">changeto_nonull_date</span><span class="p">(</span><span class="nb">input</span><span class="p">,</span> <span class="n">when_end</span><span class="p">,</span> <span class="n">i</span><span class="p">))</span>

            <span class="k">if</span> <span class="n">func</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">!=</span> <span class="s1">&#39;pycoa_date_plot&#39;</span>  <span class="ow">and</span> <span class="n">func</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">!=</span> <span class="s1">&#39;pycoa_plot&#39;</span>  <span class="ow">and</span> <span class="n">func</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">!=</span> <span class="s1">&#39;pycoa_scrollingmenu&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">input_field</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">input_field</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; is dim = &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">input_field</span><span class="p">))</span> <span class="o">+</span> <span class="s1">&#39;. No effect with &#39;</span> <span class="o">+</span> <span class="n">func</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">+</span> <span class="s1">&#39;! Take the first input: &#39;</span> <span class="o">+</span> <span class="n">input_field</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">input_field</span> <span class="o">=</span> <span class="n">input_field</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

            <span class="k">if</span> <span class="n">when_end_change</span> <span class="o">!=</span> <span class="n">when_end</span><span class="p">:</span>
                <span class="n">when_end</span> <span class="o">=</span> <span class="n">when_end_change</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">when_beg</span> <span class="o">=</span> <span class="n">when_beg</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">when_end</span> <span class="o">=</span> <span class="n">when_end</span>
            <span class="nb">input</span> <span class="o">=</span> <span class="nb">input</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="nb">input</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">]</span> <span class="o">&gt;=</span>  <span class="bp">self</span><span class="o">.</span><span class="n">when_beg</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="nb">input</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">]</span> <span class="o">&lt;=</span>  <span class="bp">self</span><span class="o">.</span><span class="n">when_end</span><span class="p">)]</span>

            <span class="n">title_temporal</span> <span class="o">=</span> <span class="s1">&#39; (&#39;</span> <span class="o">+</span> <span class="s1">&#39;between &#39;</span> <span class="o">+</span> <span class="n">when_beg</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%d</span><span class="s1">/%m/%Y&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; and &#39;</span> <span class="o">+</span> <span class="n">when_end</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%d</span><span class="s1">/%m/%Y&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;)&#39;</span>
            <span class="k">if</span> <span class="n">func</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">!=</span> <span class="s1">&#39;pycoa_date_plot&#39;</span>  <span class="ow">and</span> <span class="n">func</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">!=</span> <span class="s1">&#39;pycoa_plot&#39;</span><span class="p">:</span>
                <span class="n">title_temporal</span> <span class="o">=</span> <span class="s1">&#39; (&#39;</span> <span class="o">+</span> <span class="n">when_end</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%d</span><span class="s1">/%m/%Y&#39;</span><span class="p">)</span>  <span class="o">+</span> <span class="s1">&#39;)&#39;</span>
            <span class="n">title_option</span><span class="o">=</span><span class="s1">&#39;&#39;</span>
            <span class="k">if</span> <span class="n">option</span><span class="p">:</span>
                <span class="k">if</span> <span class="s1">&#39;sumallandsmooth7&#39;</span> <span class="ow">in</span> <span class="n">option</span><span class="p">:</span>
                    <span class="n">option</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s1">&#39;sumallandsmooth7&#39;</span><span class="p">)</span>
                    <span class="n">option</span> <span class="o">+=</span> <span class="p">[</span><span class="s1">&#39;sumall&#39;</span><span class="p">,</span><span class="s1">&#39;smooth7&#39;</span><span class="p">]</span>
                <span class="n">title_option</span> <span class="o">=</span> <span class="s1">&#39; option: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">option</span><span class="p">)</span>

            <span class="n">input_field_tostring</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">input_field</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;[&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;]&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\&#39;</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">input_field_tostring</span> <span class="o">==</span> <span class="s1">&#39;daily&#39;</span><span class="p">:</span>
                <span class="n">titlefig</span> <span class="o">=</span> <span class="n">which</span> <span class="o">+</span> <span class="s1">&#39;, &#39;</span> <span class="o">+</span> <span class="s1">&#39;day to day difference &#39;</span> <span class="o">+</span> <span class="n">title_option</span>
            <span class="k">elif</span> <span class="n">input_field_tostring</span> <span class="o">==</span> <span class="s1">&#39;weekly&#39;</span><span class="p">:</span>
                <span class="n">titlefig</span> <span class="o">=</span> <span class="n">which</span> <span class="o">+</span> <span class="s1">&#39;, &#39;</span> <span class="o">+</span> <span class="s1">&#39;week to week difference &#39;</span> <span class="o">+</span> <span class="n">title_option</span>
            <span class="k">elif</span> <span class="n">input_field_tostring</span> <span class="o">==</span> <span class="s1">&#39;cumul&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="s1">&#39;cur_&#39;</span> <span class="ow">in</span>  <span class="n">which</span><span class="p">:</span>
                    <span class="n">titlefig</span> <span class="o">=</span> <span class="n">which</span> <span class="o">+</span> <span class="s1">&#39;, &#39;</span> <span class="o">+</span> <span class="s1">&#39;current &#39;</span> <span class="o">+</span> <span class="n">which</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;cur_&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">+</span> <span class="n">title_option</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">titlefig</span> <span class="o">=</span> <span class="n">which</span> <span class="o">+</span> <span class="s1">&#39;, &#39;</span> <span class="o">+</span> <span class="s1">&#39;cumulative sum &#39;</span><span class="o">+</span> <span class="n">title_option</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">titlefig</span> <span class="o">=</span> <span class="n">input_field_tostring</span> <span class="o">+</span> <span class="n">title_option</span>

            <span class="k">if</span> <span class="n">title</span><span class="p">:</span>
                <span class="n">title</span> <span class="o">=</span> <span class="n">title</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">title</span>  <span class="o">=</span> <span class="n">titlefig</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">uptitle</span> <span class="o">=</span> <span class="n">title</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">subtitle</span> <span class="o">=</span> <span class="n">title_temporal</span>
            <span class="c1">#kwargs[&#39;title&#39;] = title</span>
            <span class="k">return</span> <span class="n">func</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">input</span><span class="p">,</span> <span class="n">input_field</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">wrapper</span></div>
    <span class="sd">&#39;&#39;&#39; DECORATORS FOR PLOT: DATE, VERSUS, SCROLLINGMENU &#39;&#39;&#39;</span>
<div class="viewcode-block" id="CocoDisplay.decoplot"><a class="viewcode-back" href="../../coa.display.html#coa.display.CocoDisplay.decoplot">[docs]</a>    <span class="k">def</span> <span class="nf">decoplot</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        decorator for plot purpose</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nd">@wraps</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
        <span class="k">def</span> <span class="nf">inner_plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">input</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">input_field</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
            <span class="n">mode</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;mode&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">mode</span><span class="p">:</span>
                <span class="n">mode</span> <span class="o">=</span> <span class="n">mode</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">mode</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dvisu_default</span><span class="p">[</span><span class="s1">&#39;mode&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">mode</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">available_modes</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">CoaTypeError</span><span class="p">(</span><span class="s1">&#39;Don</span><span class="se">\&#39;</span><span class="s1">t know the mode wanted. So far:&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">available_modes</span><span class="p">))</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;mode&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mode</span>

            <span class="k">if</span> <span class="s1">&#39;location&#39;</span> <span class="ow">in</span> <span class="nb">input</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                <span class="n">new</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">columns</span> <span class="o">=</span> <span class="nb">input</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
                <span class="n">location_ordered_byvalues</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span>
                    <span class="nb">input</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="nb">input</span><span class="o">.</span><span class="n">date</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">when_end</span><span class="p">]</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="n">input_field</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)[</span><span class="s1">&#39;clustername&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span>
                <span class="nb">input</span> <span class="o">=</span> <span class="nb">input</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>  <span class="c1"># needed to avoid warning</span>

                <span class="nb">input</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="s1">&#39;clustername&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Categorical</span><span class="p">(</span><span class="nb">input</span><span class="o">.</span><span class="n">clustername</span><span class="p">,</span>
                                                       <span class="n">categories</span><span class="o">=</span><span class="n">location_ordered_byvalues</span><span class="p">,</span> <span class="n">ordered</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

                <span class="nb">input</span> <span class="o">=</span> <span class="nb">input</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;clustername&#39;</span><span class="p">,</span> <span class="s1">&#39;date&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>

                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">location_ordered_byvalues</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">12</span><span class="p">:</span>
                    <span class="nb">input</span> <span class="o">=</span> <span class="nb">input</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="nb">input</span><span class="o">.</span><span class="n">clustername</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">location_ordered_byvalues</span><span class="p">[:</span><span class="mi">12</span><span class="p">])]</span>
                <span class="n">list_max</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">input_field</span><span class="p">:</span>
                    <span class="n">list_max</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="nb">input</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="nb">input</span><span class="o">.</span><span class="n">clustername</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">location_ordered_byvalues</span><span class="p">)][</span><span class="n">i</span><span class="p">]))</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">([</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">list_max</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">x</span><span class="p">)])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">amplitude</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">list_max</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmin</span><span class="p">(</span><span class="n">list_max</span><span class="p">))</span>
                    <span class="k">if</span> <span class="n">amplitude</span> <span class="o">&gt;</span> <span class="mi">10</span> <span class="o">**</span> <span class="mi">4</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">ax_type</span><span class="o">.</span><span class="n">reverse</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">func</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;pycoa_scrollingmenu&#39;</span> <span class="p">:</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">input_field</span><span class="p">,</span><span class="nb">list</span><span class="p">):</span>
                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">input_field</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                            <span class="nb">print</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">input_field</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; is dim = &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">input_field</span><span class="p">))</span> <span class="o">+</span> <span class="s1">&#39;. No effect with &#39;</span> <span class="o">+</span> <span class="n">func</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">+</span> <span class="s1">&#39;! Take the first input: &#39;</span> <span class="o">+</span> <span class="n">input_field</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                        <span class="n">input_field</span> <span class="o">=</span> <span class="n">input_field</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">return</span> <span class="n">func</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">input</span><span class="p">,</span> <span class="n">input_field</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">inner_plot</span></div>

    <span class="sd">&#39;&#39;&#39; PLOT VERSUS &#39;&#39;&#39;</span>
<div class="viewcode-block" id="CocoDisplay.pycoa_plot"><a class="viewcode-back" href="../../coa.display.html#coa.display.CocoDisplay.pycoa_plot">[docs]</a>    <span class="nd">@decowrapper</span>
    <span class="nd">@decoplot</span>
    <span class="k">def</span> <span class="nf">pycoa_plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">input</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">input_field</span> <span class="o">=</span> <span class="kc">None</span> <span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        -----------------</span>
<span class="sd">        Create a versus plot according to arguments.</span>
<span class="sd">        See help(pycoa_plot).</span>
<span class="sd">        Keyword arguments</span>
<span class="sd">        -----------------</span>
<span class="sd">        - input = None : if None take first element. A DataFrame with a Pycoa struture is mandatory</span>
<span class="sd">        |location|date|Variable desired|daily|cumul|weekly|codelocation|clustername|permanentdisplay|rolloverdisplay|</span>
<span class="sd">        - input_field = if None take second element. It should be a list dim=2. Moreover the 2 variables must be present</span>
<span class="sd">        in the DataFrame considered.</span>
<span class="sd">        - plot_heigh = width_height_default[1]</span>
<span class="sd">        - plot_width = width_height_default[0]</span>
<span class="sd">        - title = None</span>
<span class="sd">        - textcopyrightposition = left</span>
<span class="sd">        - textcopyright = default</span>
<span class="sd">        - mode = mouse</span>
<span class="sd">        - cursor_date = None if True</span>
<span class="sd">                - orientation = horizontal</span>
<span class="sd">        - when : default min and max according to the inpude DataFrame.</span>
<span class="sd">                 Dates are given under the format dd/mm/yyyy.</span>
<span class="sd">                 when format [dd/mm/yyyy : dd/mm/yyyy]</span>
<span class="sd">                 if [:dd/mm/yyyy] min date up to</span>
<span class="sd">                 if [dd/mm/yyyy:] up to max date</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">input_field</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">CoaTypeError</span><span class="p">(</span><span class="s1">&#39;Two variables are needed to plot a versus chart ... &#39;</span><span class="p">)</span>
        <span class="n">panels</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">cases_custom</span> <span class="o">=</span> <span class="n">CocoDisplay</span><span class="o">.</span><span class="n">rollerJS</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">axis_type</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ax_type</span><span class="p">:</span>
            <span class="n">standardfig</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">standardfig</span><span class="p">(</span> <span class="n">x_axis_label</span> <span class="o">=</span> <span class="n">input_field</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">y_axis_label</span> <span class="o">=</span> <span class="n">input_field</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                                                <span class="n">y_axis_type</span> <span class="o">=</span> <span class="n">axis_type</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span> <span class="p">)</span>

            <span class="n">standardfig</span><span class="o">.</span><span class="n">add_tools</span><span class="p">(</span><span class="n">HoverTool</span><span class="p">(</span>
                <span class="n">tooltips</span><span class="o">=</span><span class="p">[(</span><span class="s1">&#39;Location&#39;</span><span class="p">,</span> <span class="s1">&#39;@rolloverdisplay&#39;</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;date&#39;</span><span class="p">,</span> <span class="s1">&#39;@date{</span><span class="si">%F</span><span class="s1">}&#39;</span><span class="p">),</span>
                          <span class="p">(</span><span class="n">input_field</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;@</span><span class="si">{casesx}</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="si">{custom}</span><span class="s1">&#39;</span><span class="p">),</span>
                          <span class="p">(</span><span class="n">input_field</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="s1">&#39;@</span><span class="si">{casesy}</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="si">{custom}</span><span class="s1">&#39;</span><span class="p">)],</span>
                <span class="n">formatters</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;location&#39;</span><span class="p">:</span> <span class="s1">&#39;printf&#39;</span><span class="p">,</span> <span class="s1">&#39;@</span><span class="si">{casesx}</span><span class="s1">&#39;</span><span class="p">:</span> <span class="n">cases_custom</span><span class="p">,</span> <span class="s1">&#39;@</span><span class="si">{casesy}</span><span class="s1">&#39;</span><span class="p">:</span> <span class="n">cases_custom</span><span class="p">,</span>
                            <span class="s1">&#39;@date&#39;</span><span class="p">:</span> <span class="s1">&#39;datetime&#39;</span><span class="p">},</span> <span class="n">mode</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;mode&#39;</span><span class="p">],</span>
                <span class="n">point_policy</span><span class="o">=</span><span class="s2">&quot;snap_to_data&quot;</span><span class="p">))</span>  <span class="c1"># ,PanTool())</span>

            <span class="k">for</span> <span class="n">loc</span> <span class="ow">in</span> <span class="nb">input</span><span class="o">.</span><span class="n">clustername</span><span class="o">.</span><span class="n">unique</span><span class="p">():</span>
                <span class="n">pandaloc</span> <span class="o">=</span> <span class="nb">input</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="nb">input</span><span class="o">.</span><span class="n">clustername</span> <span class="o">==</span> <span class="n">loc</span><span class="p">]</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="s1">&#39;date&#39;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="s1">&#39;True&#39;</span><span class="p">)</span>
                <span class="n">pandaloc</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="n">input_field</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span> <span class="s1">&#39;casesx&#39;</span><span class="p">,</span> <span class="n">input_field</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span> <span class="s1">&#39;casesy&#39;</span><span class="p">},</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">standardfig</span><span class="o">.</span><span class="n">line</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s1">&#39;casesx&#39;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s1">&#39;casesy&#39;</span><span class="p">,</span>
                                 <span class="n">source</span><span class="o">=</span><span class="n">ColumnDataSource</span><span class="p">(</span><span class="n">pandaloc</span><span class="p">),</span> <span class="n">legend_label</span><span class="o">=</span><span class="n">pandaloc</span><span class="o">.</span><span class="n">clustername</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                                 <span class="n">color</span><span class="o">=</span><span class="n">pandaloc</span><span class="o">.</span><span class="n">colors</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">line_width</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">hover_line_width</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>

            <span class="n">standardfig</span><span class="o">.</span><span class="n">legend</span><span class="o">.</span><span class="n">label_text_font_size</span> <span class="o">=</span> <span class="s2">&quot;12px&quot;</span>
            <span class="n">panel</span> <span class="o">=</span> <span class="n">Panel</span><span class="p">(</span><span class="n">child</span><span class="o">=</span><span class="n">standardfig</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="n">axis_type</span><span class="p">)</span>
            <span class="n">panels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">panel</span><span class="p">)</span>
            <span class="n">standardfig</span><span class="o">.</span><span class="n">legend</span><span class="o">.</span><span class="n">background_fill_alpha</span> <span class="o">=</span> <span class="mf">0.6</span>

            <span class="n">standardfig</span><span class="o">.</span><span class="n">legend</span><span class="o">.</span><span class="n">location</span> <span class="o">=</span> <span class="s2">&quot;top_left&quot;</span>
            <span class="n">CocoDisplay</span><span class="o">.</span><span class="n">bokeh_legend</span><span class="p">(</span><span class="n">standardfig</span><span class="p">)</span>
        <span class="n">tabs</span> <span class="o">=</span> <span class="n">Tabs</span><span class="p">(</span><span class="n">tabs</span><span class="o">=</span><span class="n">panels</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">tabs</span></div>

    <span class="sd">&#39;&#39;&#39; DATE PLOT &#39;&#39;&#39;</span>
<div class="viewcode-block" id="CocoDisplay.pycoa_date_plot"><a class="viewcode-back" href="../../coa.display.html#coa.display.CocoDisplay.pycoa_date_plot">[docs]</a>    <span class="nd">@decowrapper</span>
    <span class="nd">@decoplot</span>
    <span class="k">def</span> <span class="nf">pycoa_date_plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">input</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">input_field</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        -----------------</span>
<span class="sd">        Create a date plot according to arguments. See help(pycoa_date_plot).</span>
<span class="sd">        Keyword arguments</span>
<span class="sd">        -----------------</span>
<span class="sd">        - input = None : if None take first element. A DataFrame with a Pycoa struture is mandatory</span>
<span class="sd">        |location|date|Variable desired|daily|cumul|weekly|codelocation|clustername|permanentdisplay|rolloverdisplay|</span>
<span class="sd">        - input_field = if None take second element could be a list</span>
<span class="sd">        - plot_heigh= width_height_default[1]</span>
<span class="sd">        - plot_width = width_height_default[0]</span>
<span class="sd">        - title = None</span>
<span class="sd">        - textcopyrightposition = left</span>
<span class="sd">        - textcopyright = default</span>
<span class="sd">        - mode = mouse</span>
<span class="sd">        - guideline = False</span>
<span class="sd">        - cursor_date = None if True</span>
<span class="sd">                - orientation = horizontal</span>
<span class="sd">        - when : default min and max according to the inpude DataFrame.</span>
<span class="sd">                 Dates are given under the format dd/mm/yyyy.</span>
<span class="sd">                 when format [dd/mm/yyyy : dd/mm/yyyy]</span>
<span class="sd">                 if [:dd/mm/yyyy] min date up to</span>
<span class="sd">                 if [dd/mm/yyyy:] up to max date</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">guideline</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;guideline&#39;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">dvisu_default</span><span class="p">[</span><span class="s1">&#39;guideline&#39;</span><span class="p">])</span>
        <span class="n">panels</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">cases_custom</span> <span class="o">=</span> <span class="n">CocoDisplay</span><span class="o">.</span><span class="n">rollerJS</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="nb">input</span><span class="p">[</span><span class="s1">&#39;rolloverdisplay&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span><span class="nb">list</span><span class="p">):</span>
            <span class="nb">input</span><span class="p">[</span><span class="s1">&#39;rolloverdisplay&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">input</span><span class="p">[</span><span class="s1">&#39;clustername&#39;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">axis_type</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ax_type</span><span class="p">:</span>
            <span class="n">standardfig</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">standardfig</span><span class="p">(</span> <span class="n">y_axis_type</span> <span class="o">=</span> <span class="n">axis_type</span><span class="p">,</span> <span class="n">x_axis_type</span> <span class="o">=</span> <span class="s1">&#39;datetime&#39;</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">r_list</span><span class="o">=</span><span class="p">[]</span>
            <span class="n">maxou</span><span class="o">=-</span><span class="mi">1000</span>
            <span class="n">smcolors</span> <span class="o">=</span> <span class="nb">iter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scolors</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">input_field</span><span class="p">:</span>
                <span class="n">line_style</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;solid&#39;</span><span class="p">,</span> <span class="s1">&#39;dashed&#39;</span><span class="p">,</span> <span class="s1">&#39;dotted&#39;</span><span class="p">,</span> <span class="s1">&#39;dotdash&#39;</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">loc</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="nb">input</span><span class="o">.</span><span class="n">clustername</span><span class="o">.</span><span class="n">unique</span><span class="p">()):</span>
                    <span class="n">input_filter</span> <span class="o">=</span> <span class="nb">input</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="nb">input</span><span class="o">.</span><span class="n">clustername</span> <span class="o">==</span> <span class="n">loc</span><span class="p">]</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
                    <span class="n">src</span> <span class="o">=</span> <span class="n">ColumnDataSource</span><span class="p">(</span><span class="n">input_filter</span><span class="p">)</span>
                    <span class="n">leg</span> <span class="o">=</span> <span class="n">input_filter</span><span class="o">.</span><span class="n">permanentdisplay</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">input_field</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">:</span>
                        <span class="n">leg</span> <span class="o">=</span> <span class="n">input_filter</span><span class="o">.</span><span class="n">permanentdisplay</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;, &#39;</span> <span class="o">+</span> <span class="n">val</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">input</span><span class="o">.</span><span class="n">clustername</span><span class="o">.</span><span class="n">unique</span><span class="p">()))</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="n">color</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">smcolors</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">color</span> <span class="o">=</span> <span class="n">input_filter</span><span class="o">.</span><span class="n">colors</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">r</span> <span class="o">=</span> <span class="n">standardfig</span><span class="o">.</span><span class="n">line</span><span class="p">(</span><span class="n">x</span> <span class="o">=</span> <span class="s1">&#39;date&#39;</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">val</span><span class="p">,</span> <span class="n">source</span> <span class="o">=</span> <span class="n">src</span><span class="p">,</span>
                                     <span class="n">color</span> <span class="o">=</span> <span class="n">color</span><span class="p">,</span> <span class="n">line_width</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
                                     <span class="n">legend_label</span> <span class="o">=</span> <span class="n">leg</span><span class="p">,</span>
                                     <span class="n">hover_line_width</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span> <span class="n">name</span> <span class="o">=</span> <span class="n">val</span><span class="p">,</span> <span class="n">line_dash</span><span class="o">=</span><span class="n">line_style</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                    <span class="n">r_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
                    <span class="n">maxou</span><span class="o">=</span><span class="nb">max</span><span class="p">(</span><span class="n">maxou</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">input_filter</span><span class="p">[</span><span class="n">val</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">))</span>
                <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">r_list</span><span class="p">:</span>
                <span class="n">label</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">name</span>
                <span class="n">tooltips</span> <span class="o">=</span> <span class="p">[(</span><span class="s1">&#39;Location&#39;</span><span class="p">,</span> <span class="s1">&#39;@rolloverdisplay&#39;</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;date&#39;</span><span class="p">,</span> <span class="s1">&#39;@date{</span><span class="si">%F</span><span class="s1">}&#39;</span><span class="p">),</span> <span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s1">&#39;@$name&#39;</span><span class="p">)]</span>
                <span class="n">formatters</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;location&#39;</span><span class="p">:</span> <span class="s1">&#39;printf&#39;</span><span class="p">,</span> <span class="s1">&#39;@date&#39;</span><span class="p">:</span> <span class="s1">&#39;datetime&#39;</span><span class="p">,</span> <span class="s1">&#39;@name&#39;</span><span class="p">:</span> <span class="s1">&#39;printf&#39;</span><span class="p">}</span>
                <span class="n">hover</span><span class="o">=</span><span class="n">HoverTool</span><span class="p">(</span><span class="n">tooltips</span> <span class="o">=</span> <span class="n">tooltips</span><span class="p">,</span> <span class="n">formatters</span> <span class="o">=</span> <span class="n">formatters</span><span class="p">,</span> <span class="n">point_policy</span> <span class="o">=</span> <span class="s2">&quot;snap_to_data&quot;</span><span class="p">,</span> <span class="n">mode</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;mode&#39;</span><span class="p">],</span> <span class="n">renderers</span><span class="o">=</span><span class="p">[</span><span class="n">r</span><span class="p">])</span>  <span class="c1"># ,PanTool())</span>
                <span class="n">standardfig</span><span class="o">.</span><span class="n">add_tools</span><span class="p">(</span><span class="n">hover</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">guideline</span><span class="p">:</span>
                    <span class="n">cross</span><span class="o">=</span> <span class="n">CrosshairTool</span><span class="p">()</span>
                    <span class="n">standardfig</span><span class="o">.</span><span class="n">add_tools</span><span class="p">(</span><span class="n">cross</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">axis_type</span> <span class="o">==</span> <span class="s1">&#39;linear&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">maxou</span>  <span class="o">&lt;</span> <span class="mf">1e4</span> <span class="p">:</span>
                    <span class="n">standardfig</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">formatter</span> <span class="o">=</span> <span class="n">BasicTickFormatter</span><span class="p">(</span><span class="n">use_scientific</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

            <span class="n">standardfig</span><span class="o">.</span><span class="n">legend</span><span class="o">.</span><span class="n">label_text_font_size</span> <span class="o">=</span> <span class="s2">&quot;12px&quot;</span>
            <span class="n">panel</span> <span class="o">=</span> <span class="n">Panel</span><span class="p">(</span><span class="n">child</span><span class="o">=</span><span class="n">standardfig</span><span class="p">,</span> <span class="n">title</span> <span class="o">=</span> <span class="n">axis_type</span><span class="p">)</span>
            <span class="n">panels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">panel</span><span class="p">)</span>
            <span class="n">standardfig</span><span class="o">.</span><span class="n">legend</span><span class="o">.</span><span class="n">background_fill_alpha</span> <span class="o">=</span> <span class="mf">0.6</span>

            <span class="n">standardfig</span><span class="o">.</span><span class="n">legend</span><span class="o">.</span><span class="n">location</span> <span class="o">=</span> <span class="s2">&quot;top_left&quot;</span>
            <span class="n">standardfig</span><span class="o">.</span><span class="n">legend</span><span class="o">.</span><span class="n">click_policy</span><span class="o">=</span><span class="s2">&quot;hide&quot;</span>

            <span class="n">standardfig</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">formatter</span> <span class="o">=</span> <span class="n">DatetimeTickFormatter</span><span class="p">(</span>
                <span class="n">days</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;</span><span class="si">%d</span><span class="s2">/%m/%y&quot;</span><span class="p">],</span> <span class="n">months</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;</span><span class="si">%d</span><span class="s2">/%m/%y&quot;</span><span class="p">],</span> <span class="n">years</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;%b %Y&quot;</span><span class="p">])</span>

            <span class="n">CocoDisplay</span><span class="o">.</span><span class="n">bokeh_legend</span><span class="p">(</span><span class="n">standardfig</span><span class="p">)</span>
        <span class="n">tabs</span> <span class="o">=</span> <span class="n">Tabs</span><span class="p">(</span><span class="n">tabs</span> <span class="o">=</span> <span class="n">panels</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">tabs</span></div>

    <span class="sd">&#39;&#39;&#39; SCROLLINGMENU PLOT &#39;&#39;&#39;</span>
<div class="viewcode-block" id="CocoDisplay.pycoa_scrollingmenu"><a class="viewcode-back" href="../../coa.display.html#coa.display.CocoDisplay.pycoa_scrollingmenu">[docs]</a>    <span class="nd">@decowrapper</span>
    <span class="nd">@decoplot</span>
    <span class="k">def</span> <span class="nf">pycoa_scrollingmenu</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">input</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">input_field</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        -----------------</span>
<span class="sd">        Create a date plot, with a scrolling menu location, according to arguments.</span>
<span class="sd">        See help(pycoa_scrollingmenu).</span>
<span class="sd">        Keyword arguments</span>
<span class="sd">        -----------------</span>
<span class="sd">        len(location) &gt; 2</span>
<span class="sd">        - input = None : if None take first element. A DataFrame with a Pycoa struture is mandatory</span>
<span class="sd">        |location|date|Variable desired|daily|cumul|weekly|codelocation|clustername|permanentdisplay|rolloverdisplay|</span>
<span class="sd">        - input_field = if None take second element could be a list</span>
<span class="sd">        - plot_heigh= width_height_default[1]</span>
<span class="sd">        - plot_width = width_height_default[0]</span>
<span class="sd">        - title = None</span>
<span class="sd">        - textcopyrightposition = left</span>
<span class="sd">        - textcopyright = default</span>
<span class="sd">        - mode = mouse</span>
<span class="sd">        -guideline = False</span>
<span class="sd">        - cursor_date = None if True</span>
<span class="sd">                - orientation = horizontal</span>
<span class="sd">        - when : default min and max according to the inpude DataFrame.</span>
<span class="sd">                 Dates are given under the format dd/mm/yyyy.</span>
<span class="sd">                 when format [dd/mm/yyyy : dd/mm/yyyy]</span>
<span class="sd">                 if [:dd/mm/yyyy] min date up to</span>
<span class="sd">                 if [dd/mm/yyyy:] up to max date</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">mode</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;mode&#39;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">dvisu_default</span><span class="p">[</span><span class="s1">&#39;mode&#39;</span><span class="p">])</span>
        <span class="n">guideline</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;guideline&#39;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">dvisu_default</span><span class="p">[</span><span class="s1">&#39;guideline&#39;</span><span class="p">])</span>

        <span class="n">uniqloc</span> <span class="o">=</span> <span class="nb">input</span><span class="o">.</span><span class="n">clustername</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span><span class="o">.</span><span class="n">to_list</span><span class="p">()</span>
        <span class="k">if</span> <span class="s1">&#39;location&#39;</span> <span class="ow">in</span> <span class="nb">input</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">uniqloc</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">CoaTypeError</span><span class="p">(</span><span class="s1">&#39;What do you want me to do ? You have selected, only one country.&#39;</span>
                                   <span class="s1">&#39;There is no sens to use this method. See help.&#39;</span><span class="p">)</span>
        <span class="nb">input</span> <span class="o">=</span> <span class="nb">input</span><span class="p">[[</span><span class="s1">&#39;date&#39;</span><span class="p">,</span> <span class="s1">&#39;clustername&#39;</span><span class="p">,</span> <span class="n">input_field</span><span class="p">]]</span>

        <span class="n">mypivot</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">pivot_table</span><span class="p">(</span><span class="nb">input</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="s1">&#39;date&#39;</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="s1">&#39;clustername&#39;</span><span class="p">,</span> <span class="n">values</span><span class="o">=</span><span class="n">input_field</span><span class="p">)</span>
        <span class="n">source</span> <span class="o">=</span> <span class="n">ColumnDataSource</span><span class="p">(</span><span class="n">mypivot</span><span class="p">)</span>

        <span class="n">filter_data1</span> <span class="o">=</span> <span class="n">mypivot</span><span class="p">[[</span><span class="n">uniqloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]]]</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="n">uniqloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span> <span class="s1">&#39;cases&#39;</span><span class="p">})</span>
        <span class="n">src1</span> <span class="o">=</span> <span class="n">ColumnDataSource</span><span class="p">(</span><span class="n">filter_data1</span><span class="p">)</span>

        <span class="n">filter_data2</span> <span class="o">=</span> <span class="n">mypivot</span><span class="p">[[</span><span class="n">uniqloc</span><span class="p">[</span><span class="mi">1</span><span class="p">]]]</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="n">uniqloc</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span> <span class="s1">&#39;cases&#39;</span><span class="p">})</span>
        <span class="n">src2</span> <span class="o">=</span> <span class="n">ColumnDataSource</span><span class="p">(</span><span class="n">filter_data2</span><span class="p">)</span>

        <span class="n">cases_custom</span> <span class="o">=</span> <span class="n">CocoDisplay</span><span class="o">.</span><span class="n">rollerJS</span><span class="p">()</span>
        <span class="n">hover_tool</span> <span class="o">=</span> <span class="n">HoverTool</span><span class="p">(</span><span class="n">tooltips</span><span class="o">=</span><span class="p">[(</span><span class="s1">&#39;Cases&#39;</span><span class="p">,</span> <span class="s1">&#39;@</span><span class="si">{cases}</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="si">{custom}</span><span class="s1">&#39;</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;date&#39;</span><span class="p">,</span> <span class="s1">&#39;@date{</span><span class="si">%F</span><span class="s1">}&#39;</span><span class="p">)],</span>
                               <span class="n">formatters</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;Cases&#39;</span><span class="p">:</span> <span class="s1">&#39;printf&#39;</span><span class="p">,</span> <span class="s1">&#39;@</span><span class="si">{cases}</span><span class="s1">&#39;</span><span class="p">:</span> <span class="n">cases_custom</span><span class="p">,</span> <span class="s1">&#39;@date&#39;</span><span class="p">:</span> <span class="s1">&#39;datetime&#39;</span><span class="p">},</span> <span class="n">mode</span> <span class="o">=</span> <span class="n">mode</span><span class="p">,</span>
                               <span class="n">point_policy</span><span class="o">=</span><span class="s2">&quot;snap_to_data&quot;</span><span class="p">)</span>  <span class="c1"># ,PanTool())</span>

        <span class="n">panels</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">axis_type</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ax_type</span><span class="p">:</span>
            <span class="n">standardfig</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">standardfig</span><span class="p">(</span> <span class="n">y_axis_type</span> <span class="o">=</span> <span class="n">axis_type</span><span class="p">,</span> <span class="n">x_axis_type</span> <span class="o">=</span> <span class="s1">&#39;datetime&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

            <span class="n">standardfig</span><span class="o">.</span><span class="n">yaxis</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">formatter</span> <span class="o">=</span> <span class="n">PrintfTickFormatter</span><span class="p">(</span><span class="nb">format</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%4.2e</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="n">standardfig</span><span class="o">.</span><span class="n">add_tools</span><span class="p">(</span><span class="n">hover_tool</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">guideline</span><span class="p">:</span>
                <span class="n">cross</span><span class="o">=</span> <span class="n">CrosshairTool</span><span class="p">()</span>
                <span class="n">standardfig</span><span class="o">.</span><span class="n">add_tools</span><span class="p">(</span><span class="n">cross</span><span class="p">)</span>
            <span class="k">def</span> <span class="nf">add_line</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">options</span><span class="p">,</span> <span class="n">init</span><span class="p">,</span> <span class="n">color</span><span class="p">):</span>
                <span class="n">s</span> <span class="o">=</span> <span class="n">Select</span><span class="p">(</span><span class="n">options</span> <span class="o">=</span> <span class="n">options</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="n">init</span><span class="p">)</span>
                <span class="n">r</span> <span class="o">=</span> <span class="n">standardfig</span><span class="o">.</span><span class="n">line</span><span class="p">(</span><span class="n">x</span> <span class="o">=</span> <span class="s1">&#39;date&#39;</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="s1">&#39;cases&#39;</span><span class="p">,</span> <span class="n">source</span> <span class="o">=</span> <span class="n">src</span><span class="p">,</span> <span class="n">line_width</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span> <span class="n">line_color</span> <span class="o">=</span> <span class="n">color</span><span class="p">)</span>
                <span class="n">li</span> <span class="o">=</span> <span class="n">LegendItem</span><span class="p">(</span><span class="n">label</span> <span class="o">=</span> <span class="n">init</span><span class="p">,</span> <span class="n">renderers</span> <span class="o">=</span> <span class="p">[</span><span class="n">r</span><span class="p">])</span>
                <span class="n">s</span><span class="o">.</span><span class="n">js_on_change</span><span class="p">(</span><span class="s1">&#39;value&#39;</span><span class="p">,</span> <span class="n">CustomJS</span><span class="p">(</span><span class="n">args</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">s0</span><span class="o">=</span><span class="n">source</span><span class="p">,</span> <span class="n">s1</span><span class="o">=</span><span class="n">src</span><span class="p">,</span> <span class="n">li</span><span class="o">=</span><span class="n">li</span><span class="p">),</span>
                                                 <span class="n">code</span><span class="o">=</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">                                            var c = cb_obj.value;</span>
<span class="s2">                                            var y = s0.data[c];</span>
<span class="s2">                                            s1.data[&#39;cases&#39;] = y;</span>
<span class="s2">                                            li.label = {value: cb_obj.value};</span>
<span class="s2">                                            s1.change.emit();</span>
<span class="s2">                                     &quot;&quot;&quot;</span><span class="p">))</span>
                <span class="k">return</span> <span class="n">s</span><span class="p">,</span> <span class="n">li</span>

            <span class="n">s1</span><span class="p">,</span> <span class="n">li1</span> <span class="o">=</span> <span class="n">add_line</span><span class="p">(</span><span class="n">src1</span><span class="p">,</span> <span class="n">uniqloc</span><span class="p">,</span> <span class="n">uniqloc</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">scolors</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">s2</span><span class="p">,</span> <span class="n">li2</span> <span class="o">=</span> <span class="n">add_line</span><span class="p">(</span><span class="n">src2</span><span class="p">,</span> <span class="n">uniqloc</span><span class="p">,</span> <span class="n">uniqloc</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">scolors</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">standardfig</span><span class="o">.</span><span class="n">add_layout</span><span class="p">(</span><span class="n">Legend</span><span class="p">(</span><span class="n">items</span> <span class="o">=</span> <span class="p">[</span><span class="n">li1</span><span class="p">,</span> <span class="n">li2</span><span class="p">]))</span>
            <span class="n">standardfig</span><span class="o">.</span><span class="n">legend</span><span class="o">.</span><span class="n">location</span> <span class="o">=</span> <span class="s1">&#39;top_left&#39;</span>
            <span class="n">layout</span> <span class="o">=</span> <span class="n">row</span><span class="p">(</span><span class="n">column</span><span class="p">(</span><span class="n">row</span><span class="p">(</span><span class="n">s1</span><span class="p">,</span> <span class="n">s2</span><span class="p">),</span> <span class="n">row</span><span class="p">(</span><span class="n">standardfig</span><span class="p">)))</span>
            <span class="n">panel</span> <span class="o">=</span> <span class="n">Panel</span><span class="p">(</span><span class="n">child</span> <span class="o">=</span> <span class="n">layout</span><span class="p">,</span> <span class="n">title</span> <span class="o">=</span> <span class="n">axis_type</span><span class="p">)</span>
            <span class="n">panels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">panel</span><span class="p">)</span>

        <span class="n">tabs</span> <span class="o">=</span> <span class="n">Tabs</span><span class="p">(</span><span class="n">tabs</span> <span class="o">=</span> <span class="n">panels</span><span class="p">)</span>
        <span class="n">label</span> <span class="o">=</span> <span class="n">standardfig</span><span class="o">.</span><span class="n">title</span>
        <span class="k">return</span> <span class="n">tabs</span></div>

    <span class="sd">&#39;&#39;&#39; DECORATORS FOR HISTO VERTICAL, HISTO HORIZONTAL, PIE &amp; MAP&#39;&#39;&#39;</span>
<div class="viewcode-block" id="CocoDisplay.decohistomap"><a class="viewcode-back" href="../../coa.display.html#coa.display.CocoDisplay.decohistomap">[docs]</a>    <span class="k">def</span> <span class="nf">decohistomap</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Decorator function used for histogram and map</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nd">@wraps</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
        <span class="k">def</span> <span class="nf">inner_hm</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">input</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">input_field</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
            <span class="n">tile</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;tile&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">tile</span><span class="p">:</span>
                <span class="n">tile</span> <span class="o">=</span> <span class="n">tile</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">tile</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dvisu_default</span><span class="p">[</span><span class="s1">&#39;tile&#39;</span><span class="p">]</span>

            <span class="n">maplabel</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;maplabel&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">maplabel</span><span class="p">:</span>
                <span class="n">maplabel</span> <span class="o">=</span> <span class="n">maplabel</span>

            <span class="k">if</span> <span class="s1">&#39;map&#39;</span> <span class="ow">in</span> <span class="n">func</span><span class="o">.</span><span class="vm">__name__</span><span class="p">:</span>
                <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;tile&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tile</span>
                <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;maplabel&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">maplabel</span>

            <span class="n">orientation</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;orientation&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dvisu_default</span><span class="p">[</span><span class="s1">&#39;orientation&#39;</span><span class="p">])</span>
            <span class="n">cursor_date</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;cursor_date&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="c1">#if orientation:</span>
            <span class="c1">#    kwargs[&#39;orientation&#39;] = orientation</span>
            <span class="c1">#kwargs[&#39;cursor_date&#39;] = kwargs.get(&#39;cursor_date&#39;,  self.dvisu_default[&#39;cursor_date&#39;])</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="nb">input</span><span class="p">[</span><span class="s1">&#39;location&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="nb">list</span><span class="p">):</span>
                <span class="nb">input</span><span class="p">[</span><span class="s1">&#39;rolloverdisplay&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">input</span><span class="p">[</span><span class="s1">&#39;clustername&#39;</span><span class="p">]</span>
                <span class="nb">input</span> <span class="o">=</span> <span class="nb">input</span><span class="o">.</span><span class="n">explode</span><span class="p">(</span><span class="s1">&#39;location&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">input</span><span class="p">[</span><span class="s1">&#39;rolloverdisplay&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">input</span><span class="p">[</span><span class="s1">&#39;location&#39;</span><span class="p">]</span>

            <span class="n">uniqloc</span> <span class="o">=</span> <span class="nb">input</span><span class="o">.</span><span class="n">clustername</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>

            <span class="n">geopdwd</span> <span class="o">=</span> <span class="nb">input</span>
            <span class="n">geopdwd</span> <span class="o">=</span> <span class="n">geopdwd</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span> <span class="o">=</span> <span class="n">input_field</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">geopdwd</span> <span class="o">=</span> <span class="n">geopdwd</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>

            <span class="n">started</span> <span class="o">=</span> <span class="n">geopdwd</span><span class="o">.</span><span class="n">date</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
            <span class="n">ended</span> <span class="o">=</span> <span class="n">geopdwd</span><span class="o">.</span><span class="n">date</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>

            <span class="k">if</span> <span class="n">cursor_date</span><span class="p">:</span>
                <span class="n">date_slider</span> <span class="o">=</span> <span class="n">DateSlider</span><span class="p">(</span><span class="n">title</span> <span class="o">=</span> <span class="s2">&quot;Date: &quot;</span><span class="p">,</span> <span class="n">start</span> <span class="o">=</span> <span class="n">started</span><span class="p">,</span> <span class="n">end</span> <span class="o">=</span> <span class="n">ended</span><span class="p">,</span>
                                     <span class="n">value</span> <span class="o">=</span> <span class="n">ended</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="mi">24</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">,</span> <span class="n">orientation</span> <span class="o">=</span> <span class="n">orientation</span><span class="p">)</span>
                <span class="c1">#wanted_date = date_slider.value_as_datetime.date()</span>

            <span class="c1">#if func.__name__ == &#39;pycoa_mapfolium&#39; or func.__name__ == &#39;pycoa_map&#39; or func.__name__ == &#39;innerdecomap&#39; or func.__name__ == &#39;innerdecopycoageo&#39;:</span>
            <span class="k">if</span> <span class="n">func</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;pycoa_mapfolium&#39;</span> <span class="ow">or</span> <span class="n">func</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;pycoa_map&#39;</span> <span class="ow">or</span> <span class="n">func</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;pycoa_sparkmap&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="nb">input</span><span class="o">.</span><span class="n">location</span><span class="o">.</span><span class="n">to_list</span><span class="p">()[</span><span class="mi">0</span><span class="p">],</span><span class="nb">list</span><span class="p">):</span>
                    <span class="n">geom</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">location_geometry</span>
                    <span class="n">geodic</span><span class="o">=</span><span class="p">{</span><span class="n">loc</span><span class="p">:</span><span class="n">geom</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">geom</span><span class="o">.</span><span class="n">location</span><span class="o">==</span><span class="n">loc</span><span class="p">][</span><span class="s1">&#39;geometry&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">loc</span> <span class="ow">in</span> <span class="n">geopdwd</span><span class="o">.</span><span class="n">location</span><span class="o">.</span><span class="n">unique</span><span class="p">()}</span>
                    <span class="n">geopdwd</span><span class="p">[</span><span class="s1">&#39;geometry&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">geopdwd</span><span class="p">[</span><span class="s1">&#39;location&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">geodic</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">geopdwd</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">geopdwd</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">location_geometry</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s1">&#39;location&#39;</span><span class="p">)</span>
                <span class="n">geopdwd</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">GeoDataFrame</span><span class="p">(</span><span class="n">geopdwd</span><span class="p">,</span> <span class="n">geometry</span><span class="o">=</span><span class="n">geopdwd</span><span class="o">.</span><span class="n">geometry</span><span class="p">,</span> <span class="n">crs</span><span class="o">=</span><span class="s2">&quot;EPSG:4326&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">func</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;pycoa_histo&#39;</span><span class="p">:</span>
                <span class="n">pos</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="n">new</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
                <span class="n">n</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">uniqloc</span><span class="p">:</span>
                    <span class="n">perloc</span> <span class="o">=</span> <span class="n">geopdwd</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">geopdwd</span><span class="o">.</span><span class="n">clustername</span> <span class="o">==</span> <span class="n">i</span><span class="p">]</span>
                    <span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="n">perloc</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">):</span>
                        <span class="n">pos</span> <span class="o">=</span> <span class="n">perloc</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                        <span class="k">if</span> <span class="n">new</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
                            <span class="n">new</span> <span class="o">=</span> <span class="n">perloc</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">new</span> <span class="o">=</span> <span class="n">new</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">perloc</span><span class="p">)</span>
                        <span class="n">n</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">geopdwd</span> <span class="o">=</span> <span class="n">new</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">cursor_date</span><span class="p">:</span>
                <span class="n">date_slider</span> <span class="o">=</span> <span class="n">date_slider</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">date_slider</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;date_slider&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">date_slider</span>
            <span class="k">return</span> <span class="n">func</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">geopdwd</span><span class="p">,</span> <span class="n">input_field</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">inner_hm</span></div>

    <span class="sd">&#39;&#39;&#39; VERTICAL HISTO &#39;&#39;&#39;</span>
<div class="viewcode-block" id="CocoDisplay.pycoa_histo"><a class="viewcode-back" href="../../coa.display.html#coa.display.CocoDisplay.pycoa_histo">[docs]</a>    <span class="nd">@decowrapper</span>
    <span class="nd">@decohistomap</span>
    <span class="k">def</span> <span class="nf">pycoa_histo</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>  <span class="n">geopdwd</span><span class="p">,</span> <span class="n">input_field</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">            -----------------</span>
<span class="sd">            Create 1D histogramme by value according to arguments.</span>
<span class="sd">            See help(pycoa_histo).</span>
<span class="sd">            Keyword arguments</span>
<span class="sd">            -----------------</span>
<span class="sd">            - geopdwd : A DataFrame with a Pycoa struture is mandatory</span>
<span class="sd">            |location|date|Variable desired|daily|cumul|weekly|codelocation|clustername|permanentdisplay|rolloverdisplay|</span>
<span class="sd">            - input_field = if None take second element could be a list</span>
<span class="sd">            - plot_heigh= width_height_default[1]</span>
<span class="sd">            - plot_width = width_height_default[0]</span>
<span class="sd">            - title = None</span>
<span class="sd">            - textcopyrightposition = left</span>
<span class="sd">            - textcopyright = default</span>
<span class="sd">            - when : default min and max according to the inpude DataFrame.</span>
<span class="sd">                     Dates are given under the format dd/mm/yyyy.</span>
<span class="sd">                     when format [dd/mm/yyyy : dd/mm/yyyy]</span>
<span class="sd">                     if [:dd/mm/yyyy] min date up to</span>
<span class="sd">                     if [dd/mm/yyyy:] up to max date</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">geopdwd_filter</span> <span class="o">=</span> <span class="n">geopdwd</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">geopdwd</span><span class="o">.</span><span class="n">date</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">when_end</span><span class="p">]</span>
        <span class="n">geopdwd_filter</span> <span class="o">=</span> <span class="n">geopdwd_filter</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>

        <span class="nb">input</span> <span class="o">=</span> <span class="n">geopdwd_filter</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;cases&#39;</span><span class="p">:</span> <span class="n">input_field</span><span class="p">})</span>
        <span class="n">bins</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;bins&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

        <span class="k">if</span> <span class="s1">&#39;location&#39;</span> <span class="ow">in</span> <span class="nb">input</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="n">uniqloc</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">input</span><span class="o">.</span><span class="n">clustername</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span>
            <span class="n">allval</span>  <span class="o">=</span> <span class="nb">input</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="nb">input</span><span class="o">.</span><span class="n">clustername</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">uniqloc</span><span class="p">)][[</span><span class="s1">&#39;clustername&#39;</span><span class="p">,</span> <span class="n">input_field</span><span class="p">,</span><span class="s1">&#39;permanentdisplay&#39;</span><span class="p">]]</span>
            <span class="n">min_val</span> <span class="o">=</span> <span class="n">allval</span><span class="p">[</span><span class="n">input_field</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
            <span class="n">max_val</span> <span class="o">=</span> <span class="n">allval</span><span class="p">[</span><span class="n">input_field</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>

            <span class="k">if</span> <span class="n">bins</span><span class="p">:</span>
                <span class="n">bins</span> <span class="o">=</span> <span class="n">bins</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">uniqloc</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">bins</span> <span class="o">=</span> <span class="mi">2</span>
                    <span class="n">min_val</span> <span class="o">=</span> <span class="mf">0.</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">bins</span> <span class="o">=</span> <span class="mi">10</span>

            <span class="n">delta</span> <span class="o">=</span> <span class="p">(</span><span class="n">max_val</span> <span class="o">-</span> <span class="n">min_val</span> <span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">bins</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">interval</span> <span class="o">=</span> <span class="p">[</span> <span class="n">min_val</span> <span class="o">+</span> <span class="p">(</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">delta</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,(</span><span class="n">bins</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">)]</span>

            <span class="n">contributors</span> <span class="o">=</span> <span class="p">{</span>  <span class="n">i</span> <span class="p">:</span> <span class="p">[]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">bins</span><span class="p">)}</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">allval</span><span class="p">)):</span>
                <span class="n">rank</span> <span class="o">=</span> <span class="n">bisect</span><span class="o">.</span><span class="n">bisect_left</span><span class="p">(</span><span class="n">interval</span><span class="p">,</span> <span class="n">allval</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">input_field</span><span class="p">])</span>
                <span class="n">contributors</span><span class="p">[</span><span class="n">rank</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">allval</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;clustername&#39;</span><span class="p">])</span>

            <span class="n">colors</span> <span class="o">=</span> <span class="n">itertools</span><span class="o">.</span><span class="n">cycle</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lcolors</span><span class="p">)</span>
            <span class="n">lcolors</span> <span class="o">=</span> <span class="p">[</span><span class="nb">next</span><span class="p">(</span><span class="n">colors</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">bins</span><span class="p">)]</span>
            <span class="n">contributors</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">contributors</span><span class="o">.</span><span class="n">items</span><span class="p">()))</span>
            <span class="n">frame_histo</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
                              <span class="s1">&#39;left&#39;</span><span class="p">:</span> <span class="n">interval</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
                              <span class="s1">&#39;right&#39;</span><span class="p">:</span><span class="n">interval</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span>
                              <span class="s1">&#39;middle_bin&#39;</span><span class="p">:</span> <span class="p">[</span><span class="nb">format</span><span class="p">((</span><span class="n">i</span><span class="o">+</span><span class="n">j</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="s2">&quot;.1f&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">j</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">interval</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span><span class="n">interval</span><span class="p">[</span><span class="mi">1</span><span class="p">:])],</span>
                              <span class="s1">&#39;top&#39;</span><span class="p">:</span> <span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">contributors</span><span class="o">.</span><span class="n">values</span><span class="p">())],</span>
                              <span class="s1">&#39;contributors&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">contributors</span><span class="o">.</span><span class="n">values</span><span class="p">()</span> <span class="p">],</span>
                              <span class="s1">&#39;colors&#39;</span><span class="p">:</span> <span class="n">lcolors</span><span class="p">})</span>
        <span class="c1">#tooltips = &quot;&quot;&quot;</span>
        <span class="c1">#&lt;div style=&quot;width: 400px&quot;&gt;</span>
        <span class="c1">#&lt;b&gt;Middle value:&lt;/b&gt; @middle_bin &lt;br&gt;</span>
        <span class="c1">#&lt;b&gt;Contributors:&lt;/b&gt; @contributors{safe} &lt;br&gt;</span>
        <span class="c1">#&lt;/div&gt;</span>
        <span class="c1">#&quot;&quot;&quot;</span>
        <span class="n">tooltips</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        &lt;b&gt;Middle value:&lt;/b&gt; @middle_bin &lt;br&gt;</span>
<span class="s2">        &lt;b&gt;Contributors:&lt;/b&gt; @contributors</span><span class="si">{safe}</span><span class="s2"> &lt;br&gt;</span>
<span class="s2">        &quot;&quot;&quot;</span>
        <span class="n">hover_tool</span> <span class="o">=</span> <span class="n">HoverTool</span><span class="p">(</span><span class="n">tooltips</span> <span class="o">=</span> <span class="n">tooltips</span><span class="p">)</span>
        <span class="n">panels</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">bottom</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">x_axis_type</span><span class="p">,</span> <span class="n">y_axis_type</span><span class="p">,</span> <span class="n">axis_type_title</span> <span class="o">=</span> <span class="mi">3</span> <span class="o">*</span> <span class="p">[</span><span class="s1">&#39;linear&#39;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">axis_type</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;linear&quot;</span><span class="p">,</span> <span class="s2">&quot;linlog&quot;</span><span class="p">,</span> <span class="s2">&quot;loglin&quot;</span><span class="p">,</span> <span class="s2">&quot;loglog&quot;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">axis_type</span> <span class="o">==</span> <span class="s1">&#39;linlog&#39;</span><span class="p">:</span>
                <span class="n">y_axis_type</span><span class="p">,</span> <span class="n">axis_type_title</span> <span class="o">=</span> <span class="s1">&#39;log&#39;</span><span class="p">,</span> <span class="s1">&#39;logy&#39;</span>
            <span class="k">if</span> <span class="n">axis_type</span> <span class="o">==</span> <span class="s1">&#39;loglin&#39;</span><span class="p">:</span>
                <span class="n">x_axis_type</span><span class="p">,</span> <span class="n">y_axis_type</span><span class="p">,</span> <span class="n">axis_type_title</span> <span class="o">=</span> <span class="s1">&#39;log&#39;</span><span class="p">,</span> <span class="s1">&#39;linear&#39;</span><span class="p">,</span> <span class="s1">&#39;logx&#39;</span>
            <span class="k">if</span> <span class="n">axis_type</span> <span class="o">==</span> <span class="s1">&#39;loglog&#39;</span><span class="p">:</span>
                <span class="n">x_axis_type</span><span class="p">,</span> <span class="n">y_axis_type</span> <span class="o">=</span> <span class="s1">&#39;log&#39;</span><span class="p">,</span> <span class="s1">&#39;log&#39;</span>
                <span class="n">axis_type_title</span> <span class="o">=</span> <span class="s1">&#39;loglog&#39;</span>

            <span class="n">standardfig</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">standardfig</span><span class="p">(</span><span class="n">x_axis_type</span><span class="o">=</span><span class="n">x_axis_type</span><span class="p">,</span> <span class="n">y_axis_type</span><span class="o">=</span><span class="n">y_axis_type</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

            <span class="n">standardfig</span><span class="o">.</span><span class="n">yaxis</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">formatter</span> <span class="o">=</span> <span class="n">PrintfTickFormatter</span><span class="p">(</span><span class="nb">format</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%4.2e</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">standardfig</span><span class="o">.</span><span class="n">xaxis</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">formatter</span> <span class="o">=</span> <span class="n">PrintfTickFormatter</span><span class="p">(</span><span class="nb">format</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">%4.2e</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">standardfig</span><span class="o">.</span><span class="n">add_tools</span><span class="p">(</span><span class="n">hover_tool</span><span class="p">)</span>
            <span class="n">standardfig</span><span class="o">.</span><span class="n">x_range</span> <span class="o">=</span> <span class="n">Range1d</span><span class="p">(</span><span class="mf">1.05</span> <span class="o">*</span> <span class="n">interval</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mf">1.05</span> <span class="o">*</span> <span class="n">interval</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">standardfig</span><span class="o">.</span><span class="n">y_range</span> <span class="o">=</span> <span class="n">Range1d</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">1.05</span> <span class="o">*</span> <span class="n">frame_histo</span><span class="p">[</span><span class="s1">&#39;top&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>
            <span class="k">if</span> <span class="n">x_axis_type</span> <span class="o">==</span> <span class="s2">&quot;log&quot;</span><span class="p">:</span>
                <span class="n">left</span> <span class="o">=</span> <span class="mf">0.8</span>
                <span class="k">if</span> <span class="n">frame_histo</span><span class="p">[</span><span class="s1">&#39;left&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">frame_histo</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;left&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">left</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">left</span>  <span class="o">=</span> <span class="n">frame_histo</span><span class="p">[</span><span class="s1">&#39;left&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">standardfig</span><span class="o">.</span><span class="n">x_range</span> <span class="o">=</span> <span class="n">Range1d</span><span class="p">(</span><span class="n">left</span><span class="p">,</span> <span class="mi">10</span> <span class="o">*</span> <span class="n">interval</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>

            <span class="k">if</span> <span class="n">y_axis_type</span> <span class="o">==</span> <span class="s2">&quot;log&quot;</span><span class="p">:</span>
                <span class="n">bottom</span> <span class="o">=</span> <span class="mf">0.0001</span>
                <span class="n">standardfig</span><span class="o">.</span><span class="n">y_range</span> <span class="o">=</span> <span class="n">Range1d</span><span class="p">(</span><span class="mf">0.001</span><span class="p">,</span> <span class="mi">10</span> <span class="o">*</span> <span class="n">frame_histo</span><span class="p">[</span><span class="s1">&#39;top&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>

            <span class="n">standardfig</span><span class="o">.</span><span class="n">quad</span><span class="p">(</span><span class="n">source</span><span class="o">=</span><span class="n">ColumnDataSource</span><span class="p">(</span><span class="n">frame_histo</span><span class="p">),</span> <span class="n">top</span><span class="o">=</span><span class="s1">&#39;top&#39;</span><span class="p">,</span> <span class="n">bottom</span><span class="o">=</span><span class="n">bottom</span><span class="p">,</span> <span class="n">left</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span> \
                             <span class="n">right</span><span class="o">=</span><span class="s1">&#39;right&#39;</span><span class="p">,</span> <span class="n">fill_color</span><span class="o">=</span><span class="s1">&#39;colors&#39;</span><span class="p">)</span>
            <span class="n">panel</span> <span class="o">=</span> <span class="n">Panel</span><span class="p">(</span><span class="n">child</span><span class="o">=</span><span class="n">standardfig</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="n">axis_type_title</span><span class="p">)</span>
            <span class="n">panels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">panel</span><span class="p">)</span>
        <span class="n">tabs</span> <span class="o">=</span> <span class="n">Tabs</span><span class="p">(</span><span class="n">tabs</span><span class="o">=</span><span class="n">panels</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">tabs</span></div>

    <span class="sd">&#39;&#39;&#39; DECORATORS FOR HISTO VERTICAL, HISTO HORIZONTAL, PIE &#39;&#39;&#39;</span>
<div class="viewcode-block" id="CocoDisplay.decohistopie"><a class="viewcode-back" href="../../coa.display.html#coa.display.CocoDisplay.decohistopie">[docs]</a>    <span class="k">def</span> <span class="nf">decohistopie</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
        <span class="nd">@wraps</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
        <span class="k">def</span> <span class="nf">inner_decohistopie</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">geopdwd</span><span class="p">,</span> <span class="n">input_field</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Decorator for</span>
<span class="sd">            Horizontal histogram &amp; Pie Chart</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="n">geopdwd</span><span class="p">[</span><span class="s1">&#39;cases&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">geopdwd</span><span class="p">[</span><span class="n">input_field</span><span class="p">]</span>
            <span class="n">geopdwd_filter</span> <span class="o">=</span> <span class="n">geopdwd</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">geopdwd</span><span class="o">.</span><span class="n">date</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">when_end</span><span class="p">]</span>
            <span class="n">geopdwd_filter</span> <span class="o">=</span> <span class="n">geopdwd_filter</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
            <span class="n">geopdwd_filter</span><span class="p">[</span><span class="s1">&#39;cases&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">geopdwd_filter</span><span class="p">[</span><span class="n">input_field</span><span class="p">]</span>
            <span class="n">cursor_date</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;cursor_date&#39;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">dvisu_default</span><span class="p">[</span><span class="s1">&#39;cursor_date&#39;</span><span class="p">])</span>
            <span class="n">date_slider</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;date_slider&#39;</span><span class="p">]</span>
            <span class="n">my_date</span> <span class="o">=</span> <span class="n">geopdwd</span><span class="o">.</span><span class="n">date</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
            <span class="n">dico_utc</span> <span class="o">=</span> <span class="p">{</span><span class="n">i</span><span class="p">:</span> <span class="n">DateSlider</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="n">i</span><span class="p">)</span><span class="o">.</span><span class="n">value</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">my_date</span><span class="p">}</span>
            <span class="n">geopdwd</span><span class="p">[</span><span class="s1">&#39;date_utc&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">dico_utc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">geopdwd</span><span class="o">.</span><span class="n">date</span><span class="p">]</span>
            <span class="n">geopdwd</span> <span class="o">=</span> <span class="n">geopdwd</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">([</span><span class="s2">&quot;date&quot;</span><span class="p">,</span> <span class="s2">&quot;codelocation&quot;</span><span class="p">,</span><span class="s2">&quot;clustername&quot;</span><span class="p">])</span><span class="c1">#for sumall avoid duplicate</span>
            <span class="n">geopdwd_filter</span> <span class="o">=</span> <span class="n">geopdwd_filter</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">([</span><span class="s2">&quot;date&quot;</span><span class="p">,</span> <span class="s2">&quot;codelocation&quot;</span><span class="p">,</span><span class="s2">&quot;clustername&quot;</span><span class="p">])</span>
            <span class="n">geopdwd_filter</span> <span class="o">=</span> <span class="n">geopdwd_filter</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="s1">&#39;cases&#39;</span><span class="p">,</span> <span class="n">ascending</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
            <span class="n">locunique</span> <span class="o">=</span> <span class="n">geopdwd_filter</span><span class="o">.</span><span class="n">clustername</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span><span class="c1">#geopdwd_filtered.location.unique()</span>
            <span class="n">geopdwd_filter</span> <span class="o">=</span> <span class="n">geopdwd_filter</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">nmaxdisplayed</span> <span class="o">=</span> <span class="mi">18</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">locunique</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">nmaxdisplayed</span> <span class="p">:</span><span class="c1">#and func.__name__ != &#39;pycoa_pie&#39; :</span>
                <span class="k">if</span> <span class="n">func</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">!=</span> <span class="s1">&#39;pycoa_pie&#39;</span> <span class="p">:</span>
                    <span class="n">geopdwd_filter</span> <span class="o">=</span> <span class="n">geopdwd_filter</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">geopdwd_filter</span><span class="o">.</span><span class="n">clustername</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">locunique</span><span class="p">[:</span><span class="n">nmaxdisplayed</span><span class="p">])]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">geopdwd_filter_first</span> <span class="o">=</span> <span class="n">geopdwd_filter</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">geopdwd_filter</span><span class="o">.</span><span class="n">clustername</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">locunique</span><span class="p">[:</span><span class="n">nmaxdisplayed</span><span class="o">-</span><span class="mi">1</span><span class="p">])]</span>
                    <span class="n">geopdwd_filter_other</span> <span class="o">=</span> <span class="n">geopdwd_filter</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">geopdwd_filter</span><span class="o">.</span><span class="n">clustername</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">locunique</span><span class="p">[</span><span class="n">nmaxdisplayed</span><span class="o">-</span><span class="mi">1</span><span class="p">:])]</span>
                    <span class="n">geopdwd_filter_other</span> <span class="o">=</span> <span class="n">geopdwd_filter_other</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;date&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
                    <span class="n">geopdwd_filter_other</span><span class="p">[</span><span class="s1">&#39;location&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;others&#39;</span>
                    <span class="n">geopdwd_filter_other</span><span class="p">[</span><span class="s1">&#39;clustername&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;others&#39;</span>
                    <span class="n">geopdwd_filter_other</span><span class="p">[</span><span class="s1">&#39;codelocation&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;others&#39;</span>
                    <span class="n">geopdwd_filter_other</span><span class="p">[</span><span class="s1">&#39;permanentdisplay&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;others&#39;</span>
                    <span class="n">geopdwd_filter_other</span><span class="p">[</span><span class="s1">&#39;rolloverdisplay&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;others&#39;</span>
                    <span class="n">geopdwd_filter_other</span><span class="p">[</span><span class="s1">&#39;colors&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;#FFFFFF&#39;</span>

                    <span class="n">geopdwd_filter</span> <span class="o">=</span> <span class="n">geopdwd_filter_first</span>
                    <span class="n">geopdwd_filter</span> <span class="o">=</span> <span class="n">geopdwd_filter</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">geopdwd_filter_other</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">func</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;pycoa_horizonhisto&#39;</span> <span class="p">:</span>
                <span class="c1">#geopdwd_filter[&#39;bottom&#39;] = geopdwd_filter.index</span>
                <span class="n">geopdwd_filter</span><span class="p">[</span><span class="s1">&#39;left&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">geopdwd_filter</span><span class="p">[</span><span class="s1">&#39;cases&#39;</span><span class="p">]</span>
                <span class="n">geopdwd_filter</span><span class="p">[</span><span class="s1">&#39;right&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">geopdwd_filter</span><span class="p">[</span><span class="s1">&#39;cases&#39;</span><span class="p">]</span>
                <span class="n">geopdwd_filter</span><span class="p">[</span><span class="s1">&#39;left&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">geopdwd_filter</span><span class="p">[</span><span class="s1">&#39;left&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="mi">0</span> <span class="k">if</span> <span class="n">x</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">x</span><span class="p">)</span>
                <span class="n">geopdwd_filter</span><span class="p">[</span><span class="s1">&#39;right&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">geopdwd_filter</span><span class="p">[</span><span class="s1">&#39;right&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="mi">0</span> <span class="k">if</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">x</span><span class="p">)</span>
                <span class="n">bthick</span> <span class="o">=</span> <span class="mf">0.95</span>
                <span class="n">geopdwd_filter</span><span class="p">[</span><span class="s1">&#39;top&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">geopdwd_filter</span><span class="o">.</span><span class="n">index</span><span class="p">)</span> <span class="o">+</span> <span class="n">bthick</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">-</span> <span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span>
                                             <span class="n">geopdwd_filter</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">to_list</span><span class="p">()]</span>
                <span class="n">geopdwd_filter</span><span class="p">[</span><span class="s1">&#39;bottom&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">geopdwd_filter</span><span class="o">.</span><span class="n">index</span><span class="p">)</span> <span class="o">-</span> <span class="n">bthick</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">-</span> <span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span>
                                                <span class="n">geopdwd_filter</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">to_list</span><span class="p">()]</span>
                <span class="n">geopdwd_filter</span><span class="p">[</span><span class="s1">&#39;horihistotexty&#39;</span><span class="p">]</span> <span class="o">=</span>  <span class="n">geopdwd_filter</span><span class="p">[</span><span class="s1">&#39;bottom&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">bthick</span><span class="o">/</span><span class="mi">2</span>
                <span class="n">geopdwd_filter</span><span class="p">[</span><span class="s1">&#39;horihistotextx&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">geopdwd_filter</span><span class="p">[</span><span class="s1">&#39;right&#39;</span><span class="p">]</span>
                <span class="n">geopdwd_filter</span><span class="p">[</span><span class="s1">&#39;horihistotext&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span> <span class="s1">&#39;</span><span class="si">{:.3g}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">i</span><span class="p">))</span> <span class="k">if</span> <span class="nb">float</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">&gt;</span><span class="mf">1.e4</span> <span class="k">else</span> <span class="nb">round</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">i</span><span class="p">),</span><span class="mi">2</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">geopdwd_filter</span><span class="p">[</span><span class="s1">&#39;right&#39;</span><span class="p">]</span> <span class="p">]</span>
                <span class="n">geopdwd_filter</span><span class="p">[</span><span class="s1">&#39;horihistotext&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">geopdwd_filter</span><span class="p">[</span><span class="s1">&#39;horihistotext&#39;</span><span class="p">]]</span>
            <span class="k">if</span> <span class="n">func</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;pycoa_pie&#39;</span> <span class="p">:</span>
                <span class="n">geopdwd_filter</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_columns_for_pie_chart</span><span class="p">(</span><span class="n">geopdwd_filter</span><span class="p">,</span><span class="n">input_field</span><span class="p">)</span>
                <span class="n">geopdwd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_columns_for_pie_chart</span><span class="p">(</span><span class="n">geopdwd</span><span class="p">,</span><span class="n">input_field</span><span class="p">)</span>

            <span class="n">source</span> <span class="o">=</span> <span class="n">ColumnDataSource</span><span class="p">(</span><span class="n">data</span> <span class="o">=</span> <span class="n">geopdwd</span><span class="p">)</span>
            <span class="n">input_filter</span> <span class="o">=</span> <span class="n">geopdwd_filter</span>
            <span class="n">srcfiltered</span> <span class="o">=</span> <span class="n">ColumnDataSource</span><span class="p">(</span><span class="n">data</span> <span class="o">=</span> <span class="n">input_filter</span><span class="p">)</span>
            <span class="n">max_value</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">input_filter</span><span class="p">[</span><span class="s1">&#39;cases&#39;</span><span class="p">])</span>
            <span class="n">min_value</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">input_filter</span><span class="p">[</span><span class="s1">&#39;cases&#39;</span><span class="p">])</span>
            <span class="n">min_value_gt0</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">input_filter</span><span class="p">[</span><span class="n">input_filter</span><span class="p">[</span><span class="s1">&#39;cases&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">][</span><span class="s1">&#39;cases&#39;</span><span class="p">])</span>
            <span class="n">panels</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">axis_type</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ax_type</span><span class="p">:</span>
                <span class="n">plot_width</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;plot_width&#39;</span><span class="p">]</span>
                <span class="n">plot_height</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;plot_height&#39;</span><span class="p">]</span>
                <span class="n">standardfig</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">standardfig</span><span class="p">(</span> <span class="n">x_axis_type</span> <span class="o">=</span> <span class="n">axis_type</span><span class="p">,</span>  <span class="n">x_range</span> <span class="o">=</span> <span class="p">(</span><span class="mf">1.05</span><span class="o">*</span><span class="n">min_value</span><span class="p">,</span> <span class="mf">1.05</span> <span class="o">*</span> <span class="n">max_value</span><span class="p">),</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

                <span class="n">standardfig</span><span class="o">.</span><span class="n">xaxis</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">formatter</span> <span class="o">=</span> <span class="n">PrintfTickFormatter</span><span class="p">(</span><span class="nb">format</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">%4.2e</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">standardfig</span><span class="o">.</span><span class="n">x_range</span> <span class="o">=</span> <span class="n">Range1d</span><span class="p">(</span><span class="mf">0.01</span><span class="p">,</span> <span class="mf">1.2</span> <span class="o">*</span> <span class="n">max_value</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">input_filter</span><span class="p">[</span><span class="n">input_filter</span><span class="p">[</span><span class="n">input_field</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mf">0.</span><span class="p">]</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
                    <span class="n">standardfig</span><span class="o">.</span><span class="n">x_range</span> <span class="o">=</span> <span class="n">Range1d</span><span class="p">(</span><span class="mf">1.2</span> <span class="o">*</span> <span class="n">min_value</span><span class="p">,</span> <span class="mf">1.2</span> <span class="o">*</span> <span class="n">max_value</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">axis_type</span> <span class="o">==</span> <span class="s2">&quot;log&quot;</span><span class="p">:</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">input_filter</span><span class="p">[</span><span class="n">input_filter</span><span class="p">[</span><span class="n">input_field</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mf">0.</span><span class="p">]</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Some value are negative, can</span><span class="se">\&#39;</span><span class="s1">t display log scale in this context&#39;</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">func</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;pycoa_horizonhisto&#39;</span> <span class="p">:</span>
                            <span class="n">standardfig</span><span class="o">.</span><span class="n">x_range</span> <span class="o">=</span> <span class="n">Range1d</span><span class="p">(</span><span class="mf">0.01</span><span class="p">,</span> <span class="mi">50</span> <span class="o">*</span> <span class="n">max_value</span><span class="p">)</span>
                            <span class="n">srcfiltered</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;left&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.01</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">srcfiltered</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;right&#39;</span><span class="p">])</span>

                <span class="k">if</span> <span class="n">func</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;pycoa_pie&#39;</span> <span class="p">:</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">input_filter</span><span class="p">[</span><span class="n">input_filter</span><span class="p">[</span><span class="n">input_field</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mf">0.</span><span class="p">]</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="n">CoaKeyError</span><span class="p">(</span><span class="s1">&#39;Some values are negative, can</span><span class="se">\&#39;</span><span class="s1">t display a Pie chart, try histo by location&#39;</span><span class="p">)</span>
                    <span class="n">standardfig</span><span class="o">.</span><span class="n">plot_width</span> <span class="o">=</span> <span class="n">plot_height</span>
                    <span class="n">standardfig</span><span class="o">.</span><span class="n">plot_height</span> <span class="o">=</span> <span class="n">plot_height</span>

                <span class="k">if</span> <span class="n">date_slider</span><span class="p">:</span>
                    <span class="n">date_slider</span><span class="o">.</span><span class="n">width</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mf">0.8</span><span class="o">*</span><span class="n">plot_width</span><span class="p">)</span>
                    <span class="n">callback</span> <span class="o">=</span> <span class="n">CustomJS</span><span class="p">(</span><span class="n">args</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">source</span> <span class="o">=</span> <span class="n">source</span><span class="p">,</span>
                                                  <span class="n">source_filter</span> <span class="o">=</span> <span class="n">srcfiltered</span><span class="p">,</span>
                                                  <span class="n">date_slider</span> <span class="o">=</span> <span class="n">date_slider</span><span class="p">,</span>
                                                  <span class="n">ylabel</span> <span class="o">=</span> <span class="n">standardfig</span><span class="o">.</span><span class="n">yaxis</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                                                  <span class="n">title</span> <span class="o">=</span> <span class="n">standardfig</span><span class="o">.</span><span class="n">title</span><span class="p">,</span>
                                                  <span class="n">x_range</span> <span class="o">=</span> <span class="n">standardfig</span><span class="o">.</span><span class="n">x_range</span><span class="p">,</span>
                                                  <span class="n">x_axis_type</span> <span class="o">=</span> <span class="n">axis_type</span><span class="p">),</span>
                            <span class="n">code</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">                            var date_slide = date_slider.value;</span>
<span class="s2">                            var dates = source.data[&#39;date_utc&#39;];</span>
<span class="s2">                            var val = source.data[&#39;cases&#39;];</span>
<span class="s2">                            var loc = source.data[&#39;clustername&#39;];</span>
<span class="s2">                            //var loc = source.data[&#39;location&#39;];</span>
<span class="s2">                            var subregion = source.data[&#39;name_subregion&#39;];</span>
<span class="s2">                            var codeloc = source.data[&#39;codelocation&#39;];</span>
<span class="s2">                            var colors = source.data[&#39;colors&#39;];</span>

<span class="s2">                            var newval = [];</span>
<span class="s2">                            var newloc = [];</span>
<span class="s2">                            var newcolors = [];</span>
<span class="s2">                            var newcodeloc = [];</span>
<span class="s2">                            var newname_subregion = [];</span>
<span class="s2">                            var labeldic = </span><span class="si">{}</span><span class="s2">;</span>
<span class="s2">                            for (var i = 0; i &lt; dates.length; i++){</span>
<span class="s2">                            if (dates[i] == date_slide){</span>
<span class="s2">                                newval.push(parseFloat(val[i]));</span>
<span class="s2">                                newloc.push(loc[i]);</span>
<span class="s2">                                newcodeloc.push(codeloc[i]);</span>
<span class="s2">                                newcolors.push(colors[i]);</span>
<span class="s2">                                if(typeof subregion !== &#39;undefined&#39;)</span>
<span class="s2">                                    newname_subregion.push(subregion[i]);</span>

<span class="s2">                                }</span>
<span class="s2">                            }</span>
<span class="s2">                            console.log(newcodeloc);</span>
<span class="s2">                            var len = source_filter.data[&#39;clustername&#39;].length;</span>

<span class="s2">                            var indices = new Array(len);</span>
<span class="s2">                            for (var i = 0; i &lt; len; i++) indices[i] = i;</span>

<span class="s2">                            indices.sort(function (a, b) { return newval[a] &gt; newval[b] ? -1 : newval[a] &lt; newval[b] ? 1 : 0; });</span>
<span class="s2">                            var orderval = [];</span>
<span class="s2">                            var orderloc = [];</span>
<span class="s2">                            var ordercodeloc = [];</span>
<span class="s2">                            var ordername_subregion = [];</span>
<span class="s2">                            var ordercolors = [];</span>
<span class="s2">                            var textdisplayed = [];</span>
<span class="s2">                            for (var i = 0; i &lt; len; i++)</span>
<span class="s2">                            {</span>
<span class="s2">                                orderval.push(newval[indices[i]]);</span>
<span class="s2">                                orderloc.push(newloc[indices[i]]);</span>
<span class="s2">                                ordercodeloc.push(newcodeloc[indices[i]]);</span>

<span class="s2">                                if(typeof subregion !== &#39;undefined&#39;)</span>
<span class="s2">                                    ordername_subregion.push(newname_subregion[i]);</span>
<span class="s2">                                ordercolors.push(newcolors[indices[i]]);</span>
<span class="s2">                                labeldic[len-indices[i]] = newcodeloc[indices[i]];</span>
<span class="s2">                                textdisplayed.push(newcodeloc[indices[i]].padStart(20,&#39; &#39;));</span>
<span class="s2">                            }</span>

<span class="s2">                            source_filter.data[&#39;cases&#39;] = orderval;</span>
<span class="s2">                            const reducer = (accumulator, currentValue) =&gt; accumulator + currentValue;</span>
<span class="s2">                            var tot = orderval.reduce(reducer);</span>
<span class="s2">                            var top = [];</span>
<span class="s2">                            var bottom = [];</span>
<span class="s2">                            var starts = [];</span>
<span class="s2">                            var ends = [];</span>
<span class="s2">                            var middle = [];</span>
<span class="s2">                            var text_x = [];</span>
<span class="s2">                            var text_y = [];</span>
<span class="s2">                            var r = 0.7;</span>
<span class="s2">                            var bthick = 0.95;</span>
<span class="s2">                            var cumul = 0.;</span>
<span class="s2">                            var percentage = [];</span>
<span class="s2">                            var angle = [];</span>
<span class="s2">                            var text_size = [];</span>
<span class="s2">                            var left_quad = [];</span>
<span class="s2">                            var right_quad = [];</span>

<span class="s2">                            for(var i = 0; i &lt; orderval.length; i++)</span>
<span class="s2">                            {</span>
<span class="s2">                                cumul += ((orderval[i] / tot) * 2 * Math.PI);</span>
<span class="s2">                                ends.push(cumul);</span>
<span class="s2">                                if(i==0)</span>
<span class="s2">                                    starts.push(0);</span>
<span class="s2">                                else</span>
<span class="s2">                                    starts.push(ends[i-1]);</span>
<span class="s2">                                middle.push((ends[i]+starts[i])/2);</span>
<span class="s2">                                text_x.push(r*Math.cos(middle[i]));</span>
<span class="s2">                                text_y.push(r*Math.sin(middle[i]));</span>
<span class="s2">                                percentage.push(String(100.*orderval[i] / tot).slice(0, 4));</span>
<span class="s2">                                angle.push((orderval[i] / tot) * 2 * Math.PI)</span>
<span class="s2">                                /*if ((ends[i]-starts[i]) &gt; 0.08*(2 * Math.PI))</span>
<span class="s2">                                    text_size.push(&#39;10pt&#39;);</span>
<span class="s2">                                else</span>
<span class="s2">                                    text_size.push(&#39;6pt&#39;);*/</span>

<span class="s2">                                top.push((orderval.length-i) + bthick/2);</span>
<span class="s2">                                bottom.push((orderval.length-i) - bthick/2);</span>

<span class="s2">                                if (isNaN(orderval[i])) orderval[i] = 0.;</span>
<span class="s2">                                if(orderval[i]&lt;=0.)</span>
<span class="s2">                                {</span>
<span class="s2">                                    left_quad.push(orderval[i]);</span>
<span class="s2">                                    right_quad.push(0.);</span>
<span class="s2">                                }</span>
<span class="s2">                                else</span>
<span class="s2">                                {</span>
<span class="s2">                                    left_quad.push(0);</span>
<span class="s2">                                    right_quad.push(orderval[i]);</span>
<span class="s2">                                }</span>
<span class="s2">                            }</span>

<span class="s2">                            source_filter.data[&#39;clustername&#39;] = orderloc;</span>
<span class="s2">                            source_filter.data[&#39;codelocation&#39;] = ordercodeloc;</span>
<span class="s2">                            //source_filter.data[&#39;colors&#39;] = ordercolors;</span>

<span class="s2">                            if(typeof subregion !== &#39;undefined&#39;)</span>
<span class="s2">                                source_filter.data[&#39;rolloverdisplay&#39;] = ordername_subregion;</span>
<span class="s2">                            else</span>
<span class="s2">                                source_filter.data[&#39;rolloverdisplay&#39;] = orderloc;</span>

<span class="s2">                            source_filter.data[&#39;ends&#39;] = ends;</span>
<span class="s2">                            source_filter.data[&#39;starts&#39;] = starts;</span>
<span class="s2">                            source_filter.data[&#39;middle&#39;] = middle;</span>
<span class="s2">                            source_filter.data[&#39;text_x&#39;] = text_x;</span>
<span class="s2">                            source_filter.data[&#39;text_y&#39;] = text_y;</span>
<span class="s2">                            //source_filter.data[&#39;text_size&#39;] = text_size;</span>
<span class="s2">                            source_filter.data[&#39;percentage&#39;] = percentage;</span>
<span class="s2">                            source_filter.data[&#39;angle&#39;] = angle;</span>

<span class="s2">                            ylabel.major_label_overrides = labeldic;</span>

<span class="s2">                            source_filter.data[&#39;top&#39;] = top;</span>
<span class="s2">                            source_filter.data[&#39;bottom&#39;] = bottom;</span>
<span class="s2">                            source_filter.data[&#39;left&#39;] = left_quad;</span>
<span class="s2">                            source_filter.data[&#39;right&#39;] = right_quad;</span>

<span class="s2">                            var mid =[];</span>
<span class="s2">                            var ht = [];</span>
<span class="s2">                            var textdisplayed2 = [];</span>
<span class="s2">                            for(i=0; i&lt;right_quad.length;i++){</span>
<span class="s2">                                mid.push(bottom[i]+(top[i] - bottom[i])/2);</span>
<span class="s2">                                ht.push(right_quad[i].toFixed(2).toString());</span>
<span class="s2">                                textdisplayed2.push(right_quad[i].toFixed(2).toString().padStart(45,&#39; &#39;));</span>
<span class="s2">                            }</span>

<span class="s2">                            source_filter.data[&#39;horihistotextxy&#39;] =  mid;</span>
<span class="s2">                            source_filter.data[&#39;horihistotextx&#39;] =  right_quad;</span>
<span class="s2">                            source_filter.data[&#39;horihistotext&#39;] =  ht;</span>
<span class="s2">                            source_filter.data[&#39;textdisplayed&#39;] = textdisplayed;</span>
<span class="s2">                            source_filter.data[&#39;textdisplayed2&#39;] = textdisplayed2;</span>
<span class="s2">                            var maxx = Math.max.apply(Math, right_quad);</span>
<span class="s2">                            var minx = Math.min.apply(Math, left_quad);</span>

<span class="s2">                            x_range.end =  1.2 * maxx;</span>
<span class="s2">                            x_range.start =  1.05 * minx;</span>
<span class="s2">                            if(minx &gt;= 0){</span>
<span class="s2">                                x_range.start =  0.01;</span>
<span class="s2">                                source_filter.data[&#39;left&#39;] = Array(left_quad.length).fill(0.01);</span>
<span class="s2">                                }</span>
<span class="s2">                            var tmp = title.text;</span>
<span class="s2">                            tmp = tmp.slice(0, -11);</span>
<span class="s2">                            var dateconverted = new Date(date_slide);</span>
<span class="s2">                            var dd = String(dateconverted.getDate()).padStart(2, &#39;0&#39;);</span>
<span class="s2">                            var mm = String(dateconverted.getMonth() + 1).padStart(2, &#39;0&#39;); //January is 0!</span>
<span class="s2">                            var yyyy = dateconverted.getFullYear();</span>
<span class="s2">                            var dmy = dd + &#39;/&#39; + mm + &#39;/&#39; + yyyy;</span>
<span class="s2">                            title.text = tmp + dmy+&quot;)&quot;;</span>

<span class="s2">                            source_filter.change.emit();</span>
<span class="s2">                        &quot;&quot;&quot;</span><span class="p">)</span>
                    <span class="n">date_slider</span><span class="o">.</span><span class="n">js_on_change</span><span class="p">(</span><span class="s1">&#39;value&#39;</span><span class="p">,</span> <span class="n">callback</span><span class="p">)</span>
                <span class="n">cases_custom</span> <span class="o">=</span> <span class="n">CocoDisplay</span><span class="o">.</span><span class="n">rollerJS</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">func</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;pycoa_pie&#39;</span> <span class="p">:</span>
                    <span class="n">standardfig</span><span class="o">.</span><span class="n">add_tools</span><span class="p">(</span><span class="n">HoverTool</span><span class="p">(</span>
                        <span class="n">tooltips</span><span class="o">=</span><span class="p">[(</span><span class="s1">&#39;Location&#39;</span><span class="p">,</span> <span class="s1">&#39;@rolloverdisplay&#39;</span><span class="p">),</span> <span class="p">(</span><span class="n">input_field</span><span class="p">,</span> <span class="s1">&#39;@{&#39;</span> <span class="o">+</span> <span class="s1">&#39;cases&#39;</span> <span class="o">+</span> <span class="s1">&#39;}&#39;</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="si">{custom}</span><span class="s1">&#39;</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;%&#39;</span><span class="p">,</span><span class="s1">&#39;@percentage&#39;</span><span class="p">),</span> <span class="p">],</span>
                        <span class="n">formatters</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;location&#39;</span><span class="p">:</span> <span class="s1">&#39;printf&#39;</span><span class="p">,</span> <span class="s1">&#39;@{&#39;</span> <span class="o">+</span> <span class="s1">&#39;cases&#39;</span> <span class="o">+</span> <span class="s1">&#39;}&#39;</span><span class="p">:</span> <span class="n">cases_custom</span><span class="p">,</span> <span class="s1">&#39;%&#39;</span><span class="p">:</span><span class="s1">&#39;printf&#39;</span><span class="p">},</span>
                        <span class="n">point_policy</span><span class="o">=</span><span class="s2">&quot;snap_to_data&quot;</span><span class="p">))</span>  <span class="c1"># ,PanTool())</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">standardfig</span><span class="o">.</span><span class="n">add_tools</span><span class="p">(</span><span class="n">HoverTool</span><span class="p">(</span>
                        <span class="n">tooltips</span><span class="o">=</span><span class="p">[(</span><span class="s1">&#39;Location&#39;</span><span class="p">,</span> <span class="s1">&#39;@rolloverdisplay&#39;</span><span class="p">),</span> <span class="p">(</span><span class="n">input_field</span><span class="p">,</span> <span class="s1">&#39;@{&#39;</span> <span class="o">+</span> <span class="s1">&#39;cases&#39;</span> <span class="o">+</span> <span class="s1">&#39;}&#39;</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="si">{custom}</span><span class="s1">&#39;</span><span class="p">),</span> <span class="p">],</span>
                        <span class="n">formatters</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;location&#39;</span><span class="p">:</span> <span class="s1">&#39;printf&#39;</span><span class="p">,</span> <span class="s1">&#39;@{&#39;</span> <span class="o">+</span> <span class="s1">&#39;cases&#39;</span> <span class="o">+</span> <span class="s1">&#39;}&#39;</span><span class="p">:</span> <span class="n">cases_custom</span><span class="p">,</span> <span class="p">},</span>
                        <span class="n">point_policy</span><span class="o">=</span><span class="s2">&quot;snap_to_data&quot;</span><span class="p">))</span>  <span class="c1"># ,PanTool())</span>
                <span class="n">panel</span> <span class="o">=</span> <span class="n">Panel</span><span class="p">(</span><span class="n">child</span> <span class="o">=</span> <span class="n">standardfig</span><span class="p">,</span> <span class="n">title</span> <span class="o">=</span> <span class="n">axis_type</span><span class="p">)</span>
                <span class="n">panels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">panel</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">func</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">srcfiltered</span><span class="p">,</span> <span class="n">panels</span><span class="p">,</span> <span class="n">date_slider</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">inner_decohistopie</span></div>

    <span class="sd">&#39;&#39;&#39; VERTICAL HISTO &#39;&#39;&#39;</span>
<div class="viewcode-block" id="CocoDisplay.pycoa_horizonhisto"><a class="viewcode-back" href="../../coa.display.html#coa.display.CocoDisplay.pycoa_horizonhisto">[docs]</a>    <span class="nd">@decowrapper</span>
    <span class="nd">@decohistomap</span>
    <span class="nd">@decohistopie</span>
    <span class="k">def</span> <span class="nf">pycoa_horizonhisto</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">srcfiltered</span><span class="p">,</span> <span class="n">panels</span><span class="p">,</span> <span class="n">date_slider</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">            -----------------</span>
<span class="sd">            Create 1D histogramme by location according to arguments.</span>
<span class="sd">            See help(pycoa_histo).</span>
<span class="sd">            Keyword arguments</span>
<span class="sd">            -----------------</span>
<span class="sd">            - srcfiltered : A DataFrame with a Pycoa struture is mandatory</span>
<span class="sd">            |location|date|Variable desired|daily|cumul|weekly|codelocation|clustername|permanentdisplay|rolloverdisplay|</span>
<span class="sd">            - input_field = if None take second element could be a list</span>
<span class="sd">            - plot_heigh= width_height_default[1]</span>
<span class="sd">            - plot_width = width_height_default[0]</span>
<span class="sd">            - title = None</span>
<span class="sd">            - textcopyrightposition = left</span>
<span class="sd">            - textcopyright = default</span>
<span class="sd">            - mode = mouse</span>
<span class="sd">            - cursor_date = None if True</span>
<span class="sd">                    - orientation = horizontal</span>
<span class="sd">            - when : default min and max according to the inpude DataFrame.</span>
<span class="sd">                         Dates are given under the format dd/mm/yyyy.</span>
<span class="sd">                         when format [dd/mm/yyyy : dd/mm/yyyy]</span>
<span class="sd">                         if [:dd/mm/yyyy] min date up to</span>
<span class="sd">                         if [dd/mm/yyyy:] up to max date</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">panels</span><span class="p">)</span>
        <span class="n">loc</span> <span class="o">=</span> <span class="n">srcfiltered</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;permanentdisplay&#39;</span><span class="p">]</span><span class="c1">#srcfiltered.data[&#39;codelocation&#39;]</span>
        <span class="n">chars</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="s1">&#39;-&#39;</span><span class="p">]</span>
        <span class="n">returnchars</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">loc</span> <span class="k">if</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">chars</span><span class="p">]</span>
        <span class="n">label_dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">label_dict</span> <span class="o">=</span> <span class="p">{(</span><span class="nb">len</span><span class="p">(</span><span class="n">loc</span><span class="p">)</span> <span class="o">-</span> <span class="n">k</span><span class="p">)</span> <span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">loc</span><span class="p">)</span> <span class="p">}</span>
        <span class="n">new_panels</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
            <span class="n">fig</span> <span class="o">=</span> <span class="n">panels</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">child</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">ticker</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">loc</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">major_label_overrides</span> <span class="o">=</span> <span class="n">label_dict</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">quad</span><span class="p">(</span><span class="n">source</span> <span class="o">=</span> <span class="n">srcfiltered</span><span class="p">,</span>
                <span class="n">top</span><span class="o">=</span><span class="s1">&#39;top&#39;</span><span class="p">,</span> <span class="n">bottom</span> <span class="o">=</span> <span class="s1">&#39;bottom&#39;</span><span class="p">,</span> <span class="n">left</span> <span class="o">=</span> <span class="s1">&#39;left&#39;</span><span class="p">,</span> <span class="n">right</span> <span class="o">=</span> <span class="s1">&#39;right&#39;</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;colors&#39;</span><span class="p">,</span> <span class="n">line_color</span> <span class="o">=</span> <span class="s1">&#39;black&#39;</span><span class="p">,</span>
                <span class="n">line_width</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">hover_line_width</span> <span class="o">=</span> <span class="mi">2</span><span class="p">)</span>

            <span class="n">labels</span> <span class="o">=</span> <span class="n">LabelSet</span><span class="p">(</span>
                    <span class="n">x</span> <span class="o">=</span> <span class="s1">&#39;horihistotextx&#39;</span><span class="p">,</span>
                    <span class="n">y</span> <span class="o">=</span> <span class="s1">&#39;horihistotexty&#39;</span><span class="p">,</span>
                    <span class="n">x_offset</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
                    <span class="n">y_offset</span><span class="o">=-</span><span class="mi">4</span><span class="p">,</span>
                    <span class="n">text</span> <span class="o">=</span> <span class="s1">&#39;horihistotext&#39;</span><span class="p">,</span>
                    <span class="n">source</span> <span class="o">=</span> <span class="n">srcfiltered</span><span class="p">,</span><span class="n">text_font_size</span><span class="o">=</span><span class="s1">&#39;10px&#39;</span><span class="p">,</span><span class="n">text_color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">)</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">add_layout</span><span class="p">(</span><span class="n">labels</span><span class="p">)</span>

            <span class="n">panel</span> <span class="o">=</span> <span class="n">Panel</span><span class="p">(</span><span class="n">child</span> <span class="o">=</span> <span class="n">fig</span><span class="p">,</span> <span class="n">title</span> <span class="o">=</span> <span class="n">panels</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">title</span><span class="p">)</span>
            <span class="n">new_panels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">panel</span><span class="p">)</span>
        <span class="n">tabs</span> <span class="o">=</span> <span class="n">Tabs</span><span class="p">(</span><span class="n">tabs</span> <span class="o">=</span> <span class="n">new_panels</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">date_slider</span><span class="p">:</span>
                <span class="n">tabs</span> <span class="o">=</span> <span class="n">column</span><span class="p">(</span><span class="n">date_slider</span><span class="p">,</span><span class="n">tabs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">tabs</span></div>

    <span class="sd">&#39;&#39;&#39; PIE &#39;&#39;&#39;</span>
<div class="viewcode-block" id="CocoDisplay.add_columns_for_pie_chart"><a class="viewcode-back" href="../../coa.display.html#coa.display.CocoDisplay.add_columns_for_pie_chart">[docs]</a>    <span class="k">def</span> <span class="nf">add_columns_for_pie_chart</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">df</span><span class="p">,</span><span class="n">column_name</span><span class="p">):</span>
        <span class="n">r</span> <span class="o">=</span> <span class="mf">0.9</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">column_sum</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">column_name</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;percentage&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">column_name</span><span class="p">]</span><span class="o">/</span><span class="n">column_sum</span><span class="p">)</span>
        <span class="c1">#(( df[&#39;percentage&#39;] * 100 ).astype(np.double).round(2)).apply(lambda x: str(x)+&#39;%&#39;)</span>
        <span class="n">percentages</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span>  <span class="o">+</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;percentage&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">cumsum</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;angle&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">column_name</span><span class="p">]</span><span class="o">/</span><span class="n">column_sum</span><span class="p">)</span><span class="o">*</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;starts&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">percentages</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;ends&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">percentages</span><span class="p">[</span><span class="mi">1</span><span class="p">:]]</span>
        <span class="c1">#df[&#39;middle&#39;] = (df[&#39;starts&#39;] + df[&#39;ends&#39;])/2</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;diff&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;ends&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;starts&#39;</span><span class="p">])</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;middle&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;starts&#39;</span><span class="p">]</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;ends&#39;</span><span class="p">]</span><span class="o">-</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;starts&#39;</span><span class="p">])</span><span class="o">/</span><span class="mf">2.</span>

        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;text_size&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;10pt&#39;</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;text_angle&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.</span>
        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s1">&#39;percentage&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;percentage&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">100</span> <span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">double</span><span class="p">)</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;textdisplayed&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;permanentdisplay&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">pad</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="n">side</span> <span class="o">=</span> <span class="s2">&quot;left&quot;</span><span class="p">)</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;textdisplayed2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">column_name</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">double</span><span class="p">)</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">pad</span><span class="p">(</span><span class="mi">46</span><span class="p">,</span> <span class="n">side</span> <span class="o">=</span> <span class="s2">&quot;left&quot;</span><span class="p">)</span>
        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;diff&#39;</span><span class="p">]</span><span class="o">&lt;=</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mi">20</span><span class="p">,</span><span class="s1">&#39;textdisplayed&#39;</span><span class="p">]</span><span class="o">=</span><span class="s1">&#39;&#39;</span>
        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;diff&#39;</span><span class="p">]</span><span class="o">&lt;=</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mi">20</span><span class="p">,</span><span class="s1">&#39;textdisplayed2&#39;</span><span class="p">]</span><span class="o">=</span><span class="s1">&#39;&#39;</span>
        <span class="k">return</span> <span class="n">df</span></div>
<div class="viewcode-block" id="CocoDisplay.pycoa_pie"><a class="viewcode-back" href="../../coa.display.html#coa.display.CocoDisplay.pycoa_pie">[docs]</a>    <span class="nd">@decowrapper</span>
    <span class="nd">@decohistomap</span>
    <span class="nd">@decohistopie</span>
    <span class="k">def</span> <span class="nf">pycoa_pie</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">srcfiltered</span><span class="p">,</span> <span class="n">panels</span><span class="p">,</span> <span class="n">date_slider</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">            -----------------</span>
<span class="sd">            Create a pie chart according to arguments.</span>
<span class="sd">            See help(pycoa_pie).</span>
<span class="sd">            Keyword arguments</span>
<span class="sd">            -----------------</span>
<span class="sd">            - srcfiltered : A DataFrame with a Pycoa struture is mandatory</span>
<span class="sd">            |location|date|Variable desired|daily|cumul|weekly|codelocation|clustername|permanentdisplay|rolloverdisplay|</span>
<span class="sd">            - input_field = if None take second element could be a list</span>
<span class="sd">            - plot_heigh= width_height_default[1]</span>
<span class="sd">            - plot_width = width_height_default[0]</span>
<span class="sd">            - title = None</span>
<span class="sd">            - textcopyrightposition = left</span>
<span class="sd">            - textcopyright = default</span>
<span class="sd">            - mode = mouse</span>
<span class="sd">            - cursor_date = None if True</span>
<span class="sd">                    - orientation = horizontal</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">standardfig</span> <span class="o">=</span> <span class="n">panels</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">child</span>
        <span class="n">standardfig</span><span class="o">.</span><span class="n">x_range</span> <span class="o">=</span> <span class="n">Range1d</span><span class="p">(</span><span class="o">-</span><span class="mf">1.1</span><span class="p">,</span> <span class="mf">1.1</span><span class="p">)</span>
        <span class="n">standardfig</span><span class="o">.</span><span class="n">y_range</span> <span class="o">=</span> <span class="n">Range1d</span><span class="p">(</span><span class="o">-</span><span class="mf">1.1</span><span class="p">,</span> <span class="mf">1.1</span><span class="p">)</span>
        <span class="n">standardfig</span><span class="o">.</span><span class="n">axis</span><span class="o">.</span><span class="n">visible</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">standardfig</span><span class="o">.</span><span class="n">xgrid</span><span class="o">.</span><span class="n">grid_line_color</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">standardfig</span><span class="o">.</span><span class="n">ygrid</span><span class="o">.</span><span class="n">grid_line_color</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="n">standardfig</span><span class="o">.</span><span class="n">wedge</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">radius</span><span class="o">=</span><span class="mf">1.05</span><span class="p">,</span><span class="n">line_color</span><span class="o">=</span><span class="s1">&#39;#E8E8E8&#39;</span><span class="p">,</span>
        <span class="n">start_angle</span><span class="o">=</span><span class="n">cumsum</span><span class="p">(</span><span class="s1">&#39;angle&#39;</span><span class="p">,</span> <span class="n">include_zero</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span> <span class="n">end_angle</span><span class="o">=</span><span class="n">cumsum</span><span class="p">(</span><span class="s1">&#39;angle&#39;</span><span class="p">),</span>
        <span class="n">fill_color</span><span class="o">=</span><span class="s1">&#39;colors&#39;</span><span class="p">,</span> <span class="n">legend_label</span><span class="o">=</span><span class="s1">&#39;clustername&#39;</span><span class="p">,</span> <span class="n">source</span><span class="o">=</span><span class="n">srcfiltered</span><span class="p">)</span>
        <span class="n">standardfig</span><span class="o">.</span><span class="n">legend</span><span class="o">.</span><span class="n">visible</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="n">labels</span> <span class="o">=</span> <span class="n">LabelSet</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="s1">&#39;textdisplayed&#39;</span><span class="p">,</span>
        <span class="n">angle</span><span class="o">=</span><span class="n">cumsum</span><span class="p">(</span><span class="s1">&#39;angle&#39;</span><span class="p">,</span> <span class="n">include_zero</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span> <span class="n">source</span><span class="o">=</span><span class="n">srcfiltered</span><span class="p">,</span> <span class="n">render_mode</span><span class="o">=</span><span class="s1">&#39;canvas&#39;</span><span class="p">,</span><span class="n">text_font_size</span><span class="o">=</span><span class="s2">&quot;10pt&quot;</span><span class="p">)</span>
        <span class="n">labels2</span> <span class="o">=</span> <span class="n">LabelSet</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="s1">&#39;textdisplayed2&#39;</span><span class="p">,</span>
        <span class="n">angle</span><span class="o">=</span><span class="n">cumsum</span><span class="p">(</span><span class="s1">&#39;angle&#39;</span><span class="p">,</span> <span class="n">include_zero</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span> <span class="n">source</span><span class="o">=</span><span class="n">srcfiltered</span><span class="p">,</span> <span class="n">render_mode</span><span class="o">=</span><span class="s1">&#39;canvas&#39;</span><span class="p">,</span><span class="n">text_font_size</span><span class="o">=</span><span class="s2">&quot;8pt&quot;</span><span class="p">)</span>

        <span class="n">standardfig</span><span class="o">.</span><span class="n">add_layout</span><span class="p">(</span><span class="n">labels</span><span class="p">)</span>
        <span class="n">standardfig</span><span class="o">.</span><span class="n">add_layout</span><span class="p">(</span><span class="n">labels2</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">date_slider</span><span class="p">:</span>
            <span class="n">standardfig</span> <span class="o">=</span> <span class="n">column</span><span class="p">(</span><span class="n">date_slider</span><span class="p">,</span><span class="n">standardfig</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">standardfig</span></div>

    <span class="sd">&#39;&#39;&#39; MAP FOLIUM &#39;&#39;&#39;</span>
<div class="viewcode-block" id="CocoDisplay.pycoa_mapfolium"><a class="viewcode-back" href="../../coa.display.html#coa.display.CocoDisplay.pycoa_mapfolium">[docs]</a>    <span class="nd">@decowrapper</span>
    <span class="nd">@decohistomap</span>
    <span class="k">def</span> <span class="nf">pycoa_mapfolium</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">geopdwd</span><span class="p">,</span> <span class="n">input_field</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">            -----------------</span>
<span class="sd">            Create a map folium to arguments.</span>
<span class="sd">            See help(pycoa_histo).</span>
<span class="sd">            Keyword arguments</span>
<span class="sd">            -----------------</span>
<span class="sd">            - srcfiltered : A DataFrame with a Pycoa struture is mandatory</span>
<span class="sd">            |location|date|Variable desired|daily|cumul|weekly|codelocation|clustername|permanentdisplay|rolloverdisplay|</span>
<span class="sd">            - input_field = if None take second element could be a list</span>
<span class="sd">            - plot_heigh= width_height_default[1]</span>
<span class="sd">            - plot_width = width_height_default[0]</span>
<span class="sd">            - title = None</span>
<span class="sd">            - textcopyrightposition = left</span>
<span class="sd">            - textcopyright = default</span>
<span class="sd">            - mode = mouse</span>
<span class="sd">            - cursor_date = None if True</span>
<span class="sd">                    - orientation = horizontal</span>
<span class="sd">            - when : default min and max according to the inpude DataFrame.</span>
<span class="sd">                         Dates are given under the format dd/mm/yyyy.</span>
<span class="sd">                         when format [dd/mm/yyyy : dd/mm/yyyy]</span>
<span class="sd">                         if [:dd/mm/yyyy] min date up to</span>
<span class="sd">                         if [dd/mm/yyyy:] up to max date</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">title</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;title&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">tile</span> <span class="o">=</span>  <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;tile&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dvisu_default</span><span class="p">[</span><span class="s1">&#39;tile&#39;</span><span class="p">])</span>
        <span class="n">tile</span> <span class="o">=</span> <span class="n">CocoDisplay</span><span class="o">.</span><span class="n">convert_tile</span><span class="p">(</span><span class="n">tile</span><span class="p">,</span> <span class="s1">&#39;folium&#39;</span><span class="p">)</span>
        <span class="n">plot_width</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;plot_width&#39;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">dfigure_default</span><span class="p">[</span><span class="s1">&#39;plot_width&#39;</span><span class="p">])</span>
        <span class="n">plot_height</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;plot_height&#39;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">dfigure_default</span><span class="p">[</span><span class="s1">&#39;plot_height&#39;</span><span class="p">])</span>

        <span class="n">geopdwd</span><span class="p">[</span><span class="s1">&#39;cases&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">geopdwd</span><span class="p">[</span><span class="n">input_field</span><span class="p">]</span>
        <span class="n">geopdwd_filtered</span> <span class="o">=</span> <span class="n">geopdwd</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">geopdwd</span><span class="o">.</span><span class="n">date</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">when_end</span><span class="p">]</span>
        <span class="n">geopdwd_filtered</span> <span class="o">=</span> <span class="n">geopdwd_filtered</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
        <span class="n">geopdwd_filtered</span><span class="p">[</span><span class="s1">&#39;cases&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">geopdwd_filtered</span><span class="p">[</span><span class="n">input_field</span><span class="p">]</span>
        <span class="n">my_date</span> <span class="o">=</span> <span class="n">geopdwd</span><span class="o">.</span><span class="n">date</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
        <span class="n">dico_utc</span> <span class="o">=</span> <span class="p">{</span><span class="n">i</span><span class="p">:</span> <span class="n">DateSlider</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="n">i</span><span class="p">)</span><span class="o">.</span><span class="n">value</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">my_date</span><span class="p">}</span>
        <span class="n">geopdwd</span><span class="p">[</span><span class="s1">&#39;date_utc&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">dico_utc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">geopdwd</span><span class="o">.</span><span class="n">date</span><span class="p">]</span>
        <span class="c1">#geopdwd = geopdwd.drop_duplicates([&quot;date&quot;, &quot;codelocation&quot;,&quot;clustername&quot;])#for sumall avoid duplicate</span>
        <span class="c1">#geopdwd_filtered = geopdwd_filtered.sort_values(by=&#39;cases&#39;, ascending = False).reset_index()</span>
        <span class="c1">#locunique = geopdwd_filtered.clustername.unique()#geopdwd_filtered.location.unique()</span>

        <span class="n">zoom</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbld</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">database_name</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;WW&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">boundary</span> <span class="o">=</span> <span class="n">geopdwd_filtered</span><span class="p">[</span><span class="s1">&#39;geometry&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">total_bounds</span>
            <span class="n">name_location_displayed</span> <span class="o">=</span> <span class="s1">&#39;name_subregion&#39;</span>
            <span class="n">zoom</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">uniqloc</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">geopdwd_filtered</span><span class="o">.</span><span class="n">codelocation</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span>
        <span class="n">geopdwd_filtered</span> <span class="o">=</span> <span class="n">geopdwd_filtered</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">,</span> <span class="s1">&#39;colors&#39;</span><span class="p">])</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbld</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">database_name</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;FRA&#39;</span><span class="p">,</span><span class="s1">&#39;ESP&#39;</span><span class="p">,</span><span class="s1">&#39;PRT&#39;</span><span class="p">]:</span><span class="c1"># and all(len(l) == 2 for l in geopdwd_filtered.codelocation.unique()):</span>
            <span class="n">minx</span><span class="p">,</span> <span class="n">miny</span><span class="p">,</span> <span class="n">maxx</span><span class="p">,</span> <span class="n">maxy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">boundary_metropole</span>
            <span class="n">zoom</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">minx</span><span class="p">,</span> <span class="n">miny</span><span class="p">,</span> <span class="n">maxx</span><span class="p">,</span> <span class="n">maxy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">boundary</span>
            <span class="n">zoom</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;(data from: </span><span class="si">{}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">database_name</span><span class="p">)</span>
        <span class="n">mapa</span> <span class="o">=</span> <span class="n">folium</span><span class="o">.</span><span class="n">Map</span><span class="p">(</span><span class="n">location</span><span class="o">=</span><span class="p">[(</span><span class="n">maxy</span> <span class="o">+</span> <span class="n">miny</span><span class="p">)</span> <span class="o">/</span> <span class="mf">2.</span><span class="p">,</span> <span class="p">(</span><span class="n">maxx</span> <span class="o">+</span> <span class="n">minx</span><span class="p">)</span> <span class="o">/</span> <span class="mf">2.</span><span class="p">],</span> <span class="n">zoom_start</span><span class="o">=</span><span class="n">zoom</span><span class="p">,</span>
                          <span class="n">tiles</span><span class="o">=</span><span class="n">tile</span><span class="p">,</span> <span class="n">attr</span><span class="o">=</span><span class="s1">&#39;&lt;a href=</span><span class="se">\&quot;</span><span class="s1">http://pycoa.fr</span><span class="se">\&quot;</span><span class="s1">&gt; ©pycoa.fr &lt;/a&gt;&#39;</span> <span class="o">+</span> <span class="n">msg</span><span class="p">)</span>  <span class="c1">#</span>

        <span class="n">fig</span> <span class="o">=</span> <span class="n">Figure</span><span class="p">(</span><span class="n">width</span><span class="o">=</span><span class="n">plot_width</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="n">plot_height</span><span class="p">)</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">add_child</span><span class="p">(</span><span class="n">mapa</span><span class="p">)</span>
        <span class="n">min_col</span><span class="p">,</span> <span class="n">max_col</span> <span class="o">=</span> <span class="n">CocoDisplay</span><span class="o">.</span><span class="n">min_max_range</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nanmin</span><span class="p">(</span><span class="n">geopdwd_filtered</span><span class="p">[</span><span class="n">input_field</span><span class="p">]),</span>
                                                     <span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">geopdwd_filtered</span><span class="p">[</span><span class="n">input_field</span><span class="p">]))</span>

        <span class="n">invViridis256</span> <span class="o">=</span> <span class="n">Viridis256</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">color_mapper</span> <span class="o">=</span> <span class="n">LinearColorMapper</span><span class="p">(</span><span class="n">palette</span><span class="o">=</span><span class="n">invViridis256</span><span class="p">,</span> <span class="n">low</span><span class="o">=</span><span class="n">min_col</span><span class="p">,</span> <span class="n">high</span><span class="o">=</span><span class="n">max_col</span><span class="p">,</span> <span class="n">nan_color</span><span class="o">=</span><span class="s1">&#39;#d9d9d9&#39;</span><span class="p">)</span>
        <span class="n">colormap</span> <span class="o">=</span> <span class="n">branca</span><span class="o">.</span><span class="n">colormap</span><span class="o">.</span><span class="n">LinearColormap</span><span class="p">(</span><span class="n">color_mapper</span><span class="o">.</span><span class="n">palette</span><span class="p">)</span><span class="o">.</span><span class="n">scale</span><span class="p">(</span><span class="n">min_col</span><span class="p">,</span> <span class="n">max_col</span><span class="p">)</span>
        <span class="n">colormap</span><span class="o">.</span><span class="n">caption</span> <span class="o">=</span> <span class="s1">&#39;Cases : &#39;</span> <span class="o">+</span> <span class="n">title</span>
        <span class="n">colormap</span><span class="o">.</span><span class="n">add_to</span><span class="p">(</span><span class="n">mapa</span><span class="p">)</span>
        <span class="n">map_id</span> <span class="o">=</span> <span class="n">colormap</span><span class="o">.</span><span class="n">get_name</span><span class="p">()</span>

        <span class="n">custom_label_colorbar_js</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        var div = document.getElementById(&#39;legend&#39;);</span>
<span class="s2">        var ticks = document.getElementsByClassName(&#39;tick&#39;)</span>
<span class="s2">        for(var i = 0; i &lt; ticks.length; i++){</span>
<span class="s2">        var values = ticks[i].textContent.replace(&#39;,&#39;,&#39;&#39;)</span>
<span class="s2">        val = parseFloat(values).toExponential(1).toString().replace(&quot;+&quot;, &quot;&quot;)</span>
<span class="s2">        if(parseFloat(ticks[i].textContent) == 0) val = 0.</span>
<span class="s2">        div.innerHTML = div.innerHTML.replace(ticks[i].textContent,val);</span>
<span class="s2">        }</span>
<span class="s2">        &quot;&quot;&quot;</span>
        <span class="n">e</span> <span class="o">=</span> <span class="n">Element</span><span class="p">(</span><span class="n">custom_label_colorbar_js</span><span class="p">)</span>
        <span class="n">html</span> <span class="o">=</span> <span class="n">colormap</span><span class="o">.</span><span class="n">get_root</span><span class="p">()</span>
        <span class="n">html</span><span class="o">.</span><span class="n">script</span><span class="o">.</span><span class="n">get_root</span><span class="p">()</span><span class="o">.</span><span class="n">render</span><span class="p">()</span>
        <span class="n">html</span><span class="o">.</span><span class="n">script</span><span class="o">.</span><span class="n">_children</span><span class="p">[</span><span class="n">e</span><span class="o">.</span><span class="n">get_name</span><span class="p">()]</span> <span class="o">=</span> <span class="n">e</span>
        <span class="n">geopdwd_filtered</span><span class="p">[</span><span class="n">input_field</span> <span class="o">+</span> <span class="s1">&#39;scientific_format&#39;</span><span class="p">]</span> <span class="o">=</span> \
            <span class="p">([</span><span class="s1">&#39;</span><span class="si">{:.5g}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">geopdwd_filtered</span><span class="p">[</span><span class="s1">&#39;cases&#39;</span><span class="p">]])</span>
        <span class="c1"># ([&#39;{:.3g}&#39;.format(i) if i&gt;100000 else i for i in geopdwd_filter[input_field]])</span>

        <span class="n">map_dict</span> <span class="o">=</span> <span class="n">geopdwd_filtered</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;location&#39;</span><span class="p">)[</span><span class="n">input_field</span><span class="p">]</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmin</span><span class="p">(</span><span class="n">geopdwd_filtered</span><span class="p">[</span><span class="n">input_field</span><span class="p">])</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">geopdwd_filtered</span><span class="p">[</span><span class="n">input_field</span><span class="p">]):</span>
            <span class="n">map_dict</span><span class="p">[</span><span class="s1">&#39;FakeCountry&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.</span>
        <span class="n">color_scale</span> <span class="o">=</span> <span class="n">LinearColormap</span><span class="p">(</span><span class="n">color_mapper</span><span class="o">.</span><span class="n">palette</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="nb">min</span><span class="p">(</span><span class="n">map_dict</span><span class="o">.</span><span class="n">values</span><span class="p">()),</span> <span class="n">vmax</span><span class="o">=</span><span class="nb">max</span><span class="p">(</span><span class="n">map_dict</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span>

        <span class="k">def</span> <span class="nf">get_color</span><span class="p">(</span><span class="n">feature</span><span class="p">):</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">map_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">feature</span><span class="p">[</span><span class="s1">&#39;properties&#39;</span><span class="p">][</span><span class="s1">&#39;location&#39;</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
                <span class="k">return</span> <span class="s1">&#39;#8c8c8c&#39;</span>  <span class="c1"># MISSING -&gt; gray</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">color_scale</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

        <span class="n">displayed</span> <span class="o">=</span> <span class="s1">&#39;rolloverdisplay&#39;</span>
        <span class="n">folium</span><span class="o">.</span><span class="n">GeoJson</span><span class="p">(</span>
            <span class="n">geopdwd_filtered</span><span class="p">,</span>
            <span class="n">style_function</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span>
            <span class="p">{</span>
                <span class="s1">&#39;fillColor&#39;</span><span class="p">:</span> <span class="n">get_color</span><span class="p">(</span><span class="n">x</span><span class="p">),</span>
                <span class="s1">&#39;fillOpacity&#39;</span><span class="p">:</span> <span class="mf">0.8</span><span class="p">,</span>
                <span class="s1">&#39;color&#39;</span><span class="p">:</span> <span class="kc">None</span>
            <span class="p">},</span>
            <span class="n">highlight_function</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;weight&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;color&#39;</span><span class="p">:</span> <span class="s1">&#39;green&#39;</span><span class="p">},</span>
            <span class="n">tooltip</span><span class="o">=</span><span class="n">folium</span><span class="o">.</span><span class="n">features</span><span class="o">.</span><span class="n">GeoJsonTooltip</span><span class="p">(</span><span class="n">fields</span><span class="o">=</span><span class="p">[</span><span class="n">displayed</span><span class="p">,</span> <span class="n">input_field</span> <span class="o">+</span> <span class="s1">&#39;scientific_format&#39;</span><span class="p">],</span>
                                                   <span class="n">aliases</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;location&#39;</span> <span class="o">+</span> <span class="s1">&#39;:&#39;</span><span class="p">,</span> <span class="n">input_field</span> <span class="o">+</span> <span class="s2">&quot;:&quot;</span><span class="p">],</span>
                                                   <span class="n">style</span><span class="o">=</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">                        background-color: #F0EFEF;</span>
<span class="s2">                        border: 2px solid black;</span>
<span class="s2">                        border-radius: 3px;</span>
<span class="s2">                        box-shadow: 3px;</span>
<span class="s2">                        opacity: 0.2;</span>
<span class="s2">                        &quot;&quot;&quot;</span><span class="p">),</span>
            <span class="c1"># &#39;&lt;div style=&quot;barialckground-color: royalblue 0.2; color: black; padding: 2px; border: 1px solid black; border-radius: 2px;&quot;&gt;&#39;+input_field+&#39;&lt;/div&gt;&#39;])</span>
        <span class="p">)</span><span class="o">.</span><span class="n">add_to</span><span class="p">(</span><span class="n">mapa</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">mapa</span></div>

    <span class="sd">&#39;&#39;&#39; DECORATOR FOR MAP BOKEH &#39;&#39;&#39;</span>
<div class="viewcode-block" id="CocoDisplay.decopycoageo"><a class="viewcode-back" href="../../coa.display.html#coa.display.CocoDisplay.decopycoageo">[docs]</a>    <span class="k">def</span> <span class="nf">decopycoageo</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
        <span class="nd">@wraps</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
        <span class="k">def</span> <span class="nf">innerdecopycoageo</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">geopdwd</span><span class="p">,</span> <span class="n">input_field</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
            <span class="n">geopdwd</span><span class="p">[</span><span class="s1">&#39;cases&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">geopdwd</span><span class="p">[</span><span class="n">input_field</span><span class="p">]</span>
            <span class="n">geopdwd_filtered</span> <span class="o">=</span> <span class="n">geopdwd</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">geopdwd</span><span class="o">.</span><span class="n">date</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">when_end</span><span class="p">]</span>
            <span class="n">geopdwd_filtered</span> <span class="o">=</span> <span class="n">geopdwd_filtered</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
            <span class="n">geopdwd_filtered</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">GeoDataFrame</span><span class="p">(</span><span class="n">geopdwd_filtered</span><span class="p">,</span> <span class="n">geometry</span><span class="o">=</span><span class="n">geopdwd_filtered</span><span class="o">.</span><span class="n">geometry</span><span class="p">,</span> <span class="n">crs</span><span class="o">=</span><span class="s2">&quot;EPSG:4326&quot;</span><span class="p">)</span>
            <span class="n">geopdwd</span> <span class="o">=</span> <span class="n">geopdwd</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;clustername&#39;</span><span class="p">,</span> <span class="s1">&#39;date&#39;</span><span class="p">],</span> <span class="n">ascending</span> <span class="o">=</span> <span class="p">[</span><span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">])</span>
            <span class="n">geopdwd_filtered</span> <span class="o">=</span> <span class="n">geopdwd_filtered</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;clustername&#39;</span><span class="p">,</span> <span class="s1">&#39;date&#39;</span><span class="p">],</span> <span class="n">ascending</span> <span class="o">=</span> <span class="p">[</span><span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">])</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">,</span> <span class="s1">&#39;colors&#39;</span><span class="p">])</span>
            <span class="n">new_poly</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">geolistmodified</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>

            <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">geopdwd_filtered</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
                <span class="n">split_poly</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">new_poly</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">pt</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_polycoords</span><span class="p">(</span><span class="n">row</span><span class="p">):</span>
                    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">pt</span><span class="p">)</span> <span class="o">==</span> <span class="nb">tuple</span><span class="p">:</span>
                        <span class="n">new_poly</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">CocoDisplay</span><span class="o">.</span><span class="n">wgs84_to_web_mercator</span><span class="p">(</span><span class="n">pt</span><span class="p">))</span>
                    <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="n">pt</span><span class="p">)</span> <span class="o">==</span> <span class="nb">list</span><span class="p">:</span>
                        <span class="n">shifted</span> <span class="o">=</span> <span class="p">[]</span>
                        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">pt</span><span class="p">:</span>
                            <span class="n">shifted</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">CocoDisplay</span><span class="o">.</span><span class="n">wgs84_to_web_mercator</span><span class="p">(</span><span class="n">p</span><span class="p">))</span>
                        <span class="n">new_poly</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sg</span><span class="o">.</span><span class="n">Polygon</span><span class="p">(</span><span class="n">shifted</span><span class="p">))</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="n">CoaTypeError</span><span class="p">(</span><span class="s2">&quot;Neither tuple or list don&#39;t know what to do with </span><span class="se">\</span>
<span class="s2">                            your geometry description&quot;</span><span class="p">)</span>

                <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">new_poly</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">==</span> <span class="nb">tuple</span><span class="p">:</span>
                    <span class="n">geolistmodified</span><span class="p">[</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;location&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">sg</span><span class="o">.</span><span class="n">Polygon</span><span class="p">(</span><span class="n">new_poly</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">geolistmodified</span><span class="p">[</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;location&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">sg</span><span class="o">.</span><span class="n">MultiPolygon</span><span class="p">(</span><span class="n">new_poly</span><span class="p">)</span>

            <span class="n">ng</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">geolistmodified</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;location&#39;</span><span class="p">,</span> <span class="s1">&#39;geometry&#39;</span><span class="p">])</span>
            <span class="n">geolistmodified</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">GeoDataFrame</span><span class="p">({</span><span class="s1">&#39;location&#39;</span><span class="p">:</span> <span class="n">ng</span><span class="p">[</span><span class="s1">&#39;location&#39;</span><span class="p">],</span> <span class="s1">&#39;geometry&#39;</span><span class="p">:</span> <span class="n">gpd</span><span class="o">.</span><span class="n">GeoSeries</span><span class="p">(</span><span class="n">ng</span><span class="p">[</span><span class="s1">&#39;geometry&#39;</span><span class="p">])},</span> <span class="n">crs</span><span class="o">=</span><span class="s2">&quot;epsg:3857&quot;</span><span class="p">)</span>
            <span class="n">geopdwd_filtered</span> <span class="o">=</span> <span class="n">geopdwd_filtered</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="s1">&#39;geometry&#39;</span><span class="p">)</span>
            <span class="n">geopdwd_filtered</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">geolistmodified</span><span class="p">,</span> <span class="n">geopdwd_filtered</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s1">&#39;location&#39;</span><span class="p">)</span>
            <span class="c1">#if kwargs[&#39;wanted_dates&#39;]:</span>
            <span class="c1">#    kwargs.pop(&#39;wanted_dates&#39;)</span>
            <span class="k">return</span> <span class="n">func</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">geopdwd</span><span class="p">,</span> <span class="n">geopdwd_filtered</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">innerdecopycoageo</span></div>

    <span class="sd">&#39;&#39;&#39; RETURN GEOMETRY, LOCATIO + CASES &#39;&#39;&#39;</span>
<div class="viewcode-block" id="CocoDisplay.pycoageo"><a class="viewcode-back" href="../../coa.display.html#coa.display.CocoDisplay.pycoageo">[docs]</a>    <span class="nd">@decowrapper</span>
    <span class="nd">@decohistomap</span>
    <span class="nd">@decopycoageo</span>
    <span class="k">def</span> <span class="nf">pycoageo</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">geopdwd</span><span class="p">,</span> <span class="n">geopdwd_filtered</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">geopdwd_filtered</span></div>

<div class="viewcode-block" id="CocoDisplay.decomap"><a class="viewcode-back" href="../../coa.display.html#coa.display.CocoDisplay.decomap">[docs]</a>    <span class="k">def</span> <span class="nf">decomap</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
        <span class="nd">@wraps</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
        <span class="k">def</span> <span class="nf">innerdecomap</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">geopdwd</span><span class="p">,</span> <span class="n">geopdwd_filtered</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
            <span class="n">title</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;title&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="n">maplabel</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;maplabel&#39;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">dvisu_default</span><span class="p">[</span><span class="s1">&#39;maplabel&#39;</span><span class="p">])</span>
            <span class="n">title</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;title&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="n">tile</span> <span class="o">=</span>  <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;tile&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dvisu_default</span><span class="p">[</span><span class="s1">&#39;tile&#39;</span><span class="p">])</span>
            <span class="n">tile</span> <span class="o">=</span> <span class="n">CocoDisplay</span><span class="o">.</span><span class="n">convert_tile</span><span class="p">(</span><span class="n">tile</span><span class="p">,</span> <span class="s1">&#39;bokeh&#39;</span><span class="p">)</span>

            <span class="n">sourcemaplabel</span> <span class="o">=</span> <span class="n">ColumnDataSource</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s1">&#39;centroidx&#39;</span><span class="p">:[],</span><span class="s1">&#39;centroidy&#39;</span><span class="p">:[],</span><span class="s1">&#39;cases&#39;</span><span class="p">:[],</span><span class="s1">&#39;spark&#39;</span><span class="p">:[]}))</span>
            <span class="n">uniqloc</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">geopdwd_filtered</span><span class="o">.</span><span class="n">clustername</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span>

            <span class="k">if</span> <span class="n">maplabel</span> <span class="ow">or</span> <span class="n">func</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;pycoa_sparkmap&#39;</span><span class="p">:</span>
                <span class="n">geopdwd_filtered</span><span class="p">[</span><span class="s1">&#39;centroidx&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">geopdwd_filtered</span><span class="p">[</span><span class="s1">&#39;geometry&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">centroid</span><span class="o">.</span><span class="n">x</span>
                <span class="n">geopdwd_filtered</span><span class="p">[</span><span class="s1">&#39;centroidy&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">geopdwd_filtered</span><span class="p">[</span><span class="s1">&#39;geometry&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">centroid</span><span class="o">.</span><span class="n">y</span>
                <span class="n">locsum</span> <span class="o">=</span> <span class="n">geopdwd_filtered</span><span class="o">.</span><span class="n">clustername</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">locsum</span><span class="p">:</span>
                    <span class="n">cases</span> <span class="o">=</span> <span class="n">geopdwd_filtered</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">geopdwd_filtered</span><span class="o">.</span><span class="n">clustername</span> <span class="o">==</span> <span class="n">i</span><span class="p">][</span><span class="s1">&#39;cases&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">centrosx</span> <span class="o">=</span> <span class="n">geopdwd_filtered</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">geopdwd_filtered</span><span class="o">.</span><span class="n">clustername</span> <span class="o">==</span> <span class="n">i</span><span class="p">][</span><span class="s1">&#39;centroidx&#39;</span><span class="p">]</span><span class="c1">#.mean()</span>
                    <span class="n">centrosy</span> <span class="o">=</span> <span class="n">geopdwd_filtered</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">geopdwd_filtered</span><span class="o">.</span><span class="n">clustername</span> <span class="o">==</span> <span class="n">i</span><span class="p">][</span><span class="s1">&#39;centroidy&#39;</span><span class="p">]</span><span class="c1">#.mean()</span>
                    <span class="n">geopdwd_filtered</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">geopdwd_filtered</span><span class="o">.</span><span class="n">clustername</span> <span class="o">==</span> <span class="n">i</span><span class="p">,</span><span class="s1">&#39;cases&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cases</span>
                    <span class="n">geopdwd_filtered</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">geopdwd_filtered</span><span class="o">.</span><span class="n">clustername</span> <span class="o">==</span> <span class="n">i</span><span class="p">,</span><span class="s1">&#39;centroidx&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">centrosx</span>
                    <span class="n">geopdwd_filtered</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">geopdwd_filtered</span><span class="o">.</span><span class="n">clustername</span> <span class="o">==</span> <span class="n">i</span><span class="p">,</span><span class="s1">&#39;centroidy&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">centrosy</span>
                    <span class="n">geopdwd_filtered</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">geopdwd_filtered</span><span class="o">.</span><span class="n">clustername</span> <span class="o">==</span> <span class="n">i</span><span class="p">,</span><span class="s1">&#39;spark&#39;</span><span class="p">]</span> <span class="o">=</span> \
                                <span class="n">CocoDisplay</span><span class="o">.</span><span class="n">sparkline</span><span class="p">(</span><span class="n">geopdwd</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">geopdwd</span><span class="o">.</span><span class="n">clustername</span> <span class="o">==</span> <span class="n">i</span><span class="p">)</span> <span class="o">&amp;</span>
                                <span class="p">(</span><span class="n">geopdwd</span><span class="o">.</span><span class="n">date</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">when_beg</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">geopdwd</span><span class="o">.</span><span class="n">date</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">when_end</span><span class="p">)]</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="s1">&#39;date&#39;</span><span class="p">)[</span><span class="s1">&#39;cases&#39;</span><span class="p">])</span>
                <span class="n">dfLabel</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">geopdwd_filtered</span><span class="p">[[</span><span class="s1">&#39;location&#39;</span><span class="p">,</span><span class="s1">&#39;centroidx&#39;</span><span class="p">,</span><span class="s1">&#39;centroidy&#39;</span><span class="p">,</span><span class="s1">&#39;cases&#39;</span><span class="p">,</span><span class="s1">&#39;spark&#39;</span><span class="p">,</span><span class="s1">&#39;clustername&#39;</span><span class="p">]])</span>
                <span class="n">dfLabel</span><span class="p">[</span><span class="s1">&#39;cases&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dfLabel</span><span class="p">[</span><span class="s1">&#39;cases&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
                <span class="n">dfLabel</span> <span class="o">=</span> <span class="p">(</span><span class="n">dfLabel</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;cases&#39;</span><span class="p">,</span><span class="s1">&#39;clustername&#39;</span><span class="p">,</span><span class="s1">&#39;spark&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span>
                <span class="n">dfLabel</span> <span class="o">=</span> <span class="n">dfLabel</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
                <span class="n">dfLabel</span><span class="p">[</span><span class="s1">&#39;cases&#39;</span><span class="p">]</span><span class="o">=</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">dfLabel</span><span class="p">[</span><span class="s1">&#39;cases&#39;</span><span class="p">]]</span>
                <span class="n">sourcemaplabel</span> <span class="o">=</span> <span class="n">ColumnDataSource</span><span class="p">(</span><span class="n">dfLabel</span><span class="p">)</span>

            <span class="c1">#if self.dbld[self.database_name][0] in [&#39;FRA&#39;,&#39;ESP&#39;,&#39;PRT&#39;]: #and all(len(l) == 2 for l in geopdwd_filtered.codelocation.unique()):</span>
            <span class="c1">#    minx, miny, maxx, maxy = self.boundary_metropole</span>
            <span class="c1">#    (minx, miny) = CocoDisplay.wgs84_to_web_mercator((minx, miny))</span>
            <span class="c1">#    (maxx, maxy) = CocoDisplay.wgs84_to_web_mercator((maxx, maxy))</span>
            <span class="c1">#else:</span>
                <span class="c1">#minx, miny, maxx, maxy =  geopdwd_filtered[&#39;geometry&#39;].total_bounds #self.boundary</span>
            <span class="n">minx</span><span class="p">,</span> <span class="n">miny</span><span class="p">,</span> <span class="n">maxx</span><span class="p">,</span> <span class="n">maxy</span> <span class="o">=</span>  <span class="n">geopdwd_filtered</span><span class="p">[</span><span class="s1">&#39;geometry&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">total_bounds</span> <span class="c1">#self.boundary</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbld</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">database_name</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;WW&#39;</span><span class="p">:</span>
                <span class="n">ratio</span> <span class="o">=</span> <span class="mf">0.05</span>
                <span class="n">minx</span> <span class="o">-=</span> <span class="n">ratio</span><span class="o">*</span><span class="n">minx</span>
                <span class="n">maxx</span> <span class="o">+=</span> <span class="n">ratio</span><span class="o">*</span><span class="n">maxx</span>
                <span class="n">miny</span> <span class="o">-=</span> <span class="n">ratio</span><span class="o">*</span><span class="n">miny</span>
                <span class="n">maxy</span> <span class="o">+=</span> <span class="n">ratio</span><span class="o">*</span><span class="n">maxy</span>

            <span class="n">textcopyrightposition</span> <span class="o">=</span> <span class="s1">&#39;left&#39;</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbld</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">database_name</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;ESP&#39;</span> <span class="p">:</span>
                <span class="n">textcopyrightposition</span><span class="o">=</span><span class="s1">&#39;right&#39;</span>

            <span class="c1">#if func.__name__ == &#39;pycoa_sparkmap&#39;:</span>
            <span class="c1">#    dico[&#39;titlebar&#39;]=tit[:-12]+&#39; [ &#39;+dico[&#39;when_beg&#39;].strftime(&#39;%d/%m/%Y&#39;)+ &#39;-&#39;+ tit[-12:-1]+&#39;])&#39;</span>
            <span class="n">standardfig</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">standardfig</span><span class="p">(</span><span class="n">x_range</span><span class="o">=</span><span class="p">(</span><span class="n">minx</span><span class="p">,</span> <span class="n">maxx</span><span class="p">),</span> <span class="n">y_range</span><span class="o">=</span><span class="p">(</span><span class="n">miny</span><span class="p">,</span> <span class="n">maxy</span><span class="p">),</span>  <span class="n">x_axis_type</span><span class="o">=</span><span class="s2">&quot;mercator&quot;</span><span class="p">,</span> <span class="n">y_axis_type</span><span class="o">=</span><span class="s2">&quot;mercator&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

            <span class="n">wmt</span> <span class="o">=</span> <span class="n">WMTSTileSource</span><span class="p">(</span>
                        <span class="n">url</span><span class="o">=</span><span class="n">tile</span><span class="p">)</span>
            <span class="n">standardfig</span><span class="o">.</span><span class="n">add_tile</span><span class="p">(</span><span class="n">wmt</span><span class="p">)</span>

            <span class="n">geopdwd_filtered</span> <span class="o">=</span> <span class="n">geopdwd_filtered</span><span class="p">[[</span><span class="s1">&#39;cases&#39;</span><span class="p">,</span><span class="s1">&#39;geometry&#39;</span><span class="p">,</span><span class="s1">&#39;location&#39;</span><span class="p">,</span><span class="s1">&#39;codelocation&#39;</span><span class="p">,</span><span class="s1">&#39;rolloverdisplay&#39;</span><span class="p">]]</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbld</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">database_name</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;BEL&#39;</span> <span class="p">:</span>
                <span class="n">reorder</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">geopdwd_filtered</span><span class="o">.</span><span class="n">location</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span>
                <span class="n">geopdwd_filtered</span> <span class="o">=</span> <span class="n">geopdwd_filtered</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;location&#39;</span><span class="p">)</span>
                <span class="n">geopdwd_filtered</span> <span class="o">=</span> <span class="n">geopdwd_filtered</span><span class="o">.</span><span class="n">reindex</span><span class="p">(</span><span class="n">index</span> <span class="o">=</span> <span class="n">reorder</span><span class="p">)</span>
                <span class="n">geopdwd_filtered</span> <span class="o">=</span> <span class="n">geopdwd_filtered</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbld</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">database_name</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;GBR&#39;</span> <span class="p">:</span>
                <span class="n">geopdwd</span> <span class="o">=</span> <span class="n">geopdwd</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="o">~</span><span class="n">geopdwd</span><span class="o">.</span><span class="n">cases</span><span class="o">.</span><span class="n">isnull</span><span class="p">()]</span>
                <span class="n">geopdwd_filtered</span>  <span class="o">=</span> <span class="n">geopdwd_filtered</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="o">~</span><span class="n">geopdwd_filtered</span><span class="o">.</span><span class="n">cases</span><span class="o">.</span><span class="n">isnull</span><span class="p">()]</span>
            <span class="k">return</span> <span class="n">func</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">geopdwd</span><span class="p">,</span> <span class="n">geopdwd_filtered</span><span class="p">,</span> <span class="n">sourcemaplabel</span><span class="p">,</span> <span class="n">standardfig</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">innerdecomap</span></div>

    <span class="sd">&#39;&#39;&#39; MAP BOKEH &#39;&#39;&#39;</span>
<div class="viewcode-block" id="CocoDisplay.pycoa_map"><a class="viewcode-back" href="../../coa.display.html#coa.display.CocoDisplay.pycoa_map">[docs]</a>    <span class="nd">@decowrapper</span>
    <span class="nd">@decohistomap</span>
    <span class="nd">@decopycoageo</span>
    <span class="nd">@decomap</span>
    <span class="k">def</span> <span class="nf">pycoa_map</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">geopdwd</span><span class="p">,</span> <span class="n">geopdwd_filtered</span><span class="p">,</span> <span class="n">sourcemaplabel</span><span class="p">,</span> <span class="n">standardfig</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">            -----------------</span>
<span class="sd">            Create a map bokeh with arguments.</span>
<span class="sd">            See help(pycoa_histo).</span>
<span class="sd">            Keyword arguments</span>
<span class="sd">            -----------------</span>
<span class="sd">            - srcfiltered : A DataFrame with a Pycoa struture is mandatory</span>
<span class="sd">            |location|date|Variable desired|daily|cumul|weekly|codelocation|clustername|permanentdisplay|rolloverdisplay|</span>
<span class="sd">            - input_field = if None take second element could be a list</span>
<span class="sd">            - plot_heigh= width_height_default[1]</span>
<span class="sd">            - plot_width = width_height_default[0]</span>
<span class="sd">            - title = None</span>
<span class="sd">            - textcopyrightposition = left</span>
<span class="sd">            - textcopyright = default</span>
<span class="sd">            - mode = mouse</span>
<span class="sd">            - cursor_date = None if True</span>
<span class="sd">                    - orientation = horizontal</span>
<span class="sd">            - when : default min and max according to the inpude DataFrame.</span>
<span class="sd">                         Dates are given under the format dd/mm/yyyy.</span>
<span class="sd">                         when format [dd/mm/yyyy : dd/mm/yyyy]</span>
<span class="sd">                         if [:dd/mm/yyyy] min date up to</span>
<span class="sd">                         if [dd/mm/yyyy:] up to max date</span>
<span class="sd">            - tile : tile</span>
<span class="sd">            - maplabel: False</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">date_slider</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;date_slider&#39;</span><span class="p">]</span>
        <span class="n">maplabel</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;maplabel&#39;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">dvisu_default</span><span class="p">[</span><span class="s1">&#39;maplabel&#39;</span><span class="p">])</span>
        <span class="n">min_col</span><span class="p">,</span> <span class="n">max_col</span> <span class="o">=</span> <span class="n">CocoDisplay</span><span class="o">.</span><span class="n">min_max_range</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nanmin</span><span class="p">(</span><span class="n">geopdwd_filtered</span><span class="p">[</span><span class="s1">&#39;cases&#39;</span><span class="p">]),</span>
                                                     <span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">geopdwd_filtered</span><span class="p">[</span><span class="s1">&#39;cases&#39;</span><span class="p">]))</span>

        <span class="n">json_data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">geopdwd_filtered</span><span class="o">.</span><span class="n">to_json</span><span class="p">()))</span>
        <span class="n">geopdwd_filtered</span> <span class="o">=</span> <span class="n">GeoJSONDataSource</span><span class="p">(</span><span class="n">geojson</span><span class="o">=</span><span class="n">json_data</span><span class="p">)</span>
        <span class="n">invViridis256</span> <span class="o">=</span> <span class="n">Viridis256</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">color_mapper</span> <span class="o">=</span> <span class="n">LinearColorMapper</span><span class="p">(</span><span class="n">palette</span><span class="o">=</span><span class="n">invViridis256</span><span class="p">,</span> <span class="n">low</span><span class="o">=</span><span class="n">min_col</span><span class="p">,</span> <span class="n">high</span><span class="o">=</span><span class="n">max_col</span><span class="p">,</span> <span class="n">nan_color</span><span class="o">=</span><span class="s1">&#39;#ffffff&#39;</span><span class="p">)</span>
        <span class="n">color_bar</span> <span class="o">=</span> <span class="n">ColorBar</span><span class="p">(</span><span class="n">color_mapper</span><span class="o">=</span><span class="n">color_mapper</span><span class="p">,</span> <span class="n">label_standoff</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span>
                             <span class="n">border_line_color</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">location</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">orientation</span><span class="o">=</span><span class="s1">&#39;horizontal&#39;</span><span class="p">,</span> <span class="n">ticker</span><span class="o">=</span><span class="n">BasicTicker</span><span class="p">())</span>
        <span class="n">color_bar</span><span class="o">.</span><span class="n">formatter</span> <span class="o">=</span> <span class="n">BasicTickFormatter</span><span class="p">(</span><span class="n">use_scientific</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">precision</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">power_limit_low</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">max_col</span><span class="p">))</span>
        <span class="n">standardfig</span><span class="o">.</span><span class="n">add_layout</span><span class="p">(</span><span class="n">color_bar</span><span class="p">,</span> <span class="s1">&#39;below&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">date_slider</span><span class="p">:</span>
            <span class="n">allcases_location</span><span class="p">,</span> <span class="n">allcases_dates</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(),</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
            <span class="n">allcases_location</span> <span class="o">=</span> <span class="n">geopdwd</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;location&#39;</span><span class="p">)[</span><span class="s1">&#39;cases&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
            <span class="n">geopdwd_tmp</span> <span class="o">=</span> <span class="n">geopdwd</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">(</span><span class="n">subset</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;location&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span> <span class="o">=</span> <span class="s1">&#39;cases&#39;</span><span class="p">)</span>
            <span class="n">geopdwd_tmp</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">geopdwd_tmp</span><span class="p">,</span> <span class="n">allcases_location</span><span class="p">,</span> <span class="n">on</span> <span class="o">=</span> <span class="s1">&#39;location&#39;</span><span class="p">)</span>
            <span class="n">geopdwd_tmp</span> <span class="o">=</span> <span class="n">ColumnDataSource</span><span class="p">(</span><span class="n">geopdwd_tmp</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;geometry&#39;</span><span class="p">]))</span>

            <span class="n">callback</span> <span class="o">=</span> <span class="n">CustomJS</span><span class="p">(</span><span class="n">args</span> <span class="o">=</span>  <span class="nb">dict</span><span class="p">(</span><span class="n">source</span> <span class="o">=</span> <span class="n">geopdwd_tmp</span><span class="p">,</span> <span class="n">source_filter</span> <span class="o">=</span> <span class="n">geopdwd_filtered</span><span class="p">,</span>
                                          <span class="n">date_sliderjs</span> <span class="o">=</span> <span class="n">date_slider</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="n">standardfig</span><span class="o">.</span><span class="n">title</span><span class="p">,</span>
                                          <span class="n">maplabeljs</span> <span class="o">=</span> <span class="n">sourcemaplabel</span><span class="p">),</span>
                        <span class="n">code</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">                        var ind_date_max = (date_sliderjs.end-date_sliderjs.start)/(24*3600*1000);</span>
<span class="s2">                        var ind_date = (date_sliderjs.value-date_sliderjs.start)/(24*3600*1000);</span>
<span class="s2">                        var val_cases = [];</span>
<span class="s2">                        var val_loc = [];</span>
<span class="s2">                        var val_ind = [];</span>
<span class="s2">                        var new_cases = [];</span>
<span class="s2">                        var new_location = [];</span>
<span class="s2">                        var dict = </span><span class="si">{}</span><span class="s2">;</span>
<span class="s2">                        var iloop = source_filter.data[&#39;location&#39;].length;</span>

<span class="s2">                        for (var i = 0; i &lt; source.get_length(); i++)</span>
<span class="s2">                        {</span>
<span class="s2">                                new_cases.push(source.data[&#39;cases&#39;][i][ind_date_max-ind_date]);</span>
<span class="s2">                                new_location.push(source.data[&#39;location&#39;][i][ind_date_max-ind_date]);</span>
<span class="s2">                        }</span>
<span class="s2">                        if(source.get_length() == 1 &amp;&amp; iloop&gt;1)</span>
<span class="s2">                            for(var i = 0; i &lt; iloop; i++)</span>
<span class="s2">                                for(var j = 0; j &lt; new_cases.length; j++)</span>
<span class="s2">                                source_filter.data[&#39;cases&#39;][i][j] = new_cases[j];</span>

<span class="s2">                        else</span>
<span class="s2">                            source_filter.data[&#39;cases&#39;] = new_cases;</span>

<span class="s2">                        if (maplabeljs.get_length() !== 0){</span>
<span class="s2">                            maplabeljs.data[&#39;cases&#39;] = source_filter.data[&#39;cases&#39;];</span>
<span class="s2">                            }</span>
<span class="s2">                        for (var i = 0; i &lt; maplabeljs.get_length(); i++)   maplabeljs.data[&#39;cases&#39;][i] =  maplabeljs.data[&#39;cases&#39;][i].toString();</span>
<span class="s2">                        var tmp = title.text;</span>
<span class="s2">                        tmp = tmp.slice(0, -11);</span>
<span class="s2">                        var dateconverted = new Date(date_sliderjs.value);</span>
<span class="s2">                        var dd = String(dateconverted.getDate()).padStart(2, &#39;0&#39;);</span>
<span class="s2">                        var mm = String(dateconverted.getMonth() + 1).padStart(2, &#39;0&#39;); //January is 0!</span>
<span class="s2">                        var yyyy = dateconverted.getFullYear();</span>
<span class="s2">                        var dmy = dd + &#39;/&#39; + mm + &#39;/&#39; + yyyy;</span>
<span class="s2">                        title.text = tmp + dmy+&quot;)&quot;;</span>
<span class="s2">                        if (maplabeljs.get_length() !== 0)</span>
<span class="s2">                            maplabeljs.change.emit();</span>

<span class="s2">                        console.log(maplabeljs.data[&#39;cases&#39;])</span>

<span class="s2">                        source_filter.change.emit();</span>
<span class="s2">                    &quot;&quot;&quot;</span><span class="p">)</span>
            <span class="n">date_slider</span><span class="o">.</span><span class="n">js_on_change</span><span class="p">(</span><span class="s1">&#39;value&#39;</span><span class="p">,</span> <span class="n">callback</span><span class="p">)</span>

        <span class="n">standardfig</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">visible</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">standardfig</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">visible</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">standardfig</span><span class="o">.</span><span class="n">xgrid</span><span class="o">.</span><span class="n">grid_line_color</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">standardfig</span><span class="o">.</span><span class="n">ygrid</span><span class="o">.</span><span class="n">grid_line_color</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">standardfig</span><span class="o">.</span><span class="n">patches</span><span class="p">(</span><span class="s1">&#39;xs&#39;</span><span class="p">,</span> <span class="s1">&#39;ys&#39;</span><span class="p">,</span> <span class="n">source</span> <span class="o">=</span> <span class="n">geopdwd_filtered</span><span class="p">,</span>
                            <span class="n">fill_color</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;field&#39;</span><span class="p">:</span> <span class="s1">&#39;cases&#39;</span><span class="p">,</span> <span class="s1">&#39;transform&#39;</span><span class="p">:</span> <span class="n">color_mapper</span><span class="p">},</span>
                            <span class="n">line_color</span> <span class="o">=</span> <span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">line_width</span> <span class="o">=</span> <span class="mf">0.25</span><span class="p">,</span> <span class="n">fill_alpha</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">maplabel</span> <span class="p">:</span>
            <span class="n">labels</span> <span class="o">=</span> <span class="n">LabelSet</span><span class="p">(</span>
                <span class="n">x</span> <span class="o">=</span> <span class="s1">&#39;centroidx&#39;</span><span class="p">,</span>
                <span class="n">y</span> <span class="o">=</span> <span class="s1">&#39;centroidy&#39;</span><span class="p">,</span>
                <span class="n">text</span> <span class="o">=</span> <span class="s1">&#39;cases&#39;</span><span class="p">,</span>
                <span class="n">source</span> <span class="o">=</span> <span class="n">sourcemaplabel</span><span class="p">,</span> <span class="n">text_font_size</span><span class="o">=</span><span class="s1">&#39;10px&#39;</span><span class="p">,</span><span class="n">text_color</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">,</span><span class="n">background_fill_color</span><span class="o">=</span><span class="s1">&#39;grey&#39;</span><span class="p">,</span><span class="n">background_fill_alpha</span><span class="o">=</span><span class="mf">0.05</span><span class="p">)</span>
            <span class="n">standardfig</span><span class="o">.</span><span class="n">add_layout</span><span class="p">(</span><span class="n">labels</span><span class="p">)</span>

        <span class="n">cases_custom</span> <span class="o">=</span> <span class="n">CocoDisplay</span><span class="o">.</span><span class="n">rollerJS</span><span class="p">()</span>
        <span class="n">loctips</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;location&#39;</span><span class="p">,</span> <span class="s1">&#39;@rolloverdisplay&#39;</span><span class="p">)</span>
        <span class="n">standardfig</span><span class="o">.</span><span class="n">add_tools</span><span class="p">(</span><span class="n">HoverTool</span><span class="p">(</span>
            <span class="n">tooltips</span> <span class="o">=</span> <span class="p">[</span><span class="n">loctips</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;cases&#39;</span><span class="p">,</span> <span class="s1">&#39;@{&#39;</span> <span class="o">+</span> <span class="s1">&#39;cases&#39;</span> <span class="o">+</span> <span class="s1">&#39;}&#39;</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="si">{custom}</span><span class="s1">&#39;</span><span class="p">),</span> <span class="p">],</span>
            <span class="n">formatters</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;location&#39;</span><span class="p">:</span> <span class="s1">&#39;printf&#39;</span><span class="p">,</span> <span class="s1">&#39;@{&#39;</span> <span class="o">+</span> <span class="s1">&#39;cases&#39;</span> <span class="o">+</span> <span class="s1">&#39;}&#39;</span><span class="p">:</span> <span class="n">cases_custom</span><span class="p">,</span> <span class="p">},</span>
            <span class="n">point_policy</span> <span class="o">=</span> <span class="s2">&quot;snap_to_data&quot;</span><span class="p">))</span>  <span class="c1"># ,PanTool())</span>
        <span class="k">if</span> <span class="n">date_slider</span><span class="p">:</span>
            <span class="n">standardfig</span> <span class="o">=</span> <span class="n">column</span><span class="p">(</span><span class="n">date_slider</span><span class="p">,</span> <span class="n">standardfig</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">standardfig</span></div>

    <span class="sd">&#39;&#39;&#39; SPARKMAP BOKEH &#39;&#39;&#39;</span>
<div class="viewcode-block" id="CocoDisplay.pycoa_sparkmap"><a class="viewcode-back" href="../../coa.display.html#coa.display.CocoDisplay.pycoa_sparkmap">[docs]</a>    <span class="nd">@decowrapper</span>
    <span class="nd">@decohistomap</span>
    <span class="nd">@decopycoageo</span>
    <span class="nd">@decomap</span>
    <span class="k">def</span> <span class="nf">pycoa_sparkmap</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">geopdwd</span><span class="p">,</span> <span class="n">geopdwd_filtered</span><span class="p">,</span> <span class="n">sourcemaplabel</span><span class="p">,</span> <span class="n">standardfig</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">            -----------------</span>
<span class="sd">            Create a bokeh map with sparkline label and with to arguments.</span>
<span class="sd">            See help(pycoa_histo).</span>
<span class="sd">            Keyword arguments</span>
<span class="sd">            -----------------</span>
<span class="sd">            - srcfiltered : A DataFrame with a Pycoa struture is mandatory</span>
<span class="sd">            |location|date|Variable desired|daily|cumul|weekly|codelocation|clustername|permanentdisplay|rolloverdisplay|</span>
<span class="sd">            - input_field = if None take second element could be a list</span>
<span class="sd">            - plot_heigh= width_height_default[1]</span>
<span class="sd">            - plot_width = width_height_default[0]</span>
<span class="sd">            - title = None</span>
<span class="sd">            - textcopyrightposition = left</span>
<span class="sd">            - textcopyright = default</span>
<span class="sd">            - mode = mouse</span>
<span class="sd">            - cursor_date = None if True</span>
<span class="sd">                    - orientation = horizontal</span>
<span class="sd">            - when : default min and max according to the inpude DataFrame.</span>
<span class="sd">                         Dates are given under the format dd/mm/yyyy.</span>
<span class="sd">                         when format [dd/mm/yyyy : dd/mm/yyyy]</span>
<span class="sd">                         if [:dd/mm/yyyy] min date up to</span>
<span class="sd">                         if [dd/mm/yyyy:] up to max date</span>
<span class="sd">            - tile : tile</span>
<span class="sd">            - maplabel: False</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">standardfig</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">visible</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">standardfig</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">visible</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">standardfig</span><span class="o">.</span><span class="n">xgrid</span><span class="o">.</span><span class="n">grid_line_color</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">standardfig</span><span class="o">.</span><span class="n">ygrid</span><span class="o">.</span><span class="n">grid_line_color</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">standardfig</span><span class="o">.</span><span class="n">image_url</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="s1">&#39;spark&#39;</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="s1">&#39;centroidx&#39;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s1">&#39;centroidy&#39;</span><span class="p">,</span><span class="n">source</span><span class="o">=</span><span class="n">sourcemaplabel</span><span class="p">,</span><span class="n">anchor</span><span class="o">=</span><span class="s2">&quot;center&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">standardfig</span></div>
    <span class="c1">######################</span>
<div class="viewcode-block" id="CocoDisplay.tiles_list"><a class="viewcode-back" href="../../coa.display.html#coa.display.CocoDisplay.tiles_list">[docs]</a>    <span class="k">def</span> <span class="nf">tiles_list</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">available_tiles</span></div>
    <span class="c1">###################### BEGIN Static Methods ##################</span>
<div class="viewcode-block" id="CocoDisplay.convert_tile"><a class="viewcode-back" href="../../coa.display.html#coa.display.CocoDisplay.convert_tile">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">convert_tile</span><span class="p">(</span><span class="n">tilename</span><span class="p">,</span> <span class="n">which</span> <span class="o">=</span> <span class="s1">&#39;bokeh&#39;</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Return tiles url according to folium or bokeh resquested&#39;&#39;&#39;</span>
        <span class="n">tile</span> <span class="o">=</span> <span class="s1">&#39;openstreet&#39;</span>
        <span class="k">if</span> <span class="n">tilename</span> <span class="o">==</span> <span class="s1">&#39;openstreet&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">which</span> <span class="o">==</span> <span class="s1">&#39;folium&#39;</span><span class="p">:</span>
                <span class="n">tile</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;https://</span><span class="si">{s}</span><span class="s1">.tile.openstreetmap.org/</span><span class="si">{z}</span><span class="s1">/</span><span class="si">{x}</span><span class="s1">/</span><span class="si">{y}</span><span class="s1">.png&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">tile</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;http://c.tile.openstreetmap.org/</span><span class="si">{Z}</span><span class="s1">/</span><span class="si">{X}</span><span class="s1">/</span><span class="si">{Y}</span><span class="s1">.png&#39;</span>
        <span class="k">elif</span> <span class="n">tilename</span> <span class="o">==</span> <span class="s1">&#39;positron&#39;</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Problem with positron tile (huge http resquest need to check), esri is then used ...&#39;</span><span class="p">)</span>
            <span class="n">tile</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/</span><span class="si">{z}</span><span class="s1">/</span><span class="si">{y}</span><span class="s1">/</span><span class="si">{x}</span><span class="s1">.png&#39;</span>
        <span class="c1">#    tile = &#39;https://tiles.basemaps.cartocdn.com/light_all/{z}/{x}/{y}.png&#39;</span>
        <span class="k">elif</span> <span class="n">tilename</span> <span class="o">==</span> <span class="s1">&#39;esri&#39;</span><span class="p">:</span>
            <span class="n">tile</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/</span><span class="si">{z}</span><span class="s1">/</span><span class="si">{y}</span><span class="s1">/</span><span class="si">{x}</span><span class="s1">.png&#39;</span>
        <span class="k">elif</span> <span class="n">tilename</span> <span class="o">==</span> <span class="s1">&#39;stamen&#39;</span><span class="p">:</span>
            <span class="n">tile</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;http://tile.stamen.com/toner/</span><span class="si">{z}</span><span class="s1">/</span><span class="si">{x}</span><span class="s1">/</span><span class="si">{y}</span><span class="s1">.png&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Don</span><span class="se">\&#39;</span><span class="s1">t know you tile ... take default one: &#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">tile</span></div>
    <span class="c1">#####################</span>
<div class="viewcode-block" id="CocoDisplay.dict_shorten_loc"><a class="viewcode-back" href="../../coa.display.html#coa.display.CocoDisplay.dict_shorten_loc">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">dict_shorten_loc</span><span class="p">(</span><span class="n">toshort</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">            return a shorten name location</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">s</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">toshort</span><span class="p">)</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
            <span class="n">toshort</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">toshort</span><span class="p">)</span>
            <span class="n">toshort</span> <span class="o">=</span> <span class="p">[</span><span class="n">toshort</span><span class="p">]</span>
            <span class="n">s</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="n">toshort</span><span class="p">)</span> <span class="o">==</span> <span class="nb">str</span><span class="p">:</span>
            <span class="n">toshort</span> <span class="o">=</span> <span class="p">[</span><span class="n">toshort</span><span class="p">]</span>
            <span class="n">s</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="c1">#if type(toshort) != list:</span>
        <span class="c1">#    print(&#39;That is weird ...&#39;, toshort, &#39;not str nor list&#39;)</span>
        <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">toshort</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span><span class="nb">str</span><span class="p">):</span>
                <span class="n">val</span><span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="o">==</span> <span class="nb">list</span><span class="p">:</span>
                <span class="n">val</span> <span class="o">=</span> <span class="n">val</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">val</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                <span class="n">A</span> <span class="o">=</span> <span class="n">val</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">txt</span> <span class="o">=</span> <span class="n">val</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">txt</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&lt;</span> <span class="mi">4</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">txt</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">:</span>
                    <span class="n">A</span> <span class="o">=</span> <span class="p">[</span><span class="n">txt</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;...&#39;</span> <span class="o">+</span> <span class="n">txt</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">A</span> <span class="o">=</span> <span class="n">txt</span><span class="p">[</span><span class="mi">0</span><span class="p">][:</span><span class="mi">5</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;...&#39;</span> <span class="o">+</span> <span class="n">txt</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="o">-</span><span class="mi">5</span><span class="p">:]</span>
            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="o">==</span> <span class="nb">list</span><span class="p">:</span>
                <span class="n">s</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">A</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">s</span> <span class="o">=</span> <span class="n">A</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                <span class="n">s</span><span class="o">=</span><span class="n">s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">s</span></div>
    <span class="c1">######################</span>
<div class="viewcode-block" id="CocoDisplay.bokeh_legend"><a class="viewcode-back" href="../../coa.display.html#coa.display.CocoDisplay.bokeh_legend">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">bokeh_legend</span><span class="p">(</span><span class="n">bkfigure</span><span class="p">):</span>
        <span class="n">toggle_legend_js</span> <span class="o">=</span> <span class="n">CustomJS</span><span class="p">(</span><span class="n">args</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">leg</span><span class="o">=</span><span class="n">bkfigure</span><span class="o">.</span><span class="n">legend</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
                                    <span class="n">code</span><span class="o">=</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        if(leg.visible)</span>
<span class="s2">        {</span>
<span class="s2">            leg.visible = false;</span>
<span class="s2">        }</span>
<span class="s2">        else</span>
<span class="s2">        {</span>
<span class="s2">            leg.visible = true;</span>
<span class="s2">        }</span>
<span class="s2">        &quot;&quot;&quot;</span><span class="p">)</span>
        <span class="n">bkfigure</span><span class="o">.</span><span class="n">js_on_event</span><span class="p">(</span><span class="n">events</span><span class="o">.</span><span class="n">DoubleTap</span><span class="p">,</span> <span class="n">toggle_legend_js</span><span class="p">)</span></div>
    <span class="c1">######################</span>
<div class="viewcode-block" id="CocoDisplay.min_max_range"><a class="viewcode-back" href="../../coa.display.html#coa.display.CocoDisplay.min_max_range">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">min_max_range</span><span class="p">(</span><span class="n">a_min</span><span class="p">,</span> <span class="n">a_max</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Return a cleverly rounded min and max giving raw min and raw max of data.</span>
<span class="sd">        Usefull for hist range and colormap</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">min_p</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">max_p</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="n">a_min</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">min_p</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">fabs</span><span class="p">(</span><span class="n">a_min</span><span class="p">)))</span>  <span class="c1"># power</span>
        <span class="k">if</span> <span class="n">a_max</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">max_p</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">fabs</span><span class="p">(</span><span class="n">a_max</span><span class="p">)))</span>

        <span class="k">if</span> <span class="n">a_min</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">a_max</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">p</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">p</span> <span class="o">=</span> <span class="n">max_p</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">a_max</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">p</span> <span class="o">=</span> <span class="n">min_p</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">p</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">min_p</span><span class="p">,</span> <span class="n">max_p</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">a_min</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">min_r</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">a_min</span> <span class="o">/</span> <span class="mi">10</span> <span class="o">**</span> <span class="p">(</span><span class="n">p</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="o">*</span> <span class="mi">10</span> <span class="o">**</span> <span class="p">(</span><span class="n">p</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>  <span class="c1"># min range rounded</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">min_r</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">if</span> <span class="n">a_max</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">max_r</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">a_max</span> <span class="o">/</span> <span class="mi">10</span> <span class="o">**</span> <span class="p">(</span><span class="n">p</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="o">*</span> <span class="mi">10</span> <span class="o">**</span> <span class="p">(</span><span class="n">p</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">max_r</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">if</span> <span class="n">min_r</span> <span class="o">==</span> <span class="n">max_r</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">min_r</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">min_r</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
                <span class="n">max_r</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="n">k</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">elif</span> <span class="n">max_r</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">k</span> <span class="o">=</span> <span class="mf">0.1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">k</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.1</span>
            <span class="n">max_r</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">k</span><span class="p">)</span> <span class="o">*</span> <span class="n">max_r</span>
            <span class="n">min_r</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">k</span><span class="p">)</span> <span class="o">*</span> <span class="n">min_r</span>

        <span class="k">return</span> <span class="p">(</span><span class="n">min_r</span><span class="p">,</span> <span class="n">max_r</span><span class="p">)</span></div>
    <span class="c1">######################</span>
<div class="viewcode-block" id="CocoDisplay.save_map2png"><a class="viewcode-back" href="../../coa.display.html#coa.display.CocoDisplay.save_map2png">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">save_map2png</span><span class="p">(</span><span class="nb">map</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">pngfile</span><span class="o">=</span><span class="s1">&#39;map.png&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Save map as png geckodriver and PIL packages are needed</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">size</span> <span class="o">=</span> <span class="n">width_height_default</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">width_height_default</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">pngfile</span><span class="p">:</span>
            <span class="n">pngfile</span> <span class="o">=</span> <span class="n">pngfile</span>
        <span class="n">img_data</span> <span class="o">=</span> <span class="nb">map</span><span class="o">.</span><span class="n">_to_png</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
        <span class="n">img</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">io</span><span class="o">.</span><span class="n">BytesIO</span><span class="p">(</span><span class="n">img_data</span><span class="p">))</span>
        <span class="n">img</span><span class="o">.</span><span class="n">thumbnail</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">Image</span><span class="o">.</span><span class="n">ANTIALIAS</span><span class="p">)</span>
        <span class="n">img</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">pngfile</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">pngfile</span><span class="p">,</span> <span class="s1">&#39; is now save ...&#39;</span><span class="p">)</span></div>
    <span class="c1">######################</span>
<div class="viewcode-block" id="CocoDisplay.save_pandas_as_png"><a class="viewcode-back" href="../../coa.display.html#coa.display.CocoDisplay.save_pandas_as_png">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">save_pandas_as_png</span><span class="p">(</span><span class="n">df</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">pngfile</span><span class="o">=</span><span class="s1">&#39;pandas.png&#39;</span><span class="p">):</span>
        <span class="n">source</span> <span class="o">=</span> <span class="n">ColumnDataSource</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
        <span class="n">df_columns</span> <span class="o">=</span> <span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">name</span><span class="p">]</span>
        <span class="n">df_columns</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
        <span class="n">columns_for_table</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">column</span> <span class="ow">in</span> <span class="n">df_columns</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">column</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">columns_for_table</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">TableColumn</span><span class="p">(</span><span class="n">field</span><span class="o">=</span><span class="n">column</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="n">column</span><span class="p">))</span>
                <span class="c1"># width_height_default</span>
        <span class="n">data_table</span> <span class="o">=</span> <span class="n">DataTable</span><span class="p">(</span><span class="n">source</span><span class="o">=</span><span class="n">source</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">columns_for_table</span><span class="p">,</span>
                               <span class="n">height_policy</span><span class="o">=</span><span class="s2">&quot;auto&quot;</span><span class="p">,</span> <span class="n">width_policy</span><span class="o">=</span><span class="s2">&quot;auto&quot;</span><span class="p">,</span> <span class="n">index_position</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
        <span class="n">export_png</span><span class="p">(</span><span class="n">data_table</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="n">pngfile</span><span class="p">)</span></div>
    <span class="c1">######################</span>
<div class="viewcode-block" id="CocoDisplay.changeto_nonan_date"><a class="viewcode-back" href="../../coa.display.html#coa.display.CocoDisplay.changeto_nonan_date">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">changeto_nonan_date</span><span class="p">(</span><span class="n">df</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">when_end</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">field</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">when_end</span><span class="p">,</span> <span class="n">dt</span><span class="o">.</span><span class="n">date</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">CoaTypeError</span><span class="p">(</span><span class="s1">&#39; Not a valide data ... &#39;</span><span class="p">)</span>

        <span class="n">boolval</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="p">(</span><span class="n">boolval</span><span class="p">):</span>
            <span class="n">boolval</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">date</span> <span class="o">==</span> <span class="p">(</span><span class="n">when_end</span> <span class="o">-</span> <span class="n">dt</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="n">j</span><span class="p">))][</span><span class="n">field</span><span class="p">]</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span><span class="o">.</span><span class="n">empty</span>
            <span class="n">j</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">j</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">verb</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">when_end</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;: all the value seems to be nan! I will find an other previous date.</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span>
                 <span class="s1">&#39;Here the date I will take: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">when_end</span> <span class="o">-</span> <span class="n">dt</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="n">j</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)))</span>
        <span class="k">return</span> <span class="n">when_end</span> <span class="o">-</span> <span class="n">dt</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="n">j</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span></div>
    <span class="c1">######################</span>
<div class="viewcode-block" id="CocoDisplay.changeto_nonull_date"><a class="viewcode-back" href="../../coa.display.html#coa.display.CocoDisplay.changeto_nonull_date">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">changeto_nonull_date</span><span class="p">(</span><span class="n">df</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">when_end</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">field</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">when_end</span><span class="p">,</span> <span class="n">dt</span><span class="o">.</span><span class="n">date</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">CoaTypeError</span><span class="p">(</span><span class="s1">&#39; Not a valide data ... &#39;</span><span class="p">)</span>
        <span class="n">boolval</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="c1">#df = df.fillna(0)</span>
        <span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">field</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;all value is null for all date !&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">when_end</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">while</span><span class="p">(</span><span class="n">boolval</span><span class="p">):</span>
                <span class="n">boolval</span> <span class="o">=</span> <span class="nb">all</span><span class="p">(</span><span class="n">v</span> <span class="o">==</span> <span class="mf">0.</span> <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">date</span> <span class="o">==</span> <span class="p">(</span><span class="n">when_end</span> <span class="o">-</span> <span class="n">dt</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="n">j</span><span class="p">))][</span><span class="n">field</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
                <span class="n">j</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">j</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">verb</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">when_end</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;: all the value seems to be 0! I will find an other previous date.</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span>
                     <span class="s1">&#39;Here the date I will take: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">when_end</span> <span class="o">-</span> <span class="n">dt</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="n">j</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)))</span>
            <span class="k">return</span> <span class="n">when_end</span> <span class="o">-</span> <span class="n">dt</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="n">j</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span></div>
    <span class="c1">######################</span>
<div class="viewcode-block" id="CocoDisplay.get_utcdate"><a class="viewcode-back" href="../../coa.display.html#coa.display.CocoDisplay.get_utcdate">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">get_utcdate</span><span class="p">(</span><span class="n">date</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">date</span> <span class="o">-</span> <span class="n">dt</span><span class="o">.</span><span class="n">date</span><span class="p">(</span><span class="mi">1970</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span> <span class="o">*</span> <span class="mf">1000.</span></div>
    <span class="c1">######################</span>
<div class="viewcode-block" id="CocoDisplay.test_all_val_null"><a class="viewcode-back" href="../../coa.display.html#coa.display.CocoDisplay.test_all_val_null">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">test_all_val_null</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">a</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span></div>
    <span class="c1">######################</span>
<div class="viewcode-block" id="CocoDisplay.get_polycoords"><a class="viewcode-back" href="../../coa.display.html#coa.display.CocoDisplay.get_polycoords">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">get_polycoords</span><span class="p">(</span><span class="n">geopandasrow</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Take a row of a geopandas as an input (i.e : for index, row in geopdwd.iterrows():...)</span>
<span class="sd">            and returns a tuple (if the geometry is a Polygon) or a list (if the geometry is a multipolygon)</span>
<span class="sd">            of an exterior.coords</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">geometry</span> <span class="o">=</span> <span class="n">geopandasrow</span><span class="p">[</span><span class="s1">&#39;geometry&#39;</span><span class="p">]</span>
        <span class="nb">all</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">geometry</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s1">&#39;Polygon&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="n">geometry</span><span class="o">.</span><span class="n">exterior</span><span class="o">.</span><span class="n">coords</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">geometry</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s1">&#39;MultiPolygon&#39;</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">ea</span> <span class="ow">in</span> <span class="n">geometry</span><span class="p">:</span>
                <span class="nb">all</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">ea</span><span class="o">.</span><span class="n">exterior</span><span class="o">.</span><span class="n">coords</span><span class="p">))</span>
            <span class="k">return</span> <span class="nb">all</span></div>
    <span class="c1">######################</span>
<div class="viewcode-block" id="CocoDisplay.wgs84_to_web_mercator"><a class="viewcode-back" href="../../coa.display.html#coa.display.CocoDisplay.wgs84_to_web_mercator">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">wgs84_to_web_mercator</span><span class="p">(</span><span class="n">tuple_xy</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Take a tuple (longitude,latitude) from a coordinate reference system crs=EPSG:4326</span>
<span class="sd">         and converts it to a  longitude/latitude tuple from to Web Mercator format</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">k</span> <span class="o">=</span> <span class="mi">6378137</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">tuple_xy</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">k</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mf">180.0</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">tuple_xy</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="o">-</span><span class="mi">90</span><span class="p">:</span>
            <span class="n">lat</span> <span class="o">=</span> <span class="o">-</span><span class="mi">89</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">lat</span> <span class="o">=</span> <span class="n">tuple_xy</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">tan</span><span class="p">((</span><span class="mi">90</span> <span class="o">+</span> <span class="n">lat</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mf">360.0</span><span class="p">))</span> <span class="o">*</span> <span class="n">k</span>
        <span class="k">return</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span></div>
    <span class="c1">######################</span>
<div class="viewcode-block" id="CocoDisplay.rollerJS"><a class="viewcode-back" href="../../coa.display.html#coa.display.CocoDisplay.rollerJS">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">rollerJS</span><span class="p">():</span>
        <span class="k">return</span> <span class="n">CustomJSHover</span><span class="p">(</span><span class="n">code</span><span class="o">=</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">                var value;</span>
<span class="s2">                 //   if(Math.abs(value)&gt;100000 || Math.abs(value)&lt;0.001)</span>
<span class="s2">                 //       return value.toExponential(2);</span>
<span class="s2">                 //   else</span>
<span class="s2">                 //       return value.toFixed(2);</span>

<span class="s2">                  var s=value.toPrecision(5);</span>
<span class="s2">                  var s0=s;</span>
<span class="s2">                  var sp1=s.split(&quot;.&quot;);</span>
<span class="s2">                  var p1=sp1[0].length</span>
<span class="s2">                  if (sp1.length&gt;1) {</span>
<span class="s2">                    var sp2=s.split(&quot;e&quot;);</span>
<span class="s2">                    var p2=sp2[0].length</span>
<span class="s2">                    var p3=p2</span>
<span class="s2">                    while(s[p2-1]==&quot;0&quot; &amp;&amp; p2&gt;p1) {</span>
<span class="s2">                        p2=p2-1;</span>
<span class="s2">                    }</span>
<span class="s2">                    s=s0.substring(0,p2)+s0.substring(p3,s0.length);</span>
<span class="s2">                  }</span>
<span class="s2">                  if (s.split(&quot;.&quot;)[0].length==s.length-1) {</span>
<span class="s2">                    s=s.substring(0,s.length-1);</span>
<span class="s2">                  }</span>
<span class="s2">                  return s;</span>
<span class="s2">                &quot;&quot;&quot;</span><span class="p">)</span></div>
    <span class="c1">######################</span>
<div class="viewcode-block" id="CocoDisplay.sparkline"><a class="viewcode-back" href="../../coa.display.html#coa.display.CocoDisplay.sparkline">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">sparkline</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">),</span> <span class="o">**</span><span class="n">kwags</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns a HTML image tag containing a base64 encoded sparkline style plot</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">data</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">,</span> <span class="o">**</span><span class="n">kwags</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">patch</span><span class="o">.</span><span class="n">set_alpha</span><span class="p">(</span><span class="mf">0.2</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">ax</span><span class="o">.</span><span class="n">spines</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">v</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">([])</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">([])</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">],</span> <span class="s1">&#39;r.&#39;</span><span class="p">)</span>

        <span class="c1">#ax.fill_between(range(len(data)), data, len(data)*[min(data)], color=&#39;green&#39;,alpha=0.1)</span>
        <span class="n">img</span> <span class="o">=</span> <span class="n">BytesIO</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
        <span class="n">img</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">return</span> <span class="s1">&#39;data:image/png;base64,&#39;</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">base64</span><span class="o">.</span><span class="n">b64encode</span><span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="n">read</span><span class="p">())</span><span class="o">.</span><span class="n">decode</span><span class="p">())</span></div></div>
    <span class="c1">###################### END Static Methods ##################</span>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2021, coa.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>